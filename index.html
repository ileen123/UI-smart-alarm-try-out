<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patiënten Overzicht - Smart Alarm</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        /* Title and header buttons layout */
        .title-header-layout {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 0 auto 30px auto;
            margin-top: 50px;
            max-width: 1200px;
            gap: 30px;
        }

        .title-header-layout .main-title {
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .title-header-layout .header-buttons {
            margin-bottom: 0;
            flex-shrink: 0;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background-color: #ffffff;
            border: 2px solid #FF6B35;
            color: #FF6B35;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .header-btn:hover {
            background-color: #FF6B35;
            color: white;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 9px 15px;
            background: #bdc3c7;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-btn::after {
            content: '▼';
            font-size: 10px;
            color: white;
        }

        .instruction-text {
            text-align: left;
            margin: 0 auto 40px auto;
            max-width: 1200px;
            color: #7f8c8d;
            font-style: italic;
            font-size: 16px;
            padding: 0;
        }

        .instruction-text.hidden {
            display: none;
        }

        .beds-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            align-items: start;
            max-width: 1200px;
            margin: 80px auto 40px auto;
        }

        /* Center beds vertically when patient selection is not visible */
        body:not(.patient-selection-active) .beds-grid {
            margin: 25vh auto 25vh auto;
        }

        /* Responsive design for smaller screens */
        @media (max-width: 1024px) {
            .beds-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                max-width: 800px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 20px;
            }
            
            .beds-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        /* Remove old column classes as we now have 4 beds in one row */
        .left-column,
        .right-column {
            display: contents;
        }

        /* Patient selection area - now positioned below beds */
        .patient-selection-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        .bed-card {
            background: #bdc3c7;
            border-radius: 15px;
            padding: 20px;
            min-height: 260px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .bed-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .bed-card.occupied {
            color: white;
        }

        .bed-card.occupied.risk-low {
            background: #C2E4FF;
            color: #333;
        }

        .bed-card.occupied.risk-low .bed-status {
            color: #666;
        }

        .bed-card.occupied.risk-mid {
            background: #1191FA;
            color: white;
        }

        .bed-card.occupied.risk-high {
            background: #0020CB;
            color: white;
        }

        .bed-card.alarm-active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            animation: pulse 2s infinite;
        }

        /* Selected bed styling - orange border when selecting patient */
        .bed-card.selected {
            border: 3px solid #FC6039;
            box-shadow: 0 4px 15px rgba(252, 96, 57, 0.3);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

        .bed-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .bed-vpk {
            position: absolute;
            top: 10px;
            right: 15px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 4px 8px;
            border-radius: 0px 8px 0px 8px;
            font-size: 12px;
            font-weight: bold;
        }

        .bed-icon {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .add-patient-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px dashed #7f8c8d;
            background: transparent;
            font-size: 30px;
            color: #7f8c8d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-patient-btn:hover {
            color: #ff6b35;
            border: 3px solid #ff6b35;
            transform: scale(1.1);
        }

        .alarm-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #fff;
            color: #FC6039;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .alarm-icon {
            width: 24px;
            height: 24px;
        }

        .discharge-btn {
            padding: 6px 12px;
            border: 1px solid #FC6039;
            background: #fff;
            color: #f74518;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 4px;
        }

        .discharge-btn:hover {
            background: #e74c3c;
            color: #fff;
        }

        .bed-card.occupied.risk-low .alarm-btn {
            background: #fff;
            color: #0020CB;
        }

        .bed-status {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 10px;
        }

        .bed-card.occupied .bed-status {
            color: rgba(255,255,255,0.9);
        }

        .patient-name {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        .patient-selection {
            background: #ecf0f1;
            border-radius: 15px;
            padding: 30px;
            min-height: 250px;
            width: 100%;
            text-align: center;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .patient-selection.active {
            display: block;
        }

        .patient-selection h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .patient-list {
            list-style: none;
            padding: 0;
            max-width: 400px;
            margin: 0 auto;
        }

        .patient-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .patient-item:hover {
            background: #F1D9D3;
            transform: translateX(5px);
        }

        .patient-item.selected {
            border-color: #FC6039;
            background: #FC6039;
            color: white;
        }

        .no-patients {
            background: #f8f9fa;
            color: #6c757d;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            font-style: italic;
        }

        .patient-info {
            text-align: left;
            font-size: 16px;
        }

        .patient-id {
            font-weight: normal;
        }

        .patient-name {
            font-weight: bold;
        }

        .patient-details {
            font-weight: normal;
            opacity: 0.8;
        }

        .selection-buttons {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: space-between;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Base styling for navigation buttons (matching setup page) */
        .nav-btn {
            padding: 10px 20px;
            border: 2px solid #ff6b35;
            border-radius: 20px;
            background: white;
            color: #ff6b35;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Open Sans', sans-serif;
            transition: all 0.3s ease;
        }

        /* Primary action button (Bevestigen) styling */
        .nav-btn.primary {
            background-color: #1961AB;
            border-color: #1961AB;
            color: white;
        }

        /* Disabled state for primary button */
        .nav-btn.primary.disabled {
            background-color: #ccc;
            border-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        /* Hover effects */
        .nav-btn:hover:not(.disabled) {
            background-color: #ff6b35;
            color: white;
        }

        .nav-btn.primary:hover:not(.disabled) {
            background-color: #144a8a;
            border-color: #144a8a;
        }
    </style>
    
    <!-- Shared Data Manager for cross-page data synchronization -->
    <script src="js/shared-data-manager.js"></script>
</head>
<body>
    <!-- Title and header buttons layout -->
    <div class="title-header-layout">
        <!-- Main page title -->
        <h1 class="main-title">Kamer Overzicht</h1>
        
        <!-- Header buttons for plattegrond and unit selection -->
        <div class="header-buttons">
            <button class="header-btn">Plattegrond</button>
            <button class="header-btn">Unit 1</button>
        </div>
    </div>

    <div class="instruction-text" id="instruction-text">
        <p>Klik op een kamer om een patiënt toe te voegen</p>
    </div>

    <div class="beds-grid">
        <!-- All 4 beds in one row -->
        <div class="bed-card" id="bed-1" onclick="handleBedClick(1)">
            <div class="bed-number">1</div>
            <div class="bed-icon">
                <button class="add-patient-btn">+</button>
            </div>
            <div class="bed-status">Nieuwe Patiënt</div>
        </div>

        <div class="bed-card" id="bed-2" onclick="handleBedClick(2)">
            <div class="bed-number">2</div>
            <div class="bed-icon">
                <button class="add-patient-btn">+</button>
            </div>
            <div class="bed-status">Nieuwe Patiënt</div>
        </div>

        <div class="bed-card" id="bed-3" onclick="handleBedClick(3)">
            <div class="bed-number">3</div>
            <div class="bed-icon">
                <button class="add-patient-btn">+</button>
            </div>
            <div class="bed-status">Nieuwe Patiënt</div>
        </div>

        <div class="bed-card" id="bed-4" onclick="handleBedClick(4)">
            <div class="bed-number">4</div>
            <div class="bed-icon">
                <button class="add-patient-btn">+</button>
            </div>
            <div class="bed-status">Nieuwe Patiënt</div>
        </div>
    </div>

    <!-- Patient Selection Area - Now Below Beds -->
    <div class="patient-selection-container">
        <div class="patient-selection" id="patient-selection">
            <h3>Selecteer een patiënt voor bed <span id="selected-bed-number"></span></h3>
            <ul class="patient-list" id="patient-list">
                <!-- Patients will be populated here -->
            </ul>
            <div class="selection-buttons">
                <button class="nav-btn" onclick="cancelSelection()">Annuleren</button>
                <button class="nav-btn primary disabled" id="confirm-btn" onclick="confirmPatientSelection()" disabled>Bevestigen</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        let bedData = {};
        let availablePatients = [];
        let selectedBed = null;
        let selectedPatient = null;
        
        // WebSocket configuration
        const WEBSOCKET_URL = 'ws://localhost:8080';
        let websocket = null;
        let reconnectInterval = null;

        // WebSocket connection management
        function initializeWebSocket() {
            try {
                console.log('🔌 Attempting to connect to WebSocket at:', WEBSOCKET_URL);
                websocket = new WebSocket(WEBSOCKET_URL);
                
                websocket.onopen = function(event) {
                    console.log('✅ WebSocket connected successfully');
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                };
                
                websocket.onmessage = function(event) {
                    console.log('📨 WebSocket message received:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('❌ Error parsing WebSocket message:', error);
                    }
                };
                
                websocket.onclose = function(event) {
                    console.log('🔌 WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
                    websocket = null;
                    
                    // Attempt to reconnect after 5 seconds
                    if (!reconnectInterval) {
                        console.log('🔄 Will attempt to reconnect in 5 seconds...');
                        reconnectInterval = setInterval(initializeWebSocket, 5000);
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('❌ WebSocket error:', error);
                };
                
            } catch (error) {
                console.error('❌ Error creating WebSocket connection:', error);
                // Attempt to reconnect after 5 seconds
                if (!reconnectInterval) {
                    console.log('🔄 Will attempt to reconnect in 5 seconds...');
                    reconnectInterval = setInterval(initializeWebSocket, 5000);
                }
            }
        }

        // Handle incoming WebSocket messages
        function handleWebSocketMessage(data) {
            console.log('📥 Handling WebSocket message:', data);
            // Handle different message types from server if needed
            switch (data.type) {
                case 'acknowledgment':
                    console.log('✅ Server acknowledged patient data:', data.message);
                    break;
                case 'error':
                    console.error('❌ Server error:', data.message);
                    break;
                default:
                    console.log('ℹ️ Unknown message type:', data.type);
            }
        }

        // Send patient data via WebSocket
        function sendPatientDataViaWebSocket(patientData) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                console.warn('⚠️ WebSocket not connected. Cannot send patient data:', patientData);
                return false;
            }
            
            try {
                const message = {
                    type: 'patient_selected',
                    timestamp: new Date().toISOString(),
                    data: patientData
                };
                
                console.log('📤 Sending patient data via WebSocket:', message);
                websocket.send(JSON.stringify(message));
                return true;
            } catch (error) {
                console.error('❌ Error sending WebSocket message:', error);
                return false;
            }
        }

        // Function to save bed states using shared data manager
        function saveBedStatesToStorage() {
            try {
                window.sharedDataManager.saveBedStates(bedData);
                console.log('✅ Bed states saved via shared data manager:', bedData);
            } catch (error) {
                console.error('❌ Error saving bed states:', error);
            }
        }

        // Function to load bed states using shared data manager
        function loadBedStatesFromStorage() {
            try {
                const savedBedStates = window.sharedDataManager.getBedStates();
                if (savedBedStates) {
                    // Migrate old "med" values to "mid" in bed states
                    let hasChanges = false;
                    Object.keys(savedBedStates).forEach(bedNumber => {
                        if (savedBedStates[bedNumber].riskLevel === 'med') {
                            savedBedStates[bedNumber].riskLevel = 'mid';
                            hasChanges = true;
                            console.log('🔄 Migrated bed ' + bedNumber + ' risk level from "med" to "mid"');
                        }
                    });
                    
                    // Save back if we made changes
                    if (hasChanges) {
                        window.sharedDataManager.saveBedStates(savedBedStates);
                    }
                    
                    console.log('✅ Loaded bed states via shared data manager:', savedBedStates);
                    return savedBedStates;
                } else {
                    console.log('ℹ️ No bed states found in shared data manager');
                }
            } catch (error) {
                console.error('❌ Error loading bed states:', error);
            }
            return null;
        }

        // Function to save patient medical information using shared data manager
        function savePatientMedicalInfo(patientId, medicalInfo) {
            try {
                window.sharedDataManager.savePatientMedicalInfo(patientId, medicalInfo);
                console.log('✅ Saved medical info for patient ' + patientId + ' via shared data manager:', medicalInfo);
            } catch (error) {
                console.error('❌ Error saving patient medical info:', error);
            }
        }

        // Function to load patient medical information using shared data manager
        function loadPatientMedicalInfo(patientId) {
            try {
                const savedInfo = window.sharedDataManager.getPatientMedicalInfo(patientId);
                if (savedInfo) {
                    // Migrate old "med" values to "mid" for consistency
                    if (savedInfo.selectedRiskLevel === 'med') {
                        savedInfo.selectedRiskLevel = 'mid';
                        // Save the migrated data back
                        window.sharedDataManager.savePatientMedicalInfo(patientId, savedInfo);
                        console.log('🔄 Migrated risk level from "med" to "mid" for patient ' + patientId);
                    }
                    
                    console.log('✅ Loaded medical info for patient ' + patientId + ' via shared data manager:', savedInfo);
                    return savedInfo;
                } else {
                    console.log('ℹ️ No medical info found for patient ' + patientId);
                }
            } catch (error) {
                console.error('❌ Error loading patient medical info:', error);
            }
            return null;
        }

        // Refresh risk levels for all occupied beds from patient medical info
        function refreshRiskLevelsFromMedicalInfo() {
            console.log('🔄 Refreshing risk levels from patient medical info...');
            
            Object.keys(bedData).forEach(bedNumber => {
                const bed = bedData[bedNumber];
                if (bed.occupied && bed.patientId) {
                    // Get patient medical info from SharedDataManager
                    const patientMedicalInfo = window.sharedDataManager.getPatientMedicalInfo(bed.patientId);
                    if (patientMedicalInfo && patientMedicalInfo.selectedRiskLevel) {
                        const oldRiskLevel = bed.riskLevel;
                        // Migrate old "med" values to "mid"
                        const riskLevel = patientMedicalInfo.selectedRiskLevel === 'med' ? 'mid' : patientMedicalInfo.selectedRiskLevel;
                        bed.riskLevel = riskLevel;
                        console.log(`✅ Updated bed ${bedNumber} risk level: ${oldRiskLevel} → ${bed.riskLevel} (patient ${bed.patientId})`);
                    } else {
                        console.log(`ℹ️ No risk level found for patient ${bed.patientId} in bed ${bedNumber}`);
                    }
                }
            });
            
            // Save updated bed states to storage
            saveBedStatesToStorage();
        }

        // Load initial data
        async function loadData() {
            console.log('🔄 loadData() function called');
            console.log('📍 Current availablePatients:', availablePatients);
            
            // First try to load bed states from storage
            const savedBedStates = loadBedStatesFromStorage();
            if (savedBedStates) {
                bedData = savedBedStates;
                console.log('Using saved bed states:', bedData);
            } else {
                // Initialize with default data if no saved states
                initializeDefaultData();
            }

            // Try to load patient list from shared data manager
            console.log('👥 Patient data already loaded via shared data manager initialization');
            try {
                const hospitalData = window.sharedDataManager.getHospitalData();
                console.log('� Hospital data from shared manager:', hospitalData);
                
                // Get available patients
                if (hospitalData && hospitalData.patients && Array.isArray(hospitalData.patients)) {
                    availablePatients = [...hospitalData.patients];
                    console.log('✅ Successfully loaded patients:', availablePatients);
                    
                    // Remove patients that are already assigned to beds
                    Object.values(bedData).forEach(bed => {
                        if (bed.occupied && bed.patientId) {
                            availablePatients = availablePatients.filter(p => p.id !== bed.patientId);
                        }
                    });
                    
                    console.log('Successfully loaded patients from shared data manager');
                    console.log('Available patients after filtering:', availablePatients);
                } else {
                    throw new Error('Invalid data structure - missing patients array');
                }
            } catch (error) {
                console.warn('Could not load patient data from shared data manager, using fallback:', error.message);
                // Use fallback patient data
                if (availablePatients.length === 0) {
                    // Only set default patients if we don't already have them
                    availablePatients = [
                        { id: "1", name: "S. Groen", gender: "Vrouw", age: 16, weight: 55 },
                        { id: "2", name: "M. Bunnik", gender: "Vrouw", age: 44, weight: 70 },
                        { id: "3", name: "H. Demir", gender: "Man", age: 35, weight: 81 },
                        { id: "4", name: "B. Al Salah", gender: "Man", age: 65, weight: 73 }
                    ];
                    
                    // Remove patients that are already assigned to beds
                    Object.values(bedData).forEach(bed => {
                        if (bed.occupied && bed.patientId) {
                            availablePatients = availablePatients.filter(p => p.id !== bed.patientId);
                        }
                    });
                }
            }
            
            // Refresh risk levels from patient medical info for all occupied beds
            refreshRiskLevelsFromMedicalInfo();
            
            updateDisplay();
        }

        function initializeDefaultData() {
            bedData = {
                1: { bedNumber: 1, occupied: false, patientId: null, vpkCode: null, riskLevel: null },
                2: { bedNumber: 2, occupied: false, patientId: null, vpkCode: null, riskLevel: null },
                3: { bedNumber: 3, occupied: false, patientId: null, vpkCode: null, riskLevel: null },
                4: { bedNumber: 4, occupied: false, patientId: null, vpkCode: null, riskLevel: null }
            };
            
            availablePatients = [
                { id: "1", name: "S. Groen", gender: "Vrouw", age: 16, weight: 55 },
                { id: "2", name: "M. Bunnik", gender: "Vrouw", age: 44, weight: 70 },
                { id: "3", name: "H. Demir", gender: "Man", age: 35, weight: 81 },
                { id: "4", name: "B. Al Salah", gender: "Man", age: 65, weight: 73 }
            ];
            
            updateDisplay();
        }

        function updateDisplay() {
            // Update bed displays
            Object.keys(bedData).forEach(bedNumber => {
                updateBedDisplay(parseInt(bedNumber));
            });
        }

        // Function to translate risk levels to Dutch
        function translateRiskLevel(riskLevel) {
            const translations = {
                'low': 'laag',
                'mid': 'mid',
                'high': 'hoog'
            };
            return translations[riskLevel] || riskLevel;
        }

        function updateBedDisplay(bedNumber) {
            const bed = bedData[bedNumber];
            const bedElement = document.getElementById('bed-' + bedNumber);
            
            if (bed.occupied) {
                const patient = getPatientById(bed.patientId);
                const patientMedicalInfo = loadPatientMedicalInfo(bed.patientId);
                const riskClass = bed.riskLevel ? 'risk-' + bed.riskLevel : 'risk-mid';
                
                


                // Create display text for medical info
                let medicalDisplay = 'Alarm Instellingen';
                if (patientMedicalInfo) {
                    const problem = patientMedicalInfo.selectedProblem || 'Geen probleem geselecteerd';
                    const riskLevel = patientMedicalInfo.selectedRiskLevel || 'Geen risico geselecteerd';
                    medicalDisplay = problem + ' (' + translateRiskLevel(riskLevel) + ')';
                }
                
                console.log('Updating bed ' + bedNumber + ' display with risk level: ' + bed.riskLevel + ', CSS class: ' + riskClass);
                bedElement.className = 'bed-card occupied ' + riskClass;
                bedElement.innerHTML = 
                    '<div class="bed-number">' + bedNumber + '</div>' +
                    '<div class="bed-vpk">VPK: ' + bed.vpkCode + '</div>' +
                    '<div class="bed-icon">' +
                        '<button class="alarm-btn" onclick="event.stopPropagation(); navigateToAlarmSettings(' + bedNumber + ', \'' + bed.patientId + '\')"><svg class="alarm-icon" width="26" height="32" viewBox="0 0 26 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.9015 21.8751H22.105C21.5979 21.0816 21.2059 20.023 21.1188 18.4159V18.4005C21.0612 16.0508 20.9803 14.1972 20.7532 12.718C20.537 11.3143 20.1932 10.2804 19.6083 9.50695L19.5974 9.49154C18.8461 8.42376 17.8536 7.5732 16.7211 6.98768C15.5964 6.40677 14.3271 6.08939 13.0157 6.08785H12.9908C11.6779 6.08939 10.4101 6.4068 9.28537 6.98768C8.15603 7.57013 7.16822 8.41911 6.41688 9.48227L6.39821 9.50847C5.81329 10.282 5.46954 11.3159 5.2533 12.7196C5.02618 14.1941 4.94529 16.0401 4.88773 18.3776V18.4192C4.80062 20.0247 4.40865 21.0831 3.9015 21.8751ZM23.7569 22.0477C23.0584 21.2988 22.4144 20.305 22.3102 18.3574C22.2511 15.9536 22.1671 14.057 21.9353 12.5423C21.6911 10.9522 21.2804 9.75035 20.5648 8.80426C19.703 7.58548 18.5675 6.61165 17.2732 5.94294C16.6183 5.6055 15.923 5.34357 15.2027 5.16792C15.7441 4.61785 16.077 3.86899 16.077 3.04312C16.077 2.20183 15.7332 1.4422 15.1763 0.890593L15.1747 0.892133C14.6178 0.342069 13.8494 0 13.0031 0C12.1756 0 11.4211 0.326654 10.8673 0.85825L10.83 0.892149C10.2731 1.44375 9.92929 2.20339 9.92929 3.04468C9.92929 3.869 10.2622 4.61941 10.8035 5.16794C10.0833 5.34359 9.38794 5.604 8.73305 5.94296C7.4388 6.61167 6.3032 7.5855 5.44143 8.80428C4.7274 9.75187 4.31519 10.9522 4.07096 12.5423C3.83918 14.0539 3.75517 15.9476 3.69606 18.3467L3.69451 18.3575C3.59028 20.3097 2.94316 21.3051 2.24315 22.0524L2.22137 22.074C2.05337 22.2527 1.88226 22.4176 1.71427 22.5794C0.777789 23.4823 -0.0575398 24.2881 0.0031107 26.2296C0.00155481 26.2527 0.0031108 26.2758 0.00466628 26.2989C0.0544451 26.8968 0.28467 27.3621 0.696911 27.6934C1.0687 27.9923 1.57115 28.1587 2.20429 28.1926C2.22918 28.1957 2.25563 28.1972 2.28052 28.1972H8.33004C8.5276 29.1941 9.04407 30.0801 9.77052 30.7442C10.6199 31.5239 11.7555 32 12.9999 32C14.2444 32 15.3784 31.5239 16.2293 30.7442C16.9542 30.0801 17.4707 29.1941 17.6698 28.1972H23.7193V28.1957H23.7427C24.3991 28.1695 24.9202 28.0016 25.3029 27.6949C25.7152 27.3637 25.947 26.8983 25.9952 26.3005H25.9936L25.9952 26.2743C26.0714 24.3005 25.2298 23.49 24.2856 22.5794C24.1191 22.4191 23.9496 22.2558 23.7831 22.0786C23.7769 22.0694 23.7662 22.0584 23.7569 22.0477ZM23.0818 23.0584C23.2078 23.1848 23.3338 23.3065 23.4582 23.4267C24.1971 24.1386 24.8567 24.7749 24.8085 26.2079C24.7867 26.4698 24.7011 26.6609 24.5549 26.7795C24.3807 26.9198 24.1038 26.9983 23.7242 27.0168V27.0153H2.26317C1.89294 26.9953 1.62226 26.9167 1.45114 26.7795C1.30336 26.6609 1.2178 26.4698 1.19758 26.2079L1.19602 26.194C1.15247 24.7688 1.81049 24.1355 2.54782 23.4252C2.67227 23.305 2.79827 23.1833 2.92427 23.0569L23.0815 23.06L23.0818 23.0584ZM15.425 29.8813C14.7919 30.4622 13.9409 30.8166 13.0029 30.8166C12.0665 30.8166 11.2156 30.4622 10.5809 29.8813C10.094 29.4345 9.73311 28.8551 9.55733 28.1987H16.4487C16.2729 28.8536 15.9119 29.4345 15.425 29.8813ZM14.3314 1.72565V1.72873C14.6705 2.06463 14.8821 2.52994 14.8821 3.04458C14.8821 3.55923 14.6721 4.02456 14.3345 4.36044L14.3314 4.36352C13.9985 4.69326 13.538 4.89974 13.0278 4.90589L13.0029 4.90435H12.978C12.4678 4.89819 12.0074 4.69172 11.6745 4.36198L11.6714 4.3589C11.3338 4.02454 11.1238 3.55922 11.1238 3.04304C11.1238 2.52994 11.3338 2.0646 11.6745 1.72719L11.7009 1.69945C12.0369 1.37896 12.4958 1.18327 13.0029 1.18327C13.5225 1.18327 13.9923 1.39129 14.3314 1.72565Z" fill="#FC6039"/><path d="M17.4041 13.9091H16.6699C16.5736 13.4633 16.3962 13.0483 16.1565 12.6766L16.6774 12.1568C16.9876 11.8466 16.9876 11.3437 16.6774 11.0335C16.3666 10.7234 15.8627 10.7234 15.5519 11.0335L15.0309 11.5534C14.6585 11.3136 14.2426 11.1365 13.7959 11.0404V10.3077C13.7959 9.8695 13.4398 9.51351 13 9.51351C12.5602 9.51351 12.2041 9.8695 12.2041 10.3077V11.0404C11.7574 11.1371 11.3415 11.3142 10.9697 11.5534L10.4488 11.0335C10.1386 10.7234 9.634 10.7234 9.32382 11.0335C9.01302 11.3437 9.01302 11.8466 9.32382 12.1568L9.84414 12.676C9.60317 13.0477 9.42638 13.4633 9.32949 13.9091H8.59589C8.15673 13.9091 7.8 14.2645 7.8 14.7033C7.8 15.1422 8.1561 15.4976 8.59589 15.4976H9.32949C9.42638 15.9433 9.6038 16.3583 9.84351 16.73L9.32319 17.2493C9.01239 17.5594 9.01239 18.0623 9.32319 18.3725C9.4786 18.5276 9.68181 18.6048 9.88629 18.6048C10.0908 18.6048 10.2934 18.5276 10.4494 18.3725L10.9697 17.8526C11.3422 18.0925 11.758 18.2689 12.2047 18.3656V19.0977C12.2047 19.5359 12.5608 19.8919 13.0006 19.8919C13.4404 19.8919 13.7965 19.5365 13.7965 19.0977V18.3656C14.2432 18.2695 14.6597 18.0918 15.0322 17.8526L15.5525 18.3719C15.7079 18.5269 15.9111 18.6048 16.1156 18.6048C16.3188 18.6048 16.5227 18.5276 16.6781 18.3725C16.9889 18.0623 16.9889 17.5594 16.6787 17.2499L16.1578 16.7294C16.3981 16.3583 16.5749 15.9427 16.6711 15.4976H17.4041C17.8433 15.4976 18.2 15.1422 18.2 14.7033C18.2 14.2645 17.8433 13.9091 17.4041 13.9091ZM13.0006 16.8638C11.8065 16.8638 10.8357 15.8956 10.8344 14.7052L10.8351 14.7033L10.8344 14.7014C10.8357 13.5104 11.8065 12.5423 13.0006 12.5423C14.1941 12.5423 15.1649 13.5117 15.1649 14.7033C15.1649 15.8944 14.1941 16.8638 13.0006 16.8638Z" fill="#FC6039"/></svg></button>' +
                        '<button class="discharge-btn" onclick="event.stopPropagation(); dischargePatient(' + bedNumber + ')" title="Patiënt ontslaan">Ontslaan</button>' +
                    '</div>' +
                    '<div class="patient-name">' + (patient ? patient.name : 'Unknown') + '</div>' +
                    '<div class="bed-status">' + medicalDisplay + '</div>';
            } else {
                bedElement.className = 'bed-card';
                bedElement.innerHTML = 
                    '<div class="bed-number">' + bedNumber + '</div>' +
                    '<div class="bed-icon">' +
                        '<button class="add-patient-btn">+</button>' +
                    '</div>' +
                    '<div class="bed-status">Nieuwe Patiënt</div>';
            }
        }

        function getPatientById(patientId) {
            // Use shared data manager to get patient info
            return window.sharedDataManager.getPatientInfo(patientId);
        }

        function handleBedClick(bedNumber) {
            console.log('🛏️ Bed clicked:', bedNumber);
            const bed = bedData[bedNumber];
            console.log('📋 Bed data:', bed);
            
            if (bed.occupied) {
                console.log('👤 Bed is occupied, navigating to alarm settings');
                // Navigate to alarm settings for occupied bed
                navigateToAlarmSettings(bedNumber, bed.patientId);
            } else {
                console.log('➕ Bed is empty, showing patient selection');
                // Show patient selection for empty bed
                showPatientSelection(bedNumber);
            }
        }

        function showPatientSelection(bedNumber) {
            console.log('📋 showPatientSelection called for bed:', bedNumber);
            console.log('👥 Available patients at start:', availablePatients);
            
            selectedBed = bedNumber;
            selectedPatient = null;
            
            // Remove selected class from all beds and add to current bed
            document.querySelectorAll('.bed-card').forEach(bed => bed.classList.remove('selected'));
            document.getElementById('bed-' + bedNumber).classList.add('selected');
            
            document.getElementById('selected-bed-number').textContent = bedNumber;
            document.getElementById('instruction-text').classList.add('hidden');
            document.getElementById('patient-selection').classList.add('active');
            
            // Add class to body to indicate patient selection is active
            document.body.classList.add('patient-selection-active');
            
            console.log('🔄 Calling updatePatientList...');
            updatePatientList();
        }

        function updatePatientList() {
            const patientList = document.getElementById('patient-list');
            patientList.innerHTML = '';
            
            console.log('updatePatientList called - availablePatients:', availablePatients);
            console.log('Number of available patients:', availablePatients.length);
            
            if (availablePatients.length === 0) {
                patientList.innerHTML = '<li class="no-patients">Geen patiënten beschikbaar</li>';
                console.warn('No patients available to display');
                return;
            }
            
            // Sort patients by ID (1-4) with lowest number on top
            const sortedPatients = [...availablePatients].sort((a, b) => {
                const idA = parseInt(a.id) || 0;
                const idB = parseInt(b.id) || 0;
                return idA - idB;
            });
            
            sortedPatients.forEach(patient => {
                console.log('Adding patient to list:', patient);
                const li = document.createElement('li');
                li.className = 'patient-item';
                li.onclick = () => selectPatient(patient.id);
                li.innerHTML = 
                    '<div class="patient-info">' + 
                    '<span class="patient-id">' + patient.id + ' - </span>' +
                    '<span class="patient-name">' + patient.name + '</span>' +
                    '<span class="patient-details"> - ' + patient.gender + ' - ' + patient.age + ' jaar - ' + patient.weight + ' kg</span>' +
                    '</div>';
                patientList.appendChild(li);
            });
            
            const confirmBtn = document.getElementById('confirm-btn');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('disabled');
        }

        function selectPatient(patientId) {
            console.log('✅ Patient selected:', patientId);
            selectedPatient = patientId;
            
            // Update visual selection
            document.querySelectorAll('.patient-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            event.target.closest('.patient-item').classList.add('selected');
            const confirmBtn = document.getElementById('confirm-btn');
            confirmBtn.disabled = false;
            confirmBtn.classList.remove('disabled');
            console.log('✅ Confirm button enabled for patient:', patientId);
        }

        function confirmPatientSelection() {
            if (!selectedPatient || !selectedBed) {
                console.error('❌ Missing selectedPatient or selectedBed:', {selectedPatient, selectedBed});
                return;
            }
            
            console.log('✅ Assigning patient ' + selectedPatient + ' to bed ' + selectedBed);
            
            // Validate that the patient exists
            const patientExists = availablePatients.find(p => p.id === selectedPatient);
            if (!patientExists) {
                console.error('❌ Selected patient not found in available patients:', selectedPatient);
                return;
            }
            
            // Prepare patient data for WebSocket transmission
            const patientData = {
                id: patientExists.id,
                name: patientExists.name,
                age: patientExists.age,
                gender: patientExists.gender, // Using 'gender' instead of 'sexe' for clarity
                weight: patientExists.weight,
                bedNumber: selectedBed,
                timestamp: new Date().toISOString()
            };
            
            // Send patient data via WebSocket
            const webSocketSent = sendPatientDataViaWebSocket(patientData);
            if (webSocketSent) {
                console.log('✅ Patient data sent to server via WebSocket');
            } else {
                console.warn('⚠️ Failed to send patient data via WebSocket');
            }
            
            // Generate VPK code
            const vpkCodes = ['FG', 'AM', 'IB', 'GT'];
            const vpkCode = vpkCodes[Math.floor(Math.random() * vpkCodes.length)];
            
            // Update bed data with default medium risk (will be updated when returning from setup)
            bedData[selectedBed].occupied = true;
            bedData[selectedBed].patientId = selectedPatient;
            bedData[selectedBed].vpkCode = vpkCode;
            bedData[selectedBed].riskLevel = 'mid'; // default risk level
            
            console.log('✅ Updated bed data:', bedData[selectedBed]);
            
            // Save bed states immediately
            saveBedStatesToStorage();
            
            // Remove patient from available list
            availablePatients = availablePatients.filter(p => p.id !== selectedPatient);
            
            console.log('Remaining available patients:', availablePatients);
            
            // Update display
            updateBedDisplay(selectedBed);
            // cancelSelection();
            
            // Navigate to patient setup
            navigateToPatientSetup(bedNumber = selectedBed, patientId = selectedPatient);
        }

        function cancelSelection() {
            selectedBed = null;
            selectedPatient = null;
            
            // Remove selected class from all beds
            document.querySelectorAll('.bed-card').forEach(bed => bed.classList.remove('selected'));
            
            // Reset button state
            const confirmBtn = document.getElementById('confirm-btn');
            confirmBtn.disabled = true;
            confirmBtn.classList.add('disabled');
            
            document.getElementById('patient-selection').classList.remove('active');
            document.getElementById('instruction-text').classList.remove('hidden');
            
            // Remove class from body to center beds vertically
            document.body.classList.remove('patient-selection-active');
        }

        function navigateToPatientSetup(bedNumber, patientId) {
            console.log('Navigating to patient setup for bed', bedNumber, 'patient', patientId);
            // Store current state using shared data manager
            console.log('Saving state before navigation:', {
                bedData: bedData,
                availablePatients: availablePatients
            });
            
            // Validate patient ID
            if (!patientId) {
                console.error('❌ No patient ID provided to navigateToPatientSetup');
                return;
            }
            
            console.log('✅ Setting session data with patientId:', patientId, 'bedNumber:', bedNumber);
            
            // Save session data
            window.sharedDataManager.saveSessionData({
                currentBed: bedNumber,
                currentPatient: patientId,
                bedOverviewState: {
                    bedData: bedData,
                    availablePatients: availablePatients
                },
                timestamp: new Date().toISOString()
            });
            
            // Verify the data was saved correctly
            const verifyData = window.sharedDataManager.getSessionData();
            console.log('✅ Verified session data after save:', verifyData);
            
            if (verifyData.currentPatient !== patientId) {
                console.error('❌ Patient ID was not saved correctly!');
                return;
            }
            
            console.log('Navigating to patient setup for bed', bedNumber, 'patient', patientId);
            
            // Navigate to setup page
            window.location.href = 'setup.html';
        }

        function navigateToAlarmSettings(bedNumber, patientId) {
            console.log('Navigating to alarm settings for bed ' + bedNumber + ', patient ' + patientId);
            // Navigate to alarm overview page with bed and patient parameters
            window.location.href = 'alarm-overview.html?bed=' + bedNumber + '&patient=' + patientId;
        }

        // Function to discharge a patient from a bed
        function dischargePatient(bedNumber) {
            const bed = bedData[bedNumber];
            if (!bed || !bed.occupied) {
                console.log('Bed ' + bedNumber + ' is not occupied or does not exist');
                return;
            }

            const patient = getPatientById(bed.patientId);
            const patientName = patient ? patient.name : 'Unknown';
            
            if (confirm('Weet je zeker dat je ' + patientName + ' wilt ontslaan uit bed ' + bedNumber + '?')) {
                console.log('Discharging patient ' + bed.patientId + ' from bed ' + bedNumber);
                
                // Clear patient medical info using shared data manager
                window.sharedDataManager.removePatient(bed.patientId);
                console.log('Cleared medical info for patient ' + bed.patientId + ' via shared data manager');
                
                // Add patient back to available patients list if not already there
                const patientExists = availablePatients.find(p => p.id === bed.patientId);
                if (!patientExists && patient) {
                    availablePatients.push(patient);
                    console.log('Added patient ' + patient.name + ' back to available patients');
                }
                
                // Clear bed data
                bedData[bedNumber] = {
                    bedNumber: bedNumber,
                    occupied: false,
                    patientId: null,
                    vpkCode: null,
                    riskLevel: null
                };
                
                // Save updated state and refresh display
                saveBedStatesToStorage();
                updateDisplay();
                
                console.log('Patient discharged from bed ' + bedNumber + '. Bed is now available.');
            }
        }

        // Check if returning from patient setup
        function checkReturnFromSetup() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('from') === 'setup') {
                console.log('Returning from setup, updating risk level...');
                
                // Get the risk level and bed from shared data manager
                const sessionData = window.sharedDataManager.getSessionData();
                const currentBed = sessionData.currentBed;
                const savedRiskLevel = sessionData.selectedRiskLevel;
                console.log('Retrieved from shared data manager - currentBed:', currentBed, 'savedRiskLevel:', savedRiskLevel);
                
                if (currentBed && savedRiskLevel) {
                    // Load current bed states
                    const currentBedStates = loadBedStatesFromStorage();
                    if (currentBedStates && currentBedStates[currentBed] && currentBedStates[currentBed].occupied) {
                        console.log('Updating bed ' + currentBed + ' risk level from ' + currentBedStates[currentBed].riskLevel + ' to ' + savedRiskLevel);
                        
                        // Update the risk level in bed data
                        currentBedStates[currentBed].riskLevel = savedRiskLevel;
                        
                        // Save the updated bed states
                        bedData = currentBedStates;
                        saveBedStatesToStorage();
                        
                        console.log('Bed ' + currentBed + ' after risk level update:', bedData[currentBed]);
                    } else {
                        console.log('Bed not found or not occupied:', currentBed);
                    }
                }
                
                // Clean up temporary session data
                window.sharedDataManager.clearSessionData();
                localStorage.removeItem('bedOverviewState'); // Clean up old system
                
                // Load the updated data and display
                loadData();
                return true; // Indicate that we handled the return from setup
            }
            return false; // No return from setup
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOMContentLoaded event fired');
            
            // Initialize WebSocket connection
            initializeWebSocket();
            
            // Initialize using shared data manager
            const initData = window.sharedDataManager.initializeBedOverviewPage();
            console.log('📊 Initialized bed overview data:', initData);
            
            // Use initialized available patients
            if (initData.availablePatients) {
                availablePatients = [...initData.availablePatients];
                console.log('✅ Using available patients from shared data manager:', availablePatients);
            }
            
            // Clear any old localStorage data that might conflict
            localStorage.removeItem('bedOverviewState');
            localStorage.removeItem('currentBed');
            localStorage.removeItem('currentPatient');
            console.log('🧹 Cleared old localStorage data');
            
            const stateRestored = checkReturnFromSetup();
            console.log('🔄 checkReturnFromSetup result:', stateRestored);
            
            if (!stateRestored) {
                console.log('📞 Calling loadData()...');
                // Only load default data if no state was restored
                loadData();
            } else {
                console.log('⏭️ Skipped loadData() because state was restored');
            }
        });

        // Clean up WebSocket connection when page is unloaded
        window.addEventListener('beforeunload', function() {
            console.log('🧹 Page unloading - cleaning up WebSocket connection');
            
            // Clear reconnection interval
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            }
            
            // Close WebSocket connection
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.close(1000, 'Page unloading');
            }
        });

        // Test function to manually test risk levels (for debugging)
        function testRiskLevels() {
            console.log('Testing risk levels...');
            // Manually set bed 1 to different risk levels for testing
            bedData[1] = { bedNumber: 1, occupied: true, patientId: "1", vpkCode: "TEST", riskLevel: 'low' };
            bedData[2] = { bedNumber: 2, occupied: true, patientId: "2", vpkCode: "TEST", riskLevel: 'mid' };
            bedData[3] = { bedNumber: 3, occupied: true, patientId: "3", vpkCode: "TEST", riskLevel: 'high' };
            updateDisplay();
        }

        // Test shared data manager flow
        function testLocalStorageFlow(bedNum, riskLevel) {
            console.log('Testing shared data manager flow for bed ' + bedNum + ' with risk ' + riskLevel);
            
            // Simulate the workflow using shared data manager
            window.sharedDataManager.saveSessionData({
                currentBed: bedNum,
                selectedRiskLevel: riskLevel,
                timestamp: new Date().toISOString()
            });
            
            // Simulate returning from setup
            const urlParams = new URLSearchParams('?from=setup');
            window.history.replaceState({}, '', window.location.pathname + '?from=setup');
            
            // Trigger state restoration
            checkReturnFromSetup();
        }

        // Call this function from browser console to test: testRiskLevels()
    </script>
</body>
</html>
