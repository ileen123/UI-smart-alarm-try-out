<!DOCTYPE html>
<html lang="nl">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title that appears in browser tab -->
    <title>Circulatoir Instellingen</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/slider-component.css">
    
    <!-- Data Manager for cross-page data synchronization -->
    <script src="js/shared-data-manager.js"></script>
    
    <!-- Slider Component -->
    <script src="js/slider-component.js"></script>
    
    <!-- Heart Circle Component -->
    <script src="js/heart-circle-component.js"></script>
</head>
<body>
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <a href="#" class="breadcrumb-link" onclick="goToBedOverview()">
            <img src="svg's/home.svg" alt="Home" class="breadcrumb-icon">
            Pati√´nten Overzicht
        </a>
        <span class="breadcrumb-separator">></span>
        <a href="#" class="breadcrumb-link" onclick="goBackToAlarmOverview()">Alarm Instellingen - S. Groen</a>
        <span class="breadcrumb-separator">></span>
        <span class="breadcrumb-current">Circulatoire Monitoring</span>
    </nav>

    <!-- Title and Patient Info Layout -->
    <div class="title-patient-layout">
        <!-- Main page title -->
        <h1 class="main-title">Circulatoire Monitoring</h1>
        
        <!-- Patient information header section -->
        <div class="header">
            <img src="svg's/patient_icon.svg" alt="Patient" class="user-icon" />
            <span id="patient-header-info">Loading patient info...</span>
        </div>
    </div>
    
    <!-- Main content container -->
    <div class="circulatoir-settings-container">
        
        <!-- Monitoring Level Controls -->
        <div class="monitoring-controls-layout">
            <!-- Monitoring buttons - now direct children -->
            <div class="monitoring-buttons-direct">
                <h3 class="info-title">Monitoring Level</h3>
                <div class="button-group">
                    <button class="btn risk-low" data-level="loose" onclick="changeMonitoringLevel('loose')">Los</button>
                    <button class="btn risk-med selected" data-level="mid" onclick="changeMonitoringLevel('mid')">Mid</button>
                    <button class="btn risk-high" data-level="tight" onclick="changeMonitoringLevel('tight')">Strak</button>
                </div>
            </div>
            
            <!-- Heart circle - now direct child -->
            <div class="heart-circle-direct">
                <h3 class="info-title"> </h3>
                <div id="circulatoir-heart-circle-container"></div>
            </div>
            
            <!-- Additional Circulatory Information Container -->
            <div class="additional-circulatory-info">
                <h3 class="info-title">Circulatoire additionele informatie:</h3>
                <div class="circulatory-tags-section">
                    <button class="btn tag-btn circulatory-tag" data-condition="sepsis">
                        Sepsis <img src="svg's/sepsis.svg" alt="Sepsis" class="sepsis-icon">
                    </button>
                    <button class="circulatory-more-btn">‚ãØ</button>
                </div>
            </div>
        </div>
        
        
        <!-- Section title moved outside the container -->
        <h2 class="section-title">Circulatoire Streefgebieden Aanpassen</h2>
        
        <!-- Interactive Slider Demo Section -->
        <div class="slider-demo-section">
            
            <!-- Direct slider containers without extra wrappers -->
            <div class="sliders-layout">
                <div id="hr-slider-container" class="individual-slider"></div>
                <div class="bp-slider-with-legend">
                    <div id="bp-slider-container" class="individual-slider"></div>
                    <div class="alarm-legend">
                        <div class="legend-item">
                            <div class="legend-color green"></div>
                            <span>Acceptabel</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color yellow"></div>
                            <span>Lichte overschrijding</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color orange"></div>
                            <span>Medium overschrijding</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color red"></div>
                            <span>Significante overschrijding</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation section with back button -->
    <div class="bottom-left-nav">
        <button class="nav-button back-button" onclick="goBackToAlarmOverview()">
            ‚Üê Terug naar Alarm Overzicht
        </button>
    </div>

    <!-- Bottom right navigation button -->
    <div class="bottom-right-nav">
        <button class="nav-button forward-button" onclick="goToRespiratoir()">
            Naar Respiratoir ‚Üí
        </button>
    </div>

    <style>
        /* Page-specific gradient background - only for circulatory settings page */
        body {
            background: linear-gradient(to bottom, #ffffff 0%, #ffffff 10%, #E6E4E0 100%);
            min-height: 100vh; /* Ensure full viewport height for gradient */
            padding: 50px 200px 5px 200px; /* Further reduced padding for no scrolling */
            margin: 0;
            font-family: 'Open Sans', sans-serif;
        }

        /* Breadcrumb Navigation */
        .breadcrumb-nav {
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            color: #FC6039;
            margin-bottom: 25px;
            padding-top: 10px;
            display: flex;
            align-items: center;
            line-height: 1.2;
        }

        .breadcrumb-link {
            color: #FC6039;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s ease;
            vertical-align: middle;
        }

        .breadcrumb-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .breadcrumb-icon {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            filter: brightness(0) saturate(100%) invert(44%) sepia(93%) saturate(1352%) hue-rotate(346deg) brightness(119%) contrast(119%);
            vertical-align: middle;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #FC6039;
            font-weight: normal;
        }

        .breadcrumb-current {
            color: #FC6039;
            font-weight: 600;
        }
        
        /* Title and Patient Info Layout */
        .title-patient-layout {
            display: flex;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .title-patient-layout .main-title {
            margin: 0; /* Remove default margin */
            flex: 0 0 auto; /* Don't grow or shrink */
        }
        
        /* Position header to align with the right edge of additional-circulatory-info */
        .header {
            width: fit-content; /* Resize to content width */
            margin: 0; /* Remove default margins */
            position: absolute;
            right: 0; /* Align to the right edge of the container */
            /* This will align with the additional info box since both are in the same container width */
        }
        
        /* Monitoring Level Controls - matching risk level button styling */
        .monitoring-level-controls {
            margin: 0px 0; /* Further reduced from 15px */
            text-align: left; /* Changed from center to left */
            background: rgba(255, 255, 255, 0);
            padding: 0px; /* Further reduced from 20px */
            border-radius: 10px;
            /* box-shadow: 0 2px 4px rgba(0,0,0,0.1); */ /* Shadow removed */
            border: 1px solid #e9ecef;
        }
        
        .monitoring-level-controls .section-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: left; /* Ensure title is also left-aligned */
        }
        
        .monitoring-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 10px; /* Further reduced from 15px */
            text-align: left; /* Changed from default to explicitly left */
        }
        
        /* Layout for monitoring controls and heart circle - horizontal sections */
        .monitoring-controls-layout {
            display: flex;
            gap: -400px; /* Further reduced gap to bring heart circle even closer */
            margin-top: 3px; /* Further reduced from 5px */
            margin-bottom: 10px; /* Further reduced from 15px */
            align-items: flex-start;
            width: 100%;
            position: relative;
        }
        
        .monitoring-buttons-direct {
            flex: 1;
            /* Container properties removed - now direct on page */
            padding: 12px 15px 15px 0px; /* Removed left padding to align with title */
            min-height: 120px; /* Reduced to match additional info container */
            max-height: 120px; /* Reduced to match additional info container */
            display: flex;
            flex-direction: column;
        }
        
        .heart-circle-direct {
            flex: 1;
            /* Container properties removed - now direct on page */
            padding: 0px 15px 15px 15px; /* Further reduced padding */
            margin-left: -300px; /* Increased negative margin to move heart circle closer to monitoring buttons */
            min-height: 200px; /* Reduced from 240px to make it more compact */
            max-height: 200px; /* Reduced from 240px to make it more compact */
            display: flex;
            flex-direction: column;
            align-items: left;
            justify-content: flex-start;
            overflow: visible; /* Changed from hidden to visible to show full circle */
            position: relative;
        }
        
        .heart-circle-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }
        
        #circulatoir-heart-circle-container {
            width: 220px;
            height: 220px;
            max-width: 100%;
            max-height: 260px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Changed from center to flex-start to move left */
            margin: 0;
            padding-top: 12px;
            overflow: visible; /* Ensure circle content is not clipped */
        }
        .heart-organ-circle {
            opacity: 1 !important;
            position: relative !important;
        }
        
        /* Specific override for circulatory page heart circle positioning */
        #circulatoir-heart-circle-container .heart-organ-circle {
            justify-content: flex-start !important;
            margin: 0 !important;
        }
        
        /* Additional Circulatory Information Container - matches alarm overview form-section */
        .additional-circulatory-info {
            flex: 1.05; /* Further reduced for better proportions */
            display: flex;
            flex-direction: column;
        }
        
        .circulatory-tags-section {
            background: #C2E4FF;
            padding: 15px 20px 20px 20px;
            border-radius: 30px 0px 30px 0px;
            min-height: 100px; /* Reduced since title is outside */
            max-height: 100px;
            display: flex;
            gap: 8px; /* Reduced from 15px to bring buttons closer */
            flex-wrap: wrap;
            align-items: flex-start;
        }
        
        /* General info-title styling for all containers */
        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 15px;
            text-align: left;
            position: relative;
            z-index: 2;
        }
        
        .additional-circulatory-info .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 8px; /* Reduced margin to bring container closer */
            margin-left: 0px; /* Reduced left margin for better alignment */
            text-align: left;
            position: relative;
            background: transparent; /* Ensure no background */
            z-index: 10; /* Position above the blue container */
        }

        .monitoring-buttons-direct .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 8px; /* Match additional info title margin */
            text-align: left;
            position: relative;
            z-index: 2;
        }
        
        /* Using standard tag styling from styles.css - no custom circulatory styling needed */
        
        .circulatory-tag {
            padding: 6px 12px;
            font-size: 13px;
            white-space: nowrap;
            border-radius: 20px;
            background-color: #bbdefb;
            border: 2px solid #1961AB;
            color: #1961AB;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: auto;
            flex-shrink: 0;
            flex-grow: 0;
        }
        
        .circulatory-tag:hover {
            background: #90caf9;
            border-color: #64b5f6;
        }
        
        .circulatory-tag.selected {
            background-color: #1961AB;
            color: white;
            border-color: #1961AB;
            font-weight: 600;
        }
        
        .circulatory-more-btn {
            background-color: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .circulatory-more-btn:hover {
            background-color: #e55a2b;
            transform: scale(1.05);
        }
        
        /* Slider containers and titles */
        .slider-demo-section {
            margin: 8px 0; /* Further reduced from 12px for tighter spacing */
            max-width: 1920px; /* Use full width */
            margin-left: auto;
            margin-right: auto;
            padding: 0; /* Remove padding to align with body padding */
            /* flex: 1; */ /* Remove flex:1 - don't take remaining space */
        }
        
        .slider-demo-section .section-title {
            color: #1961AB;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 0px;
            text-align: left;
        }
        
        .demo-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .sliders-layout {
            display: flex;
            gap: 40px; /* Reduced from 120px for compact layout */
            justify-content: center;
            flex-wrap: nowrap; /* Force horizontal layout, no wrapping */
            margin: -20px auto;
            align-items: flex-start; /* Align sliders at the top */
        }
        
        .individual-slider {
            flex: 0 0 auto; /* Don't grow or shrink, use natural size */
            min-width: 400px; /* Reduced from 500px */
            max-width: 450px; /* Reduced from 600px */
        }

        /* BP Slider with Legend Layout */
        .bp-slider-with-legend {
            display: flex;
            gap: 100px;
            align-items: center; /* This centers the legend vertically */
        }

        /* Alarm Legend Styles */
        .alarm-legend {
            background: white;
            border-radius: 8px;
            padding: 15px; /* Reduced from 20px */
            /* border: 1px solid #e9ecef; */ /* Border removed */
            min-width: 160px; /* Reduced from 200px */
            /* margin-top removed - flexbox centering handles positioning */
        }

        .alarm-legend h4 {
            font-family: 'Open Sans', sans-serif;
            color: black;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            font-family: 'Open Sans', sans-serif;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-color.green {
            background-color: #00C877;
        }

        .legend-color.yellow {
            background-color: #ECEC3E;
        }

        .legend-color.orange {
            background-color: #F0973E;
        }

        .legend-color.red {
            background-color: #EB4921;
        }

        .legend-item span {
            color: black;
            font-size: 14px;
            font-weight: 400;
        }
        .nav-button {
            background-color: transparent;
            border: 2px solid #ff6b35;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Open Sans', sans-serif;
            color: #ff6b35;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-button:hover {
            background-color: #ff6b35;
            border-color: #ff6b35;
            color: white;
            transform: translateY(-2px);
        }
        
        /* Bottom right navigation button */
        .bottom-right-nav {
            position: fixed;
            bottom: 63px;
            right: 200px;
            z-index: 1000;
        }
        
        /* Bottom left navigation button - matching right button positioning */
        .bottom-left-nav {
            position: fixed;
            bottom: 63px;
            left: 200px;
            z-index: 1000;
        }
        
        .subtitle {
            text-align: left; /* Changed from center to left */
            color: #6c757d;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: 400;
        }
        
        .circulatoir-settings-container {
            max-width: 1920px; /* Use full width for 1920x1080 */
            margin: 0 auto;
            padding: 0; /* Remove padding to align with body padding */
            /* height: calc(100vh - 30px); */ /* Remove fixed height - let content determine height */
            display: flex;
            flex-direction: column;
        }
        
        .parameter-section {
            background: white;
            border-radius: 12px;
            padding: 18px; /* Further reduced from 20px */
            margin-bottom: 15px; /* Further reduced from 20px */
            /* box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); */ /* Shadow removed */
            border: 1px solid #e9ecef;
        }
        
        .parameter-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 18px; /* Reduced from 25px */
            color: #cd3ae1;
            font-size: 24px;
            font-weight: 600;
        }
        
        .heart-icon, .bp-icon {
            font-size: 32px;
        }
        
        .range-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .current-range {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .range-status {
            font-size: 14px;
            color: #28a745;
            font-weight: 500;
        }
        
        .adjustment-controls {
            margin-bottom: 20px;
        }
        
        .range-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .range-input-group label {
            font-weight: 600;
            color: #495057;
            flex: 1;
        }
        
        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-with-unit input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }
        
        .input-with-unit input:focus {
            outline: none;
            border-color: #1961AB;
            /* box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); */ /* Shadow removed */
        }
        
        .unit {
            font-weight: 600;
            color: #6c757d;
            min-width: 50px;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background-color: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .preset-btn:hover {
            background-color: #1961AB;
            border-color: #1961AB;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 40px 0;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .reset-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .reset-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .save-btn {
            background-color: #28a745;
            color: white;
        }
        
        .save-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .settings-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #dee2e6;
        }
        
        .settings-preview h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
            text-align: center;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .preview-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .preview-label {
            font-weight: 600;
            color: #495057;
        }
        
        .preview-value {
            font-weight: 600;
            color: #1961AB;
            font-size: 16px;
        }
        
        /* Slider Demo Section Styles */
        .slider-demo-section {
            background: #ffffff;
            border-radius: 0px 30px 0px 30px;
            padding: 20px; /* Add some padding instead of fixed height */
            margin-top: 0px;
            width: 1520px;
            /* height: 120px; */ /* Remove fixed height - let content determine size */
            height: auto; /* Let content determine height */
        }
        
        .slider-demo-section h3 {
            color: #2c3e50;
            font-size: 22px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .demo-description {
            text-align: center;
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .slider-containers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .slider-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            /* box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); */ /* Shadow removed */
            border: 1px solid #e9ecef;
        }
        
        .slider-container h4 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .slider-container > div {
            min-height: 300px;
        }
        
        /* Monitoring Level Controls */
        .monitoring-level-controls {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .monitoring-level-controls h4 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .monitoring-description {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .level-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .level-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .level-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-2px);
        }
        
        .level-btn.active {
            background: #1961AB;
            border-color: #1961AB;
            color: white;
        }
        
        .level-btn strong {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .level-btn span {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .circulatoir-settings-container {
                padding: 10px;
            }
            
            .parameter-section {
                padding: 20px;
            }
            
            .range-input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .preset-buttons {
                justify-content: center;
            }
        }
    </style>

    <script>
        // Global variables
        let currentPatientId = null;
        let currentBed = null;
        let currentSettings = {};

        // Initialize currentSettings from SharedDataManager
        function initializeCurrentSettings() {
            if (currentPatientId && window.sharedDataManager) {
                // Get current target ranges from SharedDataManager
                const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                if (targetRanges) {
                    currentSettings = {
                        hr: {
                            min: targetRanges.HR?.min || window.HR_MIN || 60,
                            max: targetRanges.HR?.max || window.HR_MAX || 100
                        },
                        bp: {
                            min: targetRanges.BP_Mean?.min || window.BP_MIN || 65,
                            max: targetRanges.BP_Mean?.max || window.BP_MAX || 85
                        }
                    };
                } else {
                    // Fallback to global variables
                    currentSettings = {
                        hr: { min: window.HR_MIN || 60, max: window.HR_MAX || 100 },
                        bp: { min: window.BP_MIN || 65, max: window.BP_MAX || 85 }
                    };
                }
                console.log('üíì Circulatory currentSettings initialized from SharedDataManager:', currentSettings);
            } else {
                // Default fallback
                currentSettings = {
                    hr: { min: 60, max: 100 },
                    bp: { min: 65, max: 85 }
                };
                console.log('üíì Circulatory currentSettings initialized with defaults:', currentSettings);
            }
        }

        
        // Store slider references for monitoring level changes
        let hrSlider = null;
        let bpSlider = null;

        // ===================================================================
        // CENTRALIZED SYNCHRONIZATION SYSTEM
        // ===================================================================

        /**
         * Synchronize sliders with centralized target ranges
         * Called on page load and when ranges change from other pages
         */
        function syncSlidersWithCentralizedRanges() {
            if (!currentPatientId || !window.sharedDataManager) {
                console.log('‚è∏Ô∏è No patient ID or SharedDataManager available for slider sync');
                return;
            }

            console.log('üìä Syncing circulatory sliders with centralized target ranges...');
            const currentRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
            
            if (!currentRanges) {
                console.log('‚è∏Ô∏è No centralized ranges found for patient:', currentPatientId);
                return;
            }

            // Update HR slider
            if (hrSlider && currentRanges.HR) {
                console.log('üìä Syncing HR slider:', currentRanges.HR.min, '-', currentRanges.HR.max);
                
                // Update slider config
                hrSlider.config.targetRange.min = currentRanges.HR.min;
                hrSlider.config.targetRange.max = currentRanges.HR.max;
                
                // Update current positions
                hrSlider.currentMin = currentRanges.HR.min;
                hrSlider.currentMax = currentRanges.HR.max;
                
                // Update original values so slider doesn't think these are user changes
                hrSlider.originalMin = currentRanges.HR.min;
                hrSlider.originalMax = currentRanges.HR.max;
                
                // Force re-render
                if (hrSlider.updateSliderPosition) {
                    hrSlider.updateSliderPosition();
                    console.log('‚úÖ HR slider synced and re-rendered');
                }
            }

            // Update BP slider  
            if (bpSlider && currentRanges.BP_Mean) {
                console.log('üìä Syncing BP slider:', currentRanges.BP_Mean.min, '-', currentRanges.BP_Mean.max);
                
                // Update slider config
                bpSlider.config.targetRange.min = currentRanges.BP_Mean.min;
                bpSlider.config.targetRange.max = currentRanges.BP_Mean.max;
                
                // Update current positions
                bpSlider.currentMin = currentRanges.BP_Mean.min;
                bpSlider.currentMax = currentRanges.BP_Mean.max;
                
                // Update original values
                bpSlider.originalMin = currentRanges.BP_Mean.min;
                bpSlider.originalMax = currentRanges.BP_Mean.max;
                
                // Force re-render
                if (bpSlider.updateSliderPosition) {
                    bpSlider.updateSliderPosition();
                    console.log('‚úÖ BP slider synced and re-rendered');
                }
            }

            console.log('‚úÖ All circulatory sliders synced with centralized ranges');
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
            initializeSepsisTagState(); // Initialize sepsis state FIRST
            
            // Initialize global variables system (simple approach)
            if (window.sharedDataManager) {
                window.sharedDataManager.loadGlobalParameterVariables();
                console.log('‚úÖ Global variables loaded for circulatoir page');
            }

            // Initialize button states immediately after DOM is ready
            initializeMonitoringLevelButtons();

            // Initialize heart circle component (same as alarm overview)
            setTimeout(() => {
                initializeHeartCircleComponent();
                initializeSliders();
            }, 1000);
        });
        // Heart SVG content (copied from alarm overview)
        const svgContent = {
            heart: `<svg class="organ-icon" viewBox="0 0 22 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.22 10.3743C12.0679 12.132 10.9163 15.0615 10.9163 19.1628M13.22 10.3743C12.0681 12.132 11.4922 14.4756 6.30842 14.4756M13.22 10.3743C14.6766 8.39884 16.9516 6.83964 19.3552 6.3986C20.0557 6.27006 20.6011 5.62288 20.4841 4.90863L20.2921 3.73684C20.1996 3.17181 19.7182 2.75127 19.159 2.81881C16.3987 3.15222 12.9705 4.8327 10.9162 7.44486C10.9162 6.27307 10.9162 2.75769 10.3402 1M5.73245 6.85896C5.15648 5.10127 4.00454 3.92948 2.27663 3.92948M1.70071 15.6441C2.85258 20.9171 7.26892 25 10.3401 25C13.4113 25 17.6365 20.9175 18.9799 15.6441C20.3232 10.3707 16.1 6.85563 13.2201 10.371C13.2201 8.61732 11.4922 6.85906 8.03639 6.85906C4.58057 6.85906 0.548838 10.371 1.70071 15.6441Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`
        };

        // Utility to inject SVG content into the heart circle
        function injectSVG(containerId, svgType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const iconDiv = container.querySelector('.heart-white-center');
            if (iconDiv) {
                iconDiv.innerHTML = svgContent[svgType];
                const svgEl = iconDiv.querySelector('svg');
                if (svgEl) {
                    svgEl.style.width = '70%';
                    svgEl.style.height = '70%';
                    svgEl.style.display = 'block';
                    svgEl.style.margin = '0 auto';
                }
            } else {
                setTimeout(() => injectSVG(containerId, svgType), 50);
            }
        }

        // Initialize the heart circle component in circulatoir settings
        function initializeHeartCircleComponent() {
            console.log('ü´Ä Starting initializeHeartCircleComponent...');
            
            // Use same size as alarm overview
            const circleSize = 130;
            
            // Get current monitoring level from SharedDataManager
            let initialLevel = 'mid';
            if (currentPatientId && window.sharedDataManager) {
                initialLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                console.log(`ü´Ä Heart circle initialization - Loading heart monitoring level for patient ${currentPatientId}:`, initialLevel);
            } else {
                console.log('ü´Ä Heart circle initialization - Using default level (mid) - no patient ID or SharedDataManager');
                console.log('ü´Ä Current patient ID:', currentPatientId);
                console.log('ü´Ä SharedDataManager available:', !!window.sharedDataManager);
            }
            
            console.log(`ü´Ä Creating heart circle component with initialState: ${initialLevel}`);
            
            window.circulatoirHeartCircle = new HeartCircleComponent('circulatoir-heart-circle-container', { 
                size: circleSize, 
                initialState: initialLevel 
            });
            setTimeout(() => injectSVG('circulatoir-heart-circle-container', 'heart'), 100);
            
            // Map heart circle levels to button levels for initial setup
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight'
            };
            
            const buttonLevel = levelMapping[initialLevel] || 'mid';
            
            // Button states are now handled by initializeMonitoringLevelButtons() during DOM ready
            // No need to update them here as they're already set earlier
            
            // Update sliders to match loaded level (wait for sliders to be initialized)
            setTimeout(() => {
                updateSlidersMonitoringLevel(buttonLevel);
            }, 1500); // Wait for sliders to be fully initialized
            
            // Listen for global heart monitoring level changes
            document.addEventListener('heartMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                if (patientId === currentPatientId) {
                    console.log(`Received heart monitoring level change for patient ${patientId}:`, level);
                    if (window.circulatoirHeartCircle) {
                        window.circulatoirHeartCircle.setRiskLevel(level);
                    }
                    
                    const buttonLevel = levelMapping[level] || 'mid';
                    updateButtonStates(buttonLevel);
                    updateSlidersMonitoringLevel(buttonLevel);
                }
            });
        }
        
        // Initialize monitoring level buttons immediately when DOM is ready
        function initializeMonitoringLevelButtons() {
            console.log('üîò Initializing monitoring level buttons...');
            console.log('üîç Current patient ID:', currentPatientId);
            console.log('üîç SharedDataManager available:', !!window.sharedDataManager);
            
            // Get current monitoring level from SharedDataManager
            let currentLevel = 'mid'; // default
            if (currentPatientId && window.sharedDataManager) {
                currentLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                console.log(`üì± Loaded heart monitoring level for patient ${currentPatientId}:`, currentLevel);
            } else {
                console.log('‚ö†Ô∏è Using default level (mid) - no patient ID or SharedDataManager');
            }
            
            // Map heart circle levels to button levels
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight'
            };
            
            const buttonLevel = levelMapping[currentLevel] || 'mid';
            console.log(`üîò Setting button state to: ${buttonLevel} (from heart level: ${currentLevel})`);
            console.log(`üîò Level mapping result: ${currentLevel} ‚Üí ${levelMapping[currentLevel]} ‚Üí fallback: ${buttonLevel}`);
            
            // Check if buttons exist before updating
            const buttons = document.querySelectorAll('.button-group .btn');
            console.log(`üîò Found ${buttons.length} buttons in button-group`);
            
            // Update button states immediately
            updateButtonStates(buttonLevel);
        }
        
        // Helper function to update button states
        function updateButtonStates(level) {
            // Map heart circle levels back to button levels
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight',
                'loose': 'loose',  // fallback mappings
                'tight': 'tight'
            };
            
            const mappedLevel = levelMapping[level] || level;
            console.log(`Updating button states: ${level} ‚Üí ${mappedLevel}`);
            
            // Update button states
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            const selectedButton = document.querySelector(`[data-level="${mappedLevel}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`‚úÖ Button ${mappedLevel} selected in updateButtonStates`);
            } else {
                console.warn(`‚ùå Button with data-level="${mappedLevel}" not found`);
            }
        }

        // Helper function to update sliders monitoring level (moved outside closure for global access)
        function updateSlidersMonitoringLevel(level) {
            console.log(`üéõÔ∏è Updating sliders monitoring level to: ${level}`);
            console.log('üîç DEBUG - hrSlider exists:', !!hrSlider);
            console.log('üîç DEBUG - bpSlider exists:', !!bpSlider);
            
            if (hrSlider) {
                console.log('üîç DEBUG - hrSlider type:', typeof hrSlider);
                console.log('üîç DEBUG - hrSlider.updateMonitoringLevel exists:', typeof hrSlider.updateMonitoringLevel);
            }
            
            // Update HR slider if it exists
            if (hrSlider && typeof hrSlider.updateMonitoringLevel === 'function') {
                console.log('üéõÔ∏è Calling hrSlider.updateMonitoringLevel with:', level);
                hrSlider.updateMonitoringLevel(level);
                console.log('‚úÖ HR slider monitoring level updated to:', level);
            } else {
                console.warn('‚ùå HR slider not found or updateMonitoringLevel method not available');
                console.warn('‚ùå hrSlider:', hrSlider);
                if (hrSlider) {
                    console.warn('‚ùå Available methods:', Object.getOwnPropertyNames(hrSlider));
                }
            }
            
            // Update BP slider if it exists
            if (bpSlider && typeof bpSlider.updateMonitoringLevel === 'function') {
                console.log('üéõÔ∏è Calling bpSlider.updateMonitoringLevel with:', level);
                bpSlider.updateMonitoringLevel(level);
                console.log('‚úÖ BP slider monitoring level updated to:', level);
            } else {
                console.warn('‚ùå BP slider not found or updateMonitoringLevel method not available');
                console.warn('‚ùå bpSlider:', bpSlider);
                if (bpSlider) {
                    console.warn('‚ùå Available methods:', Object.getOwnPropertyNames(bpSlider));
                }
            }
        }

        // Function to change monitoring level for all sliders
        function changeMonitoringLevel(level) {
            console.log(`üîÑ Changing monitoring level to: ${level}`);
            
            // Map button levels to heart circle levels
            const levelMapping = {
                'loose': 'low',
                'mid': 'mid',
                'tight': 'high',
                'Los': 'low',
                'Mid': 'mid',
                'Strak': 'high'
            };
            
            const heartLevel = levelMapping[level] || level;
            console.log(`Mapped ${level} to heart level: ${heartLevel}`);
            
            // Update button states - remove active/selected from all buttons
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            // Add selected class to the clicked button
            const selectedButton = document.querySelector(`[data-level="${level}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`‚úÖ Button ${level} selected`);
            }
            
            // Update heart circle if it exists
            if (window.circulatoirHeartCircle) {
                console.log(`ü´Ä Updating heart circle to: ${heartLevel}`);
                window.circulatoirHeartCircle.setRiskLevel(heartLevel);
            } else {
                console.warn('‚ùå circulatoirHeartCircle not found');
            }
            
            // Save to SharedDataManager for global sync
            if (currentPatientId && window.sharedDataManager) {
                window.sharedDataManager.updateGlobalHeartMonitoringLevel(currentPatientId, heartLevel);
                console.log(`‚úÖ Saved heart level ${heartLevel} for patient ${currentPatientId}`);
                
                // Mark this as a recent manual change to prioritize it over calculated values
                sessionStorage.setItem('recentHeartLevelChange', Date.now().toString());
            }
            
            // Update sliders if they exist
            updateSlidersMonitoringLevel(level);
            
            console.log(`‚úÖ Monitoring level changed to: ${level} (heart: ${heartLevel})`);
        }

        function initializePage() {
            console.log('üîÑ Initializing circulatoir settings page...');
            
            // Try to get patient and session data from multiple sources
            if (window.sharedDataManager) {
                // First, try to get from URL parameters (if navigated directly)
                const urlParams = new URLSearchParams(window.location.search);
                const urlPatient = urlParams.get('patient');
                const urlBed = urlParams.get('bed');
                
                // Second, try to get from session data
                const sessionData = window.sharedDataManager.getSessionData();
                
                // Use URL parameters if available, otherwise use session data
                currentPatientId = urlPatient || sessionData.currentPatient;
                currentBed = urlBed || sessionData.currentBed;
                
                console.log('üìã Patient sources - URL:', urlPatient, 'Session:', sessionData.currentPatient);
                console.log('üõèÔ∏è Bed sources - URL:', urlBed, 'Session:', sessionData.currentBed);
                console.log('‚úÖ Final selection - Patient:', currentPatientId, 'Bed:', currentBed);
                
                // If still no patient/bed data, redirect to bed overview
                if (!currentPatientId || !currentBed) {
                    console.warn('‚ö†Ô∏è No patient or bed data found, redirecting to bed overview');
                    alert('Geen pati√´ntgegevens gevonden. Ga terug naar het bedoverzicht om een pati√´nt te selecteren.');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Update session data to ensure consistency
                window.sharedDataManager.saveSessionData({
                    currentPatient: currentPatientId,
                    currentBed: currentBed,
                    lastUpdated: new Date().toISOString()
                });
                
                // Update header with patient info
                updatePatientHeader();
                
                // Initialize currentSettings from SharedDataManager
                initializeCurrentSettings();
                
                // Initialize global variables for this patient (simple approach)
                if (window.sharedDataManager) {
                    window.sharedDataManager.initializeGlobalParameterVariables(currentPatientId);
                    console.log('‚úÖ Global variables initialized for patient:', currentPatientId);
                }
            } else {
                console.error('‚ùå SharedDataManager not available');
                alert('Data manager niet beschikbaar. Herlaad de pagina.');
            }
        }

        function updatePatientHeader() {
            const headerElement = document.getElementById('patient-header-info');
            if (currentPatientId && currentBed) {
                const patientInfo = window.sharedDataManager.getPatientInfo(currentPatientId);
                const displayName = patientInfo?.name || `Pati√´nt ${currentPatientId}`;
                
                // Get medical information including main problem and risk level
                const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                
                let headerText = `${displayName} - Bed ${currentBed}`;
                
                // Add main problem if available
                if (medicalInfo?.selectedProblem) {
                    const problemMapping = {
                        'sepsis': 'Sepsis',
                        'pneumonia': 'Pneumonie',
                        'cardiac': 'Hartproblemen',
                        'surgery': 'Chirurgie',
                        'other': 'Anders'
                    };
                    const problemDisplay = problemMapping[medicalInfo.selectedProblem] || medicalInfo.selectedProblem;
                    headerText += ` | Hoofdprobleem: ${problemDisplay}`;
                }
                
                // Add risk level if available
                if (medicalInfo?.selectedRiskLevel) {
                    const riskMapping = {
                        'low': 'Laag',
                        'med': 'Middel',
                        'high': 'Hoog'
                    };
                    const riskDisplay = riskMapping[medicalInfo.selectedRiskLevel] || medicalInfo.selectedRiskLevel;
                    headerText += ` | Risiconiveau: ${riskDisplay}`;
                }
                
                headerElement.textContent = headerText;
            } else {
                headerElement.textContent = '';
            }
        }
        
        function initializeSepsisTagState() {
            console.log('ü¶† Initializing sepsis tag state...');
            
            if (currentPatientId && window.sharedDataManager) {
                // Ensure patient has clean state for new setup (but don't force clean existing states)
                window.sharedDataManager.ensureCleanPatientState(currentPatientId, false);
                
                // Check if sepsis is currently selected using the new condition state method
                const sepsisState = window.sharedDataManager.getPatientConditionState('sepsis', currentPatientId);
                const sepsisButton = document.querySelector('.circulatory-tag[data-condition="sepsis"]');
                
                if (sepsisButton) {
                    if (sepsisState && sepsisState.isActive) {
                        sepsisButton.classList.add('selected');
                        console.log('‚úÖ Initialized sepsis button as selected');
                    } else {
                        sepsisButton.classList.remove('selected');
                        console.log('‚úÖ Initialized sepsis button as deselected');
                    }
                }
            }
        }

        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');
            
            // SIMPLE APPROACH: Listen for global parameter changes from problem changes
            window.addEventListener('globalParametersChanged', function(event) {
                console.log('üåê Circulatory page received global parameters changed:', event.detail);
                console.log('üåê Current global variables - HR:', window.HR_MIN, '-', window.HR_MAX, 'BP:', window.BP_MIN, '-', window.BP_MAX);
                console.log('üåê Slider availability - hrSlider:', !!hrSlider, 'bpSlider:', !!bpSlider);
                
                // ROBUST APPROACH: Force complete slider refresh from global variables
                if (hrSlider && hrSlider.config && hrSlider.config.targetRange) {
                    console.log('üîÑ Updating HR slider config and position...');
                    console.log('   - Old HR range:', hrSlider.config.targetRange.min, '-', hrSlider.config.targetRange.max);
                    hrSlider.config.targetRange.min = window.HR_MIN;
                    hrSlider.config.targetRange.max = window.HR_MAX;
                    hrSlider.currentMin = window.HR_MIN;
                    hrSlider.currentMax = window.HR_MAX;
                    if (hrSlider.updateSliderPosition) {
                        hrSlider.updateSliderPosition();
                    }
                    console.log('‚úÖ HR slider forced to:', window.HR_MIN, '-', window.HR_MAX);
                } else {
                    console.log('‚ùå HR slider not available or not properly initialized');
                }
                
                if (bpSlider && bpSlider.config && bpSlider.config.targetRange) {
                    console.log('üîÑ Updating BP slider config and position...');
                    console.log('   - Old BP range:', bpSlider.config.targetRange.min, '-', bpSlider.config.targetRange.max);
                    bpSlider.config.targetRange.min = window.BP_MIN;
                    bpSlider.config.targetRange.max = window.BP_MAX;
                    bpSlider.currentMin = window.BP_MIN;
                    bpSlider.currentMax = window.BP_MAX;
                    if (bpSlider.updateSliderPosition) {
                        bpSlider.updateSliderPosition();
                    }
                    console.log('‚úÖ BP slider forced to:', window.BP_MIN, '-', window.BP_MAX);
                } else {
                    console.log('‚ùå BP slider not available or not properly initialized');
                }
            });

            
            // Function to force update HR slider with global HR_low and HR_high values
            function updateHRSliderFromGlobalValues() {
                if (typeof window.HR_low !== 'undefined' && typeof window.HR_high !== 'undefined') {
                    console.log('üîÑ Forcing HR slider update with global values:', window.HR_low, '-', window.HR_high);
                    
                    if (hrSlider && hrSlider.container) {
                        // Method 1: Use updateConfig if available (preferred method)
                        if (typeof hrSlider.updateConfig === 'function') {
                            hrSlider.updateConfig({
                                targetRange: {
                                    min: window.HR_MIN,
                                    max: window.HR_MAX
                                }
                            });
                            console.log('‚úÖ HR slider updated via updateConfig method');
                        } else {
                            // Method 2: Direct property manipulation + position update
                            hrSlider.currentMin = window.HR_low;
                            hrSlider.currentMax = window.HR_high;
                            
                            // Safely update config if it exists
                            if (hrSlider.config && hrSlider.config.targetRange) {
                                hrSlider.config.targetRange.min = window.HR_low;
                                hrSlider.config.targetRange.max = window.HR_high;
                            }
                            
                            // Update the visual elements directly
                            const maxValueElement = hrSlider.container.querySelector('.sliding-value-outside.max-value');
                            const minValueElement = hrSlider.container.querySelector('.sliding-value-outside.min-value');
                            if (maxValueElement) maxValueElement.textContent = Math.round(window.HR_high);
                            if (minValueElement) minValueElement.textContent = Math.round(window.HR_low);
                            
                            // Update slider positions
                            if (typeof hrSlider.updateSliderPosition === 'function') {
                                hrSlider.updateSliderPosition();
                            }
                            
                            console.log('‚úÖ HR slider updated via direct manipulation');
                        }
                        
                        // Force a timeout to ensure DOM updates are processed
                        setTimeout(() => {
                            // Double-check that the visual values are updated
                            const maxValueElement = hrSlider.container.querySelector('.sliding-value-outside.max-value');
                            const minValueElement = hrSlider.container.querySelector('.sliding-value-outside.min-value');
                            if (maxValueElement && maxValueElement.textContent != Math.round(window.HR_high)) {
                                maxValueElement.textContent = Math.round(window.HR_high);
                            }
                            if (minValueElement && minValueElement.textContent != Math.round(window.HR_low)) {
                                minValueElement.textContent = Math.round(window.HR_low);
                            }
                            console.log('üîÑ Verified HR slider visual update:', window.HR_low, '-', window.HR_high);
                        }, 100);
                        
                    } else {
                        console.warn('‚ö†Ô∏è HR slider not available for global update');
                    }
                } else {
                    console.warn('‚ö†Ô∏è Global HR_low or HR_high not available');
                }
            }
            
            // Test function to force sepsis range (90-130) - for debugging
            function testSepsisRange() {
                window.HR_low = 90;
                window.HR_high = 130;
                console.log('üß™ TEST: Set globals to sepsis range 90-130');
                updateHRSliderFromGlobalValues();
            }
            
            // Function to refresh sliders from current target ranges
            function refreshSlidersFromTargetRanges() {
                if (currentPatientId && window.sharedDataManager) {
                    const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                    console.log('üîÑ Refreshing sliders from target ranges:', targetRanges);
                    
                    if (targetRanges) {
                        // Update global values for HR
                        if (targetRanges.HR) {
                            window.HR_low = targetRanges.HR.min;
                            window.HR_high = targetRanges.HR.max;
                            updateHRSliderFromGlobalValues();
                        }
                        
                        // Update BP slider if available (similar logic)
                        if (targetRanges.BP_Mean && bpSlider && bpSlider.container) {
                            window.BP_low = targetRanges.BP_Mean.min;
                            window.BP_high = targetRanges.BP_Mean.max;
                            
                            if (typeof bpSlider.updateConfig === 'function') {
                                bpSlider.updateConfig({
                                    targetRange: {
                                        min: window.BP_MIN,
                                        max: window.BP_MAX
                                    }
                                });
                                console.log('‚úÖ BP slider updated from target ranges:', window.BP_MIN, '-', window.BP_MAX);
                            }
                        }
                        
                        console.log('‚úÖ Sliders refreshed from target ranges');
                    }
                }
            }
            
            // Make test function available globally for debugging
            window.testSepsisRange = testSepsisRange;
            
            
            // Listen for HR range changes from sepsis selection/deselection
            window.addEventListener('hrRangesChanged', function(event) {
                console.log('üíì HR ranges changed event received in circulatoir-settings:', event.detail);
                
                const { patientId, HR_low, HR_high, BP_low, BP_high, source } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    console.log('üîÑ Updating HR slider with new ranges:', HR_low, '-', HR_high, 'source:', source);
                    
                    // Update currentSettings
                    currentSettings.hr = {
                        min: HR_low,
                        max: HR_high
                    };
                    
                    // Update BP settings if BP ranges are provided
                    if (typeof BP_low !== 'undefined' && typeof BP_high !== 'undefined') {
                        console.log('ü©∏ Updating BP slider with new ranges:', BP_low, '-', BP_high, 'source:', source);
                        currentSettings.bp = {
                            min: BP_low,
                            max: BP_high
                        };
                        
                        // Update BP slider if it exists
                        if (bpSlider && typeof bpSlider.updateConfig === 'function') {
                            bpSlider.updateConfig({
                                targetRange: {
                                    min: window.BP_MIN,
                                    max: window.BP_MAX
                                }
                            });
                            console.log('‚úÖ BP slider updated with new ranges');
                        }
                    }
                    
                    // Force update HR slider using global values
                    updateHRSliderFromGlobalValues();
                }
            });
            
            // Set up circulatory tag button listeners
            const circulatoryTagButtons = document.querySelectorAll('.circulatory-tag');
            circulatoryTagButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tagCondition = this.dataset.condition;
                    
                    if (this.classList.contains('selected')) {
                        // Deselect tag
                        this.classList.remove('selected');
                        
                        // Handle sepsis deselection using new condition state system
                        if (tagCondition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.setPatientConditionState('sepsis', {
                                isActive: false,
                                patientId: currentPatientId,
                                timestamp: Date.now(),
                                source: 'circulatory-settings'
                            });
                            
                            // Restore previous HR and BP ranges from shared data manager
                            if (window.sharedDataManager.restorePreviousHRRanges) {
                                window.sharedDataManager.restorePreviousHRRanges(currentPatientId);
                            }
                            if (window.sharedDataManager.restorePreviousBPRanges) {
                                window.sharedDataManager.restorePreviousBPRanges(currentPatientId);
                            }
                            
                            // Get the restored ranges and save them to circulatory settings
                            setTimeout(() => {
                                const restoredTargetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                                if (restoredTargetRanges && restoredTargetRanges.HR && restoredTargetRanges.BP_Mean) {
                                    const existingCirculatorySettings = window.sharedDataManager.getPatientCirculatoirSettings(currentPatientId) || {};
                                    const newCirculatorySettings = {
                                        ...existingCirculatorySettings,
                                        hr: { min: restoredTargetRanges.HR.min, max: restoredTargetRanges.HR.max },
                                        bp: { min: restoredTargetRanges.BP_Mean.min, max: restoredTargetRanges.BP_Mean.max }
                                    };
                                    
                                    // Save the restored HR and BP ranges automatically
                                    window.sharedDataManager.savePatientCirculatoirSettings(currentPatientId, newCirculatorySettings);
                                    console.log('ü¶† Sepsis deselected on circulatory page - restored HR & BP ranges automatically saved:', newCirculatorySettings);
                                    
                                    // Refresh sliders to show the restored ranges
                                    setTimeout(() => {
                                        refreshSlidersFromTargetRanges();
                                    }, 50);
                                }
                            }, 100); // Small delay to ensure restoration is complete
                            
                            console.log('ü¶† Sepsis deselected and previous HR & BP ranges restored');
                        }
                    } else {
                        // Select tag
                        this.classList.add('selected');
                        
                        // Handle sepsis selection using new condition state system
                        if (tagCondition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.setPatientConditionState('sepsis', {
                                isActive: true,
                                patientId: currentPatientId,
                                timestamp: Date.now(),
                                source: 'circulatory-settings'
                            });
                            
                            // Automatically save the sepsis HR and BP ranges
                            const sepsisHRRanges = { min: 90, max: 130 };
                            const sepsisBPRanges = { min: 65, max: 85 };
                            const existingCirculatorySettings = window.sharedDataManager.getPatientCirculatoirSettings(currentPatientId) || {};
                            const newCirculatorySettings = {
                                ...existingCirculatorySettings,
                                hr: sepsisHRRanges,
                                bp: sepsisBPRanges
                            };
                            
                            // Save the HR and BP ranges automatically
                            window.sharedDataManager.savePatientCirculatoirSettings(currentPatientId, newCirculatorySettings);
                            
                            // Update target ranges as well
                            const existingTargetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId) || {};
                            const updatedTargetRanges = {
                                ...existingTargetRanges,
                                HR: { min: 90, max: 130, unit: 'bpm' },
                                BP_Mean: { min: 65, max: 85, unit: 'mmHg' }
                            };
                            window.sharedDataManager.setPatientTargetRanges(currentPatientId, updatedTargetRanges);
                            
                            console.log('ü¶† Sepsis selected and HR (90-130) & BP (65-85) ranges automatically saved');
                        }
                    }
                });
            });
            
            // Listen for sepsis state changes from other pages to update our button
            window.addEventListener('hrRangesChanged', function(event) {
                console.log('üíì Updating circulatory tag state from external change:', event.detail);
                
                const { patientId, source } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    const sepsisButton = document.querySelector('.circulatory-tag[data-condition="sepsis"]');
                    if (sepsisButton) {
                        if (source === 'sepsis') {
                            sepsisButton.classList.add('selected');
                            console.log('‚úÖ Marked sepsis button as selected due to external selection');
                        } else if (source === 'restore') {
                            sepsisButton.classList.remove('selected');
                            console.log('‚úÖ Marked sepsis button as deselected due to external deselection');
                        }
                    }
                }
            });

            // Listen for condition state changes from other pages
            window.addEventListener('patientConditionStateChanged', function(event) {
                console.log('ü¶† Condition state changed event received:', event.detail);
                
                const { condition, state } = event.detail;
                
                // Only update if it's for sepsis and the current patient
                if (condition === 'sepsis' && state.patientId === currentPatientId) {
                    const sepsisButton = document.querySelector('.circulatory-tag[data-condition="sepsis"]');
                    if (sepsisButton) {
                        if (state.isActive) {
                            if (!sepsisButton.classList.contains('selected')) {
                                sepsisButton.classList.add('selected');
                                console.log('‚úÖ Marked sepsis button as selected due to external condition change');
                            }
                        } else {
                            if (sepsisButton.classList.contains('selected')) {
                                sepsisButton.classList.remove('selected');
                                console.log('‚úÖ Marked sepsis button as deselected due to external condition change');
                            }
                        }
                    }
                }
            });
            
            // Event listeners are now handled by the slider components
        }
        



        function initializeSliders() {
            console.log('üéõÔ∏è Initializing interactive sliders...');
            
            // Debug: Check if containers exist
            const hrContainer = document.getElementById('hr-slider-container');
            const bpContainer = document.getElementById('bp-slider-container');
            console.log('HR Container found:', !!hrContainer);
            console.log('BP Container found:', !!bpContainer);
            
            // Check if slider components are loaded
            console.log('VitalParameterSlider available:', !!window.VitalParameterSlider);
            console.log('PatientConfigurationHelper available:', !!window.PatientConfigurationHelper);
            console.log('SharedDataManager available:', !!window.sharedDataManager);
            
            if (!window.VitalParameterSlider) {
                console.error('‚ùå VitalParameterSlider class not found');
                if (hrContainer) hrContainer.innerHTML = '<p style="color: red;">Slider component not loaded - VitalParameterSlider missing</p>';
                return;
            }
            
            if (!window.PatientConfigurationHelper) {
                console.error('‚ùå PatientConfigurationHelper class not found');
                if (bpContainer) bpContainer.innerHTML = '<p style="color: red;">Slider component not loaded - PatientConfigurationHelper missing</p>';
                return;
            }
            
            if (!currentPatientId) {
                console.error('‚ùå No patient ID available for sliders');
                if (hrContainer) hrContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                if (bpContainer) bpContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                return;
            }
            
            console.log('‚úÖ All prerequisites met, creating sliders for patient:', currentPatientId);
            
            try {
                // Debug: Check what data we have
                console.log('Current patient ID:', currentPatientId);
                const patientInfo = window.sharedDataManager ? window.sharedDataManager.getPatientInfo(currentPatientId) : null;
                const patientSettings = window.sharedDataManager ? window.sharedDataManager.getPatientCirculatoirSettings(currentPatientId) : null;
                console.log('Patient info:', patientInfo);
                console.log('Patient settings:', patientSettings);
                
                // Initialize HR Slider with direct approach
                const hrContainer = document.getElementById('hr-slider-container');
                if (hrContainer) {
                    console.log('ü´Ä Creating HR slider...');
                    hrContainer.innerHTML = '<p style="color: blue;">Loading HR slider...</p>';
                    
                    try {
                        // Try direct instantiation first
                        hrSlider = new window.VitalParameterSlider(hrContainer, {
                            parameter: 'HR',
                            name: 'HR',
                            unit: 'bpm',
                            targetRange: { min: window.HR_MIN, max: window.HR_MAX },
                            yAxis: { min: 40, max: 140, step: 20 },
                            monitoringLevel: 'mid',
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Pati√´nt ${currentPatientId}`,
                            onChange: (data) => {
                                console.log('HR Slider changed:', data);
                                if (data.type === 'save') {
                                    console.log('üíæ HR Slider SAVE - SIMPLE UPDATE of global variables');
                                    
                                    // SIMPLE APPROACH: Direct update of global variables
                                    window.HR_MIN = Math.round(data.min);
                                    window.HR_MAX = Math.round(data.max);
                                    
                                    // Save to localStorage
                                    if (window.sharedDataManager) {
                                        window.sharedDataManager.saveGlobalParameterVariables();
                                        console.log('üíæ Saved global variables to localStorage');
                                    }
                                    
                                    // Update all displays on all pages immediately
                                    console.log('üîÑ Updating displays across all pages...');
                                    // Update displays on this page
                                    setTimeout(() => {
                                        // Trigger display updates on other pages by dispatching a simple event
                                        window.dispatchEvent(new CustomEvent('globalParametersChanged', {
                                            detail: { parameter: 'HR', min: window.HR_MIN, max: window.HR_MAX }
                                        }));
                                    }, 10);
                                    
                                    console.log('‚úÖ HR global variables updated:', window.HR_MIN, '-', window.HR_MAX);
                                }
                            }
                        });
                        
                        if (hrSlider) {
                            console.log('‚úÖ HR Slider initialized successfully');
                            // Always sync sliders with current target ranges after initialization
                            setTimeout(() => {
                                if (currentPatientId && window.sharedDataManager) {
                                    const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                                    if (targetRanges && targetRanges.HR) {
                                        console.log('üîÑ Initializing slider with current target ranges:', targetRanges.HR.min, '-', targetRanges.HR.max);
                                        // Set global values - slider will automatically use these
                                        window.HR_MIN = targetRanges.HR.min;
                                        window.HR_MAX = targetRanges.HR.max;
                                        console.log('‚úÖ Global HR values set:', window.HR_MIN, '-', window.HR_MAX);
                                    }
                                } else {
                                    // Fallback to existing global values
                                    updateHRSliderFromGlobalValues();
                                }
                            }, 100);
                        } else {
                            console.error('‚ùå HR Slider initialization returned null');
                            hrContainer.innerHTML = '<p style="color: red;">HR Slider initialization returned null</p>';
                        }
                    } catch (error) {
                        console.error('‚ùå HR Slider creation error:', error);
                        hrContainer.innerHTML = `<p style="color: red;">HR Slider error: ${error.message}</p>`;
                    }
                }
                
                // Initialize BP Slider with direct approach
                const bpContainer = document.getElementById('bp-slider-container');
                if (bpContainer) {
                    console.log('ü©∏ Creating BP slider...');
                    bpContainer.innerHTML = '<p style="color: blue;">Loading BP slider...</p>';
                    
                    try {
                        // Try direct instantiation
                        bpSlider = new window.VitalParameterSlider(bpContainer, {
                            parameter: 'BP_Mean',
                            name: 'BP Mean',
                            unit: 'mmHg',
                            targetRange: { min: window.BP_MIN, max: window.BP_MAX },
                            yAxis: { min: 30, max: 100, step: 10 },
                            monitoringLevel: 'mid',
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Pati√´nt ${currentPatientId}`,
                            onChange: (data) => {
                                console.log('BP Slider changed:', data);
                                if (data.type === 'save') {
                                    console.log('üíæ BP Slider SAVE - SIMPLE UPDATE of global variables');
                                    
                                    // SIMPLE APPROACH: Direct update of global variables
                                    window.BP_MIN = Math.round(data.min);
                                    window.BP_MAX = Math.round(data.max);
                                    
                                    // Save to localStorage
                                    if (window.sharedDataManager) {
                                        window.sharedDataManager.saveGlobalParameterVariables();
                                        console.log('üíæ Saved global variables to localStorage');
                                    }
                                    
                                    // Update all displays on all pages immediately
                                    console.log('üîÑ Updating displays across all pages...');
                                    setTimeout(() => {
                                        window.dispatchEvent(new CustomEvent('globalParametersChanged', {
                                            detail: { parameter: 'BP_Mean', min: window.BP_MIN, max: window.BP_MAX }
                                        }));
                                    }, 10);
                                    
                                    console.log('‚úÖ BP global variables updated:', window.BP_MIN, '-', window.BP_MAX);
                                }
                            }
                        });
                        
                        if (bpSlider) {
                            console.log('‚úÖ BP Slider initialized successfully');
                        } else {
                            console.error('‚ùå BP Slider initialization returned null');
                            bpContainer.innerHTML = '<p style="color: red;">BP Slider initialization returned null</p>';
                        }
                    } catch (error) {
                        console.error('‚ùå BP Slider creation error:', error);
                        bpContainer.innerHTML = `<p style="color: red;">BP Slider error: ${error.message}</p>`;
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error initializing sliders:', error);
                document.getElementById('hr-slider-container').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                document.getElementById('bp-slider-container').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // Legacy functions removed - functionality now handled by slider components

        function goBackToAlarmOverview() {
            console.log('üîô Navigating back to alarm overview');
            
            // Ensure session data is preserved when going back
            if (currentPatientId && currentBed && window.sharedDataManager) {
                // Update session data to maintain patient context
                window.sharedDataManager.saveSessionData({
                    currentPatient: currentPatientId,
                    currentBed: currentBed,
                    lastUpdated: new Date().toISOString()
                });
                
                console.log('‚úÖ Session data preserved for patient:', currentPatientId, 'bed:', currentBed);
                
                // Navigate back to alarm overview with proper URL parameters
                const alarmUrl = `alarm-overview.html?bed=${currentBed}&patient=${currentPatientId}`;
                console.log('üîó Navigating to:', alarmUrl);
                window.location.href = alarmUrl;
            } else {
                console.warn('‚ö†Ô∏è Missing patient or bed data, redirecting to bed overview');
                window.location.href = 'index.html';
            }
        }

        function goToRespiratoir() {
            console.log('‚û°Ô∏è Navigating to respiratoir settings');
            
            // Ensure session data is preserved when going to respiratoir
            if (currentPatientId && currentBed && window.sharedDataManager) {
                // Update session data to maintain patient context
                window.sharedDataManager.saveSessionData({
                    selectedBed: currentBed,
                    patientId: currentPatientId,
                    previousPage: 'circulatoir-settings'
                });
                
                console.log('‚úÖ Session data preserved for patient:', currentPatientId, 'bed:', currentBed);
                
                // Navigate to respiratory settings with proper URL parameters
                const respiratoryUrl = `respiratory-settings.html?bed=${currentBed}&patient=${currentPatientId}`;
                console.log('üîó Navigating to:', respiratoryUrl);
                window.location.href = respiratoryUrl;
            } else {
                console.warn('‚ö†Ô∏è Missing patient or bed data, redirecting to bed overview');
                window.location.href = 'index.html';
            }
        }

        function goToBedOverview() {
            console.log('üè† Navigating to bed overview');
            
            // Clear current patient context since we're going back to the overview
            if (window.sharedDataManager) {
                window.sharedDataManager.saveSessionData({
                    selectedBed: null,
                    patientId: null,
                    previousPage: 'circulatoir-settings'
                });
                console.log('‚úÖ Session data cleared for bed overview navigation');
            }
            
            // Navigate to bed overview
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
