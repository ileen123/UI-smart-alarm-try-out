<!DOCTYPE html>
<html lang="nl">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title that appears in browser tab -->
    <title>Circulatoir Instellingen</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="slider-component.css">
    
    <!-- Data Manager for cross-page data synchronization -->
    <script src="js/data-manager.js"></script>
    <script src="js/shared-data-manager.js"></script>
    
    <!-- Slider Component -->
    <script src="slider-component.js"></script>
    
    <!-- Heart Circle Component -->
    <script src="heart-circle-component.js"></script>
</head>
<body>
    <!-- Patient information header section -->
    <div class="header">
        <span class="user-icon">üë§</span>
        <span id="patient-header-info">Loading patient info...</span>
    </div>
    
    <!-- Navigation section with back button -->
    <div class="navigation-section">
        <button class="nav-button back-button" onclick="goBackToAlarmOverview()">
            ‚Üê Terug naar Alarm Overzicht
        </button>
    </div>
    
    <!-- Main page title -->
    <h1 class="main-title">Circulatoir Instellingen</h1>
    <p class="subtitle">Pas de hart- en bloeddruk parameters aan voor deze pati√´nt</p>
    
    <!-- Main content container -->
    <div class="circulatoir-settings-container">
        
        <!-- Monitoring Level Controls -->
        <div class="monitoring-level-controls">
            <h2 class="section-title">Monitoring Level Circulatoir</h2>
            <p class="monitoring-description">Kies de monitoring intensiteit voor de visuele weergave:</p>
            
            <!-- Container for buttons, heart circle, and additional info -->
            <div class="monitoring-controls-layout">
                <div class="monitoring-buttons" style="flex: none;">
                    <h3 class="info-title">Selecteer monitoring niveau:</h3>
                    <div class="button-group">
                        <button class="btn risk-low" data-level="loose" onclick="changeMonitoringLevel('loose')">Los</button>
                        <button class="btn risk-med selected" data-level="mid" onclick="changeMonitoringLevel('mid')">Mid</button>
                        <button class="btn risk-high" data-level="tight" onclick="changeMonitoringLevel('tight')">Strak</button>
                    </div>
                </div>
                <div class="heart-circle-section">
                    <h3 class="info-title">Huidige staat circulatoir:</h3>
                    <div id="circulatoir-heart-circle-container"></div>
                </div>
                
                <!-- Additional Circulatory Information Container -->
                <div class="additional-circulatory-info">
                    <h3 class="info-title">Selecteer eventueel additionele informatie:</h3>
                    <div class="circulatory-tags-section">
                        <button class="btn tag-btn circulatory-tag" data-condition="sepsis">Sepsis ‚öôÔ∏è</button>
                        <button class="circulatory-more-btn">‚ãØ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Interactive Slider Demo Section -->
        <div class="slider-demo-section">
            <h2 class="section-title">Circulatoire Parameters Aanpassen</h2>
            
            
            <!-- Direct slider containers without extra wrappers -->
            <div class="sliders-layout">
                <div id="hr-slider-container" class="individual-slider"></div>
                <div id="bp-slider-container" class="individual-slider"></div>
            </div>
        </div>
    </div>

    <style>
        /* Monitoring Level Controls - matching risk level button styling */
        .monitoring-level-controls {
            margin: 30px 0;
            text-align: left; /* Changed from center to left */
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .monitoring-level-controls .section-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: left; /* Ensure title is also left-aligned */
        }
        
        .monitoring-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: left; /* Changed from default to explicitly left */
        }
        
        /* Layout for monitoring controls and heart circle - horizontal sections */
        .monitoring-controls-layout {
            display: flex;
            gap: 30px;
            margin-top: 20px;
            margin-bottom: 40px;
            align-items: flex-start;
            width: 100%;
            position: relative;
        }
        
        .monitoring-buttons {
            flex: 1;
            background: white;
            padding: 0px 20px 25px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 200px;
            max-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
    /* .heart-circle-wrapper removed */
        
        .heart-circle-section {
            flex: 1;
            background: white;
            padding: 0px 20px 25px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 180px;
            max-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow: hidden;
            position: relative;
        }
        
        .heart-circle-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }
        
        #circulatoir-heart-circle-container {
            width: 220px;
            height: 220px;
            max-width: 100%;
            max-height: 260px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding-top: 12px;
        }
        .heart-organ-circle {
            opacity: 1 !important;
            position: relative !important;
        }
        
        /* Additional Circulatory Information Container - matches alarm overview form-section */
        .additional-circulatory-info {
            flex: 1;
            background: white;
            padding: 0px 20px 25px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 200px;
            max-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        /* General info-title styling for all containers */
        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #007bff;
            margin: 0;
            margin-bottom: 15px;
            text-align: left;
            position: relative;
            z-index: 2;
        }
        
        .additional-circulatory-info .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #007bff;
            margin: 0;
            margin-bottom: 15px;
            text-align: left;
        }
        
        .circulatory-tags-section {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            width: 100%;
        }
        
        .circulatory-tag {
            padding: 6px 12px;
            border-radius: 20px;
            background-color: #bbdefb;
            border: 2px solid #90caf9;
            color: #1976d2;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            width: auto;
        }
        
        .circulatory-tag:hover {
            background: #90caf9;
            border-color: #64b5f6;
        }
        
        .circulatory-tag.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: 600;
        }
        
        .circulatory-more-btn {
            background-color: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Slider containers and titles */
        .slider-demo-section {
            margin: 40px 0;
            max-width: 1600px; /* Much wider container */
            margin-left: auto;
            margin-right: auto;
            padding: 0 20px;
        }
        
        .slider-demo-section .section-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .demo-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .sliders-layout {
            display: flex;
            gap: 120px; /* Very large gap to ensure no overlap */
            justify-content: center;
            flex-wrap: nowrap; /* Force horizontal layout, no wrapping */
            margin: 0 auto;
            align-items: flex-start; /* Align sliders at the top */
        }
        
        .individual-slider {
            flex: 0 0 auto; /* Don't grow or shrink, use natural size */
            min-width: 500px; /* Ensure enough space for each slider */
            max-width: 600px; /* Prevent sliders from getting too wide */
        }
        .navigation-section {
            margin: 20px 0;
            padding: 0 20px;
        }
        
        .nav-button {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-2px);
        }
        
        .subtitle {
            text-align: left; /* Changed from center to left */
            color: #6c757d;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: 400;
        }
        
        .circulatoir-settings-container {
            max-width: 1600px; /* Much wider to accommodate side-by-side sliders */
            margin: 0 auto;
            padding: 20px;
        }
        
        .parameter-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .parameter-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }
        
        .heart-icon, .bp-icon {
            font-size: 32px;
        }
        
        .range-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .current-range {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .range-status {
            font-size: 14px;
            color: #28a745;
            font-weight: 500;
        }
        
        .adjustment-controls {
            margin-bottom: 20px;
        }
        
        .range-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .range-input-group label {
            font-weight: 600;
            color: #495057;
            flex: 1;
        }
        
        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-with-unit input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }
        
        .input-with-unit input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        .unit {
            font-weight: 600;
            color: #6c757d;
            min-width: 50px;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background-color: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .preset-btn:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 40px 0;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .reset-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .reset-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .save-btn {
            background-color: #28a745;
            color: white;
        }
        
        .save-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .settings-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #dee2e6;
        }
        
        .settings-preview h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
            text-align: center;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .preview-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .preview-label {
            font-weight: 600;
            color: #495057;
        }
        
        .preview-value {
            font-weight: 600;
            color: #007bff;
            font-size: 16px;
        }
        
        /* Slider Demo Section Styles */
        .slider-demo-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            border: 2px solid #dee2e6;
        }
        
        .slider-demo-section h3 {
            color: #2c3e50;
            font-size: 22px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .demo-description {
            text-align: center;
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .slider-containers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .slider-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }
        
        .slider-container h4 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .slider-container > div {
            min-height: 300px;
        }
        
        /* Monitoring Level Controls */
        .monitoring-level-controls {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .monitoring-level-controls h4 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .monitoring-description {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .level-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .level-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .level-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-2px);
        }
        
        .level-btn.active {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .level-btn strong {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .level-btn span {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .circulatoir-settings-container {
                padding: 10px;
            }
            
            .parameter-section {
                padding: 20px;
            }
            
            .range-input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .preset-buttons {
                justify-content: center;
            }
        }
    </style>

    <script>
        // Global variables
        let currentPatientId = null;
        let currentBed = null;
        let currentSettings = {
            hr: { min: 70, max: 110 },
            bp: { min: 65, max: 85 }
        };
        
        // Store slider references for monitoring level changes
        let hrSlider = null;
        let bpSlider = null;

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
            initializeSepsisTagState(); // Initialize sepsis state FIRST
            loadCurrentSettings(); // Then load settings (which will respect sepsis state)

            // Initialize heart circle component (same as alarm overview)
            setTimeout(() => {
                initializeHeartCircleComponent();
                initializeSliders();
                
                // Check if sepsis is active and force slider update after everything is loaded
                setTimeout(() => {
                    if (currentPatientId && window.sharedDataManager) {
                        const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                        console.log('üîç Checking target ranges on page load:', targetRanges);
                        if (targetRanges && targetRanges.HR && targetRanges.HR.min === 90 && targetRanges.HR.max === 130) {
                            console.log('ü¶† SEPSIS DETECTED ON PAGE LOAD - forcing slider to 90-130');
                            testSepsisRange();
                        }
                    }
                }, 500);
            }, 1000);
        // Heart SVG content (copied from alarm overview)
        const svgContent = {
            heart: `<svg class="organ-icon" viewBox="0 0 22 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.22 10.3743C12.0679 12.132 10.9163 15.0615 10.9163 19.1628M13.22 10.3743C12.0681 12.132 11.4922 14.4756 6.30842 14.4756M13.22 10.3743C14.6766 8.39884 16.9516 6.83964 19.3552 6.3986C20.0557 6.27006 20.6011 5.62288 20.4841 4.90863L20.2921 3.73684C20.1996 3.17181 19.7182 2.75127 19.159 2.81881C16.3987 3.15222 12.9705 4.8327 10.9162 7.44486C10.9162 6.27307 10.9162 2.75769 10.3402 1M5.73245 6.85896C5.15648 5.10127 4.00454 3.92948 2.27663 3.92948M1.70071 15.6441C2.85258 20.9171 7.26892 25 10.3401 25C13.4113 25 17.6365 20.9175 18.9799 15.6441C20.3232 10.3707 16.1 6.85563 13.2201 10.371C13.2201 8.61732 11.4922 6.85906 8.03639 6.85906C4.58057 6.85906 0.548838 10.371 1.70071 15.6441Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`
        };

        // Utility to inject SVG content into the heart circle
        function injectSVG(containerId, svgType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const iconDiv = container.querySelector('.heart-white-center');
            if (iconDiv) {
                iconDiv.innerHTML = svgContent[svgType];
                const svgEl = iconDiv.querySelector('svg');
                if (svgEl) {
                    svgEl.style.width = '70%';
                    svgEl.style.height = '70%';
                    svgEl.style.display = 'block';
                    svgEl.style.margin = '0 auto';
                }
            } else {
                setTimeout(() => injectSVG(containerId, svgType), 50);
            }
        }

        // Initialize the heart circle component in circulatoir settings
        function initializeHeartCircleComponent() {
            // Use same size as alarm overview
            const circleSize = 130;
            
            // Get current monitoring level from SharedDataManager
            let initialLevel = 'mid';
            if (currentPatientId && window.sharedDataManager) {
                initialLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                console.log(`Loading heart monitoring level for patient ${currentPatientId}:`, initialLevel);
            }
            
            window.circulatoirHeartCircle = new HeartCircleComponent('circulatoir-heart-circle-container', { 
                size: circleSize, 
                initialState: initialLevel 
            });
            setTimeout(() => injectSVG('circulatoir-heart-circle-container', 'heart'), 100);
            
            // Map heart circle levels to button levels for initial setup
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight'
            };
            
            const buttonLevel = levelMapping[initialLevel] || 'mid';
            
            // Update button states to match loaded level
            updateButtonStates(buttonLevel);
            
            // Update sliders to match loaded level (wait for sliders to be initialized)
            setTimeout(() => {
                updateSlidersMonitoringLevel(buttonLevel);
            }, 1500); // Wait for sliders to be fully initialized
            
            // Listen for global heart monitoring level changes
            document.addEventListener('heartMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                if (patientId === currentPatientId) {
                    console.log(`Received heart monitoring level change for patient ${patientId}:`, level);
                    if (window.circulatoirHeartCircle) {
                        window.circulatoirHeartCircle.setRiskLevel(level);
                    }
                    
                    const buttonLevel = levelMapping[level] || 'mid';
                    updateButtonStates(buttonLevel);
                    updateSlidersMonitoringLevel(buttonLevel);
                }
            });
        }
        
        // Helper function to update button states
        function updateButtonStates(level) {
            // Map heart circle levels back to button levels
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight',
                'loose': 'loose',  // fallback mappings
                'tight': 'tight'
            };
            
            const mappedLevel = levelMapping[level] || level;
            console.log(`Updating button states: ${level} ‚Üí ${mappedLevel}`);
            
            // Update button states
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            const selectedButton = document.querySelector(`[data-level="${mappedLevel}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`‚úÖ Button ${mappedLevel} selected in updateButtonStates`);
            } else {
                console.warn(`‚ùå Button with data-level="${mappedLevel}" not found`);
            }
        }
        });

        // Helper function to update sliders monitoring level (moved outside closure for global access)
        function updateSlidersMonitoringLevel(level) {
            console.log(`üéõÔ∏è Updating sliders monitoring level to: ${level}`);
            console.log('üîç DEBUG - hrSlider exists:', !!hrSlider);
            console.log('üîç DEBUG - bpSlider exists:', !!bpSlider);
            
            if (hrSlider) {
                console.log('üîç DEBUG - hrSlider type:', typeof hrSlider);
                console.log('üîç DEBUG - hrSlider.updateMonitoringLevel exists:', typeof hrSlider.updateMonitoringLevel);
            }
            
            // Update HR slider if it exists
            if (hrSlider && typeof hrSlider.updateMonitoringLevel === 'function') {
                console.log('üéõÔ∏è Calling hrSlider.updateMonitoringLevel with:', level);
                hrSlider.updateMonitoringLevel(level);
                console.log('‚úÖ HR slider monitoring level updated to:', level);
            } else {
                console.warn('‚ùå HR slider not found or updateMonitoringLevel method not available');
                console.warn('‚ùå hrSlider:', hrSlider);
                if (hrSlider) {
                    console.warn('‚ùå Available methods:', Object.getOwnPropertyNames(hrSlider));
                }
            }
            
            // Update BP slider if it exists
            if (bpSlider && typeof bpSlider.updateMonitoringLevel === 'function') {
                console.log('üéõÔ∏è Calling bpSlider.updateMonitoringLevel with:', level);
                bpSlider.updateMonitoringLevel(level);
                console.log('‚úÖ BP slider monitoring level updated to:', level);
            } else {
                console.warn('‚ùå BP slider not found or updateMonitoringLevel method not available');
                console.warn('‚ùå bpSlider:', bpSlider);
                if (bpSlider) {
                    console.warn('‚ùå Available methods:', Object.getOwnPropertyNames(bpSlider));
                }
            }
        }

        // Function to change monitoring level for all sliders
        function changeMonitoringLevel(level) {
            console.log(`üîÑ Changing monitoring level to: ${level}`);
            
            // Map button levels to heart circle levels
            const levelMapping = {
                'loose': 'low',
                'mid': 'mid',
                'tight': 'high'
            };
            
            const heartLevel = levelMapping[level] || level;
            console.log(`Mapped ${level} to heart level: ${heartLevel}`);
            
            // Update button states - remove active/selected from all buttons
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            // Add selected class to the clicked button
            const selectedButton = document.querySelector(`[data-level="${level}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`‚úÖ Button ${level} selected`);
            }
            
            // Update heart circle if it exists
            if (window.circulatoirHeartCircle) {
                console.log(`ü´Ä Updating heart circle to: ${heartLevel}`);
                window.circulatoirHeartCircle.setRiskLevel(heartLevel);
            } else {
                console.warn('‚ùå circulatoirHeartCircle not found');
            }
            
            // Save to SharedDataManager for global sync
            if (currentPatientId && window.sharedDataManager) {
                window.sharedDataManager.updateGlobalHeartMonitoringLevel(currentPatientId, heartLevel);
                console.log(`‚úÖ Saved heart level ${heartLevel} for patient ${currentPatientId}`);
                
                // Mark this as a recent manual change to prioritize it over calculated values
                sessionStorage.setItem('recentHeartLevelChange', Date.now().toString());
            }
            
            // Update sliders if they exist
            updateSlidersMonitoringLevel(level);
            
            console.log(`‚úÖ Monitoring level changed to: ${level} (heart: ${heartLevel})`);
        }

        function initializePage() {
            console.log('üîÑ Initializing circulatoir settings page...');
            
            // Try to get patient and session data from multiple sources
            if (window.sharedDataManager) {
                // First, try to get from URL parameters (if navigated directly)
                const urlParams = new URLSearchParams(window.location.search);
                const urlPatient = urlParams.get('patient');
                const urlBed = urlParams.get('bed');
                
                // Second, try to get from session data
                const sessionData = window.sharedDataManager.getSessionData();
                
                // Use URL parameters if available, otherwise use session data
                currentPatientId = urlPatient || sessionData.currentPatient;
                currentBed = urlBed || sessionData.currentBed;
                
                console.log('üìã Patient sources - URL:', urlPatient, 'Session:', sessionData.currentPatient);
                console.log('üõèÔ∏è Bed sources - URL:', urlBed, 'Session:', sessionData.currentBed);
                console.log('‚úÖ Final selection - Patient:', currentPatientId, 'Bed:', currentBed);
                
                // If still no patient/bed data, redirect to bed overview
                if (!currentPatientId || !currentBed) {
                    console.warn('‚ö†Ô∏è No patient or bed data found, redirecting to bed overview');
                    alert('Geen pati√´ntgegevens gevonden. Ga terug naar het bedoverzicht om een pati√´nt te selecteren.');
                    window.location.href = 'bed-overview.html';
                    return;
                }
                
                // Update session data to ensure consistency
                window.sharedDataManager.saveSessionData({
                    currentPatient: currentPatientId,
                    currentBed: currentBed,
                    lastUpdated: new Date().toISOString()
                });
                
                // Update header with patient info
                updatePatientHeader();
            } else {
                console.error('‚ùå SharedDataManager not available');
                alert('Data manager niet beschikbaar. Herlaad de pagina.');
            }
        }

        function updatePatientHeader() {
            const headerElement = document.getElementById('patient-header-info');
            if (currentPatientId && currentBed) {
                const patientInfo = window.sharedDataManager.getPatientInfo(currentPatientId);
                const displayName = patientInfo?.name || `Pati√´nt ${currentPatientId}`;
                
                // Get medical information including main problem and risk level
                const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                
                let headerText = `${displayName} - Bed ${currentBed}`;
                
                // Add main problem if available
                if (medicalInfo?.selectedProblem) {
                    const problemMapping = {
                        'sepsis': 'Sepsis',
                        'pneumonia': 'Pneumonie',
                        'cardiac': 'Hartproblemen',
                        'surgery': 'Chirurgie',
                        'other': 'Anders'
                    };
                    const problemDisplay = problemMapping[medicalInfo.selectedProblem] || medicalInfo.selectedProblem;
                    headerText += ` | Hoofdprobleem: ${problemDisplay}`;
                }
                
                // Add risk level if available
                if (medicalInfo?.selectedRiskLevel) {
                    const riskMapping = {
                        'low': 'Laag',
                        'med': 'Middel',
                        'high': 'Hoog'
                    };
                    const riskDisplay = riskMapping[medicalInfo.selectedRiskLevel] || medicalInfo.selectedRiskLevel;
                    headerText += ` | Risiconiveau: ${riskDisplay}`;
                }
                
                headerElement.textContent = headerText;
            } else {
                headerElement.textContent = '';
            }
        }
        
        function initializeSepsisTagState() {
            console.log('ü¶† Initializing sepsis tag state...');
            
            if (currentPatientId && window.sharedDataManager) {
                // Check if sepsis ranges are currently active by checking the target ranges
                const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                
                if (targetRanges && targetRanges.HR) {
                    const isSepsisActive = (targetRanges.HR.min === 90 && targetRanges.HR.max === 130);
                    
                    const sepsisButton = document.querySelector('.circulatory-tag[data-condition="sepsis"]');
                    if (sepsisButton) {
                        if (isSepsisActive) {
                            sepsisButton.classList.add('selected');
                            console.log('‚úÖ Initialized sepsis button as selected (90-130 range detected)');
                        } else {
                            sepsisButton.classList.remove('selected');
                            console.log('‚úÖ Initialized sepsis button as deselected');
                        }
                    }
                }
            }
        }

        function setupEventListeners() {
            console.log('üîß Setting up event listeners...');
            
            // Listen for target range changes from other pages
            window.addEventListener('targetRangesChanged', function(event) {
                console.log('üéØ Target ranges changed event received:', event.detail);
                
                const { patientId, targetRanges } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId && targetRanges) {
                    console.log('üîÑ Updating sliders with new target ranges:', targetRanges);
                    
                    // Update currentSettings
                    currentSettings = {
                        hr: {
                            min: targetRanges.HR?.min || 70,
                            max: targetRanges.HR?.max || 110
                        },
                        bp: {
                            min: targetRanges.BP_Mean?.min || 65,
                            max: targetRanges.BP_Mean?.max || 85
                        }
                    };
                    
                    // Update sliders if they exist
                    if (hrSlider && typeof hrSlider.updateConfig === 'function') {
                        hrSlider.updateConfig({
                            targetRange: {
                                min: currentSettings.hr.min,
                                max: currentSettings.hr.max
                            }
                        });
                        console.log('‚úÖ HR slider target range updated');
                    }
                    
                    if (bpSlider && typeof bpSlider.updateConfig === 'function') {
                        bpSlider.updateConfig({
                            targetRange: {
                                min: currentSettings.bp.min,
                                max: currentSettings.bp.max
                            }
                        });
                        console.log('‚úÖ BP slider target range updated');
                    }
                }
            });
            
            // Function to force update HR slider with global HR_low and HR_high values
            function updateHRSliderFromGlobalValues() {
                if (typeof window.HR_low !== 'undefined' && typeof window.HR_high !== 'undefined') {
                    console.log('üîÑ Forcing HR slider update with global values:', window.HR_low, '-', window.HR_high);
                    
                    if (hrSlider) {
                        // Directly update slider internal values
                        hrSlider.currentMin = window.HR_low;
                        hrSlider.currentMax = window.HR_high;
                        hrSlider.config.targetRange.min = window.HR_low;
                        hrSlider.config.targetRange.max = window.HR_high;
                        
                        // Update the visual elements directly
                        const maxValueElement = hrSlider.container.querySelector('.sliding-value-outside.max-value');
                        const minValueElement = hrSlider.container.querySelector('.sliding-value-outside.min-value');
                        if (maxValueElement) maxValueElement.textContent = Math.round(window.HR_high);
                        if (minValueElement) minValueElement.textContent = Math.round(window.HR_low);
                        
                        // Update slider positions
                        hrSlider.updateSliderPosition();
                        
                        console.log('‚úÖ HR slider FORCE updated from globals:', window.HR_low, '-', window.HR_high);
                    } else {
                        console.warn('‚ö†Ô∏è HR slider not available for global update');
                    }
                } else {
                    console.warn('‚ö†Ô∏è Global HR_low or HR_high not available');
                }
            }
            
            // Test function to force sepsis range (90-130) - for debugging
            function testSepsisRange() {
                window.HR_low = 90;
                window.HR_high = 130;
                console.log('üß™ TEST: Set globals to sepsis range 90-130');
                updateHRSliderFromGlobalValues();
            }
            
            // Make test function available globally for debugging
            window.testSepsisRange = testSepsisRange;
            
            // Listen for HR range changes from sepsis selection/deselection
            window.addEventListener('hrRangesChanged', function(event) {
                console.log('üíì HR ranges changed event received in circulatoir-settings:', event.detail);
                
                const { patientId, HR_low, HR_high, BP_low, BP_high, source } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    console.log('üîÑ Updating HR slider with new ranges:', HR_low, '-', HR_high, 'source:', source);
                    
                    // Update currentSettings
                    currentSettings.hr = {
                        min: HR_low,
                        max: HR_high
                    };
                    
                    // Update BP settings if BP ranges are provided
                    if (typeof BP_low !== 'undefined' && typeof BP_high !== 'undefined') {
                        console.log('ü©∏ Updating BP slider with new ranges:', BP_low, '-', BP_high, 'source:', source);
                        currentSettings.bp = {
                            min: BP_low,
                            max: BP_high
                        };
                        
                        // Update BP slider if it exists
                        if (bpSlider && typeof bpSlider.updateConfig === 'function') {
                            bpSlider.updateConfig({
                                targetRange: {
                                    min: BP_low,
                                    max: BP_high
                                }
                            });
                            console.log('‚úÖ BP slider updated with new ranges');
                        }
                    }
                    
                    // Force update HR slider using global values
                    updateHRSliderFromGlobalValues();
                }
            });
            
            // Set up circulatory tag button listeners
            const circulatoryTagButtons = document.querySelectorAll('.circulatory-tag');
            circulatoryTagButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tagCondition = this.dataset.condition;
                    
                    if (this.classList.contains('selected')) {
                        // Deselect tag
                        this.classList.remove('selected');
                        
                        // Handle sepsis deselection
                        if (tagCondition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.handleSepsisTagChange(currentPatientId, false);
                            console.log('ü¶† Sepsis deselected in circulatory settings');
                        }
                    } else {
                        // Select tag
                        this.classList.add('selected');
                        
                        // Handle sepsis selection
                        if (tagCondition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.handleSepsisTagChange(currentPatientId, true);
                            console.log('ü¶† Sepsis selected in circulatory settings');
                            // Also force update slider immediately
                            setTimeout(() => testSepsisRange(), 100);
                        }
                    }
                });
            });
            
            // Listen for sepsis state changes from other pages to update our button
            window.addEventListener('hrRangesChanged', function(event) {
                console.log('üíì Updating circulatory tag state from external change:', event.detail);
                
                const { patientId, source } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    const sepsisButton = document.querySelector('.circulatory-tag[data-condition="sepsis"]');
                    if (sepsisButton) {
                        if (source === 'sepsis') {
                            sepsisButton.classList.add('selected');
                            console.log('‚úÖ Marked sepsis button as selected due to external selection');
                        } else if (source === 'restore') {
                            sepsisButton.classList.remove('selected');
                            console.log('‚úÖ Marked sepsis button as deselected due to external deselection');
                        }
                    }
                }
            });
            
            // Event listeners are now handled by the slider components
        }

        function loadCurrentSettings() {
            console.log('üìä Loading current circulatoir settings...');
            
            if (currentPatientId && window.sharedDataManager) {
                // Load patient-specific target ranges first
                const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                console.log('üéØ Loaded target ranges for patient:', currentPatientId, targetRanges);
                
                // Update currentSettings to use target ranges
                if (targetRanges) {
                    currentSettings = {
                        hr: {
                            min: targetRanges.HR?.min || 70,
                            max: targetRanges.HR?.max || 110
                        },
                        bp: {
                            min: targetRanges.BP_Mean?.min || 65,
                            max: targetRanges.BP_Mean?.max || 85
                        }
                    };
                }
                
                // Try to load existing patient-specific fine-tuned settings
                const savedSettings = window.sharedDataManager.getPatientCirculatoirSettings(currentPatientId);
                
                if (savedSettings) {
                    console.log('‚úÖ Found saved fine-tuned settings:', savedSettings);
                    
                    // Check if current target ranges are sepsis ranges (90-130)
                    const isSepsisActive = targetRanges && targetRanges.HR && 
                                          targetRanges.HR.min === 90 && targetRanges.HR.max === 130;
                    
                    if (isSepsisActive) {
                        // Sepsis is active - target ranges take priority over saved settings
                        console.log('ü¶† Sepsis is active - using target ranges instead of saved settings');
                        // Keep currentSettings as is (target ranges)
                    } else {
                        // Normal case - merge saved settings with target ranges (saved settings take priority for fine-tuning)
                        currentSettings = {
                            hr: savedSettings.hr || currentSettings.hr,
                            bp: savedSettings.bp || currentSettings.bp
                        };
                        console.log('‚úÖ Using saved fine-tuned settings:', currentSettings);
                    }
                } else {
                    // If no fine-tuned settings, check if we need to load from medical info
                    const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                    if (medicalInfo && medicalInfo.selectedTags && !targetRanges) {
                        // Only apply condition-based thresholds if no target ranges exist
                        const thresholds = window.sharedDataManager.getThresholdsByTags(medicalInfo.selectedTags);
                        if (thresholds && thresholds.circulatoir) {
                            currentSettings = {
                                hr: thresholds.circulatoir.HR || { min: 70, max: 110 },
                                bp: thresholds.circulatoir.BP_Mean || { min: 65, max: 85 }
                            };
                            console.log('‚úÖ Applied condition-based thresholds:', currentSettings);
                        }
                    }
                }
                
                console.log('‚úÖ Final current settings loaded:', currentSettings);
            }
        }

        function initializeSliders() {
            console.log('üéõÔ∏è Initializing interactive sliders...');
            
            // Debug: Check if containers exist
            const hrContainer = document.getElementById('hr-slider-container');
            const bpContainer = document.getElementById('bp-slider-container');
            console.log('HR Container found:', !!hrContainer);
            console.log('BP Container found:', !!bpContainer);
            
            // Check if slider components are loaded
            console.log('VitalParameterSlider available:', !!window.VitalParameterSlider);
            console.log('PatientConfigurationHelper available:', !!window.PatientConfigurationHelper);
            console.log('SharedDataManager available:', !!window.sharedDataManager);
            
            if (!window.VitalParameterSlider) {
                console.error('‚ùå VitalParameterSlider class not found');
                if (hrContainer) hrContainer.innerHTML = '<p style="color: red;">Slider component not loaded - VitalParameterSlider missing</p>';
                return;
            }
            
            if (!window.PatientConfigurationHelper) {
                console.error('‚ùå PatientConfigurationHelper class not found');
                if (bpContainer) bpContainer.innerHTML = '<p style="color: red;">Slider component not loaded - PatientConfigurationHelper missing</p>';
                return;
            }
            
            if (!currentPatientId) {
                console.error('‚ùå No patient ID available for sliders');
                if (hrContainer) hrContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                if (bpContainer) bpContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                return;
            }
            
            console.log('‚úÖ All prerequisites met, creating sliders for patient:', currentPatientId);
            
            try {
                // Debug: Check what data we have
                console.log('Current patient ID:', currentPatientId);
                const patientInfo = window.sharedDataManager ? window.sharedDataManager.getPatientInfo(currentPatientId) : null;
                const patientSettings = window.sharedDataManager ? window.sharedDataManager.getPatientCirculatoirSettings(currentPatientId) : null;
                console.log('Patient info:', patientInfo);
                console.log('Patient settings:', patientSettings);
                
                // Initialize HR Slider with direct approach
                const hrContainer = document.getElementById('hr-slider-container');
                if (hrContainer) {
                    console.log('ü´Ä Creating HR slider...');
                    hrContainer.innerHTML = '<p style="color: blue;">Loading HR slider...</p>';
                    
                    try {
                        // Try direct instantiation first
                        hrSlider = new window.VitalParameterSlider(hrContainer, {
                            parameter: 'HR',
                            name: 'HR',
                            unit: 'bpm',
                            targetRange: currentSettings.hr || { min: 70, max: 110 },
                            yAxis: { min: 40, max: 140, step: 20 },
                            monitoringLevel: 'mid',
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Pati√´nt ${currentPatientId}`,
                            onChange: (data) => {
                                console.log('HR Slider changed:', data);
                                if (window.sharedDataManager && data.type === 'save') {
                                    // Allow saving regardless of sepsis state
                                    // Save to SharedDataManager
                                    const newSettings = { hr: { min: data.min, max: data.max }, bp: currentSettings.bp };
                                    window.sharedDataManager.savePatientCirculatoirSettings(currentPatientId, newSettings);
                                    currentSettings = newSettings;
                                    // Also update target ranges to reflect the slider changes
                                    const updatedTargetRanges = {
                                        HR: { min: Math.round(data.min), max: Math.round(data.max), unit: 'bpm' },
                                        BP_Mean: { 
                                            min: Math.round(currentSettings.bp?.min || 65), 
                                            max: Math.round(currentSettings.bp?.max || 85), 
                                            unit: 'mmHg' 
                                        }
                                    };
                                    window.sharedDataManager.updateGlobalTargetRanges(currentPatientId, updatedTargetRanges);
                                    console.log('üéØ Updated target ranges after HR slider change:', updatedTargetRanges);
                                }
                            }
                        });
                        
                        if (hrSlider) {
                            console.log('‚úÖ HR Slider initialized successfully');
                            // Sync with global HR values after initialization
                            setTimeout(() => {
                                updateHRSliderFromGlobalValues();
                                // Also check if sepsis is currently active and force update
                                if (currentPatientId && window.sharedDataManager) {
                                    const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                                    if (targetRanges && targetRanges.HR && targetRanges.HR.min === 90 && targetRanges.HR.max === 130) {
                                        console.log('ü¶† Sepsis detected on initialization - forcing slider update');
                                        testSepsisRange();
                                    }
                                }
                            }, 100);
                        } else {
                            console.error('‚ùå HR Slider initialization returned null');
                            hrContainer.innerHTML = '<p style="color: red;">HR Slider initialization returned null</p>';
                        }
                    } catch (error) {
                        console.error('‚ùå HR Slider creation error:', error);
                        hrContainer.innerHTML = `<p style="color: red;">HR Slider error: ${error.message}</p>`;
                    }
                }
                
                // Initialize BP Slider with direct approach
                const bpContainer = document.getElementById('bp-slider-container');
                if (bpContainer) {
                    console.log('ü©∏ Creating BP slider...');
                    bpContainer.innerHTML = '<p style="color: blue;">Loading BP slider...</p>';
                    
                    try {
                        // Try direct instantiation
                        bpSlider = new window.VitalParameterSlider(bpContainer, {
                            parameter: 'BP_Mean',
                            name: 'BP Mean',
                            unit: 'mmHg',
                            targetRange: currentSettings.bp || { min: 65, max: 85 },
                            yAxis: { min: 30, max: 100, step: 10 },
                            monitoringLevel: 'mid',
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Pati√´nt ${currentPatientId}`,
                            onChange: (data) => {
                                console.log('BP Slider changed:', data);
                                if (window.sharedDataManager && data.type === 'save') {
                                    // Allow saving regardless of sepsis state
                                    // Save to SharedDataManager
                                    const newSettings = { hr: currentSettings.hr, bp: { min: data.min, max: data.max } };
                                    window.sharedDataManager.savePatientCirculatoirSettings(currentPatientId, newSettings);
                                    currentSettings = newSettings;
                                    // Also update target ranges to reflect the slider changes
                                    const updatedTargetRanges = {
                                        HR: { 
                                            min: Math.round(currentSettings.hr?.min || 70), 
                                            max: Math.round(currentSettings.hr?.max || 110), 
                                            unit: 'bpm' 
                                        },
                                        BP_Mean: { min: Math.round(data.min), max: Math.round(data.max), unit: 'mmHg' }
                                    };
                                    window.sharedDataManager.updateGlobalTargetRanges(currentPatientId, updatedTargetRanges);
                                    console.log('üéØ Updated target ranges after BP slider change:', updatedTargetRanges);
                                }
                            }
                        });
                        
                        if (bpSlider) {
                            console.log('‚úÖ BP Slider initialized successfully');
                        } else {
                            console.error('‚ùå BP Slider initialization returned null');
                            bpContainer.innerHTML = '<p style="color: red;">BP Slider initialization returned null</p>';
                        }
                    } catch (error) {
                        console.error('‚ùå BP Slider creation error:', error);
                        bpContainer.innerHTML = `<p style="color: red;">BP Slider error: ${error.message}</p>`;
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error initializing sliders:', error);
                document.getElementById('hr-slider-container').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                document.getElementById('bp-slider-container').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // Legacy functions removed - functionality now handled by slider components

        function goBackToAlarmOverview() {
            console.log('üîô Navigating back to alarm overview');
            
            // Ensure session data is preserved when going back
            if (currentPatientId && currentBed && window.sharedDataManager) {
                // Update session data to maintain patient context
                window.sharedDataManager.saveSessionData({
                    currentPatient: currentPatientId,
                    currentBed: currentBed,
                    lastUpdated: new Date().toISOString()
                });
                
                console.log('‚úÖ Session data preserved for patient:', currentPatientId, 'bed:', currentBed);
                
                // Navigate back to alarm overview with proper URL parameters
                const alarmUrl = `alarm-overview.html?bed=${currentBed}&patient=${currentPatientId}`;
                console.log('üîó Navigating to:', alarmUrl);
                window.location.href = alarmUrl;
            } else {
                console.warn('‚ö†Ô∏è Missing patient or bed data, redirecting to bed overview');
                window.location.href = 'bed-overview.html';
            }
        }
    </script>
</body>
</html>
