<!DOCTYPE html>
<html lang="nl">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title that appears in browser tab -->
    <title>Respiratoire Instellingen</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/slider-component.css">
    
    <!-- Data Manager for cross-page data synchronization -->
    <!-- WebSocket Communication Scripts -->
    <script src="js/websocket-outbound-client.js"></script>
    <script src="js/websocket-connection-manager.js"></script>
    <script src="js/shared-data-manager.js"></script>
    
    <!-- Slider Component -->
    <script src="js/slider-component.js"></script>
    
    <!-- Heart Circle Component -->
    <script src="js/heart-circle-component.js"></script>
</head>
<body>
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <a href="#" class="breadcrumb-link" onclick="goToBedOverview()">
            <img src="svg's/Home.svg" alt="Home" class="breadcrumb-icon">
            Kamer Overzicht
        </a>
        <span class="breadcrumb-separator">></span>
        <a href="#" class="breadcrumb-link" onclick="goBackToAlarmOverview()">Alarm Instellingen - S. Groen</a>
        <span class="breadcrumb-separator">></span>
        <span class="breadcrumb-current">Respiratoire Monitoring</span>
    </nav>

    <!-- Title and Patient Info Layout -->
    <div class="title-patient-layout">
        <!-- Main page title -->
        <h1 class="main-title">Respiratoire Monitoring</h1>
        
        <!-- Patient information header section -->
        <div class="header">
            <img src="svg's/patient_icon.svg" alt="Patient" class="user-icon" />
            <span id="patient-header-info">Loading patient info...</span>
        </div>
    </div>
    
    <!-- Main content container -->
    <div class="circulatoir-settings-container">
        
        <!-- Monitoring Level Controls -->
        <div class="monitoring-controls-layout">
            <!-- Monitoring buttons - now direct children -->
            <div class="monitoring-buttons-direct">
                <h3 class="info-title">Alarm Level</h3>
                <div class="button-group">
                    <button class="btn risk-low" data-level="loose" onclick="changeMonitoringLevel('loose')">Los</button>
                    <button class="btn risk-med selected" data-level="mid" onclick="changeMonitoringLevel('mid')">Mid</button>
                    <button class="btn risk-high" data-level="tight" onclick="changeMonitoringLevel('tight')">Strak</button>
                </div>
            </div>
            
            <!-- Heart circle - now direct child -->
            <div class="heart-circle-direct">
                <h3 class="info-title"> </h3>
                <div id="respiratory-heart-circle-container"></div>
            </div>
            
            <!-- Additional Circulatory Information Container -->
            <div class="additional-circulatory-info">
                <h3 class="info-title">Respiratoire additionele informatie:</h3>
                <div class="circulatory-tags-section">
                    <button class="btn tag-btn circulatory-tag" data-condition="pneumonie">
                        Pneumonie <img src="svg's/lung.svg" alt="Pneumonie" class="condition-icon">
                    </button>
                    <button class="circulatory-more-btn">⋯</button>
                </div>
            </div>
        </div>
        
        
        <!-- Section title moved outside the container -->
        <h2 class="section-title">Respiratoire Streefgebieden Aanpassen</h2>
        
        <!-- Interactive Slider Demo Section -->
        <div class="slider-demo-section">
            
            <!-- Direct slider containers without extra wrappers -->
            <div class="sliders-layout">
                <div id="saturatie-slider-container" class="individual-slider"></div>
                <div class="af-slider-with-legend">
                    <div id="af-slider-container" class="individual-slider"></div>
                    <div class="alarm-legend">
                        <div class="legend-item">
                            <div class="legend-color green"></div>
                            <span>Acceptabel</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color yellow"></div>
                            <span>Lichte overschrijding</span>
                        </div>
                        
                        <div class="legend-item">
                            <div class="legend-color red"></div>
                            <span>Significante overschrijding</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation section with back button -->
    <div class="bottom-left-nav">
        <button class="nav-button back-button" onclick="goBackToAlarmOverview()">
            ← Terug naar Alarm Overzicht
        </button>
    </div>

    <!-- Bottom right navigation button -->
    <div class="bottom-right-nav">
        <button class="nav-button" onclick="goToOtherSettings()">Naar Overige →</button>
    </div>

    <style>
        /* Page-specific gradient background - only for respiratory settings page */
        body {
            background: linear-gradient(to bottom, #ffffff 0%, #ffffff 10%, #E6E4E0 100%);
            min-height: 100vh; /* Ensure full viewport height for gradient */
            padding: 50px 200px 5px 200px; /* Further reduced padding for no scrolling */
            margin: 0;
            font-family: 'Open Sans', sans-serif;
        }

        /* Breadcrumb Navigation */
        .breadcrumb-nav {
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            color: #FC6039;
            margin-bottom: 25px;
            padding-top: 10px;
            display: flex;
            align-items: center;
            line-height: 1.2;
        }

        .breadcrumb-link {
            color: #FC6039;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s ease;
            vertical-align: middle;
        }

        .breadcrumb-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .breadcrumb-icon {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            filter: brightness(0) saturate(100%) invert(44%) sepia(93%) saturate(1352%) hue-rotate(346deg) brightness(119%) contrast(119%);
            vertical-align: middle;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #FC6039;
            font-weight: normal;
        }

        .breadcrumb-current {
            color: #FC6039;
            font-weight: 600;
        }
        
        /* Title and Patient Info Layout */
        .title-patient-layout {
            display: flex;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .title-patient-layout .main-title {
            margin: 0; /* Remove default margin */
            flex: 0 0 auto; /* Don't grow or shrink */
        }
        
        /* Position header to align with the right edge of additional-circulatory-info */
        .header {
            width: fit-content; /* Resize to content width */
            margin: 0; /* Remove default margins */
            position: absolute;
            right: 0; /* Align to the right edge of the container */
            /* This will align with the additional info box since both are in the same container width */
        }
        
        /* Monitoring Level Controls - matching risk level button styling */
        .monitoring-level-controls {
            margin: 0px 0; /* Further reduced from 15px */
            text-align: left; /* Changed from center to left */
            background: rgba(255, 255, 255, 0);
            padding: 0px; /* Further reduced from 20px */
            border-radius: 10px;
            /* box-shadow: 0 2px 4px rgba(0,0,0,0.1); */ /* Shadow removed */
            border: 1px solid #e9ecef;
        }
        
        .monitoring-level-controls .section-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: left; /* Ensure title is also left-aligned */
        }
        
        .monitoring-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 10px; /* Further reduced from 15px */
            text-align: left; /* Changed from default to explicitly left */
        }
        
        /* Layout for monitoring controls and heart circle - horizontal sections */
        .monitoring-controls-layout {
            display: flex;
            gap: -400px; /* Further reduced gap to bring heart circle even closer */
            margin-top: 3px; /* Further reduced from 5px */
            margin-bottom: 10px; /* Further reduced from 15px */
            align-items: flex-start;
            width: 100%;
            position: relative;
        }
        
        .monitoring-buttons-direct {
            flex: 1;
            /* Container properties removed - now direct on page */
            padding: 12px 15px 15px 0px; /* Removed left padding to align with title */
            min-height: 120px; /* Reduced to match additional info container */
            max-height: 120px; /* Reduced to match additional info container */
            display: flex;
            flex-direction: column;
        }
        
        .heart-circle-direct {
            flex: 1;
            /* Container properties removed - now direct on page */
            padding: 0px 15px 15px 15px; /* Further reduced padding */
            margin-left: -300px; /* Increased negative margin to move heart circle closer to monitoring buttons */
            min-height: 200px; /* Reduced from 240px to make it more compact */
            max-height: 200px; /* Reduced from 240px to make it more compact */
            display: flex;
            flex-direction: column;
            align-items: left;
            justify-content: flex-start;
            overflow: visible; /* Changed from hidden to visible to show full circle */
            position: relative;
        }
        
        .heart-circle-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }
        
        #respiratory-heart-circle-container {
            width: 220px;
            height: 220px;
            max-width: 100%;
            max-height: 260px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Changed from center to flex-start to move left */
            margin: 0;
            padding-top: 12px;
            overflow: visible; /* Ensure circle content is not clipped */
        }
        .heart-organ-circle {
            opacity: 1 !important;
            position: relative !important;
        }
        
        /* Specific override for respiratory page heart circle positioning */
        #respiratory-heart-circle-container .heart-organ-circle {
            justify-content: flex-start !important;
            margin: 0 !important;
        }
        
        /* Additional Circulatory Information Container - matches alarm overview form-section */
        .additional-circulatory-info {
            flex: 1.05; /* Further reduced for better proportions */
            display: flex;
            flex-direction: column;
        }
        
        .circulatory-tags-section {
            background: #C2E4FF;
            padding: 15px 20px 20px 20px;
            border-radius: 30px 0px 30px 0px;
            min-height: 100px; /* Reduced since title is outside */
            max-height: 100px;
            display: flex;
            gap: 8px; /* Reduced from 15px to bring buttons closer */
            flex-wrap: wrap;
            align-items: flex-start;
        }
        
        /* General info-title styling for all containers */
        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 15px;
            text-align: left;
            position: relative;
            z-index: 2;
        }
        
        .additional-circulatory-info .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 8px; /* Reduced margin to bring container closer */
            margin-left: 0px; /* Reduced left margin for better alignment */
            text-align: left;
            position: relative;
            background: transparent; /* Ensure no background */
            z-index: 10; /* Position above the blue container */
        }

        .monitoring-buttons-direct .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 8px; /* Match additional info title margin */
            text-align: left;
            position: relative;
            z-index: 2;
        }
        
        /* Using standard tag styling from styles.css - no custom circulatory styling needed */
        
        .circulatory-tag {
            padding: 6px 12px;
            font-size: 13px;
            white-space: nowrap;
            border-radius: 20px;
            background-color: #bbdefb;
            border: 2px solid #1961AB;
            color: #1961AB;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: auto;
            flex-shrink: 0;
            flex-grow: 0;
        }
        
        .circulatory-tag:hover {
            background: #90caf9;
            border-color: #64b5f6;
        }
        
        .circulatory-tag.selected {
            background-color: #1961AB;
            color: white;
            border-color: #1961AB;
            font-weight: 600;
        }
        
        .circulatory-more-btn {
            background-color: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .circulatory-more-btn:hover {
            background-color: #e55a2b;
            transform: scale(1.05);
        }
        
        /* Slider containers and titles */
        .slider-demo-section {
            margin: 8px 0; /* Further reduced from 12px for tighter spacing */
            max-width: 1920px; /* Use full width */
            margin-left: auto;
            margin-right: auto;
            padding: 0; /* Remove padding to align with body padding */
            /* flex: 1; */ /* Remove flex:1 - don't take remaining space */
        }
        
        .slider-demo-section .section-title {
            color: #1961AB;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 0px;
            text-align: left;
        }
        
        .demo-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .sliders-layout {
            display: flex;
            gap: 40px; /* Reduced from 120px for compact layout */
            justify-content: center;
            flex-wrap: nowrap; /* Force horizontal layout, no wrapping */
            margin: -20px auto;
            align-items: flex-start; /* Align sliders at the top */
        }
        
        .individual-slider {
            flex: 0 0 auto; /* Don't grow or shrink, use natural size */
            min-width: 400px; /* Reduced from 500px */
            max-width: 450px; /* Reduced from 600px */
        }

        /* AF Slider with Legend Layout */
        .af-slider-with-legend {
            display: flex;
            gap: 100px;
            align-items: center; /* This centers the legend vertically */
        }

        /* Alarm Legend Styles */
        .alarm-legend {
            background: white;
            border-radius: 8px;
            padding: 15px; /* Reduced from 20px */
            /* border: 1px solid #e9ecef; */ /* Border removed */
            min-width: 160px; /* Reduced from 200px */
            /* margin-top removed - flexbox centering handles positioning */
        }

        .alarm-legend h4 {
            font-family: 'Open Sans', sans-serif;
            color: black;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            font-family: 'Open Sans', sans-serif;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-color.green {
            background-color: #00C877;
        }

        .legend-color.yellow {
            background-color: #ECEC3E;
        }

        .legend-color.orange {
            background-color: #F0973E;
        }

        .legend-color.red {
            background-color: #EB4921;
        }

        .legend-item span {
            color: black;
            font-size: 14px;
            font-weight: 400;
        }
        .nav-button {
            background-color: transparent;
            border: 2px solid #ff6b35;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Open Sans', sans-serif;
            color: #ff6b35;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-button:hover {
            background-color: #ff6b35;
            border-color: #ff6b35;
            color: white;
            transform: translateY(-2px);
        }
        
        /* Bottom right navigation button */
        .bottom-right-nav {
            position: fixed;
            bottom: 63px;
            right: 200px;
            z-index: 1000;
        }
        
        /* Bottom left navigation button - matching right button positioning */
        .bottom-left-nav {
            position: fixed;
            bottom: 63px;
            left: 200px;
            z-index: 1000;
        }
        
        .subtitle {
            text-align: left; /* Changed from center to left */
            color: #6c757d;
            font-size: 18px;
            margin-bottom: 30px;
            font-weight: 400;
        }
        
        .circulatoir-settings-container {
            max-width: 1920px; /* Use full width for 1920x1080 */
            margin: 0 auto;
            padding: 0; /* Remove padding to align with body padding */
            /* height: calc(100vh - 30px); */ /* Remove fixed height - let content determine height */
            display: flex;
            flex-direction: column;
        }
        
        .parameter-section {
            background: white;
            border-radius: 12px;
            padding: 18px; /* Further reduced from 20px */
            margin-bottom: 15px; /* Further reduced from 20px */
            /* box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); */ /* Shadow removed */
            border: 1px solid #e9ecef;
        }
        
        .parameter-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 18px; /* Reduced from 25px */
            color: #cd3ae1;
            font-size: 24px;
            font-weight: 600;
        }
        
        .heart-icon, .bp-icon {
            font-size: 32px;
        }
        
        .range-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .current-range {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .range-status {
            font-size: 14px;
            color: #28a745;
            font-weight: 500;
        }
        
        .adjustment-controls {
            margin-bottom: 20px;
        }
        
        .range-input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .range-input-group label {
            font-weight: 600;
            color: #495057;
            flex: 1;
        }
        
        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-with-unit input {
            width: 80px;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
        }
        
        .input-with-unit input:focus {
            outline: none;
            border-color: #1961AB;
            /* box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); */ /* Shadow removed */
        }
        
        .unit {
            font-weight: 600;
            color: #6c757d;
            min-width: 50px;
        }
        
        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .preset-btn {
            background-color: #e9ecef;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .preset-btn:hover {
            background-color: #1961AB;
            border-color: #1961AB;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 40px 0;
        }
        
        .action-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .reset-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .reset-btn:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .save-btn {
            background-color: #28a745;
            color: white;
        }
        
        .save-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        
        .settings-preview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #dee2e6;
        }
        
        .settings-preview h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
            text-align: center;
        }
        
        .preview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .preview-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .preview-label {
            font-weight: 600;
            color: #495057;
        }
        
        .preview-value {
            font-weight: 600;
            color: #1961AB;
            font-size: 16px;
        }
        
        /* Slider Demo Section Styles */
        .slider-demo-section {
            background: #ffffff;
            border-radius: 0px 30px 0px 30px;
            padding: 20px; /* Add some padding instead of fixed height */
            margin-top: 0px;
            width: 1520px;
            /* height: 120px; */ /* Remove fixed height - let content determine size */
            height: auto; /* Let content determine height */
        }
        
        .slider-demo-section h3 {
            color: #2c3e50;
            font-size: 22px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .demo-description {
            text-align: center;
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .slider-containers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .slider-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            /* box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); */ /* Shadow removed */
            border: 1px solid #e9ecef;
        }
        
        .slider-container h4 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .slider-container > div {
            min-height: 300px;
        }
        
        /* Monitoring Level Controls */
        .monitoring-level-controls {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .monitoring-level-controls h4 {
            color: #495057;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .monitoring-description {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .level-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .level-btn {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .level-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
            transform: translateY(-2px);
        }
        
        .level-btn.active {
            background: #1961AB;
            border-color: #1961AB;
            color: white;
        }
        
        .level-btn strong {
            display: block;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .level-btn span {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .circulatoir-settings-container {
                padding: 10px;
            }
            
            .parameter-section {
                padding: 20px;
            }
            
            .range-input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .preset-buttons {
                justify-content: center;
            }
        }
    </style>

    <script>
        // Global variables
        let currentPatientId = null;
        let currentBed = null;
        let currentSettings = {};

        // SINGLE SOURCE OF TRUTH: Initialize currentSettings from unified data
        function initializeCurrentSettings() {
            if (currentPatientId && window.sharedDataManager) {
                console.log('🎯 RESPIRATORY: Initializing with single source of truth for patient:', currentPatientId);
                
                // Get ALL effective values in one call (prevents stacking)
                const effectiveValues = window.sharedDataManager.getCurrentEffectiveValues(
                    currentPatientId, 
                    { useCache: true } // Use cache during initialization to prevent redundancy
                );
                
                console.log('📦 RESPIRATORY: Received effective values package:', effectiveValues);
                
                if (effectiveValues && effectiveValues.parameterRanges) {
                    const ranges = effectiveValues.parameterRanges;
                    
                    currentSettings = {
                        saturatie: {
                            min: ranges.Saturatie?.min || window.SAT_MIN || 90,
                            max: ranges.Saturatie?.max || window.SAT_MAX || 100
                        },
                        af: {
                            min: ranges.AF?.min || window.AF_MIN || 12,
                            max: ranges.AF?.max || window.AF_MAX || 25
                        }
                    };
                } else {
                    // Fallback to global variables
                    currentSettings = {
                        saturatie: { min: window.SAT_MIN || 90, max: window.SAT_MAX || 100 },
                        af: { min: window.AF_MIN || 12, max: window.AF_MAX || 25 }
                    };
                }
                console.log('🫁 Respiratory currentSettings initialized from SharedDataManager:', currentSettings);
            } else {
                // Default fallback
                currentSettings = {
                    saturatie: { min: 90, max: 100 },
                    af: { min: 12, max: 25 }
                };
                console.log('🫁 Respiratory currentSettings initialized with defaults:', currentSettings);
            }
        }
        
        // Store slider references globally for cross-slider save synchronization
        window.saturatieSlider = null;
        window.afSlider = null;

        // ===================================================================
        // CENTRALIZED SYNCHRONIZATION SYSTEM
        // ===================================================================

        /**
         * Synchronize sliders with centralized target ranges
         * Called on page load and when ranges change from other pages
         */
        function syncSlidersWithCentralizedRanges() {
            if (!currentPatientId || !window.sharedDataManager) {
                console.log('⏸️ No patient ID or SharedDataManager available for slider sync');
                return;
            }

            console.log('📊 Syncing respiratory sliders with centralized target ranges...');
            const currentRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
            
            if (!currentRanges) {
                console.log('⏸️ No centralized ranges found for patient:', currentPatientId);
                return;
            }

            // Update AF slider
            if (window.afSlider && currentRanges.AF) {
                console.log('📊 Syncing AF slider:', currentRanges.AF.min, '-', currentRanges.AF.max);
                
                // Update slider config
                window.afSlider.config.targetRange.min = currentRanges.AF.min;
                window.afSlider.config.targetRange.max = currentRanges.AF.max;
                
                // Update current positions
                window.afSlider.currentMin = currentRanges.AF.min;
                window.afSlider.currentMax = currentRanges.AF.max;
                
                // Update original values so slider doesn't think these are user changes
                window.afSlider.originalMin = currentRanges.AF.min;
                window.afSlider.originalMax = currentRanges.AF.max;
                
                // Force re-render
                if (window.afSlider.updateSliderPosition) {
                    window.afSlider.updateSliderPosition();
                    console.log('✅ AF slider synced and re-rendered');
                }
            }

            // Update Saturatie slider  
            if (window.saturatieSlider && currentRanges.Saturatie) {
                console.log('📊 Syncing Saturatie slider:', currentRanges.Saturatie.min, '-', currentRanges.Saturatie.max);
                
                // Update slider config
                window.saturatieSlider.config.targetRange.min = currentRanges.Saturatie.min;
                window.saturatieSlider.config.targetRange.max = currentRanges.Saturatie.max;
                
                // Update current positions
                window.saturatieSlider.currentMin = currentRanges.Saturatie.min;
                window.saturatieSlider.currentMax = currentRanges.Saturatie.max;
                
                // Update original values
                window.saturatieSlider.originalMin = currentRanges.Saturatie.min;
                window.saturatieSlider.originalMax = currentRanges.Saturatie.max;
                
                // Force re-render
                if (window.saturatieSlider.updateSliderPosition) {
                    window.saturatieSlider.updateSliderPosition();
                    console.log('✅ Saturatie slider synced and re-rendered');
                }
            }

            console.log('✅ All respiratory sliders synced with centralized ranges');
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            setupEventListeners();
            initializePneumonieTagState(); // Initialize pneumonie state FIRST
            
            // Initialize global variables system (simple approach)
            if (window.sharedDataManager) {
                window.sharedDataManager.loadGlobalParameterVariables();
                console.log('✅ Global variables loaded for respiratory page');
            }

            // Initialize heart circle component (same as alarm overview)
            setTimeout(() => {
                initializeHeartCircleComponent();
                initializeSliders();
            }, 1000);
        });
        // Heart and Lung SVG content
        const svgContent = {
            heart: `<svg class="organ-icon" viewBox="0 0 22 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.22 10.3743C12.0679 12.132 10.9163 15.0615 10.9163 19.1628M13.22 10.3743C12.0681 12.132 11.4922 14.4756 6.30842 14.4756M13.22 10.3743C14.6766 8.39884 16.9516 6.83964 19.3552 6.3986C20.0557 6.27006 20.6011 5.62288 20.4841 4.90863L20.2921 3.73684C20.1996 3.17181 19.7182 2.75127 19.159 2.81881C16.3987 3.15222 12.9705 4.8327 10.9162 7.44486C10.9162 6.27307 10.9162 2.75769 10.3402 1M5.73245 6.85896C5.15648 5.10127 4.00454 3.92948 2.27663 3.92948M1.70071 15.6441C2.85258 20.9171 7.26892 25 10.3401 25C13.4113 25 17.6365 20.9175 18.9799 15.6441C20.3232 10.3707 16.1 6.85563 13.2201 10.371C13.2201 8.61732 11.4922 6.85906 8.03639 6.85906C4.58057 6.85906 0.548838 10.371 1.70071 15.6441Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`,
            lung: `<svg class="organ-icon" viewBox="0 0 30 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.5007 5.62881C11.5007 4.02205 10.3628 2.41595 5.90178 6.31748C-0.397037 11.8263 1.7026 24.2213 2.40247 24.91C3.10233 25.5986 10.8008 22.1555 11.5007 20.7783C12.2006 19.4011 10.8008 17.3352 12.2006 14.5808M18.4993 5.62879C18.4993 4.02203 19.6372 2.41593 24.0982 6.31746C30.397 11.8263 28.2974 24.2213 27.5975 24.9099C26.8977 25.5985 19.1992 22.1555 18.4993 20.7783C17.7994 19.401 19.1992 17.3352 17.7994 14.5807M21.9987 16.6468C21.9987 13.3949 19.8717 11.7738 18.2519 10.7191C14.9109 8.54378 15 4.4935 15 0.999945C15 4.4935 15.0891 8.54378 11.7481 10.7191C10.1283 11.7738 8.00142 13.3949 8.00142 16.6468" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`
        };

        // Utility to inject SVG content into the heart circle
        function injectSVG(containerId, svgType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const iconDiv = container.querySelector('.heart-white-center');
            if (iconDiv) {
                iconDiv.innerHTML = svgContent[svgType];
                const svgEl = iconDiv.querySelector('svg');
                if (svgEl) {
                    svgEl.style.width = '70%';
                    svgEl.style.height = '70%';
                    svgEl.style.display = 'block';
                    svgEl.style.margin = '0 auto';
                }
            } else {
                setTimeout(() => injectSVG(containerId, svgType), 50);
            }
        }

        // Initialize the heart circle component in respiratory settings
        function initializeHeartCircleComponent() {
            // Use same size as alarm overview
            const circleSize = 130;
            
            // Get EFFECTIVE monitoring level from SharedDataManager (including tag adjustments)
            let initialLevel = 'mid';
            if (currentPatientId && window.sharedDataManager) {
                initialLevel = window.sharedDataManager.getEffectiveLungMonitoringLevel(currentPatientId);
                console.log(`Loading EFFECTIVE lung monitoring level for patient ${currentPatientId}:`, initialLevel);
            }
            
            window.respiratoryLungCircle = new HeartCircleComponent('respiratory-heart-circle-container', { 
                size: circleSize, 
                initialState: initialLevel 
            });
            setTimeout(() => injectSVG('respiratory-heart-circle-container', 'lung'), 100);
            
            // Map heart circle levels to button levels for initial setup
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight'
            };
            
            const buttonLevel = levelMapping[initialLevel] || 'mid';
            
            // Update button states to match loaded level
            updateButtonStates(buttonLevel);
            
            // Update sliders to match loaded level (wait for sliders to be initialized)
            setTimeout(() => {
                updateSlidersMonitoringLevel(buttonLevel);
            }, 1500); // Wait for sliders to be fully initialized
            
            // Listen for global lung monitoring level changes
            document.addEventListener('lungMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                if (patientId === currentPatientId) {
                    console.log(`Received lung monitoring level change for patient ${patientId}:`, level);
                    if (window.respiratoryLungCircle) {
                        window.respiratoryLungCircle.setRiskLevel(level);
                    }
                    
                    const buttonLevel = levelMapping[level] || 'mid';
                    updateButtonStates(buttonLevel);
                    updateSlidersMonitoringLevel(buttonLevel);
                }
            });
        }
        
        // Helper function to update button states
        function updateButtonStates(level) {
            // Map heart circle levels back to button levels
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight',
                'loose': 'loose',  // fallback mappings
                'tight': 'tight'
            };
            
            const mappedLevel = levelMapping[level] || level;
            console.log(`Updating button states: ${level} → ${mappedLevel}`);
            
            // Update button states
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            const selectedButton = document.querySelector(`[data-level="${mappedLevel}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`✅ Button ${mappedLevel} selected in updateButtonStates`);
            } else {
                console.warn(`❌ Button with data-level="${mappedLevel}" not found`);
            }
        }

        // Helper function to update sliders monitoring level (moved outside closure for global access)
        function updateSlidersMonitoringLevel(level) {
            console.log(`🎛️ Updating respiratory sliders monitoring level to: ${level}`);
            console.log('🔍 DEBUG - window.saturatieSlider exists:', !!window.saturatieSlider);
            console.log('🔍 DEBUG - window.afSlider exists:', !!window.afSlider);
            
            if (window.saturatieSlider) {
                console.log('🔍 DEBUG - window.saturatieSlider type:', typeof window.saturatieSlider);
                console.log('🔍 DEBUG - window.saturatieSlider.updateMonitoringLevel exists:', typeof window.saturatieSlider.updateMonitoringLevel);
            }
            
            // Update Saturatie slider if it exists
            if (window.saturatieSlider && typeof window.saturatieSlider.updateMonitoringLevel === 'function') {
                console.log('🎛️ Calling window.saturatieSlider.updateMonitoringLevel with:', level);
                window.saturatieSlider.updateMonitoringLevel(level);
                console.log('✅ Saturatie slider monitoring level updated to:', level);
            } else {
                console.warn('❌ Saturatie slider not found or updateMonitoringLevel method not available');
                console.warn('❌ window.saturatieSlider:', window.saturatieSlider);
                if (window.saturatieSlider) {
                    console.warn('❌ Available methods:', Object.getOwnPropertyNames(window.saturatieSlider));
                }
            }
            
            // Update AF slider if it exists - allow monitoring level changes for visual updates
            if (window.afSlider && typeof window.afSlider.updateMonitoringLevel === 'function') {
                console.log('🎛️ Calling window.afSlider.updateMonitoringLevel with:', level);
                window.afSlider.updateMonitoringLevel(level);
                console.log('✅ AF slider monitoring level updated to:', level);
            } else {
                console.warn('❌ AF slider not found or updateMonitoringLevel method not available');
                console.warn('❌ window.afSlider:', window.afSlider);
                if (window.afSlider) {
                    console.warn('❌ Available methods:', Object.getOwnPropertyNames(window.afSlider));
                }
            }
        }

        // Function to change monitoring level for all sliders
        function changeMonitoringLevel(level) {
            console.log(`🔄 Changing monitoring level to: ${level}`);
            
            // Map button levels to lung circle levels
            const levelMapping = {
                'loose': 'low',
                'mid': 'mid',
                'tight': 'high'
            };
            
            const lungLevel = levelMapping[level] || level;
            console.log(`Mapped ${level} to lung level: ${lungLevel}`);
            
            // Update button states - remove active/selected from all buttons
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            // Add selected class to the clicked button
            const selectedButton = document.querySelector(`[data-level="${level}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`✅ Button ${level} selected`);
            }
            
            // Update lung circle if it exists
            if (window.respiratoryLungCircle) {
                console.log(`🫁 Updating respiratory lung circle to: ${lungLevel}`);
                window.respiratoryLungCircle.setRiskLevel(lungLevel);
            } else {
                console.warn('❌ respiratoryLungCircle not found');
            }
            
            // Save to SharedDataManager for global sync
            if (currentPatientId && window.sharedDataManager) {
                window.sharedDataManager.updateGlobalLungMonitoringLevel(currentPatientId, lungLevel);
                console.log(`✅ Saved lung level ${lungLevel} for patient ${currentPatientId}`);
                
                // Mark this as a recent manual change to prioritize it over calculated values
                sessionStorage.setItem('recentLungLevelChange', Date.now().toString());
                
                // APPLY TAG MONITORING DELTAS: Check for active tags and apply their monitoring deltas
                const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                const selectedProblem = medicalInfo?.selectedProblem || 'none';
                const selectedRiskLevel = medicalInfo?.selectedRiskLevel || 'low';
                
                // Get active condition tags
                const activeTags = [];
                const sepsisCondition = window.sharedDataManager.getPatientConditionState('sepsis', currentPatientId);
                const pneumonieCondition = window.sharedDataManager.getPatientConditionState('pneumonie', currentPatientId);
                
                if (sepsisCondition && sepsisCondition.isActive) {
                    activeTags.push('sepsis');
                }
                if (pneumonieCondition && pneumonieCondition.isActive) {
                    activeTags.push('pneumonie');
                }
                
                if (activeTags.length > 0) {
                    console.log(`🏷️ Active tags found: ${activeTags.join(', ')} - applying monitoring deltas to lung level`);
                    
                    // Apply tag-based monitoring deltas to the manually set level
                    const baseOrganStates = { heart: 'mid', lung: lungLevel, temp: 'mid' }; // Use current manual level as base
                    const tagAdjustments = window.sharedDataManager.calculateTagBasedParameterAdjustments(
                        activeTags, 
                        {}, // Empty target ranges - we only need organ state adjustments
                        baseOrganStates, 
                        selectedRiskLevel
                    );
                    
                    const adjustedLungLevel = tagAdjustments.adjustedOrganStates.lung;
                    
                    if (adjustedLungLevel !== lungLevel) {
                        console.log(`🔄 Tag adjustments changed lung level: ${lungLevel} → ${adjustedLungLevel}`);
                        
                        // Update the lung circle with the tag-adjusted level
                        if (window.respiratoryLungCircle) {
                            window.respiratoryLungCircle.setRiskLevel(adjustedLungLevel);
                        }
                        
                        // Save the adjusted level
                        window.sharedDataManager.setLungMonitoringLevel(currentPatientId, adjustedLungLevel);
                        console.log(`✅ Applied tag-adjusted lung level: ${adjustedLungLevel}`);
                    } else {
                        console.log(`ℹ️ No tag adjustment needed for lung level: ${lungLevel}`);
                    }
                } else {
                    console.log(`ℹ️ No active tags - using manual lung level: ${lungLevel}`);
                }
            }
            
            // Update sliders if they exist
            updateSlidersMonitoringLevel(level);
            
            // CONDITIONAL WEBSOCKET TRIGGER: Only send immediately if NOT part of tag parameter changes
            // Tag parameter changes have their own delayed websocket trigger to ensure proper order
            const isPartOfTagChange = sessionStorage.getItem('tagParameterChangeInProgress');
            if (!isPartOfTagChange) {
                console.log(`📤 Risk level changed - sending current display state via websocket`);
                if (window.sharedDataManager) {
                    window.sharedDataManager.sendFullThresholdsRiskLevels(currentPatientId);
                }
            } else {
                console.log(`⏸️ Risk level changed - skipping immediate websocket (tag change in progress)`);
            }
            
            console.log(`✅ Monitoring level changed to: ${level} (lung: ${lungLevel})`);
        }

        // Function to update risk level buttons based on current lung monitoring level
        function updateRiskLevelButtons() {
            if (!currentPatientId || !window.sharedDataManager) return;
            
            // Get current lung monitoring level from data manager
            const currentLungLevel = window.sharedDataManager.getLungMonitoringLevel(currentPatientId);
            console.log(`🔄 Updating risk level buttons for lung level: ${currentLungLevel}`);
            
            // Map lung levels to button levels
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight'
            };
            
            const buttonLevel = levelMapping[currentLungLevel] || 'mid';
            
            // Update button selection
            const allButtons = document.querySelectorAll('.btn.risk-low, .btn.risk-med, .btn.risk-high');
            allButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Add selected class to the correct button
            const targetButton = document.querySelector(`[data-level="${buttonLevel}"]`);
            if (targetButton) {
                targetButton.classList.add('selected');
                console.log(`✅ Updated risk level button selection to: ${buttonLevel} (lung level: ${currentLungLevel})`);
            } else {
                console.warn(`⚠️ Could not find button for level: ${buttonLevel}`);
            }
            
            // Also update the lung circle to reflect the new monitoring level
            if (window.respiratoryLungCircle && typeof window.respiratoryLungCircle.setRiskLevel === 'function') {
                window.respiratoryLungCircle.setRiskLevel(currentLungLevel);
                console.log(`🫁 Updated lung circle to reflect new monitoring level: ${currentLungLevel}`);
            } else {
                console.warn('⚠️ respiratoryLungCircle not available for update');
            }
        }

        function initializePage() {
            console.log('🔄 Initializing respiratory settings page...');
            
            // Try to get patient and session data from multiple sources
            if (window.sharedDataManager) {
                // First, try to get from URL parameters (if navigated directly)
                const urlParams = new URLSearchParams(window.location.search);
                const urlPatient = urlParams.get('patient');
                const urlBed = urlParams.get('bed');
                
                // Second, try to get from session data
                const sessionData = window.sharedDataManager.getSessionData();
                
                // Use URL parameters if available, otherwise use session data
                currentPatientId = urlPatient || sessionData.currentPatient;
                currentBed = urlBed || sessionData.currentBed;
                
                console.log('📋 Patient sources - URL:', urlPatient, 'Session:', sessionData.currentPatient);
                console.log('🛏️ Bed sources - URL:', urlBed, 'Session:', sessionData.currentBed);
                console.log('✅ Final selection - Patient:', currentPatientId, 'Bed:', currentBed);
                
                // If still no patient/bed data, redirect to bed overview
                if (!currentPatientId || !currentBed) {
                    console.warn('⚠️ No patient or bed data found, redirecting to bed overview');
                    alert('Geen patiëntgegevens gevonden. Ga terug naar het bedoverzicht om een patiënt te selecteren.');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Update session data to ensure consistency
                window.sharedDataManager.saveSessionData({
                    currentPatient: currentPatientId,
                    currentBed: currentBed,
                    lastUpdated: new Date().toISOString()
                });
                
                // Update header with patient info
                updatePatientHeader();
                
                // Initialize currentSettings from SharedDataManager
                initializeCurrentSettings();
                
                // Initialize monitoring level buttons to show saved state
                initializeMonitoringLevelButtons();
                
                // Initialize global variables for this patient (simple approach)
                if (window.sharedDataManager) {
                    window.sharedDataManager.initializeGlobalParameterVariables(currentPatientId);
                    console.log('✅ Global variables initialized for patient:', currentPatientId);
                }
            } else {
                console.error('❌ SharedDataManager not available');
                alert('Data manager niet beschikbaar. Herlaad de pagina.');
            }
        }

        function initializeMonitoringLevelButtons() {
            console.log('🔧 Initializing respiratory monitoring level buttons...');
            
            if (!currentPatientId || !window.sharedDataManager) {
                console.warn('❌ Cannot initialize monitoring buttons - missing patient ID or SharedDataManager');
                return;
            }
            
            // Get the EFFECTIVE saved lung monitoring level (including tag adjustments)
            const savedLevel = window.sharedDataManager.getEffectiveLungMonitoringLevel(currentPatientId);
            console.log('📊 Saved EFFECTIVE lung monitoring level:', savedLevel);
            
            // Map lung levels back to button levels
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight'
            };
            
            const buttonLevel = levelMapping[savedLevel] || 'mid';
            console.log('🔄 Mapped to button level:', buttonLevel);
            
            // Update button states - remove active/selected from all buttons
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            // Add selected class to the appropriate button
            const targetButton = document.querySelector(`[data-level="${buttonLevel}"]`);
            if (targetButton) {
                targetButton.classList.add('selected');
                console.log(`✅ Button ${buttonLevel} marked as selected`);
            } else {
                console.warn(`❌ Button with level ${buttonLevel} not found`);
            }
            
            // Update lung circle if it exists
            if (window.respiratoryLungCircle) {
                console.log(`🫁 Setting respiratory lung circle to: ${savedLevel}`);
                window.respiratoryLungCircle.setRiskLevel(savedLevel);
            } else {
                console.log('ℹ️ respiratoryLungCircle not yet available - will be set when created');
            }
            
            // Update sliders to match the level
            updateSlidersMonitoringLevel(buttonLevel);
            
            console.log('✅ Respiratory monitoring level buttons initialized');
        }

        function updatePatientHeader() {
            const headerElement = document.getElementById('patient-header-info');
            if (currentPatientId && currentBed) {
                const patientInfo = window.sharedDataManager.getPatientInfo(currentPatientId);
                const displayName = patientInfo?.name || `Patiënt ${currentPatientId}`;
                
                // Get medical information including main problem and risk level
                const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                
                let headerText = `${displayName} - Bed ${currentBed}`;
                
                // Add main problem if available
                if (medicalInfo?.selectedProblem) {
                    const problemMapping = {
                        'pneumonie': 'Pneumonie',
                        'pneumonia': 'Pneumonie',
                        'cardiac': 'Hartproblemen',
                        'surgery': 'Chirurgie',
                        'other': 'Anders'
                    };
                    const problemDisplay = problemMapping[medicalInfo.selectedProblem] || medicalInfo.selectedProblem;
                    headerText += ` | Hoofdprobleem: ${problemDisplay}`;
                }
                
                // Add risk level if available
                if (medicalInfo?.selectedRiskLevel) {
                    const riskMapping = {
                        'low': 'Laag',
                        'med': 'Middel',
                        'high': 'Hoog'
                    };
                    const riskDisplay = riskMapping[medicalInfo.selectedRiskLevel] || medicalInfo.selectedRiskLevel;
                    headerText += ` | Risiconiveau: ${riskDisplay}`;
                }
                
                headerElement.textContent = headerText;
            } else {
                headerElement.textContent = '';
            }
        }
        
        function initializePneumonieTagState() {
            console.log('🫁 Initializing pneumonie tag state...');
            
            if (currentPatientId && window.sharedDataManager) {
                // Ensure patient has clean state for new setup (but don't force clean existing states)
                window.sharedDataManager.ensureCleanPatientState(currentPatientId, false);
                
                // Check if pneumonie is currently selected using the new condition state method
                const pneumonieState = window.sharedDataManager.getPatientConditionState('pneumonie', currentPatientId);
                
                console.log('🔍 DEBUG RESPIRATORY: Pneumonie state:', pneumonieState);
                
                const pneumonieButton = document.querySelector('.circulatory-tag[data-condition="pneumonie"]');
                console.log('🔍 DEBUG RESPIRATORY: Button found:', !!pneumonieButton);
                
                if (pneumonieButton) {
                    if (pneumonieState && pneumonieState.isActive) {
                        pneumonieButton.classList.add('selected');
                        console.log('✅ RESPIRATORY: Initialized pneumonie button as SELECTED (isActive: true)');
                    } else {
                        pneumonieButton.classList.remove('selected');
                        console.log('✅ RESPIRATORY: Initialized pneumonie button as DESELECTED (isActive: ' + (pneumonieState?.isActive || 'undefined') + ')');
                    }
                } else {
                    console.warn('❌ RESPIRATORY: Pneumonie button not found!');
                }
                
                // Also initialize monitoring level based on EFFECTIVE stored level (including tag adjustments)
                const currentLungLevel = window.sharedDataManager.getEffectiveLungMonitoringLevel(currentPatientId);
                if (currentLungLevel && window.respiratoryLungCircle) {
                    console.log('🫁 Initializing EFFECTIVE lung monitoring level to:', currentLungLevel);
                    window.respiratoryLungCircle.setRiskLevel(currentLungLevel);
                    
                    // Update monitoring level buttons using existing helper function
                    const buttonLevel = currentLungLevel === 'low' ? 'loose' : 
                                      currentLungLevel === 'mid' ? 'mid' : 
                                      currentLungLevel === 'high' ? 'tight' : 'mid'; // Default to mid
                    
                    console.log('🫁 Initializing lung monitoring buttons for level:', currentLungLevel, '→', buttonLevel);
                    
                    if (typeof updateButtonStates === 'function') {
                        updateButtonStates(buttonLevel);
                        console.log('✅ Initialized monitoring level buttons using helper function');
                    } else {
                        // Fallback: Direct button update if helper function not available
                        document.querySelectorAll('.button-group .btn').forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        
                        const selectedButton = document.querySelector(`.button-group .btn[data-level="${buttonLevel}"]`);
                        if (selectedButton) {
                            selectedButton.classList.add('selected');
                            console.log('✅ Initialized monitoring level button to:', buttonLevel, 'for lung level:', currentLungLevel);
                        } else {
                            console.warn('❌ Could not find monitoring button for level:', buttonLevel, 'lung level:', currentLungLevel);
                        }
                    }
                }
            }
        }

        function setupEventListeners() {
            console.log('🔧 Setting up event listeners...');
            
            // FORCE SLIDER REFRESH FUNCTION: Can be called from other pages to update sliders
            window.forceAllSlidersRefresh = function() {
                console.log('💪 FORCE REFRESH - Respiratory sliders');
                console.log('💪 Global variables - AF:', window.AF_MIN, '-', window.AF_MAX, 'SAT:', window.SAT_MIN, '-', window.SAT_MAX);
                
                if (afSlider && afSlider.config && afSlider.config.targetRange) {
                    console.log('💪 Force updating AF slider:', window.AF_MIN, '-', window.AF_MAX);
                    afSlider.config.targetRange.min = window.AF_MIN;
                    afSlider.config.targetRange.max = window.AF_MAX;
                    afSlider.currentMin = window.AF_MIN;
                    afSlider.currentMax = window.AF_MAX;
                    if (afSlider.updateSliderPosition) {
                        afSlider.updateSliderPosition();
                    }
                }
                
                if (saturatieSlider && saturatieSlider.config && saturatieSlider.config.targetRange) {
                    console.log('💪 Force updating Saturatie slider:', window.SAT_MIN, '-', window.SAT_MAX);
                    saturatieSlider.config.targetRange.min = window.SAT_MIN;
                    saturatieSlider.config.targetRange.max = window.SAT_MAX;
                    saturatieSlider.currentMin = window.SAT_MIN;
                    saturatieSlider.currentMax = window.SAT_MAX;
                    if (saturatieSlider.updateSliderPosition) {
                        saturatieSlider.updateSliderPosition();
                    }
                }
            };
            
            // SIMPLE APPROACH: Listen for global parameter changes from problem changes
            window.addEventListener('globalParametersChanged', function(event) {
                console.log('🌐 Respiratory page received global parameters changed:', event.detail);
                console.log('🌐 Current global variables - AF:', window.AF_MIN, '-', window.AF_MAX, 'SAT:', window.SAT_MIN, '-', window.SAT_MAX);
                console.log('🌐 Slider availability - afSlider:', !!afSlider, 'saturatieSlider:', !!saturatieSlider);
                
                // ROBUST APPROACH: Force complete slider refresh from global variables
                if (afSlider && afSlider.config && afSlider.config.targetRange) {
                    console.log('🔄 Updating AF slider config and position...');
                    console.log('   - Old AF range:', afSlider.config.targetRange.min, '-', afSlider.config.targetRange.max);
                    afSlider.config.targetRange.min = window.AF_MIN;
                    afSlider.config.targetRange.max = window.AF_MAX;
                    afSlider.currentMin = window.AF_MIN;
                    afSlider.currentMax = window.AF_MAX;
                    if (afSlider.updateSliderPosition) {
                        afSlider.updateSliderPosition();
                    }
                    console.log('✅ AF slider forced to:', window.AF_MIN, '-', window.AF_MAX);
                } else {
                    console.log('❌ AF slider not available or not properly initialized');
                }
                
                if (saturatieSlider && saturatieSlider.config && saturatieSlider.config.targetRange) {
                    console.log('🔄 Updating Saturatie slider config and position...');
                    console.log('   - Old SAT range:', saturatieSlider.config.targetRange.min, '-', saturatieSlider.config.targetRange.max);
                    saturatieSlider.config.targetRange.min = window.SAT_MIN;
                    saturatieSlider.config.targetRange.max = window.SAT_MAX;
                    saturatieSlider.currentMin = window.SAT_MIN;
                    saturatieSlider.currentMax = window.SAT_MAX;
                    if (saturatieSlider.updateSliderPosition) {
                        saturatieSlider.updateSliderPosition();
                    }
                    console.log('✅ Saturatie slider forced to:', window.SAT_MIN, '-', window.SAT_MAX);
                } else {
                    console.log('❌ Saturatie slider not available or not properly initialized');
                }
            });

            // Listen for tag parameter changes (sepsis/pneumonie)
            window.addEventListener('tagParametersChanged', function(event) {
                console.log('🏷️ Respiratory page received tag parameters changed:', event.detail);
                const { patientId, parameters, changedTags, organStates } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    // Update tag button visual states for changed tags
                    if (changedTags && changedTags.includes('pneumonie')) {
                        const pneumonieState = window.sharedDataManager.getPatientConditionState('pneumonie', currentPatientId);
                        const pneumonieButton = document.querySelector('.circulatory-tag[data-condition="pneumonie"]');
                        
                        if (pneumonieButton) {
                            if (pneumonieState && pneumonieState.isActive) {
                                pneumonieButton.classList.add('selected');
                                console.log('✅ Updated pneumonie button to SELECTED from cross-page sync');
                            } else {
                                pneumonieButton.classList.remove('selected');
                                console.log('✅ Updated pneumonie button to DESELECTED from cross-page sync');
                            }
                        }
                    }
                    
                    // Update lung monitoring level if organ states changed
                    if (organStates && organStates.lung !== undefined) {
                        const newLungLevel = organStates.lung;
                        console.log('🫁 Updating lung monitoring level from tag change:', newLungLevel);
                        
                        // Update lung circle visual state
                        if (window.respiratoryLungCircle) {
                            window.respiratoryLungCircle.setRiskLevel(newLungLevel);
                            console.log('✅ Updated respiratory lung circle to:', newLungLevel);
                        }
                        
                        // Update monitoring level buttons visual state using existing helper function
                        const buttonLevel = newLungLevel === 'low' ? 'loose' : 
                                          newLungLevel === 'mid' ? 'mid' : 
                                          newLungLevel === 'high' ? 'tight' : 'mid'; // Default to mid
                        
                        console.log('🫁 Updating lung monitoring buttons for level:', newLungLevel, '→', buttonLevel);
                        
                        // Use existing updateButtonStates helper function for consistency
                        if (typeof updateButtonStates === 'function') {
                            updateButtonStates(buttonLevel);
                            console.log('✅ Updated monitoring level buttons using helper function');
                        } else {
                            // Fallback: Direct button update if helper function not available
                            document.querySelectorAll('.button-group .btn').forEach(btn => {
                                btn.classList.remove('selected');
                            });
                            
                            const selectedButton = document.querySelector(`.button-group .btn[data-level="${buttonLevel}"]`);
                            if (selectedButton) {
                                selectedButton.classList.add('selected');
                                console.log('✅ Updated monitoring level button to:', buttonLevel, 'for lung level:', newLungLevel);
                            } else {
                                console.warn('❌ Could not find monitoring button for level:', buttonLevel, 'lung level:', newLungLevel);
                            }
                        }
                        
                        // Update sliders to reflect new monitoring level
                        if (typeof updateSlidersMonitoringLevel === 'function') {
                            updateSlidersMonitoringLevel(buttonLevel);
                            console.log('✅ Updated sliders for monitoring level:', buttonLevel);
                        }
                    }
                    
                    // Update parameter ranges if provided
                    if (parameters) {
                        // Update AF slider if tag parameters include AF
                        if (parameters.AF && afSlider && afSlider.config && afSlider.config.targetRange) {
                            console.log('🔄 Updating AF slider from tag parameters:', parameters.AF.min, '-', parameters.AF.max);
                            afSlider.config.targetRange.min = parameters.AF.min;
                            afSlider.config.targetRange.max = parameters.AF.max;
                            afSlider.currentMin = parameters.AF.min;
                            afSlider.currentMax = parameters.AF.max;
                            if (afSlider.updateSliderPosition) {
                                afSlider.updateSliderPosition();
                            }
                            console.log('✅ AF slider updated from tag parameters');
                        }
                        
                        // Update Saturatie slider if tag parameters include Saturatie
                        if (parameters.Saturatie && saturatieSlider && saturatieSlider.config && saturatieSlider.config.targetRange) {
                            console.log('🔄 Updating Saturatie slider from tag parameters:', parameters.Saturatie.min, '-', parameters.Saturatie.max);
                            saturatieSlider.config.targetRange.min = parameters.Saturatie.min;
                            saturatieSlider.config.targetRange.max = parameters.Saturatie.max;
                            saturatieSlider.currentMin = parameters.Saturatie.min;
                            saturatieSlider.currentMax = parameters.Saturatie.max;
                            if (saturatieSlider.updateSliderPosition) {
                                saturatieSlider.updateSliderPosition();
                            }
                            console.log('✅ Saturatie slider updated from tag parameters');
                        }
                    }
                }
            });

            
            // SIMPLE APPROACH: Function to update HR slider with correct global variables
            function updateHRSliderFromGlobalValues() {
                if (typeof window.HR_MIN !== 'undefined' && typeof window.HR_MAX !== 'undefined') {
                    console.log('🔄 Forcing HR slider update with global values:', window.HR_MIN, '-', window.HR_MAX);
                    
                    if (hrSlider && typeof hrSlider.updateConfig === 'function') {
                        hrSlider.updateConfig({
                            targetRange: {
                                min: window.HR_MIN,
                                max: window.HR_MAX
                            }
                        });
                        console.log('✅ HR slider FORCE updated from globals:', window.HR_MIN, '-', window.HR_MAX);
                    } else {
                        console.warn('⚠️ HR slider not available for global update');
                    }
                } else {
                    console.warn('⚠️ Global HR_MIN or HR_MAX not available');
                }
            }
            
            // Test function to force sepsis range (90-130) - for debugging
            function testSepsisRange() {
                window.HR_MIN = 90;
                window.HR_MAX = 130;
                console.log('🧪 TEST: Set globals to sepsis range 90-130');
                updateHRSliderFromGlobalValues();
            }
            
            // Make test function available globally for debugging
            window.testSepsisRange = testSepsisRange;
            
            // SIMPLE APPROACH: Function to refresh sliders from global variables
            function refreshSlidersFromTargetRanges() {
                console.log('🔄 Refreshing respiratory sliders from global variables');
                
                // Update AF slider with current global variables
                if (afSlider && typeof afSlider.updateConfig === 'function') {
                    afSlider.updateConfig({
                        targetRange: {
                            min: window.AF_MIN,
                            max: window.AF_MAX
                        }
                    });
                    // Force visual position refresh
                    if (afSlider.updateSliderPosition) {
                        afSlider.updateSliderPosition();
                    }
                    console.log('✅ AF slider updated from globals:', window.AF_MIN, '-', window.AF_MAX);
                }
                
                // Update Saturatie slider with current global variables
                if (saturatieSlider && typeof saturatieSlider.updateConfig === 'function') {
                    saturatieSlider.updateConfig({
                        targetRange: {
                            min: window.SAT_MIN,
                            max: window.SAT_MAX
                        }
                    });
                    // Force visual position refresh
                    if (saturatieSlider.updateSliderPosition) {
                        saturatieSlider.updateSliderPosition();
                    }
                    console.log('✅ Saturatie slider updated from globals:', window.SAT_MIN, '-', window.SAT_MAX);
                }
                
                console.log('✅ All respiratory sliders refreshed from global variables');
            }
            
            // Listen for HR range changes from sepsis selection/deselection
            window.addEventListener('hrRangesChanged', function(event) {
                console.log('💓 HR ranges changed event received in circulatoir-settings:', event.detail);
                
                const { patientId, HR_low, HR_high, BP_low, BP_high, source } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    console.log('🔄 Updating HR slider with new ranges:', HR_low, '-', HR_high, 'source:', source);
                    
                    // Update currentSettings
                    currentSettings.hr = {
                        min: HR_low,
                        max: HR_high
                    };
                    
                    // Update BP settings if BP ranges are provided
                    if (typeof BP_low !== 'undefined' && typeof BP_high !== 'undefined') {
                        console.log('🩸 Updating BP slider with new ranges:', BP_low, '-', BP_high, 'source:', source);
                        currentSettings.bp = {
                            min: BP_low,
                            max: BP_high
                        };
                        
                        // Update BP slider if it exists
                        if (bpSlider && typeof bpSlider.updateConfig === 'function') {
                            bpSlider.updateConfig({
                                targetRange: {
                                    min: BP_low,
                                    max: BP_high
                                }
                            });
                            console.log('✅ BP slider updated with new ranges');
                        }
                    }
                    
                    // Force update HR slider using global values
                    updateHRSliderFromGlobalValues();
                }
            });
            
            // UNIFIED TAG HANDLING: Set up respiratory tag button listeners
            const circulatoryTagButtons = document.querySelectorAll('.circulatory-tag');
            circulatoryTagButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tagCondition = this.dataset.condition;
                    const isCurrentlySelected = this.classList.contains('selected');
                    const newState = !isCurrentlySelected;
                    
                    console.log(`🏷️ UNIFIED TAG (RESP): ${tagCondition} clicked, changing from ${isCurrentlySelected} to ${newState}`);
                    
                    // Use unified tag system for pneumonie
                    if (tagCondition === 'pneumonie' && currentPatientId && window.sharedDataManager) {
                        const result = window.sharedDataManager.toggleConditionTag(currentPatientId, 'pneumonie', newState);
                        
                        if (result && result.skipped) {
                            console.log(`⚠️ UNIFIED TAG (RESP): Tag ${tagCondition} toggle skipped - ${result.reason}`);
                            return; // Don't update UI if operation was skipped
                        }
                        
                        // Update local UI
                        if (newState) {
                            this.classList.add('selected');
                        } else {
                            this.classList.remove('selected');
                        }
                        
                        console.log(`🏷️ UNIFIED TAG (RESP): ${tagCondition} ${newState ? 'selected' : 'deselected'} via unified system`);
                        
                        // Backup timeout to ensure UI updates
                        setTimeout(() => {
                            console.log('🔄 BACKUP (RESP): Forcing slider refresh...');
                            refreshSlidersFromTargetRanges();
                            updateRiskLevelButtons(); // Also update buttons and lung circle
                        }, 50);
                    }
                });
            });
            
            // UNIFIED TAG SYSTEM: Listen for immediate UI updates after tag changes
            window.addEventListener('unifiedTagUIUpdateRequired', function(event) {
                console.log('🔄 UNIFIED TAG (RESP): Immediate UI update required:', event.detail);
                
                const { patientId, activeTags, targetRanges, organStates } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    console.log('🏷️ UNIFIED TAG (RESP): Applying immediate slider updates...');
                    console.log('   - Active tags:', activeTags);
                    console.log('   - Target ranges:', targetRanges);
                    console.log('   - Organ states:', organStates);
                    
                    // Immediately refresh sliders with new target ranges
                    if (targetRanges) {
                        console.log('🔄 UNIFIED TAG (RESP): Calling refreshSlidersFromTargetRanges()...');
                        refreshSlidersFromTargetRanges();
                    }
                    
                    // Update risk level buttons to reflect new monitoring levels
                    updateRiskLevelButtons();
                    
                    console.log('✅ UNIFIED TAG (RESP): Immediate slider updates completed');
                } else {
                    console.log('⏭️ UNIFIED TAG (RESP): Skipping slider update - different patient');
                }
            });
            
            // UNIFIED TAG SYSTEM: Listen for unified tag state synchronization
            window.addEventListener('unifiedTagStateSyncRequired', function(event) {
                console.log('🔄 UNIFIED TAG (RESP): Sync required event received:', event.detail);
                
                const { patientId, tagStates } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId) {
                    console.log('🏷️ UNIFIED TAG (RESP): Syncing UI with tag states:', tagStates);
                    
                    // Update pneumonie button
                    if (tagStates.hasOwnProperty('pneumonie')) {
                        const pneumonieButton = document.querySelector('.circulatory-tag[data-condition="pneumonie"]');
                        if (pneumonieButton) {
                            if (tagStates.pneumonie) {
                                pneumonieButton.classList.add('selected');
                            } else {
                                pneumonieButton.classList.remove('selected');
                            }
                            console.log(`🏷️ UNIFIED TAG (RESP): Synced pneumonie to ${tagStates.pneumonie ? 'SELECTED' : 'DESELECTED'}`);
                        }
                    }
                    
                    // Refresh sliders with timeout to ensure data is processed
                    setTimeout(() => {
                        console.log('🔄 UNIFIED TAG (RESP): Refreshing sliders after sync event...');
                        refreshSlidersFromTargetRanges();
                        updateRiskLevelButtons(); // Update risk level buttons too
                        console.log('✅ UNIFIED TAG (RESP): Slider refresh completed after sync');
                    }, 100);
                }
            });
            
            // LEGACY: Listen for condition state changes from other pages (for backward compatibility)
            window.addEventListener('patientConditionStateChanged', function(event) {
                console.log('🫁 LEGACY (RESP): Condition state changed event received:', event.detail);
                
                const { condition, state } = event.detail;
                
                // Only handle pneumonie and current patient, but skip unified triggers
                if (condition === 'pneumonie' && state.patientId === currentPatientId && state.triggeredBy !== 'unified_toggle') {
                    const pneumonieButton = document.querySelector('.circulatory-tag[data-condition="pneumonie"]');
                    if (pneumonieButton) {
                        if (state.isActive) {
                            if (!pneumonieButton.classList.contains('selected')) {
                                pneumonieButton.classList.add('selected');
                                console.log('✅ LEGACY (RESP): Synced pneumonie button to selected state from external change');
                            }
                        } else {
                            if (pneumonieButton.classList.contains('selected')) {
                                pneumonieButton.classList.remove('selected');
                                console.log('✅ LEGACY (RESP): Synced pneumonie button to deselected state from external change');
                            }
                        }
                    }
                }
            });
            
            // DISABLED: Listen for AF range changes from pneumonie selection/deselection
            // Pneumonie no longer changes AF ranges, only visual state
            /*
            window.addEventListener('afRangesChanged', function(event) {
                console.log('🫁 AF ranges changed event received in respiratory settings:', event.detail);
                
                const { patientId, AF_min, AF_max, source } = event.detail;
                
                // Only update if it's for the current patient
                if (patientId === currentPatientId && afSlider) {
                    console.log('🔄 Updating AF slider config and positions...');
                    
                    // Update the slider's config
                    afSlider.config.targetRange.min = AF_min;
                    afSlider.config.targetRange.max = AF_max;
                    
                    // Update the current slider handle positions to match the new range
                    afSlider.currentMin = AF_min;
                    afSlider.currentMax = AF_max;
                    
                    // Update the original values so the slider doesn't think these are user changes
                    afSlider.originalMin = AF_min;
                    afSlider.originalMax = AF_max;
                    
                    // Force re-render the slider to show new target range and positions
                    if (afSlider.updateSliderPosition) {
                        afSlider.updateSliderPosition();
                        console.log(`✅ Re-rendered AF slider with new target range and positions ${AF_min}-${AF_max} due to ${source}`);
                    } else {
                        console.warn('❌ updateSliderPosition method not available on AF slider');
                    }
                }
            });
            */
            
            // Event listeners are now handled by the slider components
        }
        



        function initializeSliders() {
            console.log('🎛️ Initializing respiratory sliders...');
            
            // Debug: Check if containers exist
            const saturatieContainer = document.getElementById('saturatie-slider-container');
            const afContainer = document.getElementById('af-slider-container');
            console.log('Saturatie Container found:', !!saturatieContainer);
            console.log('AF Container found:', !!afContainer);
            
            // Check if slider components are loaded
            console.log('VitalParameterSlider available:', !!window.VitalParameterSlider);
            console.log('PatientConfigurationHelper available:', !!window.PatientConfigurationHelper);
            console.log('SharedDataManager available:', !!window.sharedDataManager);
            
            if (!window.VitalParameterSlider) {
                console.error('❌ VitalParameterSlider class not found');
                if (saturatieContainer) saturatieContainer.innerHTML = '<p style="color: red;">Slider component not loaded - VitalParameterSlider missing</p>';
                return;
            }
            
            if (!window.PatientConfigurationHelper) {
                console.error('❌ PatientConfigurationHelper class not found');
                if (afContainer) afContainer.innerHTML = '<p style="color: red;">Slider component not loaded - PatientConfigurationHelper missing</p>';
                return;
            }
            
            if (!currentPatientId) {
                console.error('❌ No patient ID available for sliders');
                if (saturatieContainer) saturatieContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                if (afContainer) afContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                return;
            }
            
            console.log('✅ All prerequisites met, creating respiratory sliders for patient:', currentPatientId);
            
            try {
                // Debug: Check what data we have
                console.log('Current patient ID:', currentPatientId);
                const patientInfo = window.sharedDataManager ? window.sharedDataManager.getPatientInfo(currentPatientId) : null;
                const patientSettings = window.sharedDataManager ? window.sharedDataManager.getPatientRespiratorySettings(currentPatientId) : null;
                console.log('Patient info:', patientInfo);
                console.log('Patient respiratory settings:', patientSettings);
                
                // Initialize Saturatie Slider
                const saturatieContainer = document.getElementById('saturatie-slider-container');
                if (saturatieContainer) {
                    console.log('🫁 Creating Saturatie slider...');
                    saturatieContainer.innerHTML = '<p style="color: blue;">Loading Saturatie slider...</p>';
                    
                    try {
                        // GET ACTUAL STORED TARGET RANGES FIRST
                        let satTargetRange = { min: 94, max: 98 }; // Safe defaults
                        
                        if (currentPatientId && window.sharedDataManager) {
                            const currentTargetRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
                            if (currentTargetRanges && currentTargetRanges.Saturatie) {
                                satTargetRange = {
                                    min: currentTargetRanges.Saturatie.min,
                                    max: currentTargetRanges.Saturatie.max
                                };
                                console.log('📊 Using stored Saturatie target range for slider initialization:', satTargetRange);
                                
                                // Update global variables to match stored data
                                window.SAT_MIN = satTargetRange.min;
                                window.SAT_MAX = satTargetRange.max;
                                console.log('🔄 Updated global Saturatie variables to match stored data:', window.SAT_MIN, '-', window.SAT_MAX);
                            } else {
                                console.log('⚠️ No stored Saturatie target range found, using defaults:', satTargetRange);
                                
                                // Set global variables to defaults
                                window.SAT_MIN = satTargetRange.min;
                                window.SAT_MAX = satTargetRange.max;
                            }
                        }
                        
                        window.saturatieSlider = new window.VitalParameterSlider(saturatieContainer, {
                            parameter: 'Saturatie',
                            name: 'Saturatie',
                            unit: '%',
                            targetRange: satTargetRange, // Use actual stored data, not global variables
                            yAxis: { min: 80, max: 100, step: 5 },
                            monitoringLevel: 'mid',
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Patiënt ${currentPatientId}`,
                            onChange: (data) => {
                                console.log('Saturatie Slider changed:', data);
                                if (data.type === 'save') {
                                    console.log('💾 Saturatie Slider SAVE - UPDATE of global variables for BOTH sliders');
                                    
                                    // Update Saturatie global variables from this slider
                                    window.SAT_MIN = Math.round(data.min);
                                    window.SAT_MAX = Math.round(data.max);
                                    
                                    // IMPORTANT: Also update AF global variables from the AF slider's current state
                                    // This prevents the AF slider's unsaved changes from being lost
                                    if (window.afSlider) {
                                        window.AF_MIN = Math.round(window.afSlider.currentMin);
                                        window.AF_MAX = Math.round(window.afSlider.currentMax);
                                        console.log('🔄 Also updated AF globals from AF slider state:', window.AF_MIN, '-', window.AF_MAX);
                                    }
                                    
                                    // Save to localStorage
                                    if (window.sharedDataManager) {
                                        window.sharedDataManager.saveGlobalParameterVariables();
                                        console.log('💾 Saved global variables to localStorage');
                                        
                                        // CRITICAL: Save to patient-specific storage for WebSocket messaging
                                        
                                        // DEBUG: Check data BEFORE saving
                                        console.log('🔍 BEFORE SAVE - Current target ranges:', window.sharedDataManager.getCurrentTargetRanges(currentPatientId));
                                        console.log('🔍 BEFORE SAVE - New Saturatie:', window.SAT_MIN, '-', window.SAT_MAX);
                                        console.log('🔍 BEFORE SAVE - New AF:', window.AF_MIN, '-', window.AF_MAX);
                                        console.log('🔍 BEFORE SAVE - PatientId:', currentPatientId);
                                        
                                        // Get current ranges and update both parameters at once to avoid race conditions
                                        const currentRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
                                        currentRanges.Saturatie = {
                                            min: window.SAT_MIN,
                                            max: window.SAT_MAX,
                                            unit: '%'
                                        };
                                        currentRanges.AF = {
                                            min: window.AF_MIN,
                                            max: window.AF_MAX,
                                            unit: '/min'
                                        };
                                        // Save all ranges at once
                                        window.sharedDataManager.setCurrentTargetRanges(currentPatientId, currentRanges, 'slider-save');
                                        
                                        // DEBUG: Check data AFTER saving
                                        console.log('🔍 AFTER SAVE - Updated target ranges:', window.sharedDataManager.getCurrentTargetRanges(currentPatientId));
                                        
                                        // SEND WEBSOCKET MESSAGE: Manual threshold adjustment completed
                                        console.log('📤 Sending WebSocket message for manual Saturatie/AF threshold adjustment');
                                        window.sharedDataManager.sendFullThresholdsRiskLevels(currentPatientId);
                                    }
                                    
                                    // Update all displays on all pages immediately
                                    console.log('🔄 Updating displays across all pages...');
                                    setTimeout(() => {
                                        window.dispatchEvent(new CustomEvent('globalParametersChanged', {
                                            detail: { parameter: 'Saturatie', min: window.SAT_MIN, max: window.SAT_MAX }
                                        }));
                                    }, 10);
                                    
                                    console.log('✅ Saturatie global variables updated:', window.SAT_MIN, '-', window.SAT_MAX);
                                }
                            }
                        });
                        
                        if (window.saturatieSlider) {
                            console.log('✅ Saturatie Slider initialized successfully');
                        } else {
                            console.error('❌ Saturatie Slider initialization returned null');
                            saturatieContainer.innerHTML = '<p style="color: red;">Saturatie Slider initialization returned null</p>';
                        }
                    } catch (error) {
                        console.error('❌ Saturatie Slider creation error:', error);
                        saturatieContainer.innerHTML = `<p style="color: red;">Saturatie Slider error: ${error.message}</p>`;
                    }
                }
                
                // Initialize AF Slider
                const afContainer = document.getElementById('af-slider-container');
                if (afContainer) {
                    console.log('🌬️ Creating AF slider...');
                    console.log('🔍 DEBUG: currentSettings.af before AF slider creation:', currentSettings.af);
                    
                    // Double-check target ranges right before slider creation
                    const targetRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
                    console.log('🔍 DEBUG: Target ranges right before AF slider creation:', targetRanges?.AF);
                    
                    // If pneumonie is active, apply matrix-based adjusted ranges
                    if (currentPatientId && window.sharedDataManager) {
                        const pneumonieState = window.sharedDataManager.getPatientConditionState('pneumonie', currentPatientId);
                        if (pneumonieState && pneumonieState.isActive) {
                            // Get matrix-based adjusted ranges for pneumonie
                            const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                            const baseTargetRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId) || {};
                            const currentRiskLevel = medicalInfo?.selectedRiskLevel || 'low';
                            const selectedProblem = medicalInfo?.selectedProblem || 'none';
                            
                            const baseResult = window.sharedDataManager.applyProblemSpecificMonitoring(
                                selectedProblem, null, null, currentRiskLevel, false
                            );
                            
                            const tagAdjustments = window.sharedDataManager.calculateTagBasedParameterAdjustments(
                                ['pneumonie'], 
                                baseTargetRanges, 
                                baseResult.organStates, 
                                currentRiskLevel
                            );
                            
                            if (tagAdjustments.adjustedRanges.AF) {
                                console.log('🫁 Pneumonie is active - using matrix-based AF range for slider initialization:', tagAdjustments.adjustedRanges.AF);
                                currentSettings.af = { 
                                    min: tagAdjustments.adjustedRanges.AF.min, 
                                    max: tagAdjustments.adjustedRanges.AF.max 
                                };
                            }
                        }
                    }
                    
                    console.log('🔍 DEBUG: Final currentSettings.af for AF slider creation:', currentSettings.af);
                    afContainer.innerHTML = '<p style="color: blue;">Loading AF slider...</p>';
                    
                    try {
                        // GET ACTUAL STORED TARGET RANGES FIRST
                        let afTargetRange = { min: 12, max: 20 }; // Safe defaults
                        
                        if (currentPatientId && window.sharedDataManager) {
                            const currentTargetRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
                            if (currentTargetRanges && currentTargetRanges.AF) {
                                afTargetRange = {
                                    min: currentTargetRanges.AF.min,
                                    max: currentTargetRanges.AF.max
                                };
                                console.log('📊 Using stored AF target range for slider initialization:', afTargetRange);
                                
                                // Update global variables to match stored data
                                window.AF_MIN = afTargetRange.min;
                                window.AF_MAX = afTargetRange.max;
                                console.log('🔄 Updated global AF variables to match stored data:', window.AF_MIN, '-', window.AF_MAX);
                            } else {
                                console.log('⚠️ No stored AF target range found, using defaults:', afTargetRange);
                                
                                // Set global variables to defaults
                                window.AF_MIN = afTargetRange.min;
                                window.AF_MAX = afTargetRange.max;
                            }
                        }
                        
                        window.afSlider = new window.VitalParameterSlider(afContainer, {
                            parameter: 'AF',
                            name: 'Ademfrequentie',
                            unit: '/min',
                            targetRange: afTargetRange, // Use actual stored data, not global variables
                            yAxis: { min: 5, max: 35, step: 5 },
                            monitoringLevel: 'mid',
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Patiënt ${currentPatientId}`,
                            onChange: (data) => {
                                console.log('AF Slider changed:', data);
                                if (data.type === 'save') {
                                    console.log('💾 AF Slider SAVE - UPDATE of global variables for BOTH sliders');
                                    
                                    // Update AF global variables from this slider
                                    window.AF_MIN = Math.round(data.min);
                                    window.AF_MAX = Math.round(data.max);
                                    
                                    // IMPORTANT: Also update Saturatie global variables from the Saturatie slider's current state
                                    // This prevents the Saturatie slider's unsaved changes from being lost
                                    if (window.saturatieSlider) {
                                        window.SAT_MIN = Math.round(window.saturatieSlider.currentMin);
                                        window.SAT_MAX = Math.round(window.saturatieSlider.currentMax);
                                        console.log('🔄 Also updated Saturatie globals from Saturatie slider state:', window.SAT_MIN, '-', window.SAT_MAX);
                                    }
                                    
                                    // Save to localStorage
                                    if (window.sharedDataManager) {
                                        window.sharedDataManager.saveGlobalParameterVariables();
                                        console.log('💾 Saved global variables to localStorage');
                                        
                                        // CRITICAL: Save to patient-specific storage for WebSocket messaging
                                        
                                        // DEBUG: Check data BEFORE saving
                                        console.log('🔍 BEFORE SAVE - Current target ranges:', window.sharedDataManager.getCurrentTargetRanges(currentPatientId));
                                        console.log('🔍 BEFORE SAVE - New AF:', window.AF_MIN, '-', window.AF_MAX);
                                        console.log('🔍 BEFORE SAVE - New Saturatie:', window.SAT_MIN, '-', window.SAT_MAX);
                                        console.log('🔍 BEFORE SAVE - PatientId:', currentPatientId);
                                        
                                        // Get current ranges and update both parameters at once to avoid race conditions
                                        const currentRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
                                        currentRanges.AF = {
                                            min: window.AF_MIN,
                                            max: window.AF_MAX,
                                            unit: '/min'
                                        };
                                        currentRanges.Saturatie = {
                                            min: window.SAT_MIN,
                                            max: window.SAT_MAX,
                                            unit: '%'
                                        };
                                        // Save all ranges at once
                                        window.sharedDataManager.setCurrentTargetRanges(currentPatientId, currentRanges, 'slider-save');
                                        
                                        // DEBUG: Check data AFTER saving
                                        console.log('🔍 AFTER SAVE - Updated target ranges:', window.sharedDataManager.getCurrentTargetRanges(currentPatientId));
                                        
                                        // SEND WEBSOCKET MESSAGE: Manual threshold adjustment completed
                                        console.log('📤 Sending WebSocket message for manual AF/Saturatie threshold adjustment');
                                        window.sharedDataManager.sendFullThresholdsRiskLevels(currentPatientId);
                                    }
                                    
                                    // Update all displays on all pages immediately
                                    console.log('🔄 Updating displays across all pages...');
                                    setTimeout(() => {
                                        window.dispatchEvent(new CustomEvent('globalParametersChanged', {
                                            detail: { parameter: 'AF', min: window.AF_MIN, max: window.AF_MAX }
                                        }));
                                    }, 10);
                                    
                                    console.log('✅ AF global variables updated:', window.AF_MIN, '-', window.AF_MAX);
                                }
                            }
                        });
                        
                        if (window.afSlider) {
                            console.log('✅ AF Slider initialized successfully');
                            
                            // Always update AF slider from current target ranges
                            if (currentPatientId && window.sharedDataManager) {
                                const targetRanges = window.sharedDataManager.getCurrentTargetRanges(currentPatientId);
                                console.log('🔄 Loading AF target ranges after slider creation:', targetRanges);
                                
                                if (targetRanges && targetRanges.AF) {
                                    console.log('🔄 Updating AF slider to current target ranges:', targetRanges.AF.min, '-', targetRanges.AF.max);
                                    
                                    // Update the slider to use current target ranges
                                    window.afSlider.config.targetRange.min = targetRanges.AF.min;
                                    window.afSlider.config.targetRange.max = targetRanges.AF.max;
                                    window.afSlider.currentMin = targetRanges.AF.min;
                                    window.afSlider.currentMax = targetRanges.AF.max;
                                    window.afSlider.originalMin = targetRanges.AF.min;
                                    window.afSlider.originalMax = targetRanges.AF.max;
                                    
                                    // Force re-render the slider to show current ranges
                                    if (window.afSlider.updateSliderPosition) {
                                        window.afSlider.updateSliderPosition();
                                        console.log('✅ AF slider updated to current target ranges:', targetRanges.AF.min, '-', targetRanges.AF.max, targetRanges.AF.unit);
                                    }
                                }
                            }
                        } else {
                            console.error('❌ AF Slider initialization returned null');
                            afContainer.innerHTML = '<p style="color: red;">AF Slider initialization returned null</p>';
                        }
                    } catch (error) {
                        console.error('❌ AF Slider creation error:', error);
                        afContainer.innerHTML = `<p style="color: red;">AF Slider error: ${error.message}</p>`;
                    }
                }
                
            } catch (error) {
                console.error('❌ Error initializing respiratory sliders:', error);
                document.getElementById('saturatie-slider-container').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                document.getElementById('af-slider-container').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // Legacy functions removed - functionality now handled by slider components

        function goBackToAlarmOverview() {
            console.log('🔙 Navigating back to alarm overview');
            
            // Ensure session data is preserved when going back
            if (currentPatientId && currentBed && window.sharedDataManager) {
                // Update session data to maintain patient context
                window.sharedDataManager.saveSessionData({
                    currentPatient: currentPatientId,
                    currentBed: currentBed,
                    lastUpdated: new Date().toISOString()
                });
                
                console.log('✅ Session data preserved for patient:', currentPatientId, 'bed:', currentBed);
                
                // Navigate back to alarm overview with proper URL parameters
                const alarmUrl = `alarm-overview.html?bed=${currentBed}&patient=${currentPatientId}`;
                console.log('🔗 Navigating to:', alarmUrl);
                window.location.href = alarmUrl;
            } else {
                console.warn('⚠️ Missing patient or bed data, redirecting to bed overview');
                window.location.href = 'index.html';
            }
        }

        function goToCirculatorySettings() {
            console.log('➡️ Navigating to circulatory settings');
            
            // Ensure session data is preserved when going to circulatory
            if (currentPatientId && currentBed && window.sharedDataManager) {
                // Update session data to maintain patient context
                window.sharedDataManager.saveSessionData({
                    selectedBed: currentBed,
                    patientId: currentPatientId,
                    previousPage: 'respiratory-settings'
                });
                
                console.log('✅ Session data preserved for patient:', currentPatientId, 'bed:', currentBed);
                
                // Navigate to circulatory settings with proper URL parameters
                const circulatoryUrl = `circulatoir-settings.html?bed=${currentBed}&patient=${currentPatientId}`;
                console.log('🔗 Navigating to:', circulatoryUrl);
                window.location.href = circulatoryUrl;
            } else {
                console.warn('⚠️ Missing patient or bed data, redirecting to bed overview');
                window.location.href = 'index.html';
            }
        }

        function goToOtherSettings() {
            console.log('➡️ Navigating to other settings');
            
            // Ensure session data is preserved when going to other settings
            if (currentPatientId && currentBed && window.sharedDataManager) {
                // Update session data to maintain patient context
                window.sharedDataManager.saveSessionData({
                    selectedBed: currentBed,
                    patientId: currentPatientId,
                    previousPage: 'respiratory-settings'
                });
                
                console.log('✅ Session data preserved for patient:', currentPatientId, 'bed:', currentBed);
                
                // Navigate to other settings with proper URL parameters
                const otherUrl = `other.html?bed=${currentBed}&patient=${currentPatientId}`;
                console.log('🔗 Navigating to:', otherUrl);
                window.location.href = otherUrl;
            } else {
                console.warn('⚠️ Missing patient or bed data, redirecting to bed overview');
                window.location.href = 'index.html';
            }
        }

        function goToBedOverview() {
            console.log('🏠 Navigating to bed overview');
            
            // Clear current patient context since we're going back to the overview
            if (window.sharedDataManager) {
                window.sharedDataManager.saveSessionData({
                    selectedBed: null,
                    patientId: null,
                    previousPage: 'circulatoir-settings'
                });
                console.log('✅ Session data cleared for bed overview navigation');
            }
            
            // Navigate to bed overview
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
