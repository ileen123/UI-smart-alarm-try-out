<!DOCTYPE html>
<html lang="nl">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title that appears in browser tab -->
    <title>Instellen Nieuwe Patiënt</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Data Manager for cross-page data synchronization -->
    <script src="js/shared-data-manager.js"></script>
</head>
<body class="setup-page">
    <!-- Patient information header section -->
    <div class="header">
        <img src="svg's/patient_icon.svg" alt="Patient" class="user-icon" />
        <span id="patient-header-info">34567 - S. Groen - Vrouw - 16 jaar - 55 kg</span>
    </div>
    
    <!-- Main page title -->
    <h1 class="main-title">Instellen Nieuwe Patiënt</h1>
    
    <!-- Progress indicator showing current step (1-4) -->
    <div class="progress-bar">
        <div class="step">
            <div class="step-number">1</div>
        </div>
        <div class="step-line"></div>
        <div class="step">
            <div class="step-number inactive">2</div>
        </div>
        <div class="step-line"></div>
        <div class="step">
            <div class="step-number inactive">3</div>
        </div>
        <div class="step-line"></div>
        <div class="step">
            <div class="step-number inactive">✓</div>
        </div>
    </div>
    
    <!-- Container for the three main form sections - horizontal layout -->
    <div class="form-sections-container">
        <!-- Section 1: Main problem selection -->
        <div class="form-section">
            <h2 class="section-title">Wat is het hoofdprobleem?</h2>
            <div class="dropdown-container">
                <!-- Custom Dropdown -->
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="problemDropdown" onclick="toggleDropdown()">
                        <span class="dropdown-text placeholder">Selecteer een probleem...</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-options" id="dropdownOptions">
                        <div class="dropdown-option" onclick="selectOption('respiratoire-insufficientie', 'Respiratoire Insufficiëntie')">Respiratoire Insufficiëntie</div>
                        <div class="dropdown-option" onclick="selectOption('hart-falen', 'Hart Falen')">Hart Falen</div>
                        <div class="dropdown-option" onclick="selectOption('sepsis', 'Sepsis')">Sepsis</div>
                        <div class="dropdown-option disabled">Neurologische Aandoening</div>
                        <div class="dropdown-option disabled">Nierinsufficiëntie</div>
                        <div class="dropdown-option disabled">Leverfalen</div>
                    </div>
                </div>
                <!-- Legacy select for backward compatibility -->
                <select class="problem-dropdown" id="problemDropdownLegacy" style="display: none;">
                    <option value="">Selecteer een probleem...</option>
                    <option value="respiratoire-insufficientie">Respiratoire Insufficiëntie</option>
                    <option value="hart-falen">Hart Falen</option>
                    <option value="sepsis">Sepsis</option>
                    <option value="neurologische-aandoening" disabled>Neurologische Aandoening</option>
                    <option value="nierinsuffcientie" disabled>Nierinsufficiëntie</option>
                    <option value="leverfalen" disabled>Leverfalen</option>
                </select>
            </div>
        </div>
        
        <!-- Section 2: Risk level selection -->
        <div class="form-section">
            <h2 class="section-title">Wat is het risico - level van de patiënt?</h2>
            <div class="button-group">
                <button class="btn risk-low">Laag</button>
                <button class="btn risk-mid">Mid</button>
                <button class="btn risk-high">Hoog</button>
            </div>
            <!-- Static alarm indicator SVG -->
            <div class="alarm-indicator-svg">
                <img src="svg's/alarm_indicator.svg" alt="Alarm Indicator" />
            </div>
        </div>
        
        <!-- Section 3: Additional medical conditions/tags -->
        <div class="form-section">
            <h2 class="section-title">Selecteer eventueel additionele informatie:</h2>
            <div class="tags-section">
                <!-- All tags in horizontal layout with wrapping -->
                <div class="button-group tags-horizontal">
                    <button class="btn tag-btn" data-condition="sepsis">
                        Sepsis <img src="svg's/sepsis.svg" alt="Sepsis" class="sepsis-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="diabetes">
                        Diabetes <img src="svg's/diabetes.svg" alt="Diabetes" class="condition-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="herstellende">
                        Herstellende <img src="svg's/patient_icon.svg" alt="Herstellende" class="condition-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="pneumonie">
                        Pneumonie <img src="svg's/lung.svg" alt="Pneumonie" class="condition-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="chronisch-nierfalen">
                        Chronisch Nierfalen <img src="svg's/nierfalen.svg" alt="Nierfalen" class="condition-icon">
                    </button>
                    <!-- More button to show additional options -->
                    <button class="more-btn">⋯</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Section 4: Organ-level monitoring configuration -->
    <div class="monitoring-section">
        <h2 class="section-title">Monitoring op Orgaan Niveau</h2>
        
        <!-- Grid of organ monitoring circles -->
        <div class="monitoring-grid">
            <!-- Circulatory system -->
            <div class="monitor-item">
                <div class="monitor-label inactive-text">Circulatoir</div>
                <div id="heart-circle-container"></div>
                <div id="heart-status" class="monitor-status inactive-text">los</div>
                <!-- Circulatory parameters -->
                <div class="value-card">
                    <div class="parameter-group">
                        <div class="value-label inactive-text">HR</div>
                        <div class="value-number inactive-text">70 - 110 bpm</div>
                    </div>
                    
                    <div class="parameter-group">
                        <div class="value-label inactive-text">BP Mean</div>
                        <div class="value-number inactive-text">65 - 85 mmHg</div>
                    </div>
                </div>
            </div>
            <!-- Respiratory system -->
            <div class="monitor-item">
                <div class="monitor-label inactive-text">Respiratoir</div>
                <div id="lung-circle-container"></div>
                <div id="lung-status" class="monitor-status inactive-text">los</div>
                <!-- Respiratory parameters -->
                <div class="value-card">
                    <div class="parameter-group">
                        <div class="value-label inactive-text">Saturatie</div>
                        <div class="value-number inactive-text">90 - 100%</div>
                    </div>
                    
                    <div class="parameter-group">
                        <div class="value-label inactive-text">AF</div>
                        <div class="value-number inactive-text" id="af-range-display">10 - 25 /min</div>
                    </div>
                </div>
            </div>
            <!-- Other/Temperature system -->
            <div class="monitor-item">
                <div class="monitor-label inactive-text">Overig</div>
                <div id="temp-circle-container"></div>
                <div id="temp-status" class="monitor-status inactive-text">los</div>
                <!-- Temperature parameters -->
                <div class="value-card">
                    <div class="parameter-group">
                        <div class="value-label inactive-text">Temp.</div>
                        <div class="value-number inactive-text">36.0 - 38.5 °C</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation buttons at bottom of page -->
    <div class="navigation">
        <!-- Back button with onclick event -->
        <button class="nav-btn" onclick="goBack()">← Terug</button>
        <!-- Confirm button with onclick event -->
        <button class="nav-btn primary disabled" id="confirm-btn" onclick="confirmSettings()">Bevestigen</button>
    </div>

            <!-- Import Heart Circle Component -->
            <script src="heart-circle-component.js"></script>
            <script>
                // Global variables for current session
                let selectedProblem = '';
                let selectedRiskLevel = '';
                let selectedTags = [];
                let currentPatientId = null; // Add current patient ID variable
                
                // SVG content embedded to avoid CORS issues
                        const svgContent = {
                            heart: `<svg class="organ-icon" viewBox="0 0 22 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13.22 10.3743C12.0679 12.132 10.9163 15.0615 10.9163 19.1628M13.22 10.3743C12.0681 12.132 11.4922 14.4756 6.30842 14.4756M13.22 10.3743C14.6766 8.39884 16.9516 6.83964 19.3552 6.3986C20.0557 6.27006 20.6011 5.62288 20.4841 4.90863L20.2921 3.73684C20.1996 3.17181 19.7182 2.75127 19.159 2.81881C16.3987 3.15222 12.9705 4.8327 10.9162 7.44486C10.9162 6.27307 10.9162 2.75769 10.3402 1M5.73245 6.85896C5.15648 5.10127 4.00454 3.92948 2.27663 3.92948M1.70071 15.6441C2.85258 20.9171 7.26892 25 10.3401 25C13.4113 25 17.6365 20.9175 18.9799 15.6441C20.3232 10.3707 16.1 6.85563 13.2201 10.371C13.2201 8.61732 11.4922 6.85906 8.03639 6.85906C4.58057 6.85906 0.548838 10.371 1.70071 15.6441Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`,
                            lung: `<svg class="organ-icon" viewBox="0 0 30 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11.5007 5.62881C11.5007 4.02205 10.3628 2.41595 5.90178 6.31748C-0.397037 11.8263 1.7026 24.2213 2.40247 24.91C3.10233 25.5986 10.8008 22.1555 11.5007 20.7783C12.2006 19.4011 10.8008 17.3352 12.2006 14.5808M18.4993 5.62879C18.4993 4.02203 19.6372 2.41593 24.0982 6.31746C30.397 11.8263 28.2974 24.2213 27.5975 24.9099C26.8977 25.5985 19.1992 22.1555 18.4993 20.7783C17.7994 19.401 19.1992 17.3352 17.7994 14.5807M21.9987 16.6468C21.9987 13.3949 19.8717 11.7738 18.2519 10.7191C14.9109 8.54378 15 4.4935 15 0.999945C15 4.4935 15.0891 8.54378 11.7481 10.7191C10.1283 11.7738 8.00142 13.3949 8.00142 16.6468" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>`,
                            temp: `<svg class="organ-icon" viewBox="0 0 16 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.71349 0C3.94455 0 2.4982 1.42157 2.4982 3.15972V13.7459C0.944989 14.7857 0.000507593 16.5193 0 18.3844C0 21.4774 2.56656 24 5.71349 24C8.86042 24 11.4265 21.4774 11.4265 18.3844C11.4265 16.5193 10.482 14.7842 8.92828 13.7444V3.15972C8.92828 1.42157 7.48193 0 5.71349 0ZM5.71349 1.41162C6.71166 1.41162 7.49206 2.17865 7.49206 3.15972V14.1326C7.49212 14.2565 7.52539 14.3783 7.58851 14.4856C7.65162 14.5929 7.74237 14.682 7.85162 14.7438C9.17643 15.4954 9.99076 16.8812 9.99076 18.3844C9.99076 20.7144 8.08457 22.5884 5.714 22.5879C5.71383 22.5879 5.71416 22.5879 5.714 22.5879C3.34393 22.5884 1.43673 20.7144 1.43673 18.3849C1.43724 16.8822 2.25207 15.4964 3.57587 14.7453C3.68512 14.6834 3.77586 14.5944 3.83898 14.4871C3.9021 14.3798 3.93536 14.258 3.93543 14.1341V3.15972C3.93543 2.17865 4.71482 1.41162 5.71349 1.41162ZM11.5885 1.87453C11.3981 1.87455 11.2154 1.94891 11.0808 2.08127C10.9461 2.21363 10.8704 2.39315 10.8704 2.58033C10.8704 2.76752 10.9461 2.94704 11.0808 3.0794C11.2154 3.21176 11.3981 3.28613 11.5885 3.28615H15.2819C15.4723 3.28613 15.655 3.21176 15.7897 3.0794C15.9243 2.94704 16 2.76752 16 2.58033C16 2.39315 15.9243 2.21363 15.7896 2.08127C15.655 1.94891 15.4723 1.87455 15.2819 1.87453H11.5885ZM5.71349 2.58033C5.61915 2.58028 5.52572 2.59849 5.43854 2.63394C5.35136 2.66938 5.27214 2.72136 5.2054 2.7869C5.13867 2.85245 5.08572 2.93028 5.0496 3.01594C5.01348 3.1016 4.99488 3.19342 4.99487 3.28615V15.2102C3.51864 15.5338 2.40552 16.8384 2.40552 18.3834C2.40552 20.1708 3.89492 21.6347 5.71349 21.6347C7.53156 21.6347 9.02146 20.1708 9.02146 18.3834C9.02146 16.8384 7.90783 15.5348 6.4316 15.2102V3.28615C6.43158 3.09896 6.35592 2.91944 6.22125 2.78708C6.08658 2.65472 5.90394 2.58035 5.71349 2.58033ZM11.5885 5.10144C11.4942 5.10145 11.4008 5.11973 11.3136 5.15523C11.2265 5.19073 11.1473 5.24277 11.0806 5.30836C11.0139 5.37395 10.961 5.45182 10.925 5.5375C10.8889 5.62319 10.8704 5.71502 10.8704 5.80775C10.8704 5.99493 10.9461 6.17445 11.0808 6.30681C11.2154 6.43917 11.3981 6.51353 11.5885 6.51355H13.8431C14.0336 6.51353 14.2162 6.43917 14.3509 6.30681C14.4856 6.17445 14.5612 5.99493 14.5612 5.80775C14.5613 5.71502 14.5428 5.62319 14.5067 5.5375C14.4707 5.45182 14.4178 5.37395 14.3511 5.30836C14.2844 5.24277 14.2052 5.19073 14.1181 5.15523C14.0309 5.11972 13.9375 5.10145 13.8431 5.10144H11.5885ZM11.5885 8.32885C11.3981 8.32886 11.2154 8.40323 11.0808 8.53559C10.9461 8.66796 10.8704 8.84747 10.8704 9.03466C10.8704 9.22184 10.9461 9.40136 11.0808 9.53372C11.2154 9.66608 11.3981 9.74045 11.5885 9.74046H15.2819C15.4723 9.74045 15.655 9.66608 15.7896 9.53372C15.9243 9.40136 16 9.22184 16 9.03466C16 8.84747 15.9243 8.66796 15.7897 8.53559C15.655 8.40323 15.4723 8.32886 15.2819 8.32885H11.5885ZM11.5885 11.5563C11.3981 11.5563 11.2154 11.6306 11.0808 11.763C10.9461 11.8954 10.8704 12.0749 10.8704 12.2621C10.8704 12.4493 10.9461 12.6288 11.0808 12.7611C11.2154 12.8935 11.3981 12.9679 11.5885 12.9679H13.8431C14.0336 12.9679 14.2162 12.8935 14.3509 12.7611C14.4856 12.6288 14.5612 12.4493 14.5612 12.2621C14.5612 12.0749 14.4856 11.8954 14.3509 11.763C14.2162 11.6306 14.0336 11.5563 13.8431 11.5563H11.5885ZM5.71349 16.5437C6.75571 16.5437 7.58473 17.359 7.58473 18.3834C7.58473 19.4078 6.75571 20.2231 5.71349 20.2231C4.67127 20.2231 3.84174 19.4078 3.84174 18.3834C3.84174 17.359 4.67127 16.5437 5.71349 16.5437Z" fill="black"/>
                            </svg>`
                        };

                        // Utility to inject SVG content directly
                        function injectSVG(containerId, svgType) {
                            console.log('Injecting ' + svgType + ' SVG into ' + containerId);
                            const container = document.getElementById(containerId);
                            if (!container) {
                                console.log(`Container ${containerId} not found`);
                                return;
                            }
                            const iconDiv = container.querySelector('.heart-white-center');
                            if (iconDiv) {
                                console.log(`Found white center in ${containerId}, injecting SVG`);
                                iconDiv.innerHTML = svgContent[svgType];
                                const svgEl = iconDiv.querySelector('svg');
                                if (svgEl) {
                                    svgEl.style.width = '70%';
                                    svgEl.style.height = '70%';
                                    svgEl.style.display = 'block';
                                    svgEl.style.margin = '0 auto';
                                    console.log('SVG successfully injected into ' + containerId);
                                }
                            } else {
                                console.log('White center not found in ' + containerId);
                                // Try again after a short delay
                                setTimeout(() => injectSVG(containerId, svgType), 50);
                            }
                        }
                        
                        // Function to load patient data when coming from bed overview
                        function loadPatientFromBedOverview() {
                            const initData = window.sharedDataManager.initializeIndexPage();
                            const currentPatient = initData.sessionData.currentPatient;
                            
                            // Set the global currentPatientId variable
                            currentPatientId = currentPatient;
                            console.log('✅ Set currentPatientId to:', currentPatientId);
                            
                            if (currentPatient) {
                                // Get patient info using shared data manager
                                const patient = window.sharedDataManager.getPatientInfo(currentPatient);
                                
                                if (patient) {
                                    // Update header with patient information
                                    const headerInfo = document.getElementById('patient-header-info');
                                    if (headerInfo) {
                                        headerInfo.textContent = `${patient.id} - ${patient.name} - ${patient.gender} - ${patient.age} jaar - ${patient.weight} kg`;
                                    }
                                    
                                    // Patient data is already managed by SharedDataManager
                                    console.log('✅ Patient info loaded:', patient);
                                }
                            }
                        }
                        
                        // Wait for SharedDataManager to be ready
                        document.addEventListener('DOMContentLoaded', async function() {
                            console.log('DOM loaded, initializing SharedDataManager...');
                            
                            // AGGRESSIVE CLEAR: First clear all tag buttons before any initialization
                            console.log('🧹 Aggressive clearing of all tag buttons...');
                            const allTagButtons = document.querySelectorAll('.tag-btn');
                            allTagButtons.forEach(btn => {
                                btn.classList.remove('selected');
                                console.log('🧹 Cleared button:', btn.dataset.condition || btn.textContent.trim());
                            });
                            selectedTags = [];
                            console.log('🧹 Cleared selectedTags array');
                            
                            // Check if coming from bed overview and load patient data
                            loadPatientFromBedOverview();
                            
                            // SharedDataManager is already initialized when the script loads
                            if (window.sharedDataManager) {
                                console.log('SharedDataManager initialized successfully');
                                
                                // Verify configurations are available
                                const configs = window.sharedDataManager.getCircleConfigurations();
                                console.log('Available circle configurations:', configs);
                                
                                // Load any existing session data
                                loadSessionData();
                                
                                // Initialize sepsis tag state based on current patient target ranges
                                initializeSepsisTagState();
                            }
                            
                            // Create circle components after SharedDataManager is ready
                            await initializeCircleComponents();
                            
                            // Set up event listeners
                            setupEventListeners();
                            
                            // CENTRALIZED SYSTEM: Sync displays with current target ranges
                            syncDisplaysWithCentralizedRanges();
                            
                            // Initialize progress bar state
                            updateProgressBar();
                        });
                        
                        async function initializeCircleComponents() {
                            // Make all circles larger but still fit side by side
                            const circleSize = 130;
                            
                            console.log('Initializing heart circle components...');
                            
                            // Store references to the components for later control
                            window.organComponents = {};
                            
                            // Heart (circulatoir) - start inactive
                            console.log('Creating heart component...');
                            window.organComponents.heart = new HeartCircleComponent('heart-circle-container', { size: circleSize, initialState: 'mid' });
                            setTimeout(() => injectSVG('heart-circle-container', 'heart'), 100);
                            
                            // Listen for global heart monitoring level changes
                            document.addEventListener('heartMonitoringLevelChanged', function(event) {
                                const { level } = event.detail;
                                if (window.organComponents?.heart) {
                                    console.log(`Received heart monitoring level change:`, level);
                                    window.organComponents.heart.setRiskLevel(level);
                                    
                                    // Update monitoring status after risk level change
                                    setTimeout(() => updateMonitoringStatus(), 100);
                                }
                            });
                            
                            // Listen for global lung monitoring level changes
                            document.addEventListener('lungMonitoringLevelChanged', function(event) {
                                const { level } = event.detail;
                                if (window.organComponents?.lung) {
                                    console.log(`Received lung monitoring level change:`, level);
                                    window.organComponents.lung.setRiskLevel(level);
                                    
                                    // Update monitoring status after risk level change
                                    setTimeout(() => updateMonitoringStatus(), 100);
                                }
                            });
                            
                            // Listen for global temp monitoring level changes
                            document.addEventListener('tempMonitoringLevelChanged', function(event) {
                                const { level } = event.detail;
                                if (window.organComponents?.temp) {
                                    console.log(`Received temp monitoring level change:`, level);
                                    window.organComponents.temp.setRiskLevel(level);
                                    
                                    // Update monitoring status after risk level change
                                    setTimeout(() => updateMonitoringStatus(), 100);
                                }
                            });
                            
                            // DISABLED: Listen for HR range changes from sepsis selection
                            // Sepsis no longer changes target ranges, only visual state
                            /*
                            window.addEventListener('hrRangesChanged', function(event) {
                                console.log('💓 HR ranges changed event received in index:', event.detail);
                                if (event.detail.patientId === currentPatientId) {
                                    // Update the HR display immediately
                                    updateHRDisplay(event.detail.HR_low, event.detail.HR_high, event.detail.source === 'sepsis');
                                    // Also update parameter ranges to ensure consistency
                                    updateParameterRanges();
                                    
                                    // Update sepsis tag button state based on the event source
                                    const sepsisButton = document.querySelector('.tag-btn[data-condition="sepsis"]');
                                    if (sepsisButton) {
                                        if (event.detail.source === 'sepsis') {
                                            // Sepsis was selected elsewhere, select our button
                                            if (!sepsisButton.classList.contains('selected')) {
                                                sepsisButton.classList.add('selected');
                                                selectedTags.push('sepsis');
                                                console.log('✅ Synced sepsis button to selected state from external change (index)');
                                            }
                                        } else if (event.detail.source === 'restore') {
                                            // Sepsis was deselected elsewhere, deselect our button
                                            if (sepsisButton.classList.contains('selected')) {
                                                sepsisButton.classList.remove('selected');
                                                selectedTags = selectedTags.filter(t => t !== 'sepsis');
                                                console.log('✅ Synced sepsis button to deselected state from external change (index)');
                                            }
                                        }
                                    }
                                }
                            });
                            */
                            
                            // Listen for condition state changes from other pages
                            window.addEventListener('patientConditionStateChanged', function(event) {
                                console.log('🏥 Condition state changed event received on setup page:', event.detail);
                                
                                const { condition, state } = event.detail;
                                
                                // Only update if it's for the current patient
                                if (state.patientId === currentPatientId) {
                                    const conditionButton = document.querySelector(`.tag-btn[data-condition="${condition}"]`);
                                    if (conditionButton) {
                                        if (state.isActive) {
                                            if (!conditionButton.classList.contains('selected')) {
                                                conditionButton.classList.add('selected');
                                                if (!selectedTags.includes(condition)) {
                                                    selectedTags.push(condition);
                                                }
                                                console.log(`✅ Synced ${condition} button to selected state from external change (setup)`);
                                            }
                                        } else {
                                            if (conditionButton.classList.contains('selected')) {
                                                conditionButton.classList.remove('selected');
                                                selectedTags = selectedTags.filter(t => t !== condition);
                                                console.log(`✅ Synced ${condition} button to deselected state from external change (setup)`);
                                            }
                                        }
                                        
                                        // FIXED: Only update parameter ranges for non-sepsis and non-pneumonie conditions
                                        // Sepsis and pneumonie should only affect visual state, not target ranges
                                        if (condition !== 'sepsis' && condition !== 'pneumonie') {
                                            console.log('🔄 Updating parameter ranges for external condition change:', condition);
                                            updateParameterRanges();
                                        } else {
                                            if (condition === 'sepsis') console.log('🦠 Sepsis condition changed externally - visual state only, no range changes');
                                            if (condition === 'pneumonie') console.log('🫁 Pneumonie condition changed externally - visual state only, no AF range changes');
                                        }
                                    }
                                }
                            });
                            
                            // Lung (respiratoir) - start inactive
                            console.log('Creating lung component...');
                            window.organComponents.lung = new HeartCircleComponent('lung-circle-container', { size: circleSize, initialState: 'mid' });
                            setTimeout(() => injectSVG('lung-circle-container', 'lung'), 100);
                            
                            // Temp (overig) - start inactive
                            console.log('Creating temp component...');
                            window.organComponents.temp = new HeartCircleComponent('temp-circle-container', { size: circleSize, initialState: 'mid' });
                            setTimeout(() => injectSVG('temp-circle-container', 'temp'), 100);
                            
                            // Make all circles appear inactive until user makes selections
                            setTimeout(() => {
                                updateAllOpacity(false);
                            }, 200);
                        }
                        
                        // Function to update monitoring status text based on circle states
                        function updateMonitoringStatus() {
                            if (!window.organComponents) return;
                            
                            // Update heart status
                            if (window.organComponents.heart) {
                                const heartLevel = window.organComponents.heart.getRiskLevel();
                                const heartStatusElement = document.getElementById('heart-status');
                                if (heartStatusElement) {
                                    heartStatusElement.textContent = getStatusText(heartLevel);
                                }
                            }
                            
                            // Update lung status
                            if (window.organComponents.lung) {
                                const lungLevel = window.organComponents.lung.getRiskLevel();
                                const lungStatusElement = document.getElementById('lung-status');
                                if (lungStatusElement) {
                                    lungStatusElement.textContent = getStatusText(lungLevel);
                                }
                            }
                            
                            // Update temp status
                            if (window.organComponents.temp) {
                                const tempLevel = window.organComponents.temp.getRiskLevel();
                                const tempStatusElement = document.getElementById('temp-status');
                                if (tempStatusElement) {
                                    tempStatusElement.textContent = getStatusText(tempLevel);
                                }
                            }
                        }
                        
                        // Function to convert risk level to Dutch status text (setup page version)
                        function getStatusText(riskLevel) {
                            switch(riskLevel?.toLowerCase()) {
                                case 'low':
                                    return 'los';
                                case 'med':
                                case 'medium':
                                case 'mid':
                                    return 'mid';
                                case 'high':
                                    return 'strak';
                                default:
                                    return 'los';
                            }
                        }
                        
                        function setupEventListeners() {
                            // Set up problem dropdown listener
                            const problemDropdown = document.getElementById('problemDropdown');
                            if (problemDropdown) {
                                problemDropdown.addEventListener('change', function() {
                                    console.log('🎯 USER manually changed main problem dropdown');
                                    // Set flag that user is manually changing problem (should overwrite manual adjustments)
                                    if (window.sharedDataManager) {
                                        window.sharedDataManager.setUserChangingProblem(true);
                                    }
                                    
                                    selectedProblem = this.value;
                                    window.dataManager?.setSelectedProblem(selectedProblem);
                                    updateOrganCirclesBasedOnProblem(selectedProblem);
                                    updateProgressBar(); // Update progress when problem is selected
                                    
                                    // Clear flag after processing
                                    if (window.sharedDataManager) {
                                        setTimeout(() => window.sharedDataManager.setUserChangingProblem(false), 100);
                                    }
                                });
                            }
                            
                            // Set up risk level button listeners
                            const riskButtons = document.querySelectorAll('.btn.risk-low, .btn.risk-mid, .btn.risk-high');
                            riskButtons.forEach(button => {
                                button.addEventListener('click', function() {
                                    console.log('\n🟡 === RISK BUTTON CLICKED ===');
                                    
                                    // Remove selected class from all risk buttons
                                    riskButtons.forEach(btn => btn.classList.remove('selected'));
                                    // Add selected class to clicked button
                                    this.classList.add('selected');
                                    
                                    // Get risk level and update circles
                                    const riskLevel = this.classList.contains('risk-low') ? 'low' : 
                                                     this.classList.contains('risk-high') ? 'high' : 'mid';
                                    console.log('🔵 Risk button clicked, detected risk level:', riskLevel);
                                    console.log('🔵 Current selectedProblem:', selectedProblem);
                                    
                                    // Debug organ components before update
                                    console.log('🔧 Organ components before update:', window.organComponents);
                                    if (window.organComponents) {
                                        console.log('🔧 Heart level before:', window.organComponents.heart?.getRiskLevel?.());
                                        console.log('🔧 Lung level before:', window.organComponents.lung?.getRiskLevel?.());
                                        console.log('🔧 Temp level before:', window.organComponents.temp?.getRiskLevel?.());
                                    }
                                    
                                    selectedRiskLevel = riskLevel;
                                    console.log('🔵 selectedRiskLevel is now:', selectedRiskLevel);
                                    window.dataManager?.setSelectedRiskLevel(riskLevel);
                                    updateOrganCirclesWithRisk(riskLevel);
                                    
                                    // Debug organ components after update
                                    setTimeout(() => {
                                        console.log('🔧 Organ components after update:', window.organComponents);
                                        if (window.organComponents) {
                                            console.log('🔧 Heart level after:', window.organComponents.heart?.getRiskLevel?.());
                                            console.log('🔧 Lung level after:', window.organComponents.lung?.getRiskLevel?.());
                                            console.log('🔧 Temp level after:', window.organComponents.temp?.getRiskLevel?.());
                                        }
                                        console.log('🟡 === END RISK BUTTON CLICK ===\n');
                                    }, 100);
                                    
                                    updateProgressBar(); // Update progress when risk level is selected
                                });
                            });
                            
                            // Set up tag button listeners
                            const tagButtons = document.querySelectorAll('.tags-section .btn:not(.more-btn)');
                            tagButtons.forEach(button => {
                                button.addEventListener('click', function() {
                                    const tagCondition = this.dataset.condition || this.textContent.trim(); // Use data-condition if available, fallback to text
                                    
                                    if (this.classList.contains('selected')) {
                                        // Deselect tag
                                        this.classList.remove('selected');
                                        selectedTags = selectedTags.filter(tag => tag !== tagCondition);
                                        
                                        // Handle condition deselection using new condition state system
                                        if (currentPatientId && window.sharedDataManager) {
                                            window.sharedDataManager.setPatientConditionState(tagCondition, {
                                                isActive: false,
                                                patientId: currentPatientId,
                                                timestamp: Date.now(),
                                                source: 'setup-page'
                                            });
                                            
                                            // DISABLED: Pneumonie no longer changes AF ranges, only visual state
                                            // AF ranges should remain unchanged when pneumonie is deselected
                                            console.log('🫁 Pneumonie deselected - visual state only, no AF range changes');
                                        }
                                    } else {
                                        // Select tag
                                        this.classList.add('selected');
                                        if (!selectedTags.includes(tagCondition)) {
                                            selectedTags.push(tagCondition);
                                        }
                                        
                                        // Handle condition selection using new condition state system
                                        if (currentPatientId && window.sharedDataManager) {
                                            window.sharedDataManager.setPatientConditionState(tagCondition, {
                                                isActive: true,
                                                patientId: currentPatientId,
                                                timestamp: Date.now(),
                                                source: 'setup-page'
                                            });
                                            
                                            // DISABLED: Pneumonie no longer changes AF ranges, only visual state
                                            // AF ranges should remain unchanged when pneumonie is selected
                                            console.log('🫁 Pneumonie selected - visual state only, no AF range changes');
                                        }
                                    }
                                    
                                    window.dataManager?.setSelectedTags(selectedTags);
                                    
                                    // FIXED: Only update parameter ranges for non-sepsis and non-pneumonie conditions
                                    // Sepsis and pneumonie should only affect visual state, not target ranges
                                    if (tagCondition !== 'sepsis' && tagCondition !== 'pneumonie') {
                                        console.log('🔄 Updating parameter ranges for condition:', tagCondition);
                                        updateParameterRanges();
                                    } else {
                                        if (tagCondition === 'sepsis') console.log('🦠 Sepsis tag clicked - visual state only, no range changes');
                                        if (tagCondition === 'pneumonie') console.log('🫁 Pneumonie tag clicked - visual state only, no range changes');
                                    }
                                });
                            });
                            
                            // DISABLED: Listen for HR range changes from sepsis selection/deselection
                            // Sepsis no longer changes target ranges, only visual state
                            /*
                            window.addEventListener('hrRangesChanged', function(event) {
                                console.log('💓 HR ranges changed event received in setup page:', event.detail);
                                if (event.detail.patientId === currentPatientId) {
                                    // Directly update the HR display with the new values
                                    const { HR_low, HR_high, BP_low, BP_high, source } = event.detail;
                                    updateHRDisplayDirectly(HR_low, HR_high, source === 'sepsis');
                                    
                                    // Also update BP display if BP values are provided
                                    if (typeof BP_low !== 'undefined' && typeof BP_high !== 'undefined') {
                                        updateBPDisplayDirectly(BP_low, BP_high, source === 'sepsis');
                                    }
                                    
                                    console.log('✅ Directly updated HR and BP displays with values:', HR_low, '-', HR_high, 'BP:', BP_low, '-', BP_high);
                                }
                            });
                            */
                            
                            // DISABLED: Listen for AF range changes from pneumonie selection/deselection
                            // Pneumonie no longer changes AF ranges, only visual state
                            /*
                            window.addEventListener('afRangesChanged', function(event) {
                                console.log('🫁 AF ranges changed event received in setup page:', event.detail);
                                if (event.detail.patientId === currentPatientId) {
                                    const { AF_min, AF_max, source } = event.detail;
                                    updateAFDisplayDirectly(AF_min, AF_max, source === 'pneumonie');
                                    console.log('✅ Directly updated AF display with values:', AF_min, '-', AF_max);
                                }
                            });
                            */

                            // SIMPLE SYSTEM: Listen for global parameter changes from slider adjustments
                            window.addEventListener('globalParametersChanged', function(event) {
                                console.log('🌐 Global parameters changed event received on setup page:', event.detail);
                                console.log('🔄 Updating displays with new global variables...');
                                syncDisplaysWithCentralizedRanges();
                            });
                        }
                        
                        // Function to directly update HR display on setup page
                        function updateHRDisplayDirectly(hrLow, hrHigh, isSepsis) {
                            console.log(`🔄 Directly updating HR display: ${hrLow}-${hrHigh} (sepsis: ${isSepsis})`);
                            
                            const circulatoryCard = document.querySelector('.value-card');
                            const hrRange = circulatoryCard?.querySelector('.value-number');
                            
                            if (hrRange) {
                                hrRange.textContent = `${hrLow} - ${hrHigh} bpm`;
                                
                                // Apply sepsis styling if needed
                                if (isSepsis) {
                                    window.sharedDataManager.highlightElement(hrRange, 'highlight', 1500);
                                    console.log('✅ Applied sepsis highlighting to HR display');
                                } else {
                                    // Remove any existing highlighting
                                    hrRange.classList.remove('highlight', 'fade-out');
                                    hrRange.style.backgroundColor = '';
                                    hrRange.style.border = '';
                                    hrRange.style.borderRadius = '';
                                    hrRange.style.padding = '';
                                    console.log('✅ Removed sepsis styling from HR display');
                                }
                                
                                console.log(`✅ HR display updated directly: ${hrLow} - ${hrHigh}`);
                            } else {
                                console.warn('❌ Could not find HR display element on setup page');
                            }
                        }
                        
                        // Function to directly update BP display on setup page
                        function updateBPDisplayDirectly(bpLow, bpHigh, isSepsis) {
                            console.log(`🩸 Directly updating BP display: ${bpLow}-${bpHigh} mmHg (sepsis: ${isSepsis})`);
                            
                            const circulatoryCard = document.querySelector('.value-card');
                            const bpRange = circulatoryCard?.querySelectorAll('.value-number')[1]; // Second value-number is BP
                            
                            if (bpRange) {
                                bpRange.textContent = `${bpLow} - ${bpHigh} mmHg`;
                                
                                // Apply sepsis styling if needed
                                if (isSepsis) {
                                    window.sharedDataManager.highlightElement(bpRange, 'highlight', 1500);
                                    console.log('✅ Applied sepsis highlighting to BP display');
                                } else {
                                    window.sharedDataManager.highlightElement(bpRange, 'highlight-green', 1500);
                                    console.log('🔙 Applied restored highlighting to BP display');
                                }
                                
                                console.log(`✅ BP display updated directly: ${bpLow} - ${bpHigh} mmHg`);
                            } else {
                                console.warn('❌ Could not find BP display element on setup page');
                            }
                        }
                        
                        // Function to directly update AF display on setup page
                        function updateAFDisplayDirectly(afMin, afMax, isPneumonie) {
                            console.log(`🫁 Directly updating AF display: ${afMin}-${afMax} /min (pneumonie: ${isPneumonie})`);
                            
                            const afRangeDisplay = document.getElementById('af-range-display');
                            
                            if (afRangeDisplay) {
                                afRangeDisplay.textContent = `${afMin} - ${afMax}`;
                                
                                // Apply pneumonie styling if needed
                                if (isPneumonie) {
                                    window.sharedDataManager.highlightElement(afRangeDisplay, 'highlight-blue', 1500);
                                    console.log('✅ Applied pneumonie highlighting to AF display');
                                } else {
                                    // Remove any existing highlighting
                                    afRangeDisplay.classList.remove('highlight', 'highlight-blue', 'fade-out');
                                    afRangeDisplay.style.backgroundColor = '';
                                    afRangeDisplay.style.border = '';
                                    afRangeDisplay.style.borderRadius = '';
                                    afRangeDisplay.style.padding = '';
                                    console.log('✅ Removed pneumonie styling from AF display');
                                }
                                
                                console.log(`✅ AF display updated directly: ${afMin} - ${afMax} /min`);
                            } else {
                                console.warn('❌ Could not find AF display element on setup page');
                            }
                        }
                        
                        // Always start with fresh session data (no restoration of previous selections)
                        function loadSessionData() {
                            // Check if coming from bed overview - if so, don't reset everything
                            const sessionData = window.sharedDataManager.getSessionData();
                            const currentBed = sessionData.currentBed;
                            const comingFromBedOverview = !!currentBed;
                            
                            if (!comingFromBedOverview) {
                                // Ensure interface starts clean - no previous selections restored
                                selectedProblem = '';
                                selectedRiskLevel = '';
                                selectedTags = [];
                                
                                // Ensure UI elements are reset
                                const dropdown = document.getElementById('problemDropdown');
                                if (dropdown) dropdown.value = '';
                                
                                // Remove any selected classes from risk buttons
                                document.querySelectorAll('.btn.risk-low, .btn.risk-mid, .btn.risk-high').forEach(btn => {
                                    btn.classList.remove('selected');
                                });
                                
                                // Remove any selected classes from tag buttons
                                document.querySelectorAll('.tag-btn').forEach(btn => {
                                    btn.classList.remove('selected');
                                });
                            } else {
                                console.log('Coming from bed overview, preserving fresh state for new patient setup');
                                // Still reset for fresh patient setup, but don't interfere with workflow
                                selectedProblem = '';
                                selectedRiskLevel = '';
                                selectedTags = [];
                            }
                            
                            // Always reset tag buttons
                            document.querySelectorAll('.tags-section .btn').forEach(btn => {
                                btn.classList.remove('selected');
                            });
                            
                            console.log('Interface reset to fresh state');
                        }

                        // Function to update organ circles based on selected problem
                        function updateOrganCirclesBasedOnProblem(problemValue) {
                            console.log('Problem selected:', problemValue);
                            selectedProblem = problemValue;
                            updateOrganCircles();
                        }
                        
                        // Function to update organ circles based on risk level
                        function updateOrganCirclesWithRisk(riskLevel) {
                            console.log('🔄 updateOrganCirclesWithRisk called with:', riskLevel);
                            console.log('🔄 Current selectedProblem:', selectedProblem);
                            console.log('🔄 Setting selectedRiskLevel to:', riskLevel);
                            selectedRiskLevel = riskLevel;
                            console.log('🔄 Calling updateOrganCircles...');
                            updateOrganCircles();
                        }

                        function initializeSepsisTagState() {
                            console.log('🏥 Initializing condition states on setup page...');
                            
                            if (currentPatientId && window.sharedDataManager) {
                                // Clear any existing selected tags for fresh start
                                selectedTags = [];
                                console.log('🧹 Cleared selectedTags for fresh patient setup');
                                
                                // For setup page, this is often a new patient setup, so force clean state
                                window.sharedDataManager.ensureCleanPatientState(currentPatientId, true);
                                
                                // Initialize all condition buttons based on stored states
                                const conditions = ['sepsis', 'pneumonie', 'herstellende'];
                                
                                conditions.forEach(condition => {
                                    const conditionState = window.sharedDataManager.getPatientConditionState(condition, currentPatientId);
                                    const conditionButton = document.querySelector(`.tag-btn[data-condition="${condition}"]`);
                                    
                                    if (conditionButton) {
                                        // Force deselect all condition buttons for new setup
                                        conditionButton.classList.remove('selected');
                                        
                                        if (conditionState && conditionState.isActive) {
                                            conditionButton.classList.add('selected');
                                            if (!selectedTags.includes(condition)) {
                                                selectedTags.push(condition);
                                            }
                                            console.log(`✅ Initialized ${condition} button as selected (setup)`);
                                        } else {
                                            console.log(`✅ Initialized ${condition} button as deselected (setup)`);
                                        }
                                    }
                                });
                                
                                console.log('🔍 Final selectedTags after initialization:', selectedTags);
                                // Update parameter ranges after initializing condition states
                                updateParameterRanges();
                            }
                        }

                        // Main function to update organ circles based on current problem and risk
                        function updateOrganCircles() {
                            console.log('🚀 updateOrganCircles called with selectedProblem:', selectedProblem);
                            
                            if (!window.sharedDataManager) {
                                console.error('❌ SharedDataManager not available');
                                return;
                            }
                            
                            if (!window.organComponents) {
                                console.error('❌ Organ components not available');
                                return;
                            }
                            
            // Use the centralized function from SharedDataManager that handles both monitoring levels and target ranges
            console.log('🔧 Calling applyProblemSpecificMonitoring with:');
            console.log('   - Problem:', selectedProblem);
            console.log('   - Risk Level:', selectedRiskLevel);
            console.log('   - Organ Components:', window.organComponents);
            
            // If no problem is selected, use default but still apply risk level logic
            const effectiveProblem = selectedProblem || 'none';
            // If a problem is selected but no risk level chosen, default to 'mid' for visualization
            const effectiveRiskLevel = selectedProblem && !selectedRiskLevel ? 'mid' : selectedRiskLevel;
            console.log('   - Effective Problem:', effectiveProblem);
            console.log('   - Effective Risk Level:', effectiveRiskLevel);
            
            // Check if user is manually changing problem (should overwrite) or if this is page load (should preserve)
            const shouldOverwriteManualAdjustments = window.sharedDataManager?.isUserManuallyChangingProblem() || false;
            console.log('🎯 Should overwrite manual adjustments:', shouldOverwriteManualAdjustments);
            
            const result = window.sharedDataManager.applyProblemSpecificMonitoring(
                effectiveProblem, 
                window.organComponents,
                window.sharedDataManager.getCurrentPatientId(), // Pass patient ID to save target ranges
                effectiveRiskLevel, // Use 'mid' as default when problem selected but no risk chosen
                shouldOverwriteManualAdjustments // Pass user intent flag
            );

            // CONDITIONAL SYNC: Only update displays with global variables if they were actually updated
            if (shouldOverwriteManualAdjustments) {
                console.log('🔄 Global variables were updated - syncing displays');
                setTimeout(() => {
                    syncDisplaysWithCentralizedRanges();
                }, 50);
            } else {
                console.log('🚫 Manual adjustments preserved - skipping global variables sync to prevent override');
            }

            const finalOrganStates = result.organStates;
                            const targetRanges = result.targetRanges;
                            const isActivated = selectedProblem !== '';
                            
                            console.log('🎯 Applied organ states:', finalOrganStates);
                            console.log('🎯 Applied target ranges:', targetRanges);
                            console.log('🎯 Current selectedProblem:', selectedProblem);
                            console.log('🎯 Current selectedRiskLevel:', selectedRiskLevel);
                            console.log('🎯 isActivated:', isActivated);
                            
                            // Update organ settings (organ components already updated by centralized function)
                            if (finalOrganStates.heart) {
                                window.sharedDataManager.setOrganSettings('circulatoir', { 
                                    active: isActivated, 
                                    severity: isActivated ? 'active' : 'los', 
                                    riskLevel: finalOrganStates.heart 
                                });
                                console.log('Heart settings saved:', finalOrganStates.heart);
                            }
                            if (finalOrganStates.lung) {
                                window.sharedDataManager.setOrganSettings('respiratoir', { 
                                    active: isActivated, 
                                    severity: isActivated ? 'active' : 'los', 
                                    riskLevel: finalOrganStates.lung 
                                });
                                console.log('Lung settings saved:', finalOrganStates.lung);
                            }
                            if (finalOrganStates.temp) {
                                window.sharedDataManager.setOrganSettings('overig', { 
                                    active: isActivated, 
                                    severity: isActivated ? 'active' : 'los', 
                                    riskLevel: finalOrganStates.temp 
                                });
                                console.log('Temp settings saved:', finalOrganStates.temp);
                            }
                            
                            // Update monitoring status after all circles are updated
                            setTimeout(() => updateMonitoringStatus(), 100);
                            
                            // Update opacity for all monitoring elements
                            updateAllOpacity(isActivated);
                            
                            // Update displayed target ranges 
                            updateTargetRangeDisplays(targetRanges);
                            
                            // Update progress bar to reflect current state
                            updateProgressBar();
                        }
                        
                        // Function to update the displayed target ranges on the UI
                        function updateTargetRangeDisplays(targetRanges) {
                            console.log('📊 Updating target range displays with:', targetRanges);
                            
                            if (!targetRanges) {
                                console.warn('No target ranges provided');
                                return;
                            }
                            
                            try {
                                // Find all value-number elements by their position/context
                                const valueNumbers = document.querySelectorAll('.value-number');
                                
                                // Update HR (Heart Rate) - First value-number in circulatory section
                                if (targetRanges.HR && valueNumbers[0]) {
                                    valueNumbers[0].textContent = `${targetRanges.HR.min} - ${targetRanges.HR.max} ${targetRanges.HR.unit}`;
                                    console.log('✅ Updated HR display:', valueNumbers[0].textContent);
                                }
                                
                                // Update BP Mean - Second value-number in circulatory section
                                if (targetRanges.BP_Mean && valueNumbers[1]) {
                                    valueNumbers[1].textContent = `${targetRanges.BP_Mean.min} - ${targetRanges.BP_Mean.max} ${targetRanges.BP_Mean.unit}`;
                                    console.log('✅ Updated BP Mean display:', valueNumbers[1].textContent);
                                }
                                
                                // Update Saturatie (Oxygen Saturation) - First value-number in respiratory section
                                if (targetRanges.Saturatie && valueNumbers[2]) {
                                    valueNumbers[2].textContent = `${targetRanges.Saturatie.min} - ${targetRanges.Saturatie.max}${targetRanges.Saturatie.unit}`;
                                    console.log('✅ Updated Saturatie display:', valueNumbers[2].textContent);
                                }
                                
                                // Update AF (Respiratory Rate) - Second value-number in respiratory section (has id="af-range-display")
                                if (targetRanges.AF) {
                                    const afDisplay = document.getElementById('af-range-display');
                                    if (afDisplay) {
                                        afDisplay.textContent = `${targetRanges.AF.min} - ${targetRanges.AF.max} ${targetRanges.AF.unit}`;
                                        console.log('✅ Updated AF display:', afDisplay.textContent);
                                    }
                                }
                                
                                // Update Temperature - Last value-number in other section
                                if (targetRanges.Temp && valueNumbers[4]) {
                                    valueNumbers[4].textContent = `${targetRanges.Temp.min} - ${targetRanges.Temp.max} ${targetRanges.Temp.unit}`;
                                    console.log('✅ Updated Temp display:', valueNumbers[4].textContent);
                                }
                                
                                console.log('📊 All target range displays updated successfully');
                                
                            } catch (error) {
                                console.error('❌ Error updating target range displays:', error);
                            }
                        }

                        // ===================================================================
                        // CENTRALIZED SYNCHRONIZATION SYSTEM
                        // ===================================================================

                        /**
                         * Synchronize all written displays with centralized target ranges
                         * Called on page load to ensure displays match the source of truth
                         */
                        function syncDisplaysWithCentralizedRanges() {
                            console.log('🌐 SIMPLE SYNC: Updating displays with global variables...');

                            // Update circulatory parameters (HR and BP)
                            const circulatoryCard = document.querySelector('.value-card');
                            const hrRange = circulatoryCard?.querySelector('.value-number');
                            const bpRange = circulatoryCard?.querySelectorAll('.value-number')[1];

                            // Update HR display from global variables
                            if (hrRange) {
                                hrRange.textContent = `${window.HR_MIN} - ${window.HR_MAX} bpm`;
                                console.log('📊 Updated HR display:', hrRange.textContent);
                            }

                            // Update BP display from global variables
                            if (bpRange) {
                                bpRange.textContent = `${window.BP_MIN} - ${window.BP_MAX} mmHg`;
                                console.log('📊 Updated BP display:', bpRange.textContent);
                            }

                            // Update respiratory parameters
                            const respiratoryCards = document.querySelectorAll('.value-card');
                            if (respiratoryCards.length >= 2) {
                                const respiratoryCard = respiratoryCards[1];
                                const saturatieRange = respiratoryCard?.querySelector('.value-number');
                                const afDisplay = document.getElementById('af-range-display');

                                // Update Saturatie display from global variables
                                if (saturatieRange) {
                                    saturatieRange.textContent = `${window.SAT_MIN} - ${window.SAT_MAX}%`;
                                    console.log('📊 Updated Saturatie display:', saturatieRange.textContent);
                                }

                                // Update AF display from global variables
                                if (afDisplay) {
                                    afDisplay.textContent = `${window.AF_MIN} - ${window.AF_MAX} /min`;
                                    console.log('📊 Updated AF display:', afDisplay.textContent);
                                }
                            }

                            // Update temperature display from global variables
                            const temperatureCards = document.querySelectorAll('.value-card');
                            if (temperatureCards.length >= 3) {
                                const temperatureCard = temperatureCards[2];
                                const tempRange = temperatureCard?.querySelector('.value-number');

                                if (tempRange) {
                                    tempRange.textContent = `${window.TEMP_MIN} - ${window.TEMP_MAX}°C`;
                                    console.log('📊 Updated Temperature display:', tempRange.textContent);
                                }
                            }

                            console.log('✅ All displays updated with global variables');
                        }

                        function updateParameterRanges() {
                            console.log('🔍 DEBUG: Updating parameter ranges for selected tags:', selectedTags);
                            
                            // Check if sepsis or pneumonie are selected as TAGs (not main problem)
                            const hasSepsis = selectedTags.some(tag => tag.toLowerCase().includes('sepsis'));
                            const hasPneumonie = selectedTags.some(tag => tag.toLowerCase().includes('pneumonie'));
                            console.log('🔍 DEBUG: Has sepsis tag:', hasSepsis, 'Has pneumonie tag:', hasPneumonie);
                            
                            // FIXED: If sepsis or pneumonie are selected as tags, do NOT update any ranges
                            if (hasSepsis || hasPneumonie) {
                                if (hasSepsis) console.log('🦠 SEPSIS TAG DETECTED: Completely skipping parameter range updates - preserving existing ranges');
                                if (hasPneumonie) console.log('🫁 PNEUMONIE TAG DETECTED: Completely skipping parameter range updates - preserving existing ranges');
                                return; // Exit early, don't change anything
                            }
                            
                            // Get thresholds from shared data manager
                            const normalThresholds = window.sharedDataManager.getThresholds('normal');
                            console.log('🔍 DEBUG: Normal thresholds:', normalThresholds);
                            
                            // Use normal thresholds for non-sepsis conditions
                            const currentThresholds = normalThresholds;
                            console.log('🔍 DEBUG: Using thresholds:', currentThresholds);
                            
                            // Update circulatory parameters (HR and BP)
                            const circulatoryCard = document.querySelector('.value-card');
                            const hrRange = circulatoryCard?.querySelector('.value-number');
                            const bpRange = circulatoryCard?.querySelectorAll('.value-number')[1]; // Second value-number is BP
                            
                            if (hrRange && currentThresholds.circulatoir && currentThresholds.circulatoir.HR) {
                                const hr = currentThresholds.circulatoir.HR;
                                hrRange.textContent = hr.min + ' - ' + hr.max + ' ' + hr.unit;
                                
                                console.log('🔍 DEBUG: Updated HR range to:', hr.min + ' - ' + hr.max + ' ' + hr.unit);
                                
                                // DISABLED: Sepsis highlighting removed since ranges no longer change
                                // Reset any existing styling to normal
                                hrRange.classList.remove('highlight', 'fade-out');
                                hrRange.style.backgroundColor = '';
                                hrRange.style.border = '';
                                hrRange.style.borderRadius = '';
                                hrRange.style.padding = '';
                                console.log('🔍 DEBUG: Reset HR range to normal styling (sepsis disabled)');
                            }
                            
                            // Update BP range
                            if (bpRange && currentThresholds.circulatoir && currentThresholds.circulatoir.BP_Mean) {
                                const bp = currentThresholds.circulatoir.BP_Mean;
                                bpRange.textContent = bp.min + ' - ' + bp.max + ' ' + bp.unit;
                                
                                console.log('🔍 DEBUG: Updated BP range to:', bp.min + ' - ' + bp.max + ' ' + bp.unit);
                                
                                // DISABLED: Sepsis highlighting removed since ranges no longer change
                                // Reset any existing styling to normal
                                bpRange.classList.remove('highlight', 'fade-out');
                                bpRange.style.backgroundColor = '';
                                bpRange.style.border = '';
                                bpRange.style.borderRadius = '';
                                bpRange.style.padding = '';
                                console.log('🔍 DEBUG: Reset BP range to normal styling (sepsis disabled)');
                            }
                        }

                        function updateHRDisplay(hrLow, hrHigh, isSepsis) {
                            console.log('💓 Updating HR display in index:', hrLow, '-', hrHigh, 'sepsis:', isSepsis);
                            
                            // Find the HR display element
                            const circulatoryCard = document.querySelector('.value-card');
                            const hrRange = circulatoryCard?.querySelector('.value-number');
                            
                            if (hrRange) {
                                // Update the display text
                                hrRange.textContent = hrLow + ' - ' + hrHigh + ' bpm';
                                
                                // Apply styling based on source
                                if (isSepsis) {
                                    window.sharedDataManager.highlightElement(hrRange, 'highlight', 1500);
                                    console.log('🦠 Applied sepsis highlighting to HR display in index');
                                } else {
                                    window.sharedDataManager.highlightElement(hrRange, 'highlight-green', 1500);
                                    console.log('🔙 Applied restored highlighting to HR display in index');
                                }
                            }
                        }

                        function updateProgressBar() {
                            console.log('🔄 updateProgressBar called with selectedProblem:', selectedProblem, 'selectedRiskLevel:', selectedRiskLevel);
                            const stepNumbers = document.querySelectorAll('.step-number');
                            
                            // Reset all steps to inactive first
                            stepNumbers.forEach(step => {
                                step.classList.add('inactive');
                                step.style.backgroundColor = '';
                            });
                            
                            // Step 1 is always blue (active by default)
                            if (stepNumbers[0]) {
                                stepNumbers[0].classList.remove('inactive');
                                stepNumbers[0].style.backgroundColor = '#1961AB';
                            }
                            
                            // Step 2 becomes blue when problem is selected
                            if (selectedProblem && stepNumbers[1]) {
                                stepNumbers[1].classList.remove('inactive');
                                stepNumbers[1].style.backgroundColor = '#1961AB';
                            }
                            
                            // Steps 3 and ✓ become blue when risk level is selected
                            if (selectedRiskLevel) {
                                if (stepNumbers[2]) {
                                    stepNumbers[2].classList.remove('inactive');
                                    stepNumbers[2].style.backgroundColor = '#1961AB';
                                }
                                if (stepNumbers[3]) {
                                    stepNumbers[3].classList.remove('inactive');
                                    stepNumbers[3].style.backgroundColor = '#1961AB';
                                }
                            }
                            
                            // Update confirm button state
                            updateConfirmButton();
                            
                            // Update data manager with current progress
                            let completedSteps = 1; // Always start with step 1
                            if (selectedProblem) completedSteps = 2;
                            if (selectedRiskLevel) completedSteps = 4; // All steps complete
                            
                            if (window.dataManager) {
                                window.dataManager.setProgressStep(completedSteps);
                            }
                        }

                        function updateConfirmButton() {
                            const confirmBtn = document.getElementById('confirm-btn');
                            if (confirmBtn) {
                                if (selectedProblem && selectedRiskLevel) {
                                    // Both selections made - enable button
                                    confirmBtn.classList.remove('disabled');
                                    confirmBtn.style.pointerEvents = 'auto';
                                } else {
                                    // Missing selection(s) - disable button
                                    confirmBtn.classList.add('disabled');
                                    confirmBtn.style.pointerEvents = 'none';
                                }
                            }
                        }

                        // Navigation functions
                        function goBack() {
                            if (confirm('Weet je zeker dat je terug wilt gaan? Alle wijzigingen gaan verloren.')) {
                                // Clear the bed data when canceling setup
                                const sessionData = window.sharedDataManager.getSessionData();
                                const currentBed = sessionData.currentBed;
                                
                                if (currentBed) {
                                    // Get current bed states
                                    const bedStates = window.sharedDataManager.getBedStates() || {};
                                    
                                    // Clear the specific bed being configured
                                    if (bedStates[currentBed]) {
                                        bedStates[currentBed] = {
                                            bedNumber: currentBed,
                                            occupied: false,
                                            patientId: null,
                                            vpkCode: null,
                                            riskLevel: null
                                        };
                                        
                                        // Save the updated bed states
                                        window.sharedDataManager.saveBedStates(bedStates);
                                        console.log(`🗑️ Cleared bed ${currentBed} data when canceling setup`);
                                    }
                                }
                                
                                // Reset all selections and data manager
                                selectedProblem = '';
                                selectedRiskLevel = '';
                                selectedTags = [];
                                
                                if (window.dataManager) {
                                    window.dataManager.resetSession();
                                }
                                
                                // Reset UI
                                document.querySelectorAll('.btn.selected').forEach(btn => btn.classList.remove('selected'));
                                document.getElementById('problemDropdown').value = '';
                                updateProgressBar();
                                
                                // Navigate back to patient overview
                                window.location.href = 'index.html';
                            }
                        }

                        function confirmSettings() {
                            // Check if button is disabled
                            const confirmBtn = document.getElementById('confirm-btn');
                            if (confirmBtn && confirmBtn.classList.contains('disabled')) {
                                return; // Don't execute if button is disabled
                            }
                            
                            console.log('confirmSettings called - selectedRiskLevel:', selectedRiskLevel);
                            console.log('confirmSettings called - selectedProblem:', selectedProblem);
                            
                            if (!selectedProblem || !selectedRiskLevel) {
                                alert('Selecteer eerst een hoofdprobleem en risico niveau voordat je doorgaat.');
                                return;
                            }
                            
                            const organSettings = window.dataManager?.getCurrentSession()?.organSettings || {};
                            const activeOrgans = Object.keys(organSettings).filter(organ => organSettings[organ].active);
                            
                            const summary = 
                                'Overzicht instellingen:\n' +
                                '- Hoofdprobleem: ' + selectedProblem + '\n' +
                                '- Risico niveau: ' + selectedRiskLevel + '\n' +
                                '- Additionele tags: ' + (selectedTags.length > 0 ? selectedTags.join(', ') : 'Geen') + '\n' +
                                '- Actieve monitoring: ' + (activeOrgans.length > 0 ? activeOrgans.join(', ') : 'Geen');
                            
                            if (confirm(summary + '\n\nWil je deze instellingen bevestigen?')) {
                                // Save all the selected data to patient-data.json
                                if (window.dataManager) {
                                    window.dataManager.setSelectedProblem(selectedProblem);
                                    window.dataManager.setSelectedRiskLevel(selectedRiskLevel);
                                    window.dataManager.setSelectedTags(selectedTags);
                                    window.dataManager.setProgressStep(4);
                                }
                                
                                // Save patient medical information permanently
                                const sessionData = window.sharedDataManager.getSessionData();
                                const currentPatient = sessionData.currentPatient;
                                const currentBed = sessionData.currentBed; // Declare at function level
                                
                                if (currentPatient) {
                                    const patientMedicalInfo = {
                                        selectedProblem: selectedProblem,
                                        selectedRiskLevel: selectedRiskLevel,
                                        selectedTags: selectedTags,
                                        organSettings: (window.dataManager && typeof window.dataManager.getOrganSettings === 'function') ? window.dataManager.getOrganSettings() : {},
                                        lastUpdated: new Date().toISOString()
                                    };
                                    
                                    // Save using shared data manager for cross-page access
                                    window.sharedDataManager.savePatientMedicalInfo(currentPatient, patientMedicalInfo);
                                    
                                    // Also save session data including risk level
                                    window.sharedDataManager.saveSessionData({
                                        currentPatient: currentPatient,
                                        currentBed: currentBed,
                                        selectedRiskLevel: selectedRiskLevel,
                                        lastUpdated: new Date().toISOString()
                                    });
                                    
                                    // Ensure data synchronization between both managers
                                    synchronizeDataManagers(currentPatient, patientMedicalInfo);
                                }
                                
                                // alert('Instellingen opgeslagen! Patiënt monitoring is geactiveerd.');
                                
                                // Simulate moving to next step
                                const lastStep = document.querySelector('.step:last-child .step-number');
                                lastStep.classList.remove('inactive');
                                lastStep.textContent = '✓';
                                lastStep.style.backgroundColor = '#28a745';
                                
                                // Check if user came from bed overview and redirect back
                                window.location.href = 'index.html?from=setup';
                            }
                        }

                        // Function to update opacity for all monitoring elements
                        function updateAllOpacity(isActive) {
                            // Update circle opacity
                            ['heart-circle-container', 'lung-circle-container', 'temp-circle-container'].forEach(containerId => {
                                updateCircleOpacity(containerId, isActive);
                            });
                            
                            // Update labels and status opacity
                            document.querySelectorAll('.monitor-label, .monitor-status').forEach(element => {
                                if (isActive) {
                                    element.classList.remove('inactive-text');
                                    element.classList.add('active');
                                } else {
                                    element.classList.remove('active');
                                    element.classList.add('inactive-text');
                                }
                            });
                            
                            // Update value labels and numbers opacity
                            document.querySelectorAll('.value-label, .value-number').forEach(element => {
                                if (isActive) {
                                    element.classList.remove('inactive-text');
                                    element.classList.add('active');
                                } else {
                                    element.classList.remove('active');
                                    element.classList.add('inactive-text');
                                }
                            });
                            
                            // Update value cards opacity
                            document.querySelectorAll('.value-card').forEach(card => {
                                if (isActive) {
                                    card.classList.remove('inactive-text');
                                    card.classList.add('active');
                                } else {
                                    card.classList.remove('active');
                                    card.classList.add('inactive-text');
                                }
                            });
                            
                            console.log('📱 Updated all opacity elements to isActive:', isActive);
                        }

                        // Function to update circle opacity
                        function updateCircleOpacity(containerId, isActive) {
                            const container = document.getElementById(containerId);
                            if (container) {
                                const circle = container.querySelector('.heart-organ-circle');
                                if (circle) {
                                    circle.style.opacity = isActive ? '1' : '0.3';
                                }
                            }
                        }

                        // Function to synchronize data between both data managers
                        function synchronizeDataManagers(patientId, medicalInfo) {
                            try {
                                // Ensure old data manager has the patient info
                                if (window.dataManager && medicalInfo) {
                                    window.dataManager.updatePatientInfo({ id: patientId });
                                    window.dataManager.setSelectedProblem(medicalInfo.selectedProblem);
                                    window.dataManager.setSelectedRiskLevel(medicalInfo.selectedRiskLevel);
                                    window.dataManager.setSelectedTags(medicalInfo.selectedTags);
                                }
                                
                                // Save a combined localStorage entry that both can read
                                const combinedData = {
                                    patientId: patientId,
                                    medicalInfo: medicalInfo,
                                    timestamp: new Date().toISOString()
                                };
                                localStorage.setItem(`patient_${patientId}_medicalInfo`, JSON.stringify(combinedData));
                                
                                console.log('✅ Data synchronized between both managers for patient:', patientId);
                            } catch (error) {
                                console.error('❌ Error synchronizing data managers:', error);
                            }
                        }

        // =============================================================================
        // CUSTOM DROPDOWN FUNCTIONALITY
        // =============================================================================

        function toggleDropdown() {
            const dropdown = document.getElementById('problemDropdown');
            const options = document.getElementById('dropdownOptions');
            
            dropdown.classList.toggle('open');
            options.classList.toggle('show');
        }

        function selectOption(value, text) {
            const dropdown = document.getElementById('problemDropdown');
            const dropdownText = dropdown.querySelector('.dropdown-text');
            const options = document.getElementById('dropdownOptions');
            const legacySelect = document.getElementById('problemDropdownLegacy');
            
            // Update the GLOBAL selectedProblem variable (not custom one)
            selectedProblem = value;
            dropdownText.textContent = text;
            
            // Update legacy select for backward compatibility
            if (legacySelect) {
                legacySelect.value = value;
                // Trigger change event for existing listeners
                const changeEvent = new Event('change', { bubbles: true });
                legacySelect.dispatchEvent(changeEvent);
            }
            
            // Update visual state
            if (value) {
                dropdownText.classList.remove('placeholder');
            } else {
                dropdownText.classList.add('placeholder');
            }
            
            // Close dropdown
            dropdown.classList.remove('open');
            options.classList.remove('show');
            
            // Trigger all the necessary updates that the original dropdown would trigger
            if (value) {
                window.dataManager?.setSelectedProblem(selectedProblem);
                updateOrganCirclesBasedOnProblem(selectedProblem);
                // updateProgressBar is called by updateOrganCircles, no need to call it here
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.custom-dropdown-container');
            if (container && !container.contains(event.target)) {
                const dropdown = document.getElementById('problemDropdown');
                const options = document.getElementById('dropdownOptions');
                if (dropdown && options) {
                    dropdown.classList.remove('open');
                    options.classList.remove('show');
                }
            }
        });

        // Initialize dropdown state on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial state
            const dropdown = document.getElementById('problemDropdown');
            const dropdownText = dropdown?.querySelector('.dropdown-text');
            if (dropdownText) {
                dropdownText.classList.add('placeholder');
            }
        });
            </script>
</body>
</html>