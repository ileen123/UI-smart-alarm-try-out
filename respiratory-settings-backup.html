<!DOCTYPE html>
<html lang="nl">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title that appears in browser tab -->
    <title>Respiratoir Instellingen</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="slider-component.css">
    
    <!-- Data Manager for cross-page data synchronization -->
    <script src="js/data-manager.js"></script>
    <script src="js/shared-data-manager.js"></script>
    
    <!-- Slider Component -->
    <script src="slider-component.js"></script>
    
    <!-- Heart Circle Component -->
    <script src="heart-circle-component.js"></script>
</head>
<body>
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <a href="#" class="breadcrumb-link" onclick="goToBedOverview()">
            <img src="svg's/home.svg" alt="Home" class="breadcrumb-icon">
            Pati√´nten Overzicht
        </a>
        <span class="breadcrumb-separator">></span>
        <a href="#" class="breadcrumb-link" onclick="goBackToAlarmOverview()">Alarm Instellingen - S. Groen</a>
        <span class="breadcrumb-separator">></span>
        <span class="breadcrumb-current">Respiratoire Monitoring</span>
    </nav>

    <!-- Title and Patient Info Layout -->
    <div class="title-patient-layout">
        <!-- Main page title -->
        <h1 class="main-title">Respiratoire Monitoring</h1>
        
        <!-- Patient information header section -->
        <div class="header">
            <img src="svg's/patient_icon.svg" alt="Patient" class="user-icon" />
            <span id="patient-header-info">Loading patient info...</span>
        </div>
    </div>
    
    <!-- Main content container -->
            <!-- Main layout container -->
        <div class="circulatory-settings-container">
        
        <!-- Monitoring Level Controls -->
        <div class="monitoring-controls-layout">
            <!-- Monitoring buttons - now direct children -->
            <div class="monitoring-buttons-direct">
                <h3 class="info-title">Monitoring Level</h3>
                <div class="button-group">
                    <button class="btn risk-low" data-level="loose" onclick="changeMonitoringLevel('loose')">Los</button>
                    <button class="btn risk-med selected" data-level="mid" onclick="changeMonitoringLevel('mid')">Mid</button>
                    <button class="btn risk-high" data-level="tight" onclick="changeMonitoringLevel('tight')">Strak</button>
                </div>
            </div>
            
            <!-- Heart circle - now direct child -->
            <div class="heart-circle-direct">
                <h3 class="info-title"> </h3>
                <div id="respiratory-heart-circle-container"></div>
            </div>
            
            <!-- Additional Respiratory Information Container -->
            <div class="additional-circulatory-info">
                <h3 class="info-title">Respiratoire additionele informatie:</h3>
                <div class="circulatory-tags-section">
                    <button class="btn tag-btn circulatory-tag" data-condition="sepsis">
                        Sepsis <img src="svg's/sepsis.svg" alt="Sepsis" class="sepsis-icon">
                    </button>
                    <button class="circulatory-more-btn">‚ãØ</button>
                </div>
            </div>
        </div>
        
        
        <!-- Section title moved outside the container -->
        <h2 class="section-title">Respiratoire Streefgebieden Aanpassen</h2>
        
        <!-- Interactive Slider Demo Section -->
        <div class="slider-demo-section">
            
            <!-- Direct slider containers without extra wrappers -->
            <div class="sliders-layout">
                <div id="saturatie-slider-container" class="individual-slider"></div>
                <div class="af-slider-with-legend">
                    <div id="af-slider-container" class="individual-slider"></div>
                    <div class="alarm-legend">
                        <div class="legend-item">
                            <div class="legend-color green"></div>
                            <span>Acceptabel</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color yellow"></div>
                            <span>Lichte overschrijding</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color orange"></div>
                            <span>Medium overschrijding</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color red"></div>
                            <span>Significante overschrijding</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation section with back button -->
    <div class="bottom-left-nav">
        <button class="nav-button back-button" onclick="goBackToAlarmOverview()">
            ‚Üê Terug naar Alarm Overzicht
        </button>
    </div>

    <!-- Bottom right navigation button -->
    <div class="bottom-right-nav">
        <button class="nav-button forward-button" onclick="goToCirculatoir()">
            Naar Circulatoir ‚Üí
        </button>
    </div>

    <style>
        /* Page-specific gradient background - only for respiratory settings page */
        body {
            background: linear-gradient(to bottom, #ffffff 0%, #ffffff 10%, #E6E4E0 100%);
            min-height: 100vh; /* Ensure full viewport height for gradient */
            padding: 50px 200px 5px 200px; /* Further reduced padding for no scrolling */
            margin: 0;
            font-family: 'Open Sans', sans-serif;
        }

        /* Breadcrumb Navigation */
        .breadcrumb-nav {
            font-family: 'Open Sans', sans-serif;
            font-size: 14px;
            color: #FC6039;
            margin-bottom: 25px;
            padding-top: 10px;
            display: flex;
            align-items: center;
            line-height: 1.2;
        }

        .breadcrumb-link {
            color: #FC6039;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s ease;
            vertical-align: middle;
        }

        .breadcrumb-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .breadcrumb-icon {
            width: 16px;
            height: 16px;
            margin-right: 4px;
            filter: brightness(0) saturate(100%) invert(44%) sepia(93%) saturate(1352%) hue-rotate(346deg) brightness(119%) contrast(119%);
            vertical-align: middle;
        }

        .breadcrumb-separator {
            margin: 0 8px;
            color: #FC6039;
            font-weight: normal;
        }

        .breadcrumb-current {
            color: #FC6039;
            font-weight: 600;
        }
        
        /* Title and Patient Info Layout */
        .title-patient-layout {
            display: flex;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .title-patient-layout .main-title {
            margin: 0; /* Remove default margin */
            flex: 0 0 auto; /* Don't grow or shrink */
        }
        
        /* Position header to align with the right edge of additional-circulatory-info */
        .header {
            width: fit-content; /* Resize to content width */
            margin: 0; /* Remove default margins */
            position: absolute;
            right: 0; /* Align to the right edge of the container */
            /* This will align with the additional info box since both are in the same container width */
        }

        .main-title {
            font-size: 32px;
            font-weight: 600;
            color: #000000;
            margin: 0;
            margin-right: auto;
            text-align: left;
            line-height: 1.2;
        }

        .header {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 16px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }

        .user-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        #patient-header-info {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
        }

        /* Main container styles */
        .circulatory-settings-container {
            max-width: 1920px; /* Use full width for 1920x1080 */
            margin: 0 auto;
            padding: 0; /* Remove padding to align with body padding */
            display: flex;
            flex-direction: column;
        }
        
        /* Monitoring Level Controls - matching risk level button styling */
        .monitoring-level-controls {
            margin: 0px 0; /* Further reduced from 15px */
            text-align: left; /* Changed from center to left */
            background: rgba(255, 255, 255, 0);
            padding: 0px; /* Further reduced from 20px */
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .monitoring-level-controls .section-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: left; /* Ensure title is also left-aligned */
        }
        
        .monitoring-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 10px; /* Further reduced from 15px */
            text-align: left; /* Changed from default to explicitly left */
        }
        
        /* Layout for monitoring controls and heart circle - horizontal sections */
        .monitoring-controls-layout {
            display: flex;
            gap: -400px; /* Further reduced gap to bring heart circle even closer */
            margin-top: 3px; /* Further reduced from 5px */
            margin-bottom: 10px; /* Further reduced from 15px */
            align-items: flex-start;
            width: 100%;
            position: relative;
        }
        
        .monitoring-buttons-direct {
            flex: 1;
            /* Container properties removed - now direct on page */
            padding: 12px 15px 15px 0px; /* Removed left padding to align with title */
            min-height: 120px; /* Reduced to match additional info container */
            max-height: 120px; /* Reduced to match additional info container */
            display: flex;
            flex-direction: column;
        }
        
        .heart-circle-direct {
            flex: 1;
            /* Container properties removed - now direct on page */
            padding: 0px 15px 15px 15px; /* Further reduced padding */
            margin-left: -300px; /* Increased negative margin to move heart circle closer to monitoring buttons */
            min-height: 200px; /* Reduced from 240px to make it more compact */
            max-height: 200px; /* Reduced from 240px to make it more compact */
            display: flex;
            flex-direction: column;
            align-items: left;
            justify-content: flex-start;
            overflow: visible; /* Changed from hidden to visible to show full circle */
            position: relative;
        }
        
        .heart-circle-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }
        
        #respiratory-heart-circle-container {
            width: 220px;
            height: 220px;
            max-width: 100%;
            max-height: 260px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Changed from center to flex-start to move left */
            margin: 0;
            padding-top: 12px;
            overflow: visible; /* Ensure circle content is not clipped */
        }
        .heart-organ-circle {
            opacity: 1 !important;
            position: relative !important;
        }
        
        /* Specific override for respiratory page heart circle positioning */
        #respiratory-heart-circle-container .heart-organ-circle {
            justify-content: flex-start !important;
            margin: 0 !important;
        }
        
        /* Additional Circulatory Information Container - matches alarm overview form-section */
        .additional-circulatory-info {
            flex: 1.05; /* Further reduced for better proportions */
            display: flex;
            flex-direction: column;
        }
        
        .circulatory-tags-section {
            background: #C2E4FF;
            padding: 15px 20px 20px 20px;
            border-radius: 30px 0px 30px 0px;
            min-height: 100px; /* Reduced since title is outside */
            max-height: 100px;
            display: flex;
            gap: 8px; /* Reduced from 15px to bring buttons closer */
            flex-wrap: wrap;
            align-items: flex-start;
        }
        
        /* General info-title styling for all containers */
        .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 15px;
            text-align: left;
            position: relative;
            z-index: 2;
        }
        
        .additional-circulatory-info .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 8px; /* Reduced margin to bring container closer */
            margin-left: 0px; /* Reduced left margin for better alignment */
            text-align: left;
            position: relative;
            background: transparent; /* Ensure no background */
            z-index: 10; /* Position above the blue container */
        }

        .monitoring-buttons-direct .info-title {
            font-size: 18px;
            font-weight: 600;
            color: #1961AB;
            margin: 0;
            margin-bottom: 8px; /* Match additional info title margin */
            text-align: left;
            position: relative;
            z-index: 2;
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-start;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: #f8f9fa;
            color: #495057;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-family: 'Open Sans', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn.risk-low {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }

        .btn.risk-med {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
            border-color: #ffc107;
        }

        .btn.risk-high {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
            border-color: #dc3545;
        }

        .btn.selected {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            border-color: #000;
        }
        
        /* Using standard tag styling from styles.css - no custom respiratory styling needed */
        
        .circulatory-tag {
            padding: 6px 12px;
            font-size: 13px;
            white-space: nowrap;
            border-radius: 20px;
            background-color: #bbdefb;
            border: 2px solid #1961AB;
            color: #1961AB;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: auto;
            flex-shrink: 0;
            flex-grow: 0;
        }
        
        .circulatory-tag:hover {
            background: #90caf9;
            border-color: #64b5f6;
        }
        
        .circulatory-tag.selected {
            background-color: #1961AB;
            color: white;
            border-color: #1961AB;
            font-weight: 600;
        }
        
        .circulatory-more-btn {
            background-color: #ff6b35;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: none;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .circulatory-more-btn:hover {
            background-color: #e55a2b;
            transform: scale(1.05);
        }

        /* Section title */
        .section-title {
            color: #1961AB;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 0px;
            text-align: left;
        }

        /* Slider containers and titles */
        .slider-demo-section {
            margin: 8px 0; /* Further reduced from 12px for tighter spacing */
            max-width: 1920px; /* Use full width */
            margin-left: auto;
            margin-right: auto;
            padding: 0; /* Remove padding to align with body padding */
        }
        
        .slider-demo-section .section-title {
            color: #1961AB;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 0px;
            text-align: left;
        }
        
        .demo-description {
            color: #6c757d;
            font-size: 16px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .sliders-layout {
            display: flex;
            gap: 40px; /* Reduced from 120px for compact layout */
            justify-content: center;
            flex-wrap: nowrap; /* Force horizontal layout, no wrapping */
            margin: -20px auto;
            align-items: flex-start; /* Align sliders at the top */
        }
        
        .individual-slider {
            flex: 0 0 auto; /* Don't grow or shrink, use natural size */
            min-width: 400px; /* Reduced from 500px */
            max-width: 450px; /* Reduced from 600px */
        }

        /* AF Slider with Legend Layout */
        .af-slider-with-legend {
            display: flex;
            gap: 100px;
            align-items: center; /* This centers the legend vertically */
        }

        /* Alarm Legend Styles */
        .alarm-legend {
            background: white;
            border-radius: 8px;
            padding: 15px; /* Reduced from 20px */
            min-width: 160px; /* Reduced from 200px */
        }

        .alarm-legend h4 {
            font-family: 'Open Sans', sans-serif;
            color: black;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            font-family: 'Open Sans', sans-serif;
            font-size: 12px;
            color: #333;
            font-weight: 500;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .legend-color.green { background: #00C877; }
        .legend-color.yellow { background: #ECEC3E; }
        .legend-color.orange { background: #F0973E; }
        .legend-color.red { background: #EB4921; }

        /* Navigation buttons */
        .bottom-left-nav, .bottom-right-nav {
            position: fixed;
            bottom: 63px;
            z-index: 1000;
        }

        .bottom-left-nav {
            left: 200px;
        }

        .bottom-right-nav {
            right: 200px;
        }
        
        .nav-button {
            background-color: transparent;
            border: 2px solid #ff6b35;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Open Sans', sans-serif;
            color: #ff6b35;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-button:hover {
            background-color: #ff6b35;
            border-color: #ff6b35;
            color: white;
            transform: translateY(-2px);
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .sliders-layout {
                flex-direction: column;
                align-items: center;
            }
            
            .individual-slider,
            .af-slider-with-legend {
                max-width: 800px;
                width: 100%;
            }
            
            .monitoring-controls-layout {
                flex-direction: column;
                align-items: center;
                gap: 30px;
            }
        }
    </style>

    <script>
        // Global variables
        let currentPatientId = null;
        let currentBed = null;
        let currentSettings = {
            saturatie: { min: 90, max: 100 },
            af: { min: 10, max: 25 }
        };

        // Slider instances
        let saturatieSlider = null;
        let afSlider = null;

        // SVG content for the heart circle
        const svgContent = {
            heart: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="currentColor"/>
            </svg>`
        };

        // Utility to inject SVG content into the heart circle
        function injectSVG(containerId, svgType) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const iconDiv = container.querySelector('.heart-white-center');
            if (iconDiv) {
                iconDiv.innerHTML = svgContent[svgType];
                const svgEl = iconDiv.querySelector('svg');
                if (svgEl) {
                    svgEl.style.width = '70%';
                    svgEl.style.height = '70%';
                    svgEl.style.display = 'block';
                    svgEl.style.margin = '0 auto';
                }
            } else {
                setTimeout(() => injectSVG(containerId, svgType), 50);
            }
        }

        // Initialize the heart circle component in respiratory settings
        function initializeHeartCircleComponent() {
            // Use same size as alarm overview
            const circleSize = 130;
            
            // Get current monitoring level from SharedDataManager
            let initialLevel = 'mid';
            if (currentPatientId && window.sharedDataManager) {
                initialLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                console.log(`Loading heart monitoring level for patient ${currentPatientId}:`, initialLevel);
            }
            
            window.respiratoryHeartCircle = new HeartCircleComponent('respiratory-heart-circle-container', { 
                size: circleSize, 
                initialState: initialLevel 
            });
            setTimeout(() => injectSVG('respiratory-heart-circle-container', 'heart'), 100);
            
            // Map heart circle levels to button levels for initial setup
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight'
            };
            
            const buttonLevel = levelMapping[initialLevel] || 'mid';
            
            // Update button states to match loaded level
            updateButtonStates(buttonLevel);
            
            // Update sliders to match loaded level (wait for sliders to be initialized)
            setTimeout(() => {
                updateSlidersMonitoringLevel(buttonLevel);
            }, 1500); // Wait for sliders to be fully initialized
            
            // Listen for global heart monitoring level changes
            document.addEventListener('heartMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                if (patientId === currentPatientId) {
                    console.log(`Received heart monitoring level change for patient ${patientId}:`, level);
                    if (window.respiratoryHeartCircle) {
                        window.respiratoryHeartCircle.setRiskLevel(level);
                    }
                    
                    const buttonLevel = levelMapping[level] || 'mid';
                    updateButtonStates(buttonLevel);
                    updateSlidersMonitoringLevel(buttonLevel);
                }
            });
        }
        
        // Helper function to update button states
        function updateButtonStates(level) {
            // Map heart circle levels back to button levels
            const levelMapping = {
                'low': 'loose',
                'mid': 'mid', 
                'high': 'tight',
                'loose': 'loose',  // fallback mappings
                'tight': 'tight'
            };
            
            const mappedLevel = levelMapping[level] || level;
            console.log(`Updating button states: ${level} ‚Üí ${mappedLevel}`);
            
            // Update button states
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            const selectedButton = document.querySelector(`[data-level="${mappedLevel}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`‚úÖ Button ${mappedLevel} selected in updateButtonStates`);
            } else {
                console.warn(`‚ùå Button with data-level="${mappedLevel}" not found`);
            }
        }

        // Helper function to update sliders monitoring level (moved outside closure for global access)
        function updateSlidersMonitoringLevel(level) {
            console.log(`üéõÔ∏è Updating sliders monitoring level to: ${level}`);
            console.log('üîç DEBUG - saturatieSlider exists:', !!saturatieSlider);
            console.log('üîç DEBUG - afSlider exists:', !!afSlider);
            
            if (saturatieSlider) {
                console.log('üîç DEBUG - saturatieSlider type:', typeof saturatieSlider);
                console.log('üîç DEBUG - saturatieSlider.updateMonitoringLevel exists:', typeof saturatieSlider.updateMonitoringLevel);
            }
            
            // Update Saturatie slider if it exists
            if (saturatieSlider && typeof saturatieSlider.updateMonitoringLevel === 'function') {
                console.log('üéõÔ∏è Calling saturatieSlider.updateMonitoringLevel with:', level);
                saturatieSlider.updateMonitoringLevel(level);
                console.log('‚úÖ Saturatie slider monitoring level updated to:', level);
            } else {
                console.warn('‚ùå Saturatie slider not found or updateMonitoringLevel method not available');
                console.warn('‚ùå saturatieSlider:', saturatieSlider);
                if (saturatieSlider) {
                    console.warn('‚ùå Available methods:', Object.getOwnPropertyNames(saturatieSlider));
                }
            }
            
            // Update AF slider if it exists
            if (afSlider && typeof afSlider.updateMonitoringLevel === 'function') {
                console.log('üéõÔ∏è Calling afSlider.updateMonitoringLevel with:', level);
                afSlider.updateMonitoringLevel(level);
                console.log('‚úÖ AF slider monitoring level updated to:', level);
            } else {
                console.warn('‚ùå AF slider not found or updateMonitoringLevel method not available');
                console.warn('‚ùå afSlider:', afSlider);
                if (afSlider) {
                    console.warn('‚ùå Available methods:', Object.getOwnPropertyNames(afSlider));
                }
            }
        }

        // Function to change monitoring level for all sliders
        function changeMonitoringLevel(level) {
            console.log(`üîÑ Changing monitoring level to: ${level}`);
            
            // Map button levels to heart circle levels
            const levelMapping = {
                'loose': 'low',
                'mid': 'mid',
                'tight': 'high'
            };
            
            const heartLevel = levelMapping[level] || level;
            console.log(`Mapped ${level} to heart level: ${heartLevel}`);
            
            // Update button states - remove active/selected from all buttons
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            
            // Add selected class to the clicked button
            const selectedButton = document.querySelector(`[data-level="${level}"]`);
            if (selectedButton) {
                selectedButton.classList.add('selected');
                console.log(`‚úÖ Button ${level} selected`);
            }
            
            // Update heart circle if it exists
            if (window.respiratoryHeartCircle) {
                console.log(`ü´Ä Updating heart circle to: ${heartLevel}`);
                window.respiratoryHeartCircle.setRiskLevel(heartLevel);
            } else {
                console.warn('‚ùå respiratoryHeartCircle not found');
            }
            
            // Save to SharedDataManager for global sync
            if (currentPatientId && window.sharedDataManager) {
                window.sharedDataManager.updateGlobalHeartMonitoringLevel(currentPatientId, heartLevel);
                console.log(`‚úÖ Saved heart level ${heartLevel} for patient ${currentPatientId}`);
                
                // Mark this as a recent manual change to prioritize it over calculated values
                sessionStorage.setItem('recentHeartLevelChange', Date.now().toString());
            }
            
            // Update sliders if they exist
            updateSlidersMonitoringLevel(level);
            
            console.log(`‚úÖ Monitoring level changed to: ${level} (heart: ${heartLevel})`);
        }

        function initializePage() {
            console.log('üîÑ Initializing respiratory settings page...');
            
            // Try to get patient and session data from multiple sources
            if (window.sharedDataManager) {
                // First, try to get from URL parameters (if navigated directly)
                const urlParams = new URLSearchParams(window.location.search);
                const urlPatient = urlParams.get('patient');
                const urlBed = urlParams.get('bed');
                
                // Second, try to get from session data
                const sessionData = window.sharedDataManager.getSessionData();
                
                // Use URL parameters if available, otherwise use session data
                currentPatientId = urlPatient || sessionData.currentPatient;
                currentBed = urlBed || sessionData.currentBed;
                
                console.log('üìã Patient sources - URL:', urlPatient, 'Session:', sessionData.currentPatient);
                console.log('üõèÔ∏è Bed sources - URL:', urlBed, 'Session:', sessionData.currentBed);
                console.log('‚úÖ Final selection - Patient:', currentPatientId, 'Bed:', currentBed);
                
                // If still no patient/bed data, redirect to bed overview
                if (!currentPatientId || !currentBed) {
                    console.warn('‚ö†Ô∏è No patient or bed data found, redirecting to bed overview');
                    alert('Geen pati√´ntgegevens gevonden. Ga terug naar het bedoverzicht om een pati√´nt te selecteren.');
                    window.location.href = 'bed-overview.html';
                    return;
                }
                
                // Update session data to ensure consistency
                window.sharedDataManager.saveSessionData({
                    currentPatient: currentPatientId,
                    currentBed: currentBed,
                    lastUpdated: new Date().toISOString()
                });
                
                // Update header with patient info
                updatePatientHeader();
            } else {
                console.error('‚ùå SharedDataManager not available');
                alert('Data manager niet beschikbaar. Herlaad de pagina.');
            }
        }

        function updatePatientHeader() {
            const headerElement = document.getElementById('patient-header-info');
            if (currentPatientId && currentBed) {
                const patientInfo = window.sharedDataManager.getPatientInfo(currentPatientId);
                const displayName = patientInfo?.name || `Pati√´nt ${currentPatientId}`;
                
                // Get medical information including main problem and risk level
                const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                
                let headerText = `${displayName} - Bed ${currentBed}`;
                
                // Add main problem if available
                if (medicalInfo?.selectedProblem) {
                    const problemMapping = {
                        'sepsis': 'Sepsis',
                        'pneumonia': 'Pneumonie',
                        'cardiac': 'Hartproblemen',
                        'surgery': 'Chirurgie',
                        'other': 'Overig'
                    };
                    const problemText = problemMapping[medicalInfo.selectedProblem] || medicalInfo.selectedProblem;
                    headerText += ` | ${problemText}`;
                }
                
                // Add risk level indicator
                if (medicalInfo?.riskLevel && medicalInfo.riskLevel !== 'normal') {
                    const riskMapping = {
                        'high': 'üî¥ Hoog Risico',
                        'medium': 'üü° Gemiddeld Risico',
                        'low': 'üü¢ Laag Risico'
                    };
                    const riskText = riskMapping[medicalInfo.riskLevel] || medicalInfo.riskLevel;
                    headerText += ` | ${riskText}`;
                }
                
                headerElement.textContent = headerText;
            } else {
                headerElement.textContent = 'Patient information not available';
            }
        }

        // Wait for all components to be loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM Content Loaded - initializing respiratory settings page');
            
            // Wait a bit for all scripts to load
            setTimeout(() => {
                initializePage();
                loadCurrentSettings();
                initializeSliders();
                initializeHeartCircleComponent();
                setupEventListeners();
            }, 250);
        });

        function loadCurrentSettings() {
            console.log('üìä Loading current respiratory settings...');
            
            if (currentPatientId && window.sharedDataManager) {
                // Load patient-specific target ranges first
                const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                console.log('üéØ Loaded target ranges for patient:', currentPatientId, targetRanges);
                
                // Update currentSettings to use target ranges
                if (targetRanges) {
                    currentSettings = {
                        saturatie: {
                            min: targetRanges.Saturatie?.min || 90,
                            max: targetRanges.Saturatie?.max || 100
                        },
                        af: {
                            min: targetRanges.AF?.min || 10,
                            max: targetRanges.AF?.max || 25
                        }
                    };
                }
                
                // Try to load existing patient-specific fine-tuned settings
                const savedSettings = window.sharedDataManager.getPatientRespiratorySettings(currentPatientId);
                
                if (savedSettings) {
                    console.log('‚úÖ Found saved fine-tuned respiratory settings:', savedSettings);
                    
                    // Check if current target ranges are sepsis ranges
                    const isSepsisActive = targetRanges && targetRanges.Saturatie && 
                                          targetRanges.Saturatie.min === 92 && targetRanges.Saturatie.max === 100;
                    
                    if (isSepsisActive) {
                        // Sepsis is active - target ranges take priority over saved settings
                        console.log('ü¶† Sepsis is active - using target ranges instead of saved settings');
                        // Keep currentSettings as is (target ranges)
                    } else {
                        // Normal case - merge saved settings with target ranges (saved settings take priority for fine-tuning)
                        currentSettings = {
                            saturatie: savedSettings.saturatie || currentSettings.saturatie,
                            af: savedSettings.af || currentSettings.af
                        };
                        console.log('‚úÖ Using saved fine-tuned respiratory settings:', currentSettings);
                    }
                } else {
                    // If no fine-tuned settings, check if we need to load from medical info
                    const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                    if (medicalInfo && medicalInfo.selectedTags && !targetRanges) {
                        // Only apply condition-based thresholds if no target ranges exist
                        const thresholds = window.sharedDataManager.getThresholdsByTags(medicalInfo.selectedTags);
                        if (thresholds && thresholds.respiratoir) {
                            currentSettings = {
                                saturatie: thresholds.respiratoir.Saturatie || { min: 90, max: 100 },
                                af: thresholds.respiratoir.AF || { min: 10, max: 25 }
                            };
                            console.log('‚úÖ Applied condition-based respiratory thresholds:', currentSettings);
                        }
                    }
                }
                
                console.log('‚úÖ Final current respiratory settings loaded:', currentSettings);
            }
        }

        function initializeSliders() {
            console.log('üéõÔ∏è Initializing respiratory sliders...');
            
            // Debug: Check if containers exist
            const saturatieContainer = document.getElementById('saturatie-slider-container');
            const afContainer = document.getElementById('af-slider-container');
            console.log('Saturatie Container found:', !!saturatieContainer);
            console.log('AF Container found:', !!afContainer);
            
            // Check if slider components are loaded
            console.log('VitalParameterSlider available:', !!window.VitalParameterSlider);
            console.log('PatientConfigurationHelper available:', !!window.PatientConfigurationHelper);
            console.log('SharedDataManager available:', !!window.sharedDataManager);
            
            if (!window.VitalParameterSlider) {
                console.error('‚ùå VitalParameterSlider class not found');
                if (saturatieContainer) saturatieContainer.innerHTML = '<p style="color: red;">Slider component not loaded - VitalParameterSlider missing</p>';
                return;
            }
            
            if (!window.PatientConfigurationHelper) {
                console.error('‚ùå PatientConfigurationHelper class not found');
                if (afContainer) afContainer.innerHTML = '<p style="color: red;">Slider component not loaded - PatientConfigurationHelper missing</p>';
                return;
            }
            
            if (!currentPatientId) {
                console.error('‚ùå No patient ID available for sliders');
                if (saturatieContainer) saturatieContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                if (afContainer) afContainer.innerHTML = '<p style="color: orange;">No patient ID available</p>';
                return;
            }
            
            console.log('‚úÖ All prerequisites met, creating respiratory sliders for patient:', currentPatientId);
            
            try {
                // Debug: Check what data we have
                console.log('Current patient ID:', currentPatientId);
                const patientInfo = window.sharedDataManager ? window.sharedDataManager.getPatientInfo(currentPatientId) : null;
                const patientSettings = window.sharedDataManager ? window.sharedDataManager.getPatientRespiratorySettings(currentPatientId) : null;
                console.log('Patient info:', patientInfo);
                console.log('Patient respiratory settings:', patientSettings);
                
                // Initialize Saturatie Slider
                const saturatieContainer = document.getElementById('saturatie-slider-container');
                if (saturatieContainer) {
                    console.log('üí® Creating Saturatie slider...');
                    saturatieContainer.innerHTML = '<p style="color: blue;">Loading Saturatie slider...</p>';
                    
                    try {
                        // Try direct instantiation first
                        saturatieSlider = new window.VitalParameterSlider(saturatieContainer, {
                            parameter: 'Saturatie',
                            name: 'Saturatie',
                            unit: '%',
                            targetRange: {
                                min: currentSettings.saturatie.min,
                                max: currentSettings.saturatie.max
                            },
                            yAxis: {
                                min: 80,
                                max: 100,
                                step: 5
                            },
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Patient ${currentPatientId}`,
                            monitoringLevel: 'mid',
                            onChange: (data) => {
                                console.log('üéØ Saturatie slider changed:', data);
                            }
                        });
                        
                        console.log('‚úÖ Saturatie slider created successfully');
                        
                    } catch (error) {
                        console.error('‚ùå Error creating Saturatie slider with direct method:', error);
                        
                        // Fallback to PatientConfigurationHelper method
                        try {
                            console.log('üîÑ Trying PatientConfigurationHelper for Saturatie...');
                            saturatieSlider = window.PatientConfigurationHelper.createSliderFromSharedData(
                                saturatieContainer, 
                                'Saturatie', 
                                currentPatientId,
                                {
                                    monitoringLevel: 'mid',
                                    onChange: (data) => {
                                        console.log('üéØ Saturatie slider changed (helper):', data);
                                    }
                                }
                            );
                            
                            if (saturatieSlider) {
                                console.log('‚úÖ Saturatie slider created via PatientConfigurationHelper');
                            } else {
                                console.error('‚ùå PatientConfigurationHelper returned null for Saturatie');
                                saturatieContainer.innerHTML = '<p style="color: red;">Failed to create Saturatie slider</p>';
                            }
                        } catch (helperError) {
                            console.error('‚ùå Error with PatientConfigurationHelper for Saturatie:', helperError);
                            saturatieContainer.innerHTML = '<p style="color: red;">Error creating Saturatie slider</p>';
                        }
                    }
                }

                // Initialize AF Slider
                const afContainer = document.getElementById('af-slider-container');
                if (afContainer) {
                    console.log('ü´Å Creating AF slider...');
                    afContainer.innerHTML = '<p style="color: blue;">Loading AF slider...</p>';
                    
                    try {
                        // Try direct instantiation first
                        afSlider = new window.VitalParameterSlider(afContainer, {
                            parameter: 'AF',
                            name: 'Ademfrequentie',
                            unit: 'bpm',
                            targetRange: {
                                min: currentSettings.af.min,
                                max: currentSettings.af.max
                            },
                            yAxis: {
                                min: 5,
                                max: 35,
                                step: 5
                            },
                            patientId: currentPatientId,
                            patientName: patientInfo?.name || `Patient ${currentPatientId}`,
                            monitoringLevel: 'mid',
                            onChange: (data) => {
                                console.log('üéØ AF slider changed:', data);
                            }
                        });
                        
                        console.log('‚úÖ AF slider created successfully');
                        
                    } catch (error) {
                        console.error('‚ùå Error creating AF slider with direct method:', error);
                        
                        // Fallback to PatientConfigurationHelper method
                        try {
                            console.log('üîÑ Trying PatientConfigurationHelper for AF...');
                            afSlider = window.PatientConfigurationHelper.createSliderFromSharedData(
                                afContainer, 
                                'AF', 
                                currentPatientId,
                                {
                                    monitoringLevel: 'mid',
                                    onChange: (data) => {
                                        console.log('üéØ AF slider changed (helper):', data);
                                    }
                                }
                            );
                            
                            if (afSlider) {
                                console.log('‚úÖ AF slider created via PatientConfigurationHelper');
                            } else {
                                console.error('‚ùå PatientConfigurationHelper returned null for AF');
                                afContainer.innerHTML = '<p style="color: red;">Failed to create AF slider</p>';
                            }
                        } catch (helperError) {
                            console.error('‚ùå Error with PatientConfigurationHelper for AF:', helperError);
                            afContainer.innerHTML = '<p style="color: red;">Error creating AF slider</p>';
                        }
                    }
                }

                // Log final state
                console.log('üéõÔ∏è Slider creation completed');
                console.log('üéõÔ∏è Final saturatieSlider:', saturatieSlider);
                console.log('üéõÔ∏è Final afSlider:', afSlider);
                
            } catch (error) {
                console.error('‚ùå General error in slider initialization:', error);
            }
        }

        function setupEventListeners() {
            console.log('üéß Setting up respiratory event listeners...');
            
            // Set up respiratory tag button listeners
            const respiratoryTagButtons = document.querySelectorAll('.circulatory-tag');
            respiratoryTagButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tagCondition = this.dataset.condition;
                    
                    if (this.classList.contains('selected')) {
                        // Deselect tag
                        this.classList.remove('selected');
                        
                        // Handle sepsis deselection
                        if (tagCondition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.handleSepsisTagChange(currentPatientId, false);
                            console.log('ü¶† Sepsis deselected in respiratory settings');
                        }
                    } else {
                        // Select tag
                        this.classList.add('selected');
                        
                        // Handle sepsis selection
                        if (tagCondition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.handleSepsisTagChange(currentPatientId, true);
                            console.log('ü¶† Sepsis selected in respiratory settings');
                        }
                    }
                });
            });
        }

        // Navigation functions
        function goToBedOverview() {
            window.location.href = 'bed-overview.html';
        }

        function goBackToAlarmOverview() {
            if (currentPatientId && currentBed) {
                window.location.href = `alarm-overview.html?patient=${currentPatientId}&bed=${currentBed}`;
            } else {
                window.location.href = 'alarm-overview.html';
            }
        }

        function goToCirculatoir() {
            if (currentPatientId && currentBed) {
                window.location.href = `circulatoir-settings.html?patient=${currentPatientId}&bed=${currentBed}`;
            } else {
                window.location.href = 'circulatoir-settings.html';
            }
        }
    </script>
</body>
</html>
