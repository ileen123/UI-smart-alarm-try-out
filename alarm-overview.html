<!DOCTYPE html>
<html lang="nl">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title that appears in browser tab -->
    <title>Alarm Overzicht</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Data Manager for cross-page data synchronization -->
    <script src="js/data-manager.js"></script>
    <script src="js/shared-data-manager.js"></script>
</head>
<body>
    <!-- Patient information header section -->
    <div class="header">
        <img src="svg's/patient_icon.svg" alt="Patient" class="user-icon" />
        <span id="patient-header-info">Loading patient info...</span>
    </div>
    
    <!-- Main page title -->
    <h1 class="main-title">Alarm Overzicht</h1>
    
    <!-- Top section with three columns matching the setup page design -->
        <!-- Container for the three main form sections - horizontal layout -->
    <div class="form-sections-container">
        <!-- Section 1: Main problem selection -->
        <div class="form-section">
            <h2 class="section-title">Wat is het hoofdprobleem?</h2>
            <div class="dropdown-container">
                <select class="problem-dropdown" id="problem-dropdown">
                    <option value="">Selecteer een probleem...</option>
                    <option value="respiratoire-insufficientie">Respiratoire Insuffici√´ntie</option>
                    <option value="hart-falen">Hart Falen</option>
                    <option value="sepsis">Sepsis</option>
                    <option value="neurologische-aandoening">Neurologische Aandoening</option>
                    <option value="nierinsuffcientie">Nierinsuffici√´ntie</option>
                    <option value="leverfalen">Leverfalen</option>
                </select>
            </div>
        </div>
        
        <!-- Section 2: Risk level selection -->
        <div class="form-section">
            <h2 class="section-title">Wat is het risico - level van de pati√´nt?</h2>
            <div class="button-group">
                <button class="btn risk-low" data-risk="low">Laag</button>
                <button class="btn risk-med" data-risk="med">Mid</button>
                <button class="btn risk-high" data-risk="high">Hoog</button>
            </div>
            <!-- Static alarm indicator SVG -->
            <div class="alarm-indicator-svg">
                <img src="svg's/alarm_indicator.svg" alt="Alarm Indicator" />
            </div>
        </div>
        
        <!-- Section 3: Additional medical conditions/tags -->
        <div class="form-section">
            <h2 class="section-title">Selecteer eventueel additionele informatie:</h2>
            <div class="tags-section">
                <!-- All tags in horizontal layout with wrapping -->
                <div class="button-group tags-horizontal">
                    <button class="btn tag-btn" data-condition="sepsis">
                        Sepsis <img src="svg's/sepsis.svg" alt="Sepsis" class="sepsis-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="diabetes">Diabetes ÔøΩ</button>
                    <button class="btn tag-btn" data-condition="herstellende">Herstellende üë§</button>
                    <button class="btn tag-btn" data-condition="pneumonie">Pneumonie ü´Å</button>
                    <button class="btn tag-btn" data-condition="chronisch-nierfalen">Chronisch Nierfalen ÔøΩ</button>
                    <!-- More button to show additional options -->
                    <button class="more-btn">‚ãØ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom section: Organ monitoring -->
        <!-- Section 4: Organ-level monitoring configuration -->
    <div class="monitoring-section">
        <h2 class="section-title">Monitoring op Orgaan Niveau</h2>
        
        <!-- Grid of organ monitoring circles -->
        <div class="monitoring-grid">
            <!-- Circulatory system -->
            <div class="monitor-item">
                <div class="monitor-label inactive-text">Circulatoir</div>
                <div id="heart-circle-container"></div>
                <div class="monitor-status inactive-text">los</div>
            </div>
            <!-- Respiratory system -->
            <div class="monitor-item">
                <div class="monitor-label inactive-text">Respiratoir</div>
                <div id="lung-circle-container"></div>
                <div class="monitor-status inactive-text">los</div>
            </div>
            <!-- Other/Temperature system -->
            <div class="monitor-item">
                <div class="monitor-label inactive-text">Overig</div>
                <div id="temp-circle-container"></div>
                <div class="monitor-status inactive-text">los</div>
            </div>
        </div>
        
        <!-- Parameter value cards showing normal ranges for each organ system -->
        <div class="monitor-values">
            <!-- Circulatory parameters -->
            <div class="value-card">
                <div class="value-label inactive-text">HR</div>
                <div class="value-number inactive-text">70 - 110 bpm</div>
                <div class="value-label inactive-text">BP Mean</div>
                <div class="value-number inactive-text">65 - 85 mmHg</div>
                <button class="adjust-btn" onclick="adjustOrganSettings('circulatoir')">Aanpassen</button>
            </div>
            
            <!-- Respiratory parameters -->
            <div class="value-card">
                <div class="value-label inactive-text">Saturatie</div>
                <div class="value-number inactive-text">90 - 100 %</div>
                <div class="value-label inactive-text">AF</div>
                <div class="value-number inactive-text">10 - 25 /min</div>
                <button class="adjust-btn" onclick="adjustOrganSettings('respiratoir')">Aanpassen</button>
            </div>
            
            <!-- Temperature parameters -->
            <div class="value-card">
                <div class="value-label inactive-text">Temp.</div>
                <div class="value-number inactive-text">36.5 - 39 ¬∞C</div>
                <button class="adjust-btn" onclick="adjustOrganSettings('overig')">Aanpassen</button>
            </div>
        </div>
    </div>
    
    <!-- Navigation buttons at bottom of page -->
    <div class="navigation">
        <!-- Back button with onclick event -->
        <button class="nav-btn" onclick="goBackToBedOverview()">‚Üê Terug naar Bedoverzicht</button>
        <!-- Save button with onclick event -->
        <button class="nav-btn primary" onclick="saveAlarmSettings()">Instellingen Opslaan</button>
    </div>

    <!-- Import Heart Circle Component -->
    <script src="heart-circle-component.js"></script>
    <script>
        // Global variables for current session
        let selectedProblem = '';
        let selectedRiskLevel = '';
        let selectedTags = [];
        let currentPatientId = '';
        let currentBedNumber = '';

        // SVG content embedded to avoid CORS issues
        const svgContent = {
            heart: `<svg class="organ-icon" viewBox="0 0 22 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.22 10.3743C12.0679 12.132 10.9163 15.0615 10.9163 19.1628M13.22 10.3743C12.0681 12.132 11.4922 14.4756 6.30842 14.4756M13.22 10.3743C14.6766 8.39884 16.9516 6.83964 19.3552 6.3986C20.0557 6.27006 20.6011 5.62288 20.4841 4.90863L20.2921 3.73684C20.1996 3.17181 19.7182 2.75127 19.159 2.81881C16.3987 3.15222 12.9705 4.8327 10.9162 7.44486C10.9162 6.27307 10.9162 2.75769 10.3402 1M5.73245 6.85896C5.15648 5.10127 4.00454 3.92948 2.27663 3.92948M1.70071 15.6441C2.85258 20.9171 7.26892 25 10.3401 25C13.4113 25 17.6365 20.9175 18.9799 15.6441C20.3232 10.3707 16.1 6.85563 13.2201 10.371C13.2201 8.61732 11.4922 6.85906 8.03639 6.85906C4.58057 6.85906 0.548838 10.371 1.70071 15.6441Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`,
            lung: `<svg class="organ-icon" viewBox="0 0 30 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.5007 5.62881C11.5007 4.02205 10.3628 2.41595 5.90178 6.31748C-0.397037 11.8263 1.7026 24.2213 2.40247 24.91C3.10233 25.5986 10.8008 22.1555 11.5007 20.7783C12.2006 19.4011 10.8008 17.3352 12.2006 14.5808M18.4993 5.62879C18.4993 4.02203 19.6372 2.41593 24.0982 6.31746C30.397 11.8263 28.2974 24.2213 27.5975 24.9099C26.8977 25.5985 19.1992 22.1555 18.4993 20.7783C17.7994 19.401 19.1992 17.3352 17.7994 14.5807M21.9987 16.6468C21.9987 13.3949 19.8717 11.7738 18.2519 10.7191C14.9109 8.54378 15 4.4935 15 0.999945C15 4.4935 15.0891 8.54378 11.7481 10.7191C10.1283 11.7738 8.00142 13.3949 8.00142 16.6468" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`,
            temp: `<svg class="organ-icon" viewBox="0 0 16 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5.71349 0C3.94455 0 2.4982 1.42157 2.4982 3.15972V13.7459C0.944989 14.7857 0.000507593 16.5193 0 18.3844C0 21.4774 2.56656 24 5.71349 24C8.86042 24 11.4265 21.4774 11.4265 18.3844C11.4265 16.5193 10.482 14.7842 8.92828 13.7444V3.15972C8.92828 1.42157 7.48193 0 5.71349 0ZM5.71349 1.41162C6.71166 1.41162 7.49206 2.17865 7.49206 3.15972V14.1326C7.49212 14.2565 7.52539 14.3783 7.58851 14.4856C7.65162 14.5929 7.74237 14.682 7.85162 14.7438C9.17643 15.4954 9.99076 16.8812 9.99076 18.3844C9.99076 20.7144 8.08457 22.5884 5.714 22.5879C5.71383 22.5879 5.71416 22.5879 5.714 22.5879C3.34393 22.5884 1.43673 20.7144 1.43673 18.3849C1.43724 16.8822 2.25207 15.4964 3.57587 14.7453C3.68512 14.6834 3.77586 14.5944 3.83898 14.4871C3.9021 14.3798 3.93536 14.258 3.93543 14.1341V3.15972C3.93543 2.17865 4.71482 1.41162 5.71349 1.41162ZM11.5885 1.87453C11.3981 1.87455 11.2154 1.94891 11.0808 2.08127C10.9461 2.21363 10.8704 2.39315 10.8704 2.58033C10.8704 2.76752 10.9461 2.94704 11.0808 3.0794C11.2154 3.21176 11.3981 3.28613 11.5885 3.28615H15.2819C15.4723 3.28613 15.655 3.21176 15.7897 3.0794C15.9243 2.94704 16 2.76752 16 2.58033C16 2.39315 15.9243 2.21363 15.7896 2.08127C15.655 1.94891 15.4723 1.87455 15.2819 1.87453H11.5885ZM5.71349 2.58033C5.61915 2.58028 5.52572 2.59849 5.43854 2.63394C5.35136 2.66938 5.27214 2.72136 5.2054 2.7869C5.13867 2.85245 5.08572 2.93028 5.0496 3.01594C5.01348 3.1016 4.99488 3.19342 4.99487 3.28615V15.2102C3.51864 15.5338 2.40552 16.8384 2.40552 18.3834C2.40552 20.1708 3.89492 21.6347 5.71349 21.6347C7.53156 21.6347 9.02146 20.1708 9.02146 18.3834C9.02146 16.8384 7.90783 15.5348 6.4316 15.2102V3.28615C6.43158 3.09896 6.35592 2.91944 6.22125 2.78708C6.08658 2.65472 5.90394 2.58035 5.71349 2.58033ZM11.5885 5.10144C11.4942 5.10145 11.4008 5.11973 11.3136 5.15523C11.2265 5.19073 11.1473 5.24277 11.0806 5.30836C11.0139 5.37395 10.961 5.45182 10.925 5.5375C10.8889 5.62319 10.8704 5.71502 10.8704 5.80775C10.8704 5.99493 10.9461 6.17445 11.0808 6.30681C11.2154 6.43917 11.3981 6.51353 11.5885 6.51355H13.8431C14.0336 6.51353 14.2162 6.43917 14.3509 6.30681C14.4856 6.17445 14.5612 5.99493 14.5612 5.80775C14.5613 5.71502 14.5428 5.62319 14.5067 5.5375C14.4707 5.45182 14.4178 5.37395 14.3511 5.30836C14.2844 5.24277 14.2052 5.19073 14.1181 5.15523C14.0309 5.11972 13.9375 5.10145 13.8431 5.10144H11.5885ZM11.5885 8.32885C11.3981 8.32886 11.2154 8.40323 11.0808 8.53559C10.9461 8.66796 10.8704 8.84747 10.8704 9.03466C10.8704 9.22184 10.9461 9.40136 11.0808 9.53372C11.2154 9.66608 11.3981 9.74045 11.5885 9.74046H15.2819C15.4723 9.74045 15.655 9.66608 15.7896 9.53372C15.9243 9.40136 16 9.22184 16 9.03466C16 8.84747 15.9243 8.66796 15.7897 8.53559C15.655 8.40323 15.4723 8.32886 15.2819 8.32885H11.5885ZM11.5885 11.5563C11.3981 11.5563 11.2154 11.6306 11.0808 11.763C10.9461 11.8954 10.8704 12.0749 10.8704 12.2621C10.8704 12.4493 10.9461 12.6288 11.0808 12.7611C11.2154 12.8935 11.3981 12.9679 11.5885 12.9679H13.8431C14.0336 12.9679 14.2162 12.8935 14.3509 12.7611C14.4856 12.6288 14.5612 12.4493 14.5612 12.2621C14.5612 12.0749 14.4856 11.8954 14.3509 11.763C14.2162 11.6306 14.0336 11.5563 13.8431 11.5563H11.5885ZM5.71349 16.5437C6.75571 16.5437 7.58473 17.359 7.58473 18.3834C7.58473 19.4078 6.75571 20.2231 5.71349 20.2231C4.67127 20.2231 3.84174 19.4078 3.84174 18.3834C3.84174 17.359 4.67127 16.5437 5.71349 16.5437Z" fill="black"/>
            </svg>`
        };

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeAlarmOverview();
            setupEventListeners();
            initializeCircleComponents();
            
            // Load existing settings after components are initialized
            loadExistingSettings();
            
            // Load saved heart monitoring level and apply it
            setTimeout(() => {
                loadSavedHeartMonitoringLevel();
            }, 1000); // Increased delay to ensure it runs after loadExistingSettings
        });

        function initializeAlarmOverview() {
            // Get URL parameters to identify patient and bed
            const urlParams = new URLSearchParams(window.location.search);
            currentBedNumber = urlParams.get('bed');
            currentPatientId = urlParams.get('patient');
            
            console.log('Initializing alarm overview for bed:', currentBedNumber, 'patient:', currentPatientId);
            
            if (!currentBedNumber || !currentPatientId) {
                alert('Geen geldige bed- of pati√´ntinformatie gevonden. Ga terug naar het bedoverzicht.');
                goBackToBedOverview();
                return;
            }
            
            // Initialize data using shared data manager
            const initData = window.sharedDataManager.initializeAlarmOverviewPage(currentPatientId);
            console.log('üìä Initialized alarm overview data:', initData);
            
            // Load patient information and settings
            loadPatientInfo();
        }

        async function initializeCircleComponents() {
            // Make all circles same size as setup page
            const circleSize = 130;
            
            console.log('Initializing heart circle components...');
            
            // Get current heart monitoring level from SharedDataManager
            let heartLevel = 'low';
            if (currentPatientId && window.sharedDataManager) {
                heartLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                console.log(`Loading heart monitoring level for patient ${currentPatientId}:`, heartLevel);
            }
            
            // Store references to the components for later control
            window.organComponents = {};
            
            // Heart (circulatoir) - use saved monitoring level
            console.log('Creating heart component...');
            window.organComponents.heart = new HeartCircleComponent('heart-circle-container', { size: circleSize, initialState: heartLevel });
            setTimeout(() => injectSVG('heart-circle-container', 'heart'), 100);
            
            // Lung (respiratoir) - start active since patient is already assigned
            console.log('Creating lung component...');
            window.organComponents.lung = new HeartCircleComponent('lung-circle-container', { size: circleSize, initialState: 'low' });
            setTimeout(() => injectSVG('lung-circle-container', 'lung'), 100);
            
            // Temp (overig) - start active since patient is already assigned
            console.log('Creating temp component...');
            window.organComponents.temp = new HeartCircleComponent('temp-circle-container', { size: circleSize, initialState: 'low' });
            setTimeout(() => injectSVG('temp-circle-container', 'temp'), 100);
            
            // Listen for global heart monitoring level changes
            document.addEventListener('heartMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                if (patientId === currentPatientId && window.organComponents?.heart) {
                    console.log(`Received heart monitoring level change for patient ${patientId}:`, level);
                    window.organComponents.heart.setRiskLevel(level);
                }
            });
            
            // Listen for target range changes
            window.addEventListener('targetRangesChanged', function(event) {
                const { patientId, targetRanges } = event.detail;
                if (patientId === currentPatientId) {
                    console.log('üéØ Target ranges changed in alarm overview:', targetRanges);
                    updateParameterRanges(); // Refresh the displayed ranges
                }
            });
            
            // Listen for HR range changes from sepsis selection
            window.addEventListener('hrRangesChanged', function(event) {
                console.log('üíì HR ranges changed event received:', event.detail);
                if (event.detail.patientId === currentPatientId) {
                    // Update the HR display immediately
                    updateHRDisplay(event.detail.HR_low, event.detail.HR_high, event.detail.source === 'sepsis');
                    
                    // Update BP display if BP values are provided
                    if (typeof event.detail.BP_low !== 'undefined' && typeof event.detail.BP_high !== 'undefined') {
                        updateBPDisplay(event.detail.BP_low, event.detail.BP_high, event.detail.source === 'sepsis');
                    }
                    
                    // Also update parameter ranges to ensure consistency
                    updateParameterRanges();
                    console.log('‚úÖ Called updateParameterRanges() due to HR ranges change');
                    
                    // Update sepsis tag button state based on the event source
                    const sepsisButton = document.querySelector('.tag-btn[data-condition="sepsis"]');
                    if (sepsisButton) {
                        if (event.detail.source === 'sepsis') {
                            // Sepsis was selected elsewhere, select our button
                            if (!sepsisButton.classList.contains('selected')) {
                                sepsisButton.classList.add('selected');
                                selectedTags.push('sepsis');
                                console.log('‚úÖ Synced sepsis button to selected state from external change');
                            }
                        } else if (event.detail.source === 'restore') {
                            // Sepsis was deselected elsewhere, deselect our button
                            if (sepsisButton.classList.contains('selected')) {
                                sepsisButton.classList.remove('selected');
                                selectedTags = selectedTags.filter(t => t !== 'sepsis');
                                console.log('‚úÖ Synced sepsis button to deselected state from external change');
                            }
                        }
                    }
                }
            });
            
            // Make all circles appear active since patient is already assigned
            setTimeout(() => {
                updateAllOpacity(true);
            }, 200);
        }

        // Utility to inject SVG content directly (same as setup page)
        function injectSVG(containerId, svgType) {
            console.log('Injecting ' + svgType + ' SVG into ' + containerId);
            const container = document.getElementById(containerId);
            if (!container) {
                console.log('Container ' + containerId + ' not found');
                return;
            }
            const iconDiv = container.querySelector('.heart-white-center');
            if (iconDiv) {
                console.log('Found white center in ' + containerId + ', injecting SVG');
                iconDiv.innerHTML = svgContent[svgType];
                const svgEl = iconDiv.querySelector('svg');
                if (svgEl) {
                    svgEl.style.width = '70%';
                    svgEl.style.height = '70%';
                    svgEl.style.display = 'block';
                    svgEl.style.margin = '0 auto';
                    console.log('SVG successfully injected into ' + containerId);
                }
            } else {
                console.log('White center not found in ' + containerId);
                // Try again after a short delay
                setTimeout(() => injectSVG(containerId, svgType), 50);
            }
        }

        // Update opacity for all circles
        function updateAllOpacity(active) {
            ['heart-circle-container', 'lung-circle-container', 'temp-circle-container'].forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.style.opacity = active ? '1' : '0.3';
                }
            });
        }

        function setupEventListeners() {
            // Set up problem dropdown listener
            const problemDropdown = document.getElementById('problem-dropdown');
            if (problemDropdown) {
                problemDropdown.addEventListener('change', function() {
                    selectedProblem = this.value;
                    console.log('Selected problem:', selectedProblem);
                    updateOrganCirclesBasedOnProblem(selectedProblem);
                });
            }

            // Set up risk level button listeners
            const riskButtons = document.querySelectorAll('.btn.risk-low, .btn.risk-med, .btn.risk-high');
            riskButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Remove selected class from all risk buttons
                    riskButtons.forEach(btn => btn.classList.remove('selected'));
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    
                    // Get risk level and update circles
                    const riskLevel = this.classList.contains('risk-low') ? 'low' : 
                                     this.classList.contains('risk-high') ? 'high' : 'med';
                    selectedRiskLevel = riskLevel;
                    console.log('Risk button clicked, detected risk level:', selectedRiskLevel);
                    updateOrganCirclesWithRisk(riskLevel);
                    
                    // Update global heart monitoring level
                    if (currentPatientId && window.sharedDataManager) {
                        window.sharedDataManager.updateGlobalHeartMonitoringLevel(currentPatientId, riskLevel);
                    }
                });
            });

            // Event listeners for tag buttons (matching setup page structure)
            document.querySelectorAll('.tag-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const condition = this.dataset.condition;
                    if (this.classList.contains('selected')) {
                        // Deselect tag
                        this.classList.remove('selected');
                        selectedTags = selectedTags.filter(t => t !== condition);
                        
                        // Handle sepsis deselection
                        if (condition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.handleSepsisTagChange(currentPatientId, false);
                        }
                    } else {
                        // Select tag
                        this.classList.add('selected');
                        selectedTags.push(condition);
                        
                        // Handle sepsis selection
                        if (condition === 'sepsis' && currentPatientId && window.sharedDataManager) {
                            window.sharedDataManager.handleSepsisTagChange(currentPatientId, true);
                        }
                    }
                    console.log('Selected tags:', selectedTags);
                    
                    // Update parameter ranges based on selected conditions
                    updateParameterRanges();
                });
            });
        }

        function loadPatientInfo() {
            // Get patient info from shared data manager
            const patient = window.sharedDataManager.getPatientInfo(currentPatientId);
            
            if (patient) {
                updatePatientHeader(patient);
                console.log('‚úÖ Loaded patient info from shared data manager:', patient);
            } else {
                // If patient not found, show error
                console.error('‚ùå Patient not found:', currentPatientId);
                document.getElementById('patient-header-info').textContent = currentPatientId + ' - Pati√´ntgegevens niet gevonden';
            }
        }

        function updatePatientHeader(patient) {
            const headerInfo = patient.id + ' - ' + patient.name + ' - ' + patient.gender + ' - ' + patient.age + ' jaar - ' + patient.weight + ' kg';
            document.getElementById('patient-header-info').textContent = headerInfo;
        }

        function loadExistingSettings() {
            console.log('üîç DEBUG: Starting loadExistingSettings');
            console.log('üîç DEBUG: currentPatientId =', currentPatientId);
            
            // Try to load from SharedDataManager first
            let savedMedicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
            console.log('üîç DEBUG: savedMedicalInfo from shared manager =', savedMedicalInfo);
            
            // If not found, try to load from the synchronized localStorage entry
            if (!savedMedicalInfo) {
                const combinedData = localStorage.getItem(`patient_${currentPatientId}_medicalInfo`);
                if (combinedData) {
                    const parsed = JSON.parse(combinedData);
                    savedMedicalInfo = parsed.medicalInfo;
                    console.log('üîç DEBUG: Found data in synchronized localStorage =', savedMedicalInfo);
                }
            }
            
            // If still not found, try old dataManager (if available)
            if (!savedMedicalInfo && window.dataManager) {
                const patientInfo = window.dataManager.getPatientInfo();
                const currentSession = window.dataManager.getCurrentSession();
                if (patientInfo.id === currentPatientId && currentSession) {
                    savedMedicalInfo = {
                        selectedProblem: currentSession.selectedProblem,
                        selectedRiskLevel: currentSession.selectedRiskLevel,
                        selectedTags: currentSession.selectedTags,
                        organSettings: currentSession.organSettings
                    };
                    console.log('üîç DEBUG: Found data in old dataManager =', savedMedicalInfo);
                }
            }
            
            if (savedMedicalInfo) {
                console.log('‚úÖ DEBUG: Found medicalInfo =', savedMedicalInfo);
                
                // Load problem selection in dropdown
                if (savedMedicalInfo.selectedProblem) {
                    selectedProblem = savedMedicalInfo.selectedProblem;
                    const dropdown = document.getElementById('problem-dropdown');
                    console.log('üîç DEBUG: dropdown element =', dropdown);
                    if (dropdown) {
                        dropdown.value = selectedProblem;
                        console.log('‚úÖ DEBUG: Set dropdown value to:', selectedProblem);
                    }
                }
                    
                // Load risk level
                if (savedMedicalInfo.selectedRiskLevel) {
                    selectedRiskLevel = savedMedicalInfo.selectedRiskLevel;
                    console.log('‚úÖ DEBUG: Loading risk level:', selectedRiskLevel);
                    selectRiskLevel(selectedRiskLevel);
                }
                
                // Load tags - but verify sepsis state against SharedDataManager
                if (savedMedicalInfo.selectedTags && Array.isArray(savedMedicalInfo.selectedTags)) {
                    selectedTags = savedMedicalInfo.selectedTags.filter(tag => tag !== 'sepsis'); // Remove sepsis, we'll check it separately
                    console.log('‚úÖ DEBUG: Loading non-sepsis tags:', selectedTags);
                    selectedTags.forEach(tag => {
                        selectTag(tag);
                    });
                }
                
                console.log('‚úÖ DEBUG: Loaded existing settings:', savedMedicalInfo);
                
                // Update organ circles based on loaded data
                if (selectedProblem && selectedRiskLevel) {
                    console.log('‚úÖ DEBUG: Updating organ circles with:', selectedProblem, selectedRiskLevel);
                    updateOrganCircles();
                }
            } else {
                console.log('‚ùå DEBUG: No existing medical info found for patient:', currentPatientId);
                
                // Debug: show all available data
                console.log('üîç DEBUG: All patients data:', window.sharedDataManager.getAllPatients());
                window.sharedDataManager.debugLocalStorage();
            }
            
            // Initialize sepsis tag state based on current SharedDataManager state (source of truth)
            initializeSepsisTagState();
        }

        // Load and apply saved heart monitoring level from circulatoir settings
        function loadSavedHeartMonitoringLevel() {
            if (currentPatientId && window.sharedDataManager && window.organComponents?.heart) {
                const savedHeartLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                console.log(`ü´Ä Loading saved heart monitoring level for patient ${currentPatientId}:`, savedHeartLevel);
                
                // Apply the saved level to the heart circle
                window.organComponents.heart.setRiskLevel(savedHeartLevel);
                console.log(`‚úÖ Applied saved heart monitoring level: ${savedHeartLevel}`);
                
                // Update the risk level buttons if they correspond to the heart level
                updateRiskButtonsForHeartLevel(savedHeartLevel);
            }
        }
        
        // Helper function to update risk level buttons based on heart monitoring level
        function updateRiskButtonsForHeartLevel(heartLevel) {
            // Only update buttons if the heart level was manually set in circulatoir settings
            // (not if it was derived from a problem/risk selection)
            const riskLevelMapping = {
                'low': 'low',
                'mid': 'med', 
                'high': 'high'
            };
            
            const correspondingRiskLevel = riskLevelMapping[heartLevel];
            if (correspondingRiskLevel) {
                // Check if this matches the currently selected risk level
                if (!selectedRiskLevel || selectedRiskLevel !== correspondingRiskLevel) {
                    console.log(`üîÑ Heart monitoring level (${heartLevel}) suggests risk level: ${correspondingRiskLevel}`);
                    // Note: We don't automatically change the risk buttons as they might have been set independently
                    // The heart circle level can be different from the overall risk level
                }
            }
        }

        function selectRiskLevel(riskLevel) {
            // Clear previous selection
            document.querySelectorAll('.btn.risk-low, .btn.risk-med, .btn.risk-high').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select the current risk level based on class name
            let riskButton;
            if (riskLevel === 'low') {
                riskButton = document.querySelector('.btn.risk-low');
            } else if (riskLevel === 'med') {
                riskButton = document.querySelector('.btn.risk-med');
            } else if (riskLevel === 'high') {
                riskButton = document.querySelector('.btn.risk-high');
            }
            
            if (riskButton) {
                riskButton.classList.add('selected');
            }
        }

        function initializeSepsisTagState() {
            console.log('ü¶† Initializing sepsis tag state on alarm overview...');
            
            if (currentPatientId && window.sharedDataManager) {
                // Check if sepsis ranges are currently active by checking the target ranges
                const targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                
                if (targetRanges && targetRanges.HR) {
                    const isSepsisActive = (targetRanges.HR.min === 90 && targetRanges.HR.max === 130);
                    
                    const sepsisButton = document.querySelector('.tag-btn[data-condition="sepsis"]');
                    if (sepsisButton) {
                        if (isSepsisActive) {
                            sepsisButton.classList.add('selected');
                            if (!selectedTags.includes('sepsis')) {
                                selectedTags.push('sepsis');
                            }
                            console.log('‚úÖ Initialized sepsis button as selected (90-130 range detected)');
                        } else {
                            sepsisButton.classList.remove('selected');
                            selectedTags = selectedTags.filter(t => t !== 'sepsis');
                            console.log('‚úÖ Initialized sepsis button as deselected');
                        }
                    }
                }
                
                // Update parameter ranges after initializing sepsis state
                updateParameterRanges();
            }
        }

        function selectTag(tag) {
            const tagElement = document.querySelector('[data-condition="' + tag + '"]');
            if (tagElement && !tagElement.classList.contains('selected')) {
                tagElement.classList.add('selected');
            }
        }

        function updateParameterRanges() {
            console.log('üîç DEBUG: Updating parameter ranges for selected tags:', selectedTags);
            
            // Get patient-specific target ranges first
            let targetRanges = null;
            if (currentPatientId && window.sharedDataManager) {
                targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                console.log('üéØ Patient target ranges:', targetRanges);
            }
            
            // If we have target ranges, use them; otherwise fall back to condition-based logic
            if (targetRanges) {
                // Update HR display with target ranges
                const circulatoryCard = document.querySelector('.value-card');
                const hrRange = circulatoryCard?.querySelector('.value-number');
                
                if (hrRange && targetRanges.HR) {
                    const hr = targetRanges.HR;
                    hrRange.textContent = Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + (hr.unit || 'bpm');
                    console.log('üéØ Updated HR range from target ranges:', Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + (hr.unit || 'bpm'));
                    
                    // Apply target range styling
                    hrRange.style.backgroundColor = '#e8f5e8'; // Light green highlight
                    hrRange.style.border = '2px solid #28a745'; // Green border
                    hrRange.style.borderRadius = '4px';
                    hrRange.style.padding = '2px 4px';
                    console.log('‚úÖ Applied target range styling to HR display');
                }
                
                // Update BP display if available
                const bpCards = document.querySelectorAll('.value-card');
                if (bpCards.length > 0 && targetRanges.BP_Mean) {
                    // Get the BP range from the circulatory card (1st card, 2nd value-number)
                    const bpRange = bpCards[0]?.querySelectorAll('.value-number')[1];
                    if (bpRange) {
                        const bp = targetRanges.BP_Mean;
                        bpRange.textContent = Math.round(bp.min) + ' - ' + Math.round(bp.max) + ' ' + (bp.unit || 'mmHg');
                        console.log('üéØ Updated BP range from target ranges:', Math.round(bp.min) + ' - ' + Math.round(bp.max) + ' ' + (bp.unit || 'mmHg'));
                        
                        // Apply target range styling
                        bpRange.style.backgroundColor = '#e8f5e8'; // Light green highlight
                        bpRange.style.border = '2px solid #28a745'; // Green border
                        bpRange.style.borderRadius = '4px';
                        bpRange.style.padding = '2px 4px';
                    }
                }
            } else {
                // Fall back to original condition-based logic
                console.log('üîç DEBUG: No target ranges found, using condition-based thresholds');
                
                // Check if sepsis is selected
                const hasSepsis = selectedTags.some(tag => tag.toLowerCase().includes('sepsis'));
                console.log('üîç DEBUG: Has sepsis tag:', hasSepsis);
                
                // Get thresholds from shared data manager
                const normalThresholds = window.sharedDataManager.getThresholds('normal');
                const sepsisThresholds = window.sharedDataManager.getThresholds('conditions')?.sepsis;
                
                console.log('üîç DEBUG: Normal thresholds:', normalThresholds);
                console.log('üîç DEBUG: Sepsis thresholds:', sepsisThresholds);
                
                // Determine which thresholds to use
                const currentThresholds = hasSepsis && sepsisThresholds ? 
                    {
                        ...normalThresholds,
                        circulatoir: {
                            ...normalThresholds.circulatoir,
                            ...sepsisThresholds.circulatoir
                        }
                    } : normalThresholds;
                
                console.log('üîç DEBUG: Using thresholds:', currentThresholds);
                
                // Update circulatory parameters (HR) - find the heart rate display
                const circulatoryCard = document.querySelector('.value-card');
                const hrRange = circulatoryCard?.querySelector('.value-number');
                
                if (hrRange && currentThresholds.circulatoir && currentThresholds.circulatoir.HR) {
                    const hr = currentThresholds.circulatoir.HR;
                    hrRange.textContent = Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + hr.unit;
                    
                    console.log('üîç DEBUG: Updated HR range to:', Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + hr.unit);
                    
                    // Highlight if using sepsis thresholds
                    if (hasSepsis && sepsisThresholds) {
                        hrRange.style.backgroundColor = '#fff3cd'; // Light yellow highlight
                        hrRange.style.border = '2px solid #ffc107'; // Yellow border
                        hrRange.style.borderRadius = '4px';
                        hrRange.style.padding = '2px 4px';
                        console.log('üîç DEBUG: Applied sepsis highlighting to HR range');
                    } else {
                        // Reset to normal styling
                        hrRange.style.backgroundColor = '';
                        hrRange.style.border = '';
                        hrRange.style.borderRadius = '';
                        hrRange.style.padding = '';
                        console.log('üîç DEBUG: Reset HR range to normal styling');
                    }
                }
            }
        }

        function updateHRDisplay(hrLow, hrHigh, isSepsis) {
            console.log('üíì Updating HR display:', hrLow, '-', hrHigh, 'sepsis:', isSepsis);
            
            // Find the HR display element
            const circulatoryCard = document.querySelector('.value-card');
            const hrRange = circulatoryCard?.querySelector('.value-number');
            
            if (hrRange) {
                // Update the display text
                hrRange.textContent = hrLow + ' - ' + hrHigh + ' bpm';
                
                // Apply styling based on source
                if (isSepsis) {
                    hrRange.style.backgroundColor = '#fff3cd'; // Light yellow highlight for sepsis
                    hrRange.style.border = '2px solid #ffc107'; // Yellow border
                    hrRange.style.borderRadius = '4px';
                    hrRange.style.padding = '2px 4px';
                    console.log('ü¶† Applied sepsis styling to HR display');
                } else {
                    hrRange.style.backgroundColor = '#e8f5e8'; // Light green for restored
                    hrRange.style.border = '2px solid #28a745'; // Green border
                    hrRange.style.borderRadius = '4px';
                    hrRange.style.padding = '2px 4px';
                    console.log('üîô Applied restored styling to HR display');
                }
            }
        }
        
        function updateBPDisplay(bpLow, bpHigh, isSepsis) {
            console.log('ü©∏ Updating BP display:', bpLow, '-', bpHigh, 'mmHg, sepsis:', isSepsis);
            
            // Find the BP display element (second value-number in circulatory card)
            const circulatoryCard = document.querySelector('.value-card');
            const bpRange = circulatoryCard?.querySelectorAll('.value-number')[1];
            
            if (bpRange) {
                // Update the display text with unit
                bpRange.textContent = bpLow + ' - ' + bpHigh + ' mmHg';
                
                // Apply styling based on source
                if (isSepsis) {
                    bpRange.style.backgroundColor = '#fff3cd'; // Light yellow highlight for sepsis
                    bpRange.style.border = '2px solid #ffc107'; // Yellow border
                    bpRange.style.borderRadius = '4px';
                    bpRange.style.padding = '2px 4px';
                    console.log('ü¶† Applied sepsis styling to BP display');
                } else {
                    bpRange.style.backgroundColor = '#e8f5e8'; // Light green for restored
                    bpRange.style.border = '2px solid #28a745'; // Green border
                    bpRange.style.borderRadius = '4px';
                    bpRange.style.padding = '2px 4px';
                    console.log('üîô Applied restored styling to BP display');
                }
                
                // Remove inactive-text class if present
                bpRange.classList.remove('inactive-text');
            }
        }

        function adjustOrganSettings(organType) {
            console.log('üîß Adjusting settings for:', organType);
            
            if (organType === 'circulatoir') {
                // Navigate to the circulatoir settings page with current patient and bed data
                console.log('ü´Ä Opening circulatoir settings page for patient:', currentPatientId, 'bed:', currentBedNumber);
                
                if (currentPatientId && currentBedNumber) {
                    const circulatoirUrl = `circulatoir-settings.html?patient=${currentPatientId}&bed=${currentBedNumber}`;
                    console.log('üîó Navigating to:', circulatoirUrl);
                    window.location.href = circulatoirUrl;
                } else {
                    console.warn('‚ö†Ô∏è Missing patient or bed data');
                    alert('Pati√´ntgegevens niet beschikbaar. Ga terug naar bedoverzicht.');
                    window.location.href = 'circulatoir-settings.html';
                }
            } else {
                // For other organ types, show placeholder message
                alert('Aanpassingen voor ' + organType + ' systeem - functionaliteit komt binnenkort!');
            }
            
            // Here you would open a modal or navigate to detailed settings pages
        }

        function saveAlarmSettings() {
            console.log('Saving alarm settings...');
            
            if (!selectedProblem || !selectedRiskLevel) {
                alert('Selecteer eerst een hoofdprobleem en risico niveau voordat je opslaat.');
                return;
            }
            
            // Get organ settings from SharedDataManager
            const organSettings = window.sharedDataManager.getOrganSettings();
            
            const updatedMedicalInfo = {
                selectedProblem: selectedProblem,
                selectedRiskLevel: selectedRiskLevel,
                selectedTags: selectedTags,
                organSettings: organSettings,
                lastUpdated: new Date().toISOString()
            };
            
            // Save using shared data manager
            window.sharedDataManager.savePatientMedicalInfo(currentPatientId, updatedMedicalInfo);
            
            // Also update session data
            const sessionData = window.sharedDataManager.getSessionData();
            window.sharedDataManager.saveSessionData({
                ...sessionData,
                selectedRiskLevel: selectedRiskLevel,
                lastUpdated: new Date().toISOString()
            });
            
            alert('Alarm instellingen succesvol opgeslagen!');
            goBackToBedOverview()
        }

        function goBackToBedOverview() {
            window.location.href = 'bed-overview.html';
        }

        function testLocalStorage() {
            console.log('üîç TESTING SHARED DATA MANAGER:');
            console.log('Current Patient ID from URL:', currentPatientId);
            
            // Use shared data manager debug function
            window.sharedDataManager.debugLocalStorage();
            
            // Try to manually set some test data using shared data manager
            const testData = {
                selectedProblem: "respiratoire-insufficientie",
                selectedRiskLevel: "high",
                selectedTags: ["sepsis", "diabetes"],
                organSettings: {},
                lastUpdated: new Date().toISOString()
            };
            window.sharedDataManager.savePatientMedicalInfo(currentPatientId, testData);
            console.log('‚úÖ Set test data for patient via shared data manager:', currentPatientId);
            
            // Try to reload the data
            loadExistingSettings();
        }

        // Function to update organ circles based on selected problem
        function updateOrganCirclesBasedOnProblem(problemValue) {
            console.log('Problem selected:', problemValue);
            selectedProblem = problemValue;
            updateOrganCircles();
            
            // Save current medical info including the problem selection
            if (currentPatientId && window.sharedDataManager) {
                const currentMedicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId) || {};
                currentMedicalInfo.selectedProblem = problemValue;
                window.sharedDataManager.savePatientMedicalInfo(currentPatientId, currentMedicalInfo);
                console.log('‚úÖ Problem selection saved for patient:', currentPatientId, problemValue);
            }
        }
        
        // Function to update organ circles based on risk level
        function updateOrganCirclesWithRisk(riskLevel) {
            console.log('Risk level selected:', riskLevel);
            selectedRiskLevel = riskLevel;
            updateOrganCircles();
        }

        // Main function to update organ circles based on current problem and risk
        function updateOrganCircles() {
            console.log('Updating organ circles for problem:', selectedProblem, 'risk:', selectedRiskLevel);
            
            if (!window.sharedDataManager) {
                console.warn('SharedDataManager not available');
                return;
            }
            
            // Use SharedDataManager to calculate organ states
            console.log('üîç DEBUG: Calculating organ states with problem:', selectedProblem, 'riskLevel:', selectedRiskLevel);
            const finalOrganStates = window.sharedDataManager.calculateOrganStates(selectedProblem, selectedRiskLevel);
            console.log('üîç DEBUG: Final organ states:', finalOrganStates);
            console.log('üîç DEBUG: Final organ states type:', typeof finalOrganStates);
            console.log('üîç DEBUG: Final organ states keys:', finalOrganStates ? Object.keys(finalOrganStates) : 'null');
            console.log('üîç DEBUG: Heart property:', finalOrganStates?.heart);
            
            if (!finalOrganStates || !finalOrganStates.heart) {
                console.error('‚ùå DEBUG: Invalid organ states returned:', finalOrganStates);
                return;
            }
            
            const isActivated = selectedProblem !== '';
            
            // Debug organ components
            console.log('üîç DEBUG: window.organComponents:', window.organComponents);
            console.log('üîç DEBUG: window.organComponents type:', typeof window.organComponents);
            
            // Update each organ component
            if (window.organComponents && window.organComponents.heart) {
                console.log('üîç DEBUG: Heart component found, checking for manual override...');
                
                // Check if there's a manually set heart monitoring level that should take precedence
                const currentSavedLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                const calculatedLevel = finalOrganStates.heart;
                
                console.log('üîç DEBUG: Current saved heart level:', currentSavedLevel);
                console.log('üîç DEBUG: Calculated heart level:', calculatedLevel);
                
                // Use manually set level if it exists and is different from default 'mid'
                // OR if it was recently changed (within last 1 second) to prioritize manual changes
                let levelToUse = calculatedLevel;
                const recentManualChange = sessionStorage.getItem('recentHeartLevelChange');
                
                if (recentManualChange) {
                    const changeTime = parseInt(recentManualChange);
                    const timeDiff = Date.now() - changeTime;
                    if (timeDiff < 1000) { // Within last 1 second
                        levelToUse = currentSavedLevel;
                        console.log('ü´Ä Using recently manually set heart level:', levelToUse);
                    } else {
                        sessionStorage.removeItem('recentHeartLevelChange');
                    }
                } else if (currentSavedLevel !== 'mid' && currentSavedLevel !== calculatedLevel) {
                    // Manual level exists and differs from calculated - ask user or use manual
                    levelToUse = currentSavedLevel;
                    console.log('ü´Ä Using existing manual heart level:', levelToUse);
                }
                
                window.organComponents.heart.setRiskLevel(levelToUse);
                
                // Only save if we're using the calculated level (not overriding manual setting)
                if (levelToUse === calculatedLevel) {
                    window.sharedDataManager.updateGlobalHeartMonitoringLevel(currentPatientId, levelToUse);
                    console.log('‚úÖ Heart monitoring level saved globally:', levelToUse);
                }
                
                window.sharedDataManager.setOrganSettings('circulatoir', { 
                    active: isActivated, 
                    severity: isActivated ? 'active' : 'los', 
                    riskLevel: levelToUse 
                });
                console.log('Heart set to:', levelToUse);
            } else {
                console.error('‚ùå DEBUG: Heart component not found in window.organComponents');
            }
            if (window.organComponents.lung) {
                window.organComponents.lung.setRiskLevel(finalOrganStates.lung);
                window.sharedDataManager.setOrganSettings('respiratoir', { 
                    active: isActivated, 
                    severity: isActivated ? 'active' : 'los', 
                    riskLevel: finalOrganStates.lung 
                });
                console.log('Lung set to:', finalOrganStates.lung);
            }
            if (window.organComponents.temp) {
                window.organComponents.temp.setRiskLevel(finalOrganStates.temp);
                window.sharedDataManager.setOrganSettings('overig', { 
                    active: isActivated, 
                    severity: isActivated ? 'active' : 'los', 
                    riskLevel: finalOrganStates.temp 
                });
                console.log('Temp set to:', finalOrganStates.temp);
            }
            
            // Update opacity for all monitoring elements
            updateAllOpacity(isActivated);
        }

        // Function to update opacity for all monitoring elements
        function updateAllOpacity(isActive) {
            // Update circle opacity
            ['heart-circle-container', 'lung-circle-container', 'temp-circle-container'].forEach(containerId => {
                updateCircleOpacity(containerId, isActive);
            });
            
            // Update labels and status opacity
            document.querySelectorAll('.monitor-label, .monitor-status').forEach(element => {
                if (isActive) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }
            });
            
            // Update value cards opacity
            document.querySelectorAll('.value-card').forEach(card => {
                if (isActive) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        }

        // Function to update circle opacity
        function updateCircleOpacity(containerId, isActive) {
            const container = document.getElementById(containerId);
            if (container) {
                const circle = container.querySelector('.heart-organ-circle');
                if (circle) {
                    circle.style.opacity = isActive ? '1' : '0.3';
                }
            }
        }
    </script>
</body>
</html>
