<!DOCTYPE html>
<html lang="nl">
<head>
    <!-- Meta tags for character encoding and responsive design -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Page title that appears in browser tab -->
    <title>Alarm Instellingen</title>
    
    <!-- Google Fonts - Open Sans with multiple weights -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">
    
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Custom styles for tag parameter highlighting -->
    <style>
        .highlight-red {
            background-color: rgba(255, 99, 99, 0.3) !important;
            border: 2px solid #ff6363 !important;
            border-radius: 4px !important;
            padding: 2px 4px !important;
            transition: all 0.3s ease !important;
            animation: pulse-red 0.6s ease-in-out !important;
        }
        
        .highlight-blue {
            background-color: rgba(99, 150, 255, 0.3) !important;
            border: 2px solid #6396ff !important;
            border-radius: 4px !important;
            padding: 2px 4px !important;
            transition: all 0.3s ease !important;
            animation: pulse-blue 0.6s ease-in-out !important;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 99, 99, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 99, 99, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 99, 99, 0); }
        }
        
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(99, 150, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 150, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 150, 255, 0); }
        }
    </style>
    
    <!-- Data Manager for cross-page data synchronization -->
    <script src="js/shared-data-manager.js"></script>
</head>
<body class="alarm-overview-page">

        <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <a href="#" class="breadcrumb-link" onclick="goBackToBedOverview()">
            <img src="svg's/home.svg" alt="Home" class="breadcrumb-icon">
            Patiënten Overzicht
        </a>
        <span class="breadcrumb-separator">></span>
        <span class="breadcrumb-current">Alarm Instellingen - S. Groen</span>
    </nav>

    <!-- Title and Patient Info Layout -->
    <div class="title-patient-layout">
        <!-- Main page title -->
        <h1 class="main-title" id="main-page-title">Alarm Instellingen</h1>
        
        <!-- Patient information header section -->
        <div class="header">
            <img src="svg's/patient_icon.svg" alt="Patient" class="user-icon" />
            <span id="patient-header-info">Loading patient info...</span>
        </div>
    </div>
    
    <!-- Top section with three columns matching the setup page design -->
        <!-- Container for the three main form sections - horizontal layout -->
    <div class="form-sections-container">
        <!-- Section 1: Main problem selection -->
        <div class="form-section">
            <h2 class="section-title">Wat is het hoofdprobleem?</h2>
            <div class="dropdown-container">
                <!-- Custom Dropdown -->
                <div class="custom-dropdown-container">
                    <div class="custom-dropdown" id="problemDropdown" onclick="toggleDropdown()">
                        <span class="dropdown-text placeholder">Selecteer een probleem...</span>
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="dropdown-options" id="dropdownOptions">
                        <div class="dropdown-option" onclick="selectOption('respiratoire-insufficientie', 'Respiratoire Insufficiëntie')">Respiratoire Insufficiëntie</div>
                        <div class="dropdown-option" onclick="selectOption('hart-falen', 'Hart Falen')">Hart Falen</div>
                        <div class="dropdown-option" onclick="selectOption('sepsis', 'Sepsis')">Sepsis</div>
                        <div class="dropdown-option disabled">Neurologische Aandoening</div>
                        <div class="dropdown-option disabled">Nierinsufficiëntie</div>
                        <div class="dropdown-option disabled">Leverfalen</div>
                    </div>
                </div>
                <!-- Legacy select for backward compatibility -->
                <select class="problem-dropdown" id="problem-dropdown" style="display: none;">
                    <option value="">Selecteer een probleem...</option>
                    <option value="respiratoire-insufficientie">Respiratoire Insufficiëntie</option>
                    <option value="hart-falen">Hart Falen</option>
                    <option value="sepsis">Sepsis</option>
                    <option value="neurologische-aandoening" disabled>Neurologische Aandoening</option>
                    <option value="nierinsuffcientie" disabled>Nierinsufficiëntie</option>
                    <option value="leverfalen" disabled>Leverfalen</option>
                </select>
            </div>
        </div>
        
        <!-- Section 2: Risk level selection -->
        <div class="form-section">
            <h2 class="section-title">Wat is het risico - level van de patiënt?</h2>
            <div class="button-group">
                <button class="btn risk-low" data-risk="low">Laag</button>
                <button class="btn risk-mid" data-risk="mid">Mid</button>
                <button class="btn risk-high" data-risk="high">Hoog</button>
            </div>
            <!-- Static alarm indicator SVG -->
            <div class="alarm-indicator-svg">
                <img src="svg's/alarm_indicator.svg" alt="Alarm Indicator" />
            </div>
        </div>
        
        <!-- Section 3: Additional medical conditions/tags -->
        <div class="form-section">
            <h2 class="section-title">Selecteer eventueel additionele informatie:</h2>
            <div class="tags-section">
                <!-- All tags in horizontal layout with wrapping -->
                <div class="button-group tags-horizontal">
                    <button class="btn tag-btn" data-condition="sepsis">
                        Sepsis <img src="svg's/sepsis.svg" alt="Sepsis" class="sepsis-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="diabetes">
                        Diabetes <img src="svg's/diabetes.svg" alt="Diabetes" class="condition-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="herstellende">
                        Herstellende <img src="svg's/patient_icon.svg" alt="Herstellende" class="condition-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="pneumonie">
                        Pneumonie <img src="svg's/lung.svg" alt="Pneumonie" class="condition-icon">
                    </button>
                    <button class="btn tag-btn" data-condition="chronisch-nierfalen">
                        Chronisch Nierfalen <img src="svg's/nierfalen.svg" alt="Nierfalen" class="condition-icon">
                    </button>
                    <!-- More button to show additional options -->
                    <button class="more-btn">⋯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom section: Organ monitoring -->
        <!-- Section 4: Organ-level monitoring configuration -->
    <div class="monitoring-section">
        <h2 class="section-title">Monitoring op Orgaan Niveau</h2>
        
        <!-- Grid of organ monitoring circles -->
        <div class="monitoring-grid">
            <!-- Circulatory system -->
            <div class="monitor-item">
                <div id="heart-circle-container"></div>
                <div id="heart-status" class="monitor-status inactive-text">los</div>
                <!-- Circulatory parameters -->
                <div class="value-card">
                    <div class="organ-title-container">
                        <h3 class="organ-title">Circulatoir</h3>
                        <img src="svg's/alarm_bell.svg" alt="Alarm" class="alarm-bell-icon">
                    </div>
                    <div class="parameter-row" data-parameter="HR">
                        <div class="value-label inactive-text">HR</div>
                        <div class="value-number inactive-text">70 - 110 bpm</div>
                        <label class="alarm-toggle">
                            <input type="checkbox" checked onchange="toggleParameterAlarm('HR', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="parameter-row" data-parameter="BP_Mean">
                        <div class="value-label inactive-text">BP Mean</div>
                        <div class="value-number inactive-text">65 - 85 mmHg</div>
                        <label class="alarm-toggle">
                            <input type="checkbox" checked onchange="toggleParameterAlarm('BP_Mean', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button class="adjust-btn" onclick="adjustOrganSettings('circulatoir')">Aanpassen</button>
                </div>
            </div>
            <!-- Respiratory system -->
            <div class="monitor-item">
                <div id="lung-circle-container"></div>
                <div id="lung-status" class="monitor-status inactive-text">los</div>
                <!-- Respiratory parameters -->
                <div class="value-card">
                    <div class="organ-title-container">
                        <h3 class="organ-title">Respiratoir</h3>
                        <img src="svg's/alarm_bell.svg" alt="Alarm" class="alarm-bell-icon">
                    </div>
                    <div class="parameter-row" data-parameter="Saturatie">
                        <div class="value-label inactive-text">Saturatie</div>
                        <div class="value-number inactive-text">90 - 100 %</div>
                        <label class="alarm-toggle">
                            <input type="checkbox" checked onchange="toggleParameterAlarm('Saturatie', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="parameter-row" data-parameter="AF">
                        <div class="value-label inactive-text">AF</div>
                        <div class="value-number inactive-text" id="af-range-display-overview">10 - 25 /min</div>
                        <label class="alarm-toggle">
                            <input type="checkbox" checked onchange="toggleParameterAlarm('AF', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button class="adjust-btn" onclick="adjustOrganSettings('respiratoir')">Aanpassen</button>
                </div>
            </div>
            <!-- Other/Temperature system -->
            <div class="monitor-item">
                <div id="temp-circle-container"></div>
                <div id="temp-status" class="monitor-status inactive-text">los</div>
                <!-- Temperature parameters -->
                <div class="value-card">
                    <div class="organ-title-container">
                        <h3 class="organ-title">Overig</h3>
                        <img src="svg's/alarm_bell.svg" alt="Alarm" class="alarm-bell-icon">
                    </div>
                    <div class="parameter-row" data-parameter="Temperature">
                        <div class="value-label inactive-text">Temp.</div>
                        <div class="value-number inactive-text">36.0 - 38.5 °C</div>
                        <label class="alarm-toggle">
                            <input type="checkbox" checked onchange="toggleParameterAlarm('Temperature', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button class="adjust-btn" onclick="adjustOrganSettings('overig')">Aanpassen</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation buttons at bottom of page -->
    <div class="navigation">
        <!-- Back button with onclick event -->
        <button class="nav-btn" onclick="goBackToBedOverview()">← Terug naar Bedoverzicht</button>
        <!-- Save button with onclick event -->
        <button class="nav-btn primary" onclick="saveAlarmSettings()">Instellingen Opslaan</button>
    </div>

    <!-- Import Heart Circle Component -->
    <script src="js/heart-circle-component.js"></script>
    <script>
        // Global variables for current session
        let selectedProblem = '';
        let selectedRiskLevel = '';
        let selectedTags = [];
        let currentPatientId = '';
        let currentBedNumber = '';

        // SVG content embedded to avoid CORS issues
        const svgContent = {
            heart: `<svg class="organ-icon" viewBox="0 0 22 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M13.22 10.3743C12.0679 12.132 10.9163 15.0615 10.9163 19.1628M13.22 10.3743C12.0681 12.132 11.4922 14.4756 6.30842 14.4756M13.22 10.3743C14.6766 8.39884 16.9516 6.83964 19.3552 6.3986C20.0557 6.27006 20.6011 5.62288 20.4841 4.90863L20.2921 3.73684C20.1996 3.17181 19.7182 2.75127 19.159 2.81881C16.3987 3.15222 12.9705 4.8327 10.9162 7.44486C10.9162 6.27307 10.9162 2.75769 10.3402 1M5.73245 6.85896C5.15648 5.10127 4.00454 3.92948 2.27663 3.92948M1.70071 15.6441C2.85258 20.9171 7.26892 25 10.3401 25C13.4113 25 17.6365 20.9175 18.9799 15.6441C20.3232 10.3707 16.1 6.85563 13.2201 10.371C13.2201 8.61732 11.4922 6.85906 8.03639 6.85906C4.58057 6.85906 0.548838 10.371 1.70071 15.6441Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`,
            lung: `<svg class="organ-icon" viewBox="0 0 30 26" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11.5007 5.62881C11.5007 4.02205 10.3628 2.41595 5.90178 6.31748C-0.397037 11.8263 1.7026 24.2213 2.40247 24.91C3.10233 25.5986 10.8008 22.1555 11.5007 20.7783C12.2006 19.4011 10.8008 17.3352 12.2006 14.5808M18.4993 5.62879C18.4993 4.02203 19.6372 2.41593 24.0982 6.31746C30.397 11.8263 28.2974 24.2213 27.5975 24.9099C26.8977 25.5985 19.1992 22.1555 18.4993 20.7783C17.7994 19.401 19.1992 17.3352 17.7994 14.5807M21.9987 16.6468C21.9987 13.3949 19.8717 11.7738 18.2519 10.7191C14.9109 8.54378 15 4.4935 15 0.999945C15 4.4935 15.0891 8.54378 11.7481 10.7191C10.1283 11.7738 8.00142 13.3949 8.00142 16.6468" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`,
            temp: `<svg class="organ-icon" viewBox="0 0 16 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5.71349 0C3.94455 0 2.4982 1.42157 2.4982 3.15972V13.7459C0.944989 14.7857 0.000507593 16.5193 0 18.3844C0 21.4774 2.56656 24 5.71349 24C8.86042 24 11.4265 21.4774 11.4265 18.3844C11.4265 16.5193 10.482 14.7842 8.92828 13.7444V3.15972C8.92828 1.42157 7.48193 0 5.71349 0ZM5.71349 1.41162C6.71166 1.41162 7.49206 2.17865 7.49206 3.15972V14.1326C7.49212 14.2565 7.52539 14.3783 7.58851 14.4856C7.65162 14.5929 7.74237 14.682 7.85162 14.7438C9.17643 15.4954 9.99076 16.8812 9.99076 18.3844C9.99076 20.7144 8.08457 22.5884 5.714 22.5879C5.71383 22.5879 5.71416 22.5879 5.714 22.5879C3.34393 22.5884 1.43673 20.7144 1.43673 18.3849C1.43724 16.8822 2.25207 15.4964 3.57587 14.7453C3.68512 14.6834 3.77586 14.5944 3.83898 14.4871C3.9021 14.3798 3.93536 14.258 3.93543 14.1341V3.15972C3.93543 2.17865 4.71482 1.41162 5.71349 1.41162ZM11.5885 1.87453C11.3981 1.87455 11.2154 1.94891 11.0808 2.08127C10.9461 2.21363 10.8704 2.39315 10.8704 2.58033C10.8704 2.76752 10.9461 2.94704 11.0808 3.0794C11.2154 3.21176 11.3981 3.28613 11.5885 3.28615H15.2819C15.4723 3.28613 15.655 3.21176 15.7897 3.0794C15.9243 2.94704 16 2.76752 16 2.58033C16 2.39315 15.9243 2.21363 15.7896 2.08127C15.655 1.94891 15.4723 1.87455 15.2819 1.87453H11.5885ZM5.71349 2.58033C5.61915 2.58028 5.52572 2.59849 5.43854 2.63394C5.35136 2.66938 5.27214 2.72136 5.2054 2.7869C5.13867 2.85245 5.08572 2.93028 5.0496 3.01594C5.01348 3.1016 4.99488 3.19342 4.99487 3.28615V15.2102C3.51864 15.5338 2.40552 16.8384 2.40552 18.3834C2.40552 20.1708 3.89492 21.6347 5.71349 21.6347C7.53156 21.6347 9.02146 20.1708 9.02146 18.3834C9.02146 16.8384 7.90783 15.5348 6.4316 15.2102V3.28615C6.43158 3.09896 6.35592 2.91944 6.22125 2.78708C6.08658 2.65472 5.90394 2.58035 5.71349 2.58033ZM11.5885 5.10144C11.4942 5.10145 11.4008 5.11973 11.3136 5.15523C11.2265 5.19073 11.1473 5.24277 11.0806 5.30836C11.0139 5.37395 10.961 5.45182 10.925 5.5375C10.8889 5.62319 10.8704 5.71502 10.8704 5.80775C10.8704 5.99493 10.9461 6.17445 11.0808 6.30681C11.2154 6.43917 11.3981 6.51353 11.5885 6.51355H13.8431C14.0336 6.51353 14.2162 6.43917 14.3509 6.30681C14.4856 6.17445 14.5612 5.99493 14.5612 5.80775C14.5613 5.71502 14.5428 5.62319 14.5067 5.5375C14.4707 5.45182 14.4178 5.37395 14.3511 5.30836C14.2844 5.24277 14.2052 5.19073 14.1181 5.15523C14.0309 5.11972 13.9375 5.10145 13.8431 5.10144H11.5885ZM11.5885 8.32885C11.3981 8.32886 11.2154 8.40323 11.0808 8.53559C10.9461 8.66796 10.8704 8.84747 10.8704 9.03466C10.8704 9.22184 10.9461 9.40136 11.0808 9.53372C11.2154 9.66608 11.3981 9.74045 11.5885 9.74046H15.2819C15.4723 9.74045 15.655 9.66608 15.7896 9.53372C15.9243 9.40136 16 9.22184 16 9.03466C16 8.84747 15.9243 8.66796 15.7897 8.53559C15.655 8.40323 15.4723 8.32886 15.2819 8.32885H11.5885ZM11.5885 11.5563C11.3981 11.5563 11.2154 11.6306 11.0808 11.763C10.9461 11.8954 10.8704 12.0749 10.8704 12.2621C10.8704 12.4493 10.9461 12.6288 11.0808 12.7611C11.2154 12.8935 11.3981 12.9679 11.5885 12.9679H13.8431C14.0336 12.9679 14.2162 12.8935 14.3509 12.7611C14.4856 12.6288 14.5612 12.4493 14.5612 12.2621C14.5612 12.0749 14.4856 11.8954 14.3509 11.763C14.2162 11.6306 14.0336 11.5563 13.8431 11.5563H11.5885ZM5.71349 16.5437C6.75571 16.5437 7.58473 17.359 7.58473 18.3834C7.58473 19.4078 6.75571 20.2231 5.71349 20.2231C4.67127 20.2231 3.84174 19.4078 3.84174 18.3834C3.84174 17.359 4.67127 16.5437 5.71349 16.5437Z" fill="black"/>
            </svg>`
        };

        // ===================================================================
        // CENTRALIZED SYNCHRONIZATION SYSTEM  
        // ===================================================================
        
        // Function to check if a parameter is actually affected by a specific tag
        function isParameterAffectedByTag(parameter, tag) {
            // Based on the tagMatrix in SharedDataManager, determine which parameters are affected by each tag
            const tagParameterMap = {
                'sepsis': ['HR', 'BP_Mean'], // Sepsis affects HR and BP_Mean only
                'pneumonie': ['AF', 'Saturatie', 'HR', 'BP_Mean', 'Temperature'] // Pneumonie affects AF, Saturatie, HR, BP_Mean, and Temperature
            };
            
            return tagParameterMap[tag] && tagParameterMap[tag].includes(parameter);
        }

        // Function to determine which parameters are affected by risk level changes for different medical conditions
        function getParametersAffectedByRiskLevelChange(medicalProblem) {
            // Based on the medical condition matrix, determine which parameters change with risk level
            const problemParameterMap = {
                'respiratoire-insufficientie': ['AF', 'Saturatie', 'HR'], // Respiratory issues affect breathing and compensatory heart rate
                'hart-falen': ['HR', 'BP_Mean', 'Saturatie'], // Heart failure affects heart rate, blood pressure, and oxygen saturation
                'sepsis': ['HR', 'BP_Mean', 'Temperature'], // Sepsis affects circulatory system and temperature
                'none': ['HR', 'BP_Mean', 'AF', 'Saturatie', 'Temperature'] // Default: all parameters might change
            };
            
            return problemParameterMap[medicalProblem] || problemParameterMap['none'];
        }

        // Function to highlight parameters affected by risk level changes
        function highlightParametersForRiskLevelChange(medicalProblem, oldRiskLevel, newRiskLevel, newParameters) {
            console.log(`🎨 Highlighting parameters affected by risk level change: ${oldRiskLevel} → ${newRiskLevel} for condition: ${medicalProblem}`);
            
            // Get parameters that are affected by this medical condition's risk level changes
            const affectedParameters = getParametersAffectedByRiskLevelChange(medicalProblem);
            console.log(`📊 Parameters affected by ${medicalProblem} risk level changes:`, affectedParameters);
            
            // Get all parameter display elements
            const valueNumbers = document.querySelectorAll('.value-number');
            const afDisplay = document.getElementById('af-range-display-overview');
            
            // Update all parameters but only highlight those affected by the risk level change
            if (newParameters.HR && valueNumbers[0]) {
                valueNumbers[0].textContent = `${newParameters.HR.min} - ${newParameters.HR.max} ${newParameters.HR.unit}`;
                if (affectedParameters.includes('HR')) {
                    highlightParameterChange(valueNumbers[0], 'highlight', `Risk level change (${oldRiskLevel}→${newRiskLevel}) affected HR`);
                    console.log(`✅ Updated and HIGHLIGHTED HR for risk level change:`, valueNumbers[0].textContent);
                } else {
                    console.log(`📊 Updated HR (no highlight - not affected by ${medicalProblem} risk change):`, valueNumbers[0].textContent);
                }
            }
            
            if (newParameters.BP_Mean && valueNumbers[1]) {
                valueNumbers[1].textContent = `${newParameters.BP_Mean.min} - ${newParameters.BP_Mean.max} ${newParameters.BP_Mean.unit}`;
                if (affectedParameters.includes('BP_Mean')) {
                    highlightParameterChange(valueNumbers[1], 'highlight', `Risk level change (${oldRiskLevel}→${newRiskLevel}) affected BP`);
                    console.log(`✅ Updated and HIGHLIGHTED BP for risk level change:`, valueNumbers[1].textContent);
                } else {
                    console.log(`📊 Updated BP (no highlight - not affected by ${medicalProblem} risk change):`, valueNumbers[1].textContent);
                }
            }
            
            if (newParameters.Saturatie && valueNumbers[2]) {
                valueNumbers[2].textContent = `${newParameters.Saturatie.min} - ${newParameters.Saturatie.max}${newParameters.Saturatie.unit}`;
                if (affectedParameters.includes('Saturatie')) {
                    highlightParameterChange(valueNumbers[2], 'highlight', `Risk level change (${oldRiskLevel}→${newRiskLevel}) affected Saturatie`);
                    console.log(`✅ Updated and HIGHLIGHTED Saturatie for risk level change:`, valueNumbers[2].textContent);
                } else {
                    console.log(`📊 Updated Saturatie (no highlight - not affected by ${medicalProblem} risk change):`, valueNumbers[2].textContent);
                }
            }
            
            if (newParameters.AF && afDisplay) {
                afDisplay.textContent = `${newParameters.AF.min} - ${newParameters.AF.max} /min`;
                if (affectedParameters.includes('AF')) {
                    highlightParameterChange(afDisplay, 'highlight', `Risk level change (${oldRiskLevel}→${newRiskLevel}) affected AF`);
                    console.log(`✅ Updated and HIGHLIGHTED AF for risk level change:`, afDisplay.textContent);
                } else {
                    console.log(`📊 Updated AF (no highlight - not affected by ${medicalProblem} risk change):`, afDisplay.textContent);
                }
            }
            
            if (newParameters.Temperature && valueNumbers[4]) {
                valueNumbers[4].textContent = `${newParameters.Temperature.min} - ${newParameters.Temperature.max} ${newParameters.Temperature.unit}`;
                if (affectedParameters.includes('Temperature')) {
                    highlightParameterChange(valueNumbers[4], 'highlight', `Risk level change (${oldRiskLevel}→${newRiskLevel}) affected Temperature`);
                    console.log(`✅ Updated and HIGHLIGHTED Temperature for risk level change:`, valueNumbers[4].textContent);
                } else {
                    console.log(`📊 Updated Temperature (no highlight - not affected by ${medicalProblem} risk change):`, valueNumbers[4].textContent);
                }
            }
            
            console.log(`✅ Completed parameter highlighting for risk level change: ${oldRiskLevel} → ${newRiskLevel}`);
        }

        // Function to apply tag parameter changes with visual highlighting
        function applyTagParameterChangesWithHighlighting(tag, isActive, parameters) {
            console.log(`🎨 Applying ${tag} parameter changes with highlighting on alarm overview:`, parameters);
            
            // Get all parameter display elements
            const valueNumbers = document.querySelectorAll('.value-number');
            const afDisplay = document.getElementById('af-range-display-overview'); // Fixed: Use correct ID for alarm-overview
            
            // Define highlight colors for different conditions
            const highlightClass = tag === 'sepsis' ? 'highlight-red' : 'highlight-blue';
            
            // Update ALL parameter displays (to ensure consistency)
            // But only highlight those that are ACTUALLY affected by this specific tag
            
            if (parameters.HR && valueNumbers[0]) {
                valueNumbers[0].textContent = `${parameters.HR.min} - ${parameters.HR.max} ${parameters.HR.unit}`;
                if (isParameterAffectedByTag('HR', tag)) {
                    highlightParameterChange(valueNumbers[0], highlightClass, `${tag} affected HR`);
                    console.log(`✅ Updated and HIGHLIGHTED HR display with ${tag} delta:`, valueNumbers[0].textContent);
                } else {
                    console.log(`📊 Updated HR display (no highlight - not affected by ${tag}):`, valueNumbers[0].textContent);
                }
            }
            
            if (parameters.BP_Mean && valueNumbers[1]) {
                valueNumbers[1].textContent = `${parameters.BP_Mean.min} - ${parameters.BP_Mean.max} ${parameters.BP_Mean.unit}`;
                if (isParameterAffectedByTag('BP_Mean', tag)) {
                    highlightParameterChange(valueNumbers[1], highlightClass, `${tag} affected BP`);
                    console.log(`✅ Updated and HIGHLIGHTED BP display with ${tag} delta:`, valueNumbers[1].textContent);
                } else {
                    console.log(`📊 Updated BP display (no highlight - not affected by ${tag}):`, valueNumbers[1].textContent);
                }
            }
            
            if (parameters.Saturatie && valueNumbers[2]) {
                valueNumbers[2].textContent = `${parameters.Saturatie.min} - ${parameters.Saturatie.max}${parameters.Saturatie.unit}`;
                if (isParameterAffectedByTag('Saturatie', tag)) {
                    highlightParameterChange(valueNumbers[2], highlightClass, `${tag} affected Saturatie`);
                    console.log(`✅ Updated and HIGHLIGHTED Saturatie display with ${tag} delta:`, valueNumbers[2].textContent);
                } else {
                    console.log(`📊 Updated Saturatie display (no highlight - not affected by ${tag}):`, valueNumbers[2].textContent);
                }
            }
            
            if (parameters.AF && afDisplay) {
                afDisplay.textContent = `${parameters.AF.min} - ${parameters.AF.max} /min`;
                if (isParameterAffectedByTag('AF', tag)) {
                    highlightParameterChange(afDisplay, highlightClass, `${tag} affected AF`);
                    console.log(`✅ Updated and HIGHLIGHTED AF display with ${tag} delta:`, afDisplay.textContent);
                } else {
                    console.log(`📊 Updated AF display (no highlight - not affected by ${tag}):`, afDisplay.textContent);
                }
            }
            
            if (parameters.Temperature && valueNumbers[4]) {
                valueNumbers[4].textContent = `${parameters.Temperature.min} - ${parameters.Temperature.max} ${parameters.Temperature.unit}`;
                if (isParameterAffectedByTag('Temperature', tag)) {
                    highlightParameterChange(valueNumbers[4], highlightClass, `${tag} affected Temperature`);
                    console.log(`✅ Updated and HIGHLIGHTED Temperature display with ${tag} delta:`, valueNumbers[4].textContent);
                } else {
                    console.log(`📊 Updated Temperature display (no highlight - not affected by ${tag}):`, valueNumbers[4].textContent);
                }
            }
        }
        
        // Function to highlight parameter changes with visual feedback
        function highlightParameterChange(element, highlightClass, message) {
            if (!element) return;
            
            // Remove any existing highlight classes
            element.classList.remove('highlight-red', 'highlight-blue', 'highlight', 'fade-out');
            
            // Add the appropriate highlight class
            element.classList.add(highlightClass);
            
            // Add a data attribute to show tooltip or message
            element.setAttribute('title', message);
            
            // Remove highlight after animation
            setTimeout(() => {
                element.classList.remove(highlightClass);
                element.removeAttribute('title');
            }, 2000);
            
            console.log(`🎨 Applied ${highlightClass} highlighting to parameter:`, message);
        }

        // Function to highlight parameters affected by individual organ monitoring level changes
        function highlightParametersForOrganLevelChange(organType, newLevel) {
            console.log(`🎨 Highlighting parameters affected by ${organType} risk level change to: ${newLevel}`);
            
            // Simply use the syncDisplaysWithCentralizedRanges to update values and add highlighting
            // The display values will be updated by the global system, we just add highlighting
            const valueNumbers = document.querySelectorAll('.value-number');
            const afDisplay = document.getElementById('af-range-display-overview');
            
            // Determine which parameters are affected by this organ's risk level
            if (organType === 'heart' || organType === 'HR') {
                // Heart/HR changes affect Heart Rate and Blood Pressure
                if (valueNumbers[0]) {
                    highlightParameterChange(valueNumbers[0], 'highlight', `Heart risk level change affected HR`);
                }
                if (valueNumbers[1]) {
                    highlightParameterChange(valueNumbers[1], 'highlight', `Heart risk level change affected BP`);
                }
            }
            
            if (organType === 'lung' || organType === 'respiratory') {
                // Lung changes affect Saturation and AF (Respiratory Frequency)
                if (valueNumbers[2]) {
                    highlightParameterChange(valueNumbers[2], 'highlight', `Lung risk level change affected Saturatie`);
                }
                if (afDisplay) {
                    highlightParameterChange(afDisplay, 'highlight', `Lung risk level change affected AF`);
                }
            }
            
            if (organType === 'temp' || organType === 'temperature') {
                // Temperature changes affect Temperature parameter
                if (valueNumbers[4]) {
                    highlightParameterChange(valueNumbers[4], 'highlight', `Temperature risk level change affected Temperature`);
                }
            }
            
            console.log(`✅ Completed parameter highlighting for ${organType} risk level change`);
        }

        /**
         * Synchronize all written displays with centralized target ranges
         * Called on page load to ensure displays match the source of truth
         */
        function syncDisplaysWithCentralizedRanges() {
            console.log('🌐 SIMPLE SYNC: Updating alarm overview displays with global variables...');

            // Update parameter displays - simple direct approach
            const valueNumbers = document.querySelectorAll('.value-number');
            
            if (valueNumbers.length >= 5) {
                // Update HR display from global variables
                if (valueNumbers[0]) {
                    valueNumbers[0].textContent = `${window.HR_MIN} - ${window.HR_MAX} bpm`;
                    console.log('📊 Updated HR display:', valueNumbers[0].textContent);
                }

                // Update BP display from global variables
                if (valueNumbers[1]) {
                    valueNumbers[1].textContent = `${window.BP_MIN} - ${window.BP_MAX} mmHg`;
                    console.log('📊 Updated BP display:', valueNumbers[1].textContent);
                }

                // Update Saturatie display from global variables
                if (valueNumbers[2]) {
                    valueNumbers[2].textContent = `${window.SAT_MIN} - ${window.SAT_MAX}%`;
                    console.log('📊 Updated Saturatie display:', valueNumbers[2].textContent);
                }

                // Update AF display from global variables
                const afDisplay = document.getElementById('af-range-display-overview');
                if (afDisplay) {
                    afDisplay.textContent = `${window.AF_MIN} - ${window.AF_MAX} /min`;
                    console.log('📊 Updated AF display:', afDisplay.textContent);
                }

                // Update Temperature display from global variables
                if (valueNumbers[4]) {
                    valueNumbers[4].textContent = `${window.TEMP_MIN} - ${window.TEMP_MAX}°C`;
                    console.log('📊 Updated Temperature display:', valueNumbers[4].textContent);
                }
            }

            console.log('✅ All alarm overview displays updated with global variables');
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeAlarmOverview();
            setupEventListeners();
            initializeCircleComponents();
            
            // Initialize condition states first (source of truth)
            initializeSepsisTagState();
            
            // CENTRALIZED SYSTEM: Sync displays with current target ranges
            syncDisplaysWithCentralizedRanges();
            
            // Initialize alarm toggle functionality
            setupAlarmToggleEventListeners();
            
            // Load existing settings after components are initialized
            loadExistingSettings();
            
            // Initialize alarm toggles after patient is loaded (no delay needed)
            initializeAlarmToggles();
            
            // Update monitoring status after everything is loaded (small delay for DOM updates)
            setTimeout(() => updateMonitoringStatus(), 100);
        });

        function initializeAlarmOverview() {
            // Get URL parameters to identify patient and bed
            const urlParams = new URLSearchParams(window.location.search);
            currentBedNumber = urlParams.get('bed');
            currentPatientId = urlParams.get('patient');
            
            console.log('Initializing alarm overview for bed:', currentBedNumber, 'patient:', currentPatientId);
            
            if (!currentBedNumber || !currentPatientId) {
                alert('Geen geldige bed- of patiëntinformatie gevonden. Ga terug naar het bedoverzicht.');
                goBackToBedOverview();
                return;
            }
            
            // Initialize data using shared data manager
            const initData = window.sharedDataManager.initializeAlarmOverviewPage(currentPatientId);
            console.log('📊 Initialized alarm overview data:', initData);
            
            // Load patient information and settings
            loadPatientInfo();
        }

        async function initializeCircleComponents() {
            // Make all circles same size as setup page
            const circleSize = 130;
            
            console.log('Initializing heart circle components...');
            
            // Get current heart monitoring level from SharedDataManager
            let heartLevel = 'low';
            let lungLevel = 'low';
            let tempLevel = 'low';
            if (currentPatientId && window.sharedDataManager) {
                heartLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                lungLevel = window.sharedDataManager.getLungMonitoringLevel(currentPatientId);
                tempLevel = window.sharedDataManager.getTempMonitoringLevel(currentPatientId);
                console.log(`Loading monitoring levels for patient ${currentPatientId}:`, { heartLevel, lungLevel, tempLevel });
            }
            
            // Store references to the components for later control
            window.organComponents = {};
            
            // Heart (circulatoir) - use saved monitoring level
            console.log('Creating heart component...');
            window.organComponents.heart = new HeartCircleComponent('heart-circle-container', { size: circleSize, initialState: heartLevel });
            setTimeout(() => injectSVG('heart-circle-container', 'heart'), 100);
            
            // Lung (respiratoir) - use saved monitoring level
            console.log('Creating lung component...');
            window.organComponents.lung = new HeartCircleComponent('lung-circle-container', { size: circleSize, initialState: lungLevel });
            setTimeout(() => injectSVG('lung-circle-container', 'lung'), 100);
            
            // Temp (overig) - use saved monitoring level
            console.log('Creating temp component...');
            window.organComponents.temp = new HeartCircleComponent('temp-circle-container', { size: circleSize, initialState: tempLevel });
            setTimeout(() => injectSVG('temp-circle-container', 'temp'), 100);
            
            // Update monitoring status labels after all components are initialized
            setTimeout(() => updateMonitoringStatus(), 200);
            
            // Listen for global heart monitoring level changes
            document.addEventListener('heartMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                console.log(`🔔 Received heart monitoring level change event:`, { patientId, level, currentPatientId });
                if (patientId === currentPatientId && window.organComponents?.heart) {
                    console.log(`💓 Applying heart monitoring level change: ${level}`);
                    window.organComponents.heart.setRiskLevel(level);
                    
                    // Update monitoring status after risk level change
                    setTimeout(() => updateMonitoringStatus(), 100);
                    
                    // Highlight parameters affected by heart risk level change
                    setTimeout(() => highlightParametersForOrganLevelChange('heart', level), 150);
                } else {
                    console.log(`⏸️ Ignoring heart level change - patient mismatch or component missing`);
                }
            });
            
            // Listen for global lung monitoring level changes
            document.addEventListener('lungMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                console.log(`🔔 Received lung monitoring level change event:`, { patientId, level, currentPatientId });
                if (patientId === currentPatientId && window.organComponents?.lung) {
                    console.log(`🫁 Applying lung monitoring level change: ${level}`);
                    window.organComponents.lung.setRiskLevel(level);
                    
                    // Update monitoring status after risk level change
                    setTimeout(() => updateMonitoringStatus(), 100);
                    
                    // Highlight parameters affected by lung risk level change
                    setTimeout(() => highlightParametersForOrganLevelChange('lung', level), 150);
                } else {
                    console.log(`⏸️ Ignoring lung level change - patient mismatch or component missing`);
                }
            });
            
            // Listen for global temp monitoring level changes
            document.addEventListener('tempMonitoringLevelChanged', function(event) {
                const { patientId, level } = event.detail;
                console.log(`🔔 Received temp monitoring level change event:`, { patientId, level, currentPatientId });
                if (patientId === currentPatientId && window.organComponents?.temp) {
                    console.log(`🌡️ Applying temp monitoring level change: ${level}`);
                    window.organComponents.temp.setRiskLevel(level);
                    
                    // Update monitoring status after risk level change
                    setTimeout(() => updateMonitoringStatus(), 100);
                    
                    // Highlight parameters affected by temp risk level change
                    setTimeout(() => highlightParametersForOrganLevelChange('temp', level), 150);
                } else {
                    console.log(`⏸️ Ignoring temp level change - patient mismatch or component missing`);
                }
            });
            
            // SIMPLE SYSTEM: Listen for global parameter changes from slider adjustments
            window.addEventListener('globalParametersChanged', function(event) {
                console.log('🌐 Global parameters changed event received on alarm overview:', event.detail);
                console.log('� Updating alarm overview displays with new global variables...');
                syncDisplaysWithCentralizedRanges();
                console.log('📊 SYNC COMPLETED on alarm overview');
            });

            // TAG SYSTEM: Listen for tag-based parameter changes (sepsis, pneumonie)
            window.addEventListener('tagParametersChanged', function(event) {
                console.log('🏷️ Tag parameters changed event received on alarm overview:', event.detail);
                const { tag, isActive, patientId, parameters, organStates } = event.detail;
                
                if (patientId === currentPatientId) {
                    console.log(`🏷️ Applying ${tag} parameter changes (${isActive ? 'ACTIVE' : 'INACTIVE'}):`, parameters);
                    
                    // Apply parameter changes with highlighting
                    if (parameters) {
                        applyTagParameterChangesWithHighlighting(tag, isActive, parameters);
                    }
                    
                    // Update organ circle visual states if tag affected monitoring levels
                    if (organStates && window.organComponents) {
                        console.log(`🔄 Updating organ states from tag ${tag}:`, organStates);
                        
                        if (organStates.heart && window.organComponents.heart) {
                            window.organComponents.heart.setRiskLevel(organStates.heart);
                            console.log(`✅ Updated heart circle to: ${organStates.heart}`);
                        }
                        
                        if (organStates.lung && window.organComponents.lung) {
                            window.organComponents.lung.setRiskLevel(organStates.lung);
                            console.log(`✅ Updated lung circle to: ${organStates.lung}`);
                        }
                        
                        if (organStates.temp && window.organComponents.temp) {
                            window.organComponents.temp.setRiskLevel(organStates.temp);
                            console.log(`✅ Updated temp circle to: ${organStates.temp}`);
                        }
                    }
                    
                    // Update tag button visual state if it exists
                    const tagButton = document.querySelector(`.tag-btn[data-condition="${tag}"]`);
                    if (tagButton) {
                        if (isActive) {
                            tagButton.classList.add('selected');
                        } else {
                            tagButton.classList.remove('selected');
                        }
                        console.log(`✅ Updated ${tag} tag button visual state: ${isActive ? 'selected' : 'unselected'}`);
                    }
                    
                    console.log('📊 TAG SYNC COMPLETED on alarm overview - parameters AND organ states updated');
                } else {
                    console.log(`⏸️ Ignoring tag change - patient mismatch (${patientId} vs ${currentPatientId})`);
                }
            });
            
            // DISABLED: Listen for HR range changes from sepsis selection
            // Sepsis no longer changes target ranges, only visual state
            /*
            window.addEventListener('hrRangesChanged', function(event) {
                console.log('💓 HR ranges changed event received:', event.detail);
                if (event.detail.patientId === currentPatientId) {
                    // Update the HR display immediately
                    updateHRDisplay(event.detail.HR_low, event.detail.HR_high, event.detail.source === 'sepsis');
                    
                    // Update BP display if BP values are provided
                    if (typeof event.detail.BP_low !== 'undefined' && typeof event.detail.BP_high !== 'undefined') {
                        updateBPDisplay(event.detail.BP_low, event.detail.BP_high, event.detail.source === 'sepsis');
                    }
                    
                    // Also update parameter ranges to ensure consistency
                    updateParameterRanges();
                    console.log('✅ Called updateParameterRanges() due to HR ranges change');
                    
                    // Update sepsis tag button state based on the event source
                    const sepsisButton = document.querySelector('.tag-btn[data-condition="sepsis"]');
                    if (sepsisButton) {
                        if (event.detail.source === 'sepsis') {
                            // Sepsis was selected elsewhere, select our button
                            if (!sepsisButton.classList.contains('selected')) {
                                sepsisButton.classList.add('selected');
                                selectedTags.push('sepsis');
                                console.log('✅ Synced sepsis button to selected state from external change');
                            }
                        } else if (event.detail.source === 'restore') {
                            // Sepsis was deselected elsewhere, deselect our button
                            if (sepsisButton.classList.contains('selected')) {
                                sepsisButton.classList.remove('selected');
                                selectedTags = selectedTags.filter(t => t !== 'sepsis');
                                console.log('✅ Synced sepsis button to deselected state from external change');
                            }
                        }
                    }
                }
            });
            */
            
            // DISABLED: Listen for AF range changes from pneumonie selection/deselection
            // Pneumonie no longer changes AF ranges, only visual state
            /*
            window.addEventListener('afRangesChanged', function(event) {
                console.log('🫁 AF ranges changed event received:', event.detail);
                if (event.detail.patientId === currentPatientId) {
                    // Update the AF display immediately
                    updateAFDisplay(event.detail.AF_min, event.detail.AF_max, event.detail.source === 'pneumonie');
                    console.log('✅ Updated AF display due to range change');
                }
            });
            */
            
            // Listen for condition state changes from other pages
            window.addEventListener('patientConditionStateChanged', function(event) {
                console.log('🏥 Condition state changed event received:', event.detail);
                
                const { condition, state } = event.detail;
                
                // Only update if it's for the current patient
                if (state.patientId === currentPatientId) {
                    const conditionButton = document.querySelector(`.tag-btn[data-condition="${condition}"]`);
                    if (conditionButton) {
                        if (state.isActive) {
                            if (!conditionButton.classList.contains('selected')) {
                                conditionButton.classList.add('selected');
                                if (!selectedTags.includes(condition)) {
                                    selectedTags.push(condition);
                                }
                                console.log(`✅ Synced ${condition} button to selected state from external change`);
                            }
                        } else {
                            if (conditionButton.classList.contains('selected')) {
                                conditionButton.classList.remove('selected');
                                selectedTags = selectedTags.filter(t => t !== condition);
                                console.log(`✅ Synced ${condition} button to deselected state from external change`);
                            }
                        }
                        
                        // Update parameter ranges after condition state change
                        updateParameterRanges();
                    }
                }
            });
            
            // Make all circles appear active since patient is already assigned
            setTimeout(() => {
                updateAllOpacity(true);
            }, 200);
        }

        // Utility to inject SVG content directly (same as setup page)
        function injectSVG(containerId, svgType) {
            console.log('Injecting ' + svgType + ' SVG into ' + containerId);
            const container = document.getElementById(containerId);
            if (!container) {
                console.log('Container ' + containerId + ' not found');
                return;
            }
            const iconDiv = container.querySelector('.heart-white-center');
            if (iconDiv) {
                console.log('Found white center in ' + containerId + ', injecting SVG');
                iconDiv.innerHTML = svgContent[svgType];
                const svgEl = iconDiv.querySelector('svg');
                if (svgEl) {
                    svgEl.style.width = '70%';
                    svgEl.style.height = '70%';
                    svgEl.style.display = 'block';
                    svgEl.style.margin = '0 auto';
                    console.log('SVG successfully injected into ' + containerId);
                }
            } else {
                console.log('White center not found in ' + containerId);
                // Try again after a short delay
                setTimeout(() => injectSVG(containerId, svgType), 50);
            }
        }

        // Update opacity for all circles
        function updateAllOpacity(active) {
            ['heart-circle-container', 'lung-circle-container', 'temp-circle-container'].forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.style.opacity = active ? '1' : '0.3';
                }
            });
        }

        // Function to update monitoring status text based on circle states
        function updateMonitoringStatus() {
            if (!window.organComponents) return;
            
            console.log('🔄 Updating monitoring status displays...');
            
            // Update heart status
            if (window.organComponents.heart) {
                const heartLevel = window.organComponents.heart.getRiskLevel();
                const heartStatusElement = document.getElementById('heart-status');
                if (heartStatusElement) {
                    heartStatusElement.textContent = getStatusText(heartLevel);
                    console.log(`💓 Heart status updated to: ${getStatusText(heartLevel)} (level: ${heartLevel})`);
                }
            }
            
            // Update lung status
            if (window.organComponents.lung) {
                const lungLevel = window.organComponents.lung.getRiskLevel();
                const lungStatusElement = document.getElementById('lung-status');
                if (lungStatusElement) {
                    lungStatusElement.textContent = getStatusText(lungLevel);
                    console.log(`🫁 Lung status updated to: ${getStatusText(lungLevel)} (level: ${lungLevel})`);
                }
            }
            
            // Update temp status
            if (window.organComponents.temp) {
                const tempLevel = window.organComponents.temp.getRiskLevel();
                const tempStatusElement = document.getElementById('temp-status');
                if (tempStatusElement) {
                    tempStatusElement.textContent = getStatusText(tempLevel);
                    console.log(`🌡️ Temp status updated to: ${getStatusText(tempLevel)} (level: ${tempLevel})`);
                }
            }
            
            // Log current monitoring levels from SharedDataManager for verification
            if (currentPatientId && window.sharedDataManager) {
                const heartLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                const lungLevel = window.sharedDataManager.getLungMonitoringLevel(currentPatientId);
                const tempLevel = window.sharedDataManager.getTempMonitoringLevel(currentPatientId);
                console.log(`📊 Current stored monitoring levels - Heart: ${heartLevel}, Lung: ${lungLevel}, Temp: ${tempLevel}`);
            }
        }
        
        // Function to convert risk level to Dutch status text
        function getStatusText(riskLevel) {
            switch(riskLevel?.toLowerCase()) {
                case 'low':
                    return 'los';
                case 'med':
                case 'medium':
                case 'mid':
                    return 'mid';
                case 'high':
                    return 'strak';
                default:
                    return 'los';
            }
        }

        // ===================================================================
        // PARAMETER ALARM TOGGLE FUNCTIONALITY
        // ===================================================================

        /**
         * Toggle parameter alarm on/off
         * @param {string} parameter - Parameter name (HR, BP_Mean, Saturatie, AF, Temperature)
         * @param {boolean} isEnabled - Whether alarm is enabled
         */
        function toggleParameterAlarm(parameter, isEnabled) {
            if (!currentPatientId) {
                console.warn('No patient selected for alarm toggle');
                return;
            }

            // Save state to SharedDataManager
            window.sharedDataManager.setParameterAlarmEnabled(currentPatientId, parameter, isEnabled);
            
            // Update visual state immediately
            updateParameterVisualState(parameter, isEnabled);
            
            console.log(`🔔 Alarm for ${parameter}:`, isEnabled ? 'ENABLED' : 'DISABLED');
        }

        /**
         * Update visual state of parameter based on alarm state
         * @param {string} parameter - Parameter name
         * @param {boolean} isEnabled - Whether alarm is enabled
         */
        function updateParameterVisualState(parameter, isEnabled) {
            const parameterRow = document.querySelector(`[data-parameter="${parameter}"]`);
            if (parameterRow) {
                if (isEnabled) {
                    parameterRow.classList.remove('parameter-disabled');
                } else {
                    parameterRow.classList.add('parameter-disabled');
                }
            }
        }

        /**
         * Initialize alarm toggle states for current patient
         */
        function initializeAlarmToggles() {
            if (!currentPatientId || !window.sharedDataManager) return;

            const parameters = ['HR', 'BP_Mean', 'Saturatie', 'AF', 'Temperature'];
            
            parameters.forEach(parameter => {
                const isEnabled = window.sharedDataManager.getParameterAlarmEnabled(currentPatientId, parameter);
                
                // Update toggle switch state
                const parameterRow = document.querySelector(`[data-parameter="${parameter}"]`);
                if (parameterRow) {
                    const toggleInput = parameterRow.querySelector('input[type="checkbox"]');
                    if (toggleInput) {
                        toggleInput.checked = isEnabled;
                    }
                    
                    // Update visual state
                    updateParameterVisualState(parameter, isEnabled);
                }
            });

            console.log('🔄 Initialized alarm toggles for patient:', currentPatientId);
        }

        /**
         * Listen for parameter alarm toggle events from other pages
         */
        function setupAlarmToggleEventListeners() {
            window.addEventListener('parameterAlarmToggled', function(event) {
                console.log(`📡 OVERVIEW: Received parameterAlarmToggled event:`, event.detail);
                
                const { patientId, parameter, isEnabled } = event.detail;
                
                console.log(`📡 OVERVIEW: Event patient: ${patientId}, Current patient: ${currentPatientId}`);
                console.log(`📡 OVERVIEW: Patient match:`, patientId === currentPatientId);
                
                if (patientId === currentPatientId) {
                    console.log(`📡 OVERVIEW: Processing alarm toggle for ${parameter}:`, isEnabled);
                    
                    // Update toggle switch state
                    const parameterRow = document.querySelector(`[data-parameter="${parameter}"]`);
                    console.log(`📡 OVERVIEW: Found parameter row for ${parameter}:`, !!parameterRow);
                    
                    if (parameterRow) {
                        const toggleInput = parameterRow.querySelector('input[type="checkbox"]');
                        console.log(`📡 OVERVIEW: Found toggle input for ${parameter}:`, !!toggleInput);
                        
                        if (toggleInput) {
                            console.log(`📡 OVERVIEW: Setting ${parameter} toggle to:`, isEnabled);
                            toggleInput.checked = isEnabled;
                        }
                        
                        // Update visual state
                        updateParameterVisualState(parameter, isEnabled);
                    }
                } else {
                    console.log(`📡 OVERVIEW: Ignoring event for different patient`);
                }
            });
        }

        function setupEventListeners() {
            // Set up problem dropdown listener
            const problemDropdown = document.getElementById('problem-dropdown');
            if (problemDropdown) {
                problemDropdown.addEventListener('change', function() {
                    selectedProblem = this.value;
                    console.log('Selected problem:', selectedProblem);
                    updateOrganCirclesBasedOnProblem(selectedProblem);
                });
            }

            // Set up risk level button listeners
            const riskButtons = document.querySelectorAll('.btn.risk-low, .btn.risk-mid, .btn.risk-high');
            riskButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Store the old risk level for comparison
                    const oldRiskLevel = selectedRiskLevel;
                    
                    // Remove selected class from all risk buttons
                    riskButtons.forEach(btn => btn.classList.remove('selected'));
                    // Add selected class to clicked button
                    this.classList.add('selected');
                    
                    // Get risk level and update circles
                    const riskLevel = this.classList.contains('risk-low') ? 'low' : 
                                     this.classList.contains('risk-high') ? 'high' : 'mid';
                    selectedRiskLevel = riskLevel;
                    console.log('Risk button clicked, detected risk level:', selectedRiskLevel);
                    updateOrganCirclesWithRisk(riskLevel);
                    
                    // Update monitoring status text after circles are updated
                    setTimeout(() => updateMonitoringStatus(), 100);
                    
                    // Apply riskMatrix logic based on current medical problem and new overall risk level
                    if (currentPatientId && window.sharedDataManager) {
                        console.log(`🔄 Updating overall risk level to: ${riskLevel} for patient ${currentPatientId}`);
                        
                        // Get the current medical problem
                        const medicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
                        const selectedProblem = medicalInfo?.selectedProblem || 'none';
                        
                        console.log(`🎯 Applying riskMatrix for problem: ${selectedProblem} with risk: ${riskLevel}`);
                        
                        // Apply problem-specific monitoring with the new overall risk level
                        const result = window.sharedDataManager.applyProblemSpecificMonitoring(
                            selectedProblem,
                            window.organComponents, // Pass the organ components for visual updates
                            currentPatientId,
                            riskLevel,
                            true // shouldOverwriteManualAdjustments = true for overall risk changes
                        );
                        
                        console.log(`✅ Applied riskMatrix calculation:`, result.organStates);
                        console.log(`📋 Medical reasoning:`, result.reasoning);
                        
                        // HIGHLIGHT PARAMETERS affected by risk level change
                        if (result.targetRanges && oldRiskLevel !== riskLevel) {
                            console.log(`🎨 Risk level changed from ${oldRiskLevel} to ${riskLevel} - highlighting affected parameters`);
                            setTimeout(() => {
                                highlightParametersForRiskLevelChange(selectedProblem, oldRiskLevel, riskLevel, result.targetRanges);
                            }, 200); // Small delay to ensure displays are updated first
                        }
                        
                        // Save the risk level to patient medical info for bed overview color updates
                        const currentMedicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId) || {};
                        currentMedicalInfo.selectedRiskLevel = riskLevel;
                        currentMedicalInfo.lastUpdated = new Date().toISOString();
                        window.sharedDataManager.savePatientMedicalInfo(currentPatientId, currentMedicalInfo);
                        console.log('✅ Risk level saved to patient medical info for bed overview color update:', riskLevel);
                    }
                });
            });

            // Event listeners for tag buttons (matching setup page structure)
            document.querySelectorAll('.tag-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const condition = this.dataset.condition;
                    if (this.classList.contains('selected')) {
                        // Deselect tag
                        this.classList.remove('selected');
                        selectedTags = selectedTags.filter(t => t !== condition);
                        
                        // Handle condition deselection using new condition state system
                        if (currentPatientId && window.sharedDataManager) {
                            // Use new tag parameter system for sepsis and pneumonie
                            if (condition === 'sepsis' || condition === 'pneumonie') {
                                console.log(`🏷️ Deactivating ${condition} tag with parameter adjustments`);
                                window.sharedDataManager.toggleConditionTag(currentPatientId, condition, false);
                            } else {
                                // Use old system for other conditions
                                window.sharedDataManager.setPatientConditionState(condition, {
                                    isActive: false,
                                    patientId: currentPatientId,
                                    timestamp: Date.now(),
                                    source: 'alarm-overview'
                                });
                            }
                        }
                    } else {
                        // Select tag
                        this.classList.add('selected');
                        selectedTags.push(condition);
                        
                        // Handle condition selection using new condition state system
                        if (currentPatientId && window.sharedDataManager) {
                            // Use new tag parameter system for sepsis and pneumonie
                            if (condition === 'sepsis' || condition === 'pneumonie') {
                                console.log(`🏷️ Activating ${condition} tag with parameter adjustments`);
                                window.sharedDataManager.toggleConditionTag(currentPatientId, condition, true);
                            } else {
                                // Use old system for other conditions
                                window.sharedDataManager.setPatientConditionState(condition, {
                                    isActive: true,
                                    patientId: currentPatientId,
                                    timestamp: Date.now(),
                                    source: 'alarm-overview'
                                });
                            }
                        }
                    }
                    console.log('Selected tags:', selectedTags);
                    
                    // Update parameter ranges based on selected conditions (but not for pneumonie or sepsis - they handle their own ranges)
                    if (condition !== 'pneumonie' && condition !== 'sepsis') {
                        updateParameterRanges();
                    }
                });
            });
        }

        function loadPatientInfo() {
            // Get patient info from shared data manager
            const patient = window.sharedDataManager.getPatientInfo(currentPatientId);
            
            if (patient) {
                updatePatientHeader(patient);
                console.log('✅ Loaded patient info from shared data manager:', patient);
            } else {
                // If patient not found, show error
                console.error('❌ Patient not found:', currentPatientId);
                document.getElementById('patient-header-info').textContent = currentPatientId + ' - Patiëntgegevens niet gevonden';
            }
        }

        function updatePatientHeader(patient) {
            const headerInfo = patient.id + ' - ' + patient.name + ' - ' + patient.gender + ' - ' + patient.age + ' jaar - ' + patient.weight + ' kg';
            document.getElementById('patient-header-info').textContent = headerInfo;
            
            // Update breadcrumb with patient name
            const breadcrumbCurrent = document.querySelector('.breadcrumb-current');
            if (breadcrumbCurrent) {
                breadcrumbCurrent.textContent = `Alarm Instellingen - ${patient.name}`;
            }
            
            // Update main page title with patient name
            const mainTitle = document.getElementById('main-page-title');
            if (mainTitle) {
                mainTitle.textContent = `Alarm Instellingen ${patient.name}`;
            }
            
            // Update browser tab title with patient name
            document.title = `Alarm Instellingen ${patient.name}`;
        }

        function loadExistingSettings() {
            console.log('🔍 DEBUG: Starting loadExistingSettings');
            console.log('🔍 DEBUG: currentPatientId =', currentPatientId);
            
            // Try to load from SharedDataManager first
            let savedMedicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId);
            console.log('🔍 DEBUG: savedMedicalInfo from shared manager =', savedMedicalInfo);
            
            // If not found, try to load from the synchronized localStorage entry
            if (!savedMedicalInfo) {
                const combinedData = localStorage.getItem(`patient_${currentPatientId}_medicalInfo`);
                if (combinedData) {
                    const parsed = JSON.parse(combinedData);
                    savedMedicalInfo = parsed.medicalInfo;
                    console.log('🔍 DEBUG: Found data in synchronized localStorage =', savedMedicalInfo);
                }
            }
            
            // If still not found, try old dataManager (if available)
            if (!savedMedicalInfo && window.dataManager) {
                const patientInfo = window.dataManager.getPatientInfo();
                const currentSession = window.dataManager.getCurrentSession();
                if (patientInfo.id === currentPatientId && currentSession) {
                    savedMedicalInfo = {
                        selectedProblem: currentSession.selectedProblem,
                        selectedRiskLevel: currentSession.selectedRiskLevel,
                        selectedTags: currentSession.selectedTags,
                        organSettings: currentSession.organSettings
                    };
                    console.log('🔍 DEBUG: Found data in old dataManager =', savedMedicalInfo);
                }
            }
            
            if (savedMedicalInfo) {
                console.log('✅ DEBUG: Found medicalInfo =', savedMedicalInfo);
                
                // Load problem selection in dropdown
                if (savedMedicalInfo.selectedProblem) {
                    selectedProblem = savedMedicalInfo.selectedProblem;
                    const dropdown = document.getElementById('problem-dropdown');
                    console.log('🔍 DEBUG: dropdown element =', dropdown);
                    if (dropdown) {
                        dropdown.value = selectedProblem;
                        console.log('✅ DEBUG: Set dropdown value to:', selectedProblem);
                    }
                }
                    
                // Load risk level
                if (savedMedicalInfo.selectedRiskLevel) {
                    selectedRiskLevel = savedMedicalInfo.selectedRiskLevel;
                    console.log('✅ DEBUG: Loading risk level:', selectedRiskLevel);
                    selectRiskLevel(selectedRiskLevel);
                }
                
                // Load tags - but verify condition states against SharedDataManager
                if (savedMedicalInfo.selectedTags && Array.isArray(savedMedicalInfo.selectedTags)) {
                    selectedTags = savedMedicalInfo.selectedTags.filter(tag => tag !== 'sepsis' && tag !== 'pneumonie'); // Remove condition tags, we'll check them separately
                    console.log('✅ DEBUG: Loading non-condition tags:', selectedTags);
                    selectedTags.forEach(tag => {
                        selectTag(tag);
                    });
                }
                
                console.log('✅ DEBUG: Loaded existing settings:', savedMedicalInfo);
                
                // Update organ circles based on loaded data
                if (selectedProblem && selectedRiskLevel) {
                    console.log('✅ DEBUG: Updating organ circles with:', selectedProblem, selectedRiskLevel);
                    updateOrganCircles(false); // PAGE LOAD: Preserve manual adjustments
                }
            } else {
                console.log('❌ DEBUG: No existing medical info found for patient:', currentPatientId);
                
                // Debug: show all available data
                console.log('🔍 DEBUG: All patients data:', window.sharedDataManager.getAllPatients());
                window.sharedDataManager.debugLocalStorage();
            }
        }

        // Comprehensive function to synchronize all monitoring levels
        function synchronizeAllMonitoringLevels() {
            if (!currentPatientId || !window.sharedDataManager || !window.organComponents) {
                console.log('⏸️ Cannot synchronize monitoring levels - missing dependencies');
                return;
            }
            
            console.log('🔄 Synchronizing all monitoring levels for patient:', currentPatientId);
            
            // Get stored monitoring levels from SharedDataManager
            const heartLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
            const lungLevel = window.sharedDataManager.getLungMonitoringLevel(currentPatientId);
            const tempLevel = window.sharedDataManager.getTempMonitoringLevel(currentPatientId);
            
            console.log('📊 Stored monitoring levels:', { heartLevel, lungLevel, tempLevel });
            
            // Apply stored levels to organ components
            if (window.organComponents.heart && heartLevel) {
                console.log(`💓 Applying stored heart level: ${heartLevel}`);
                window.organComponents.heart.setRiskLevel(heartLevel);
            }
            
            if (window.organComponents.lung && lungLevel) {
                console.log(`🫁 Applying stored lung level: ${lungLevel}`);
                window.organComponents.lung.setRiskLevel(lungLevel);
            }
            
            if (window.organComponents.temp && tempLevel) {
                console.log(`🌡️ Applying stored temp level: ${tempLevel}`);
                window.organComponents.temp.setRiskLevel(tempLevel);
            }
            
            console.log('✅ All monitoring levels synchronized');
        }

        // Load and apply saved heart monitoring level from circulatoir settings
        function loadSavedHeartMonitoringLevel() {
            if (currentPatientId && window.sharedDataManager && window.organComponents?.heart) {
                const savedHeartLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                console.log(`🫀 Loading saved heart monitoring level for patient ${currentPatientId}:`, savedHeartLevel);
                
                // Apply the saved level to the heart circle
                window.organComponents.heart.setRiskLevel(savedHeartLevel);
                console.log(`✅ Applied saved heart monitoring level: ${savedHeartLevel}`);
                
                // Update monitoring status after setting risk level
                setTimeout(() => updateMonitoringStatus(), 100);
                
                // Update the risk level buttons if they correspond to the heart level
                updateRiskButtonsForHeartLevel(savedHeartLevel);
            }
        }
        
        // Helper function to update risk level buttons based on heart monitoring level
        function updateRiskButtonsForHeartLevel(heartLevel) {
            // Only update buttons if the heart level was manually set in circulatoir settings
            // (not if it was derived from a problem/risk selection)
            const riskLevelMapping = {
                'low': 'low',
                'mid': 'med', 
                'high': 'high'
            };
            
            const correspondingRiskLevel = riskLevelMapping[heartLevel];
            if (correspondingRiskLevel) {
                // Check if this matches the currently selected risk level
                if (!selectedRiskLevel || selectedRiskLevel !== correspondingRiskLevel) {
                    console.log(`🔄 Heart monitoring level (${heartLevel}) suggests risk level: ${correspondingRiskLevel}`);
                    // Note: We don't automatically change the risk buttons as they might have been set independently
                    // The heart circle level can be different from the overall risk level
                }
            }
        }

        function selectRiskLevel(riskLevel) {
            // Clear previous selection
            document.querySelectorAll('.btn.risk-low, .btn.risk-mid, .btn.risk-high').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select the current risk level based on class name
            let riskButton;
            if (riskLevel === 'low') {
                riskButton = document.querySelector('.btn.risk-low');
            } else if (riskLevel === 'mid' || riskLevel === 'med') {
                riskButton = document.querySelector('.btn.risk-mid');
            } else if (riskLevel === 'high') {
                riskButton = document.querySelector('.btn.risk-high');
            }
            
            if (riskButton) {
                riskButton.classList.add('selected');
            }
        }

        function initializeSepsisTagState() {
            console.log('🏥 Initializing condition states on alarm overview...');
            
            if (currentPatientId && window.sharedDataManager) {
                // Ensure patient has clean state for new setup (but don't force clean existing states)
                window.sharedDataManager.ensureCleanPatientState(currentPatientId, false);
                
                // Initialize all condition buttons based on stored states
                const conditions = ['sepsis', 'pneumonie', 'herstellende'];
                
                conditions.forEach(condition => {
                    const conditionState = window.sharedDataManager.getPatientConditionState(condition, currentPatientId);
                    const conditionButton = document.querySelector(`.tag-btn[data-condition="${condition}"]`);
                    
                    console.log(`🔍 DEBUG: Condition ${condition} - State:`, conditionState, 'Button found:', !!conditionButton);
                    
                    if (conditionButton) {
                        if (conditionState && conditionState.isActive) {
                            conditionButton.classList.add('selected');
                            if (!selectedTags.includes(condition)) {
                                selectedTags.push(condition);
                            }
                            console.log(`✅ Initialized ${condition} button as SELECTED (isActive: ${conditionState.isActive})`);
                        } else {
                            conditionButton.classList.remove('selected');
                            selectedTags = selectedTags.filter(t => t !== condition);
                            console.log(`✅ Initialized ${condition} button as DESELECTED (isActive: ${conditionState?.isActive || 'undefined'})`);
                        }
                    } else {
                        console.warn(`❌ Button not found for condition: ${condition}`);
                    }
                });
                
                // Update parameter ranges after initializing condition states
                updateParameterRanges();
            }
        }

        function selectTag(tag) {
            const tagElement = document.querySelector('[data-condition="' + tag + '"]');
            if (tagElement && !tagElement.classList.contains('selected')) {
                tagElement.classList.add('selected');
            }
        }

        function updateParameterRanges(shouldHighlight = false, highlightCondition = null) {
            console.log('🔍 DEBUG: Updating parameter ranges for selected tags:', selectedTags, 'shouldHighlight:', shouldHighlight, 'highlightCondition:', highlightCondition);
            
            // Get patient-specific target ranges first
            let targetRanges = null;
            if (currentPatientId && window.sharedDataManager) {
                targetRanges = window.sharedDataManager.getPatientTargetRanges(currentPatientId);
                console.log('🎯 Patient target ranges:', targetRanges);
            }
            
            // If we have target ranges, use them; otherwise fall back to condition-based logic
            if (targetRanges) {
                // Check which conditions are currently active
                const hasSepsis = selectedTags.some(tag => tag.toLowerCase().includes('sepsis'));
                const hasPneumonie = selectedTags.some(tag => tag.toLowerCase().includes('pneumonie'));
                
                // Always update HR display if target ranges exist (for manual adjustments)
                if (targetRanges.HR) {
                    const circulatoryCard = document.querySelector('.value-card');
                    const hrRange = circulatoryCard?.querySelector('.value-number');
                    
                    if (hrRange) {
                        const hr = targetRanges.HR;
                        hrRange.textContent = Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + (hr.unit || 'bpm');
                        console.log('🎯 Updated HR range from target ranges:', Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + (hr.unit || 'bpm'));
                        
                        // Apply highlighting only if sepsis is active AND we should highlight (tag button clicked) AND it's sepsis-specific
                        if (hasSepsis && shouldHighlight && (highlightCondition === 'sepsis' || highlightCondition === null)) {
                            window.sharedDataManager.highlightElement(hrRange, 'highlight-beige', 1500);
                            console.log('✅ Applied sepsis highlighting to HR display');
                        }
                    }
                }
                
                // Always update BP display if target ranges exist (for manual adjustments)
                if (targetRanges.BP_Mean) {
                    const bpCards = document.querySelectorAll('.value-card');
                    if (bpCards.length > 0) {
                        // Get the BP range from the circulatory card (1st card, 2nd value-number)
                        const bpRange = bpCards[0]?.querySelectorAll('.value-number')[1];
                        if (bpRange) {
                            const bp = targetRanges.BP_Mean;
                            bpRange.textContent = Math.round(bp.min) + ' - ' + Math.round(bp.max) + ' ' + (bp.unit || 'mmHg');
                            console.log('🎯 Updated BP range from target ranges:', Math.round(bp.min) + ' - ' + Math.round(bp.max) + ' ' + (bp.unit || 'mmHg'));
                            
                            // Apply highlighting only if sepsis is active AND we should highlight (tag button clicked) AND it's sepsis-specific
                            if (hasSepsis && shouldHighlight && (highlightCondition === 'sepsis' || highlightCondition === null)) {
                                window.sharedDataManager.highlightElement(bpRange, 'highlight-beige', 1500);
                                console.log('✅ Applied sepsis highlighting to BP display');
                            }
                        } else {
                            console.warn('❌ BP range element not found');
                        }
                    } else {
                        console.warn('❌ BP cards not found');
                    }
                }
                
                // Always update AF display if target ranges exist (for manual adjustments)
                if (targetRanges.AF) {
                    const afRangeDisplay = document.getElementById('af-range-display-overview');
                    if (afRangeDisplay) {
                        const af = targetRanges.AF;
                        afRangeDisplay.textContent = Math.round(af.min) + ' - ' + Math.round(af.max) + ' ' + (af.unit || '/min');
                        console.log('🎯 Updated AF range from target ranges:', Math.round(af.min) + ' - ' + Math.round(af.max) + ' ' + (af.unit || '/min'));
                        
                        // Apply highlighting only if pneumonie is active AND we should highlight (tag button clicked) AND it's pneumonie-specific
                        if (hasPneumonie && shouldHighlight && (highlightCondition === 'pneumonie' || highlightCondition === null)) {
                            window.sharedDataManager.highlightElement(afRangeDisplay, 'highlight-blue', 1500);
                            console.log('✅ Applied pneumonie highlighting to AF display');
                        }
                        
                        // Remove inactive-text class if present
                        afRangeDisplay.classList.remove('inactive-text');
                    } else {
                        console.warn('❌ AF range display element not found with ID: af-range-display-overview');
                    }
                } else {
                    console.warn('❌ No AF data in target ranges');
                }
                
                // Always update Saturatie display if target ranges exist (for manual adjustments)
                if (targetRanges.Saturatie) {
                    const respiratoryCards = document.querySelectorAll('.value-card');
                    if (respiratoryCards.length > 1) {
                        // Get the Saturatie range from the respiratory card (2nd card, 1st value-number)
                        const saturatieRange = respiratoryCards[1]?.querySelector('.value-number');
                        if (saturatieRange) {
                            const saturatie = targetRanges.Saturatie;
                            saturatieRange.textContent = Math.round(saturatie.min) + ' - ' + Math.round(saturatie.max) + ' ' + (saturatie.unit || '%');
                            console.log('🎯 Updated Saturatie range from target ranges:', Math.round(saturatie.min) + ' - ' + Math.round(saturatie.max) + ' ' + (saturatie.unit || '%'));
                            
                            // Remove inactive-text class if present to make the text visible
                            saturatieRange.classList.remove('inactive-text');
                        } else {
                            console.warn('❌ Saturatie range element not found');
                        }
                    } else {
                        console.warn('❌ Respiratory card not found');
                    }
                } else {
                    console.log('ℹ️ No Saturatie data in target ranges');
                }
                
                // Always update Temperature display if target ranges exist (for manual adjustments)
                if (targetRanges.Temperature) {
                    const temperatureCards = document.querySelectorAll('.value-card');
                    if (temperatureCards.length > 2) {
                        // Get the Temperature range from the other card (3rd card, 1st value-number)
                        const temperatureRange = temperatureCards[2]?.querySelector('.value-number');
                        if (temperatureRange) {
                            const temperature = targetRanges.Temperature;
                            temperatureRange.textContent = temperature.min + ' - ' + temperature.max + ' ' + (temperature.unit || '°C');
                            console.log('🎯 Updated Temperature range from target ranges:', temperature.min + ' - ' + temperature.max + ' ' + (temperature.unit || '°C'));
                            
                            // Remove inactive-text class if present to make the text visible
                            temperatureRange.classList.remove('inactive-text');
                        } else {
                            console.warn('❌ Temperature range element not found');
                        }
                    } else {
                        console.warn('❌ Temperature card not found');
                    }
                } else {
                    console.log('ℹ️ No Temperature data in target ranges');
                }
            } else {
                // Fall back to original condition-based logic
                console.log('🔍 DEBUG: No target ranges found, using condition-based thresholds');
                
                // Check if sepsis is selected
                const hasSepsis = selectedTags.some(tag => tag.toLowerCase().includes('sepsis'));
                console.log('🔍 DEBUG: Has sepsis tag:', hasSepsis);
                
                // Get thresholds from shared data manager
                const normalThresholds = window.sharedDataManager.getThresholds('normal');
                const sepsisThresholds = window.sharedDataManager.getThresholds('conditions')?.sepsis;
                
                console.log('🔍 DEBUG: Normal thresholds:', normalThresholds);
                console.log('🔍 DEBUG: Sepsis thresholds:', sepsisThresholds);
                
                // DISABLED: Sepsis no longer changes thresholds, only visual state
                // Always use normal thresholds regardless of sepsis selection
                const currentThresholds = normalThresholds;
                
                console.log('🔍 DEBUG: Using thresholds:', currentThresholds);
                
                // DISABLED: Update circulatory parameters (HR) - sepsis no longer changes ranges
                // Sepsis only provides visual feedback, no range changes
                /*
                if (hasSepsis) {
                    const circulatoryCard = document.querySelector('.value-card');
                    const hrRange = circulatoryCard?.querySelector('.value-number');
                    
                    if (hrRange && currentThresholds.circulatoir && currentThresholds.circulatoir.HR) {
                        const hr = currentThresholds.circulatoir.HR;
                        hrRange.textContent = Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + hr.unit;
                        
                        console.log('🔍 DEBUG: Updated HR range to (sepsis):', Math.round(hr.min) + ' - ' + Math.round(hr.max) + ' ' + hr.unit);
                        
                        // Highlight if using sepsis thresholds
                        if (hasSepsis && sepsisThresholds) {
                            window.sharedDataManager.highlightElement(hrRange, 'highlight-beige', 1500);
                            console.log('🔍 DEBUG: Applied sepsis highlighting to HR range');
                        }
                    }
                }
                */
            }
        }

        function updateHRDisplay(hrLow, hrHigh, isSepsis) {
            console.log('💓 Updating HR display:', hrLow, '-', hrHigh, 'sepsis:', isSepsis);
            
            // Find the HR display element
            const circulatoryCard = document.querySelector('.value-card');
            const hrRange = circulatoryCard?.querySelector('.value-number');
            
            if (hrRange) {
                // Update the display text
                hrRange.textContent = hrLow + ' - ' + hrHigh + ' bpm';
                
                // Apply styling based on source
                if (isSepsis) {
                    // Use the shared highlighting function with timeout for sepsis
                    window.sharedDataManager.highlightElement(hrRange, 'highlight-beige', 1500);
                    console.log('🦠 Applied sepsis highlighting to HR display with 1.5s timeout');
                } else {
                    // Use the shared highlighting function with timeout for restored values
                    window.sharedDataManager.highlightElement(hrRange, 'highlight-beige', 1500);
                    console.log('🔙 Applied restored highlighting to HR display with 1.5s timeout');
                }
            }
        }
        
        function updateBPDisplay(bpLow, bpHigh, isSepsis) {
            console.log('🩸 Updating BP display:', bpLow, '-', bpHigh, 'mmHg, sepsis:', isSepsis);
            
            // Find the BP display element (second value-number in circulatory card)
            const circulatoryCard = document.querySelector('.value-card');
            const bpRange = circulatoryCard?.querySelectorAll('.value-number')[1];
            
            if (bpRange) {
                // Update the display text with unit
                bpRange.textContent = bpLow + ' - ' + bpHigh + ' mmHg';
                
                // Apply styling based on source
                if (isSepsis) {
                    // Use the shared highlighting function with timeout for sepsis
                    window.sharedDataManager.highlightElement(bpRange, 'highlight-beige', 1500);
                    console.log('🦠 Applied sepsis highlighting to BP display with 1.5s timeout');
                } else {
                    // Use the shared highlighting function with timeout for restored values
                    window.sharedDataManager.highlightElement(bpRange, 'highlight-beige', 1500);
                    console.log('🔙 Applied restored highlighting to BP display with 1.5s timeout');
                }
                
                // Remove inactive-text class if present
                bpRange.classList.remove('inactive-text');
            }
        }

        function updateAFDisplay(afMin, afMax, isPneumonie) {
            console.log('🫁 Updating AF display:', afMin, '-', afMax, '/min, pneumonie:', isPneumonie);
            
            // Find the AF display element by ID
            const afRangeDisplay = document.getElementById('af-range-display-overview');
            
            if (afRangeDisplay) {
                // Update the display text with unit
                afRangeDisplay.textContent = afMin + ' - ' + afMax + ' /min';
                
                // Apply styling based on source
                if (isPneumonie) {
                    // Use the shared highlighting function with timeout for pneumonie (same as setup.html)
                    window.sharedDataManager.highlightElement(afRangeDisplay, 'highlight-blue', 1500);
                    console.log('🫁 Applied pneumonie highlighting to AF display with 1.5s timeout');
                } else {
                    // Use the shared highlighting function with timeout for restored values
                    window.sharedDataManager.highlightElement(afRangeDisplay, 'highlight-blue', 1500);
                    console.log('🔙 Applied restored highlighting to AF display with 1.5s timeout');
                }
                
                // Remove inactive-text class if present
                afRangeDisplay.classList.remove('inactive-text');
            }
        }

        function adjustOrganSettings(organType) {
            console.log('🔧 Adjusting settings for:', organType);
            
            if (organType === 'circulatoir') {
                // Navigate to the circulatoir settings page with current patient and bed data
                console.log('🫀 Opening circulatoir settings page for patient:', currentPatientId, 'bed:', currentBedNumber);
                
                if (currentPatientId && currentBedNumber) {
                    const circulatoirUrl = `circulatoir-settings.html?patient=${currentPatientId}&bed=${currentBedNumber}`;
                    console.log('🔗 Navigating to:', circulatoirUrl);
                    window.location.href = circulatoirUrl;
                } else {
                    console.warn('⚠️ Missing patient or bed data');
                    alert('Patiëntgegevens niet beschikbaar. Ga terug naar bedoverzicht.');
                    window.location.href = 'circulatoir-settings.html';
                }
            } else if (organType === 'respiratoir') {
                // Navigate to the respiratory settings page with current patient and bed data
                console.log('🫁 Opening respiratory settings page for patient:', currentPatientId, 'bed:', currentBedNumber);
                
                if (currentPatientId && currentBedNumber) {
                    const respiratoryUrl = `respiratory-settings.html?patient=${currentPatientId}&bed=${currentBedNumber}`;
                    console.log('🔗 Navigating to:', respiratoryUrl);
                    window.location.href = respiratoryUrl;
                } else {
                    console.warn('⚠️ Missing patient or bed data');
                    alert('Patiëntgegevens niet beschikbaar. Ga terug naar bedoverzicht.');
                    window.location.href = 'respiratory-settings.html';
                }
            } else if (organType === 'overig') {
                // Navigate to the other settings page with current patient and bed data
                console.log('🌡️ Opening other settings page for patient:', currentPatientId, 'bed:', currentBedNumber);
                
                if (currentPatientId && currentBedNumber) {
                    const otherUrl = `other.html?patient=${currentPatientId}&bed=${currentBedNumber}`;
                    console.log('🔗 Navigating to:', otherUrl);
                    window.location.href = otherUrl;
                } else {
                    console.warn('⚠️ Missing patient or bed data');
                    alert('Patiëntgegevens niet beschikbaar. Ga terug naar bedoverzicht.');
                    window.location.href = 'other.html';
                }
            } else {
                // For other organ types, show placeholder message
                alert('Aanpassingen voor ' + organType + ' systeem - functionaliteit komt binnenkort!');
            }
            
            // Here you would open a modal or navigate to detailed settings pages
        }

        function saveAlarmSettings() {
            console.log('Saving alarm settings...');
            
            if (!selectedProblem || !selectedRiskLevel) {
                alert('Selecteer eerst een hoofdprobleem en risico niveau voordat je opslaat.');
                return;
            }
            
            // Get organ settings from SharedDataManager
            const organSettings = window.sharedDataManager.getOrganSettings();
            
            const updatedMedicalInfo = {
                selectedProblem: selectedProblem,
                selectedRiskLevel: selectedRiskLevel,
                selectedTags: selectedTags,
                organSettings: organSettings,
                lastUpdated: new Date().toISOString()
            };
            
            // Save using shared data manager
            window.sharedDataManager.savePatientMedicalInfo(currentPatientId, updatedMedicalInfo);
            
            // Also update session data
            const sessionData = window.sharedDataManager.getSessionData();
            window.sharedDataManager.saveSessionData({
                ...sessionData,
                selectedRiskLevel: selectedRiskLevel,
                lastUpdated: new Date().toISOString()
            });
            
            alert('Alarm instellingen succesvol opgeslagen!');
            goBackToBedOverview()
        }

        function goBackToBedOverview() {
            window.location.href = 'index.html';
        }

        function testLocalStorage() {
            console.log('🔍 TESTING SHARED DATA MANAGER:');
            console.log('Current Patient ID from URL:', currentPatientId);
            
            // Use shared data manager debug function
            window.sharedDataManager.debugLocalStorage();
            
            // Try to manually set some test data using shared data manager
            const testData = {
                selectedProblem: "respiratoire-insufficientie",
                selectedRiskLevel: "high",
                selectedTags: ["sepsis", "diabetes"],
                organSettings: {},
                lastUpdated: new Date().toISOString()
            };
            window.sharedDataManager.savePatientMedicalInfo(currentPatientId, testData);
            console.log('✅ Set test data for patient via shared data manager:', currentPatientId);
            
            // Try to reload the data
            loadExistingSettings();
        }

        // Function to update organ circles based on selected problem
        function updateOrganCirclesBasedOnProblem(problemValue) {
            console.log('🎯 MAIN PROBLEM CHANGE - Problem selected:', problemValue);
            console.log('🎯 MAIN PROBLEM CHANGE - Previous selectedProblem:', selectedProblem);
            selectedProblem = problemValue;
            console.log('🎯 MAIN PROBLEM CHANGE - New selectedProblem:', selectedProblem);
            console.log('🎯 MAIN PROBLEM CHANGE - Calling updateOrganCircles(true)...');
            updateOrganCircles(true); // MANUAL PROBLEM CHANGE: Overwrite manual adjustments
            
            // Save current medical info including the problem selection
            if (currentPatientId && window.sharedDataManager) {
                const currentMedicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId) || {};
                currentMedicalInfo.selectedProblem = problemValue;
                window.sharedDataManager.savePatientMedicalInfo(currentPatientId, currentMedicalInfo);
                console.log('✅ Problem selection saved for patient:', currentPatientId, problemValue);
            }
        }
        
        // Function to update organ circles based on risk level
        function updateOrganCirclesWithRisk(riskLevel) {
            console.log('🔄 updateOrganCirclesWithRisk called with:', riskLevel);
            console.log('🔄 Current selectedProblem:', selectedProblem);
            console.log('🔄 Setting selectedRiskLevel to:', riskLevel);
            selectedRiskLevel = riskLevel;
            console.log('🔄 Calling updateOrganCircles...');
            updateOrganCircles(true); // MANUAL RISK CHANGE: Overwrite manual adjustments
        }

        // Main function to update organ circles based on current problem and risk
        function updateOrganCircles(shouldOverwriteManualAdjustments = false) {
            console.log('🚀 updateOrganCircles called with selectedProblem:', selectedProblem, 'shouldOverwrite:', shouldOverwriteManualAdjustments);
            
            if (!window.sharedDataManager) {
                console.error('❌ SharedDataManager not available');
                return;
            }
            
            if (!window.organComponents) {
                console.error('❌ Organ components not available');
                return;
            }
            
            // Use the centralized function from SharedDataManager that handles both monitoring levels and target ranges
            console.log('� Calling applyProblemSpecificMonitoring with:');
            console.log('   - Problem:', selectedProblem);
            console.log('   - Risk Level:', selectedRiskLevel);
            console.log('   - Organ Components:', window.organComponents);
            console.log('   - Should overwrite manual adjustments:', shouldOverwriteManualAdjustments);
            
            // If no problem is selected, use default but still apply risk level logic
            const effectiveProblem = selectedProblem || 'none';
            // If a problem is selected but no risk level chosen, default to 'mid' for visualization
            const effectiveRiskLevel = selectedProblem && !selectedRiskLevel ? 'mid' : selectedRiskLevel;
            console.log('   - Effective Problem:', effectiveProblem);
            console.log('   - Effective Risk Level:', effectiveRiskLevel);
            
            const result = window.sharedDataManager.applyProblemSpecificMonitoring(
                effectiveProblem, 
                window.organComponents,
                window.sharedDataManager.getCurrentPatientId(), // Pass patient ID to save target ranges
                effectiveRiskLevel, // Use 'mid' as default when problem selected but no risk chosen
                shouldOverwriteManualAdjustments // CRITICAL: Pass the flag to preserve/overwrite manual adjustments
            );
            
            const finalOrganStates = result.organStates;
            const targetRanges = result.targetRanges;
            const isActivated = selectedProblem !== '';
            
            console.log('🎯 Applied organ states:', finalOrganStates);
            console.log('🎯 Applied target ranges:', targetRanges);
            console.log('🎯 Current selectedProblem:', selectedProblem);
            console.log('🎯 Current selectedRiskLevel:', selectedRiskLevel);
            console.log('🎯 isActivated:', isActivated);
            
            // Log monitoring level synchronization that happens automatically in SharedDataManager
            if (currentPatientId && window.sharedDataManager) {
                console.log('📊 Monitoring levels automatically synchronized by SharedDataManager:');
                setTimeout(() => {
                    const heartLevel = window.sharedDataManager.getHeartMonitoringLevel(currentPatientId);
                    const lungLevel = window.sharedDataManager.getLungMonitoringLevel(currentPatientId);
                    const tempLevel = window.sharedDataManager.getTempMonitoringLevel(currentPatientId);
                    console.log(`   - Heart: ${heartLevel}, Lung: ${lungLevel}, Temp: ${tempLevel}`);
                }, 50);
            }
            
            // Update organ settings (organ components already updated by centralized function)
            if (finalOrganStates.heart) {
                window.sharedDataManager.setOrganSettings('circulatoir', { 
                    active: isActivated, 
                    severity: isActivated ? 'active' : 'los', 
                    riskLevel: finalOrganStates.heart 
                });
                console.log('Heart settings saved:', finalOrganStates.heart);
            }
            if (finalOrganStates.lung) {
                window.sharedDataManager.setOrganSettings('respiratoir', { 
                    active: isActivated, 
                    severity: isActivated ? 'active' : 'los', 
                    riskLevel: finalOrganStates.lung 
                });
                console.log('Lung settings saved:', finalOrganStates.lung);
            }
            if (finalOrganStates.temp) {
                window.sharedDataManager.setOrganSettings('overig', { 
                    active: isActivated, 
                    severity: isActivated ? 'active' : 'los', 
                    riskLevel: finalOrganStates.temp 
                });
                console.log('Temp settings saved:', finalOrganStates.temp);
            }
            
            // Update monitoring status after all circles are updated
            setTimeout(() => updateMonitoringStatus(), 100);
            
            // Update opacity for all monitoring elements
            updateAllOpacity(isActivated);
        }

        // Function to update opacity for all monitoring elements
        function updateAllOpacity(isActive) {
            // Update circle opacity
            ['heart-circle-container', 'lung-circle-container', 'temp-circle-container'].forEach(containerId => {
                updateCircleOpacity(containerId, isActive);
            });
            
            // Update labels and status opacity
            document.querySelectorAll('.monitor-label, .monitor-status').forEach(element => {
                if (isActive) {
                    element.classList.add('active');
                } else {
                    element.classList.remove('active');
                }
            });
            
            // Update value cards opacity
            document.querySelectorAll('.value-card').forEach(card => {
                if (isActive) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        }

        // Function to update circle opacity
        function updateCircleOpacity(containerId, isActive) {
            const container = document.getElementById(containerId);
            if (container) {
                const circle = container.querySelector('.heart-organ-circle');
                if (circle) {
                    circle.style.opacity = isActive ? '1' : '0.3';
                }
            }
        }

        // Custom dropdown functionality
        function toggleDropdown() {
            const dropdown = document.getElementById('problemDropdown');
            const options = document.getElementById('dropdownOptions');
            
            dropdown.classList.toggle('open');
            options.classList.toggle('show');
        }

        function selectOption(value, text) {
            const dropdown = document.getElementById('problemDropdown');
            const dropdownText = dropdown.querySelector('.dropdown-text');
            const options = document.getElementById('dropdownOptions');
            const legacySelect = document.getElementById('problem-dropdown');
            
            // Update display
            dropdownText.textContent = text;
            
            // Update legacy select for backward compatibility
            if (legacySelect) {
                legacySelect.value = value;
                // Trigger change event for existing listeners
                const changeEvent = new Event('change', { bubbles: true });
                legacySelect.dispatchEvent(changeEvent);
            }
            
            // Update visual state
            if (value) {
                dropdownText.classList.remove('placeholder');
            } else {
                dropdownText.classList.add('placeholder');
            }
            
            // Close dropdown
            dropdown.classList.remove('open');
            options.classList.remove('show');
            
            // Store the selected problem using sharedDataManager for consistency
            const sessionData = window.sharedDataManager?.getSessionData();
            const currentPatientId = sessionData?.currentPatient;
            
            if (currentPatientId && window.sharedDataManager && value) {
                // Get existing medical info and update the selected problem
                const currentMedicalInfo = window.sharedDataManager.getPatientMedicalInfo(currentPatientId) || {};
                currentMedicalInfo.selectedProblem = value;
                currentMedicalInfo.lastUpdated = new Date().toISOString();
                
                // Save back to sharedDataManager
                window.sharedDataManager.savePatientMedicalInfo(currentPatientId, currentMedicalInfo);
                console.log('✅ Updated selected problem in sharedDataManager:', value);
            }
            
            // Also update dataManager if it exists for backward compatibility
            if (window.dataManager) {
                window.dataManager.setSelectedProblem(value);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.custom-dropdown-container');
            if (container && !container.contains(event.target)) {
                const dropdown = document.getElementById('problemDropdown');
                const options = document.getElementById('dropdownOptions');
                if (dropdown && options) {
                    dropdown.classList.remove('open');
                    options.classList.remove('show');
                }
            }
        });

        // Sync custom dropdown with hidden select element (legacy compatibility)
        document.addEventListener('DOMContentLoaded', function() {
            // Initial sync with delay to ensure original logic has run
            setTimeout(function() {
                syncCustomDropdownWithHiddenSelect();
            }, 200);
            
            // Watch for changes to the hidden select and update custom dropdown
            const hiddenSelect = document.getElementById('problem-dropdown');
            if (hiddenSelect) {
                // Create a MutationObserver to watch for value changes
                const observer = new MutationObserver(function(mutations) {
                    setTimeout(syncCustomDropdownWithHiddenSelect, 50);
                });
                
                // Watch for attribute changes (like value)
                observer.observe(hiddenSelect, {
                    attributes: true,
                    attributeFilter: ['value']
                });
                
                // Also listen for change events
                hiddenSelect.addEventListener('change', function() {
                    setTimeout(syncCustomDropdownWithHiddenSelect, 50);
                });
            }
        });

        function syncCustomDropdownWithHiddenSelect() {
            const hiddenSelect = document.getElementById('problem-dropdown');
            const dropdown = document.getElementById('problemDropdown');
            const dropdownText = dropdown?.querySelector('.dropdown-text');
            
            if (!hiddenSelect || !dropdownText) return;
            
            const selectedValue = hiddenSelect.value;
            console.log('🔄 Syncing custom dropdown with hidden select value:', selectedValue);
            
            if (selectedValue) {
                // Find the option text for the selected value
                const problemMap = {
                    'respiratoire-insufficientie': 'Respiratoire Insufficiëntie',
                    'hart-falen': 'Hart Falen',
                    'sepsis': 'Sepsis',
                    'neurologische-aandoening': 'Neurologische Aandoening',
                    'nierinsuffcientie': 'Nierinsufficiëntie',
                    'leverfalen': 'Leverfalen'
                };
                
                const problemText = problemMap[selectedValue];
                if (problemText) {
                    dropdownText.textContent = problemText;
                    dropdownText.classList.remove('placeholder');
                    console.log('✅ Updated custom dropdown to show:', problemText);
                } else {
                    console.log('❌ Problem not found in mapping:', selectedValue);
                }
            } else {
                // Set placeholder state
                dropdownText.textContent = 'Selecteer een probleem...';
                dropdownText.classList.add('placeholder');
                console.log('💡 Set custom dropdown to placeholder state');
            }
        }
    </script>
</body>
</html>
